---
phase: 19-npc-interactions
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - src/components/LocationGrid.vue
  - src/components/NpcDialogPanel.vue
  - src/composables/useGameData.ts
  - src/App.vue
autonomous: false

must_haves:
  truths:
    - "NPC dialogue panel shows affinity tier and progress bar for selected NPC"
    - "Available dialogue options display with locked options showing requirements"
    - "Clicking a dialogue option calls choose_dialogue_option reducer and shows NPC response"
    - "Right-clicking an NPC in location grid shows Gift option in context menu"
    - "Gift context menu shows player's inventory items and calls give_gift_to_npc on selection"
    - "Affinity changes from conversations and gifts reflect in UI immediately via subscription"
  artifacts:
    - path: "src/components/NpcDialogPanel.vue"
      provides: "Overhauled NPC dialogue panel with affinity display, dialogue options, conversation history"
      min_lines: 100
    - path: "src/components/LocationGrid.vue"
      provides: "Updated NPC context menu with Gift option"
    - path: "src/composables/useGameData.ts"
      provides: "Subscriptions for npc_affinity and npc_dialogue_option tables"
  key_links:
    - from: "src/components/NpcDialogPanel.vue"
      to: "src/module_bindings"
      via: "conn.reducers.chooseDialogueOption and conn.reducers.giveGiftToNpc calls"
      pattern: "chooseDialogueOption|giveGiftToNpc"
    - from: "src/composables/useGameData.ts"
      to: "src/module_bindings"
      via: "useTable(tables.npcAffinity) and useTable(tables.npcDialogueOption) subscriptions"
      pattern: "npcAffinity|npcDialogueOption"
    - from: "src/components/LocationGrid.vue"
      to: "src/App.vue"
      via: "emit('gift-npc', { npcId, itemId }) event bubbling"
      pattern: "gift-npc|giveGiftToNpc"
---

<objective>
Build the frontend UI for NPC interactions: overhaul NpcDialogPanel with affinity display, dialogue options, and conversation history. Add gift-giving via NPC context menu in LocationGrid. Subscribe to NpcAffinity and NpcDialogueOption tables. Human verification of full interaction flow.

Purpose: Connects the backend relationship system to player-visible UI. Without this, players cannot see affinity progress, choose dialogue options, or give gifts through the interface.
Output: Updated NpcDialogPanel with affinity badge + dialogue tree, LocationGrid with gift context menu, useGameData subscriptions, verified end-to-end NPC interaction flow.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-npc-interactions-deepen-relationships-dialogue-complexity-affinity-systems-and-dynamic-npc-reactions-to-player-actions/19-01-SUMMARY.md
@.planning/phases/19-npc-interactions-deepen-relationships-dialogue-complexity-affinity-systems-and-dynamic-npc-reactions-to-player-actions/19-02-SUMMARY.md
@src/components/NpcDialogPanel.vue
@src/components/LocationGrid.vue
@src/composables/useGameData.ts
@src/App.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NPC affinity/dialogue subscriptions and overhaul NPC dialogue panel</name>
  <files>
    src/composables/useGameData.ts
    src/components/NpcDialogPanel.vue
    src/components/LocationGrid.vue
    src/App.vue
  </files>
  <action>
**Update `src/composables/useGameData.ts`:**

1. Add subscriptions for the new tables. Import `tables` from module_bindings and add:
   ```typescript
   const [npcAffinities, npcAffinitiesLoading] = useTable(tables.npcAffinity);
   const [npcDialogueOptions, npcDialogueOptionsLoading] = useTable(tables.npcDialogueOption);
   ```
2. Return these from the composable alongside existing data.
3. Add the new tables to the SQL subscription list (the subscriptionBuilder subscribe array). Add:
   ```
   'SELECT * FROM npc_affinity',
   'SELECT * FROM npc_dialogue_option',
   ```

**Overhaul `src/components/NpcDialogPanel.vue`:**

Complete rewrite of the NPC dialogue panel. The current panel is a basic split-view showing NPC list and conversation history. Replace with:

1. **Left column (NPC list):** Same as before, but add an affinity badge next to each NPC name showing tier (e.g., "Stranger", "Friend") with color coding:
   - Hostile/Unfriendly: red (#f87171)
   - Stranger: gray (#9ca3af)
   - Acquaintance: yellow (#fbbf24)
   - Friend: blue (#60a5fa)
   - Close Friend/Devoted: green (#4ade80)

2. **Right column (when NPC selected):** Two sections:

   a. **Affinity header:** Show NPC name, affinity tier name, and a thin progress bar showing progress to next tier. Bar uses same color coding. Calculate progress: `((affinity - currentTierMin) / (nextTierMin - currentTierMin)) * 100`.

   b. **Dialogue options section (NEW):** Below the affinity header, show available dialogue options as clickable rows. Each option shows the player's dialogue text. Locked options (requirements not met) show dimmed with requirement text (e.g., "Requires Friend (50 affinity)"). Clicking an available option calls `window.__db_conn.reducers.chooseDialogueOption({ characterId, npcId, optionId })` using the object syntax.

   c. **Conversation history section:** Below dialogue options, show scrollable conversation history (same as before but now includes dialogue option exchanges).

3. **Props:** Accept all existing props plus `npcAffinities`, `npcDialogueOptions`, `selectedCharacterId`, and `factionStandings`.

4. **Affinity tier calculation:** Define AFFINITY_TIERS client-side as a constant array (same pattern as FACTION_RANKS in RenownPanel):
   ```typescript
   const AFFINITY_TIERS = [
     { min: -100, max: -51, name: 'Hostile', color: '#f87171' },
     { min: -50, max: -26, name: 'Unfriendly', color: '#f87171' },
     { min: -25, max: -1, name: 'Wary', color: '#fb923c' },
     { min: 0, max: 24, name: 'Stranger', color: '#9ca3af' },
     { min: 25, max: 49, name: 'Acquaintance', color: '#fbbf24' },
     { min: 50, max: 74, name: 'Friend', color: '#60a5fa' },
     { min: 75, max: 99, name: 'Close Friend', color: '#4ade80' },
     { min: 100, max: 100, name: 'Devoted', color: '#a78bfa' },
   ];
   ```

5. **Dialogue option filtering:** Client-side filter `npcDialogueOptions` by:
   - `npcId` matches selected NPC
   - `parentOptionId` is null/undefined (root options only for now)
   - For each option, check if character meets requirements:
     - `affinity >= requiredAffinity` (use npcAffinities filtered by characterId + npcId)
     - `factionStanding >= requiredFactionStanding` (use factionStandings prop)
     - `renownRank >= requiredRenownRank` (if applicable)

6. **Reducer calls use object syntax** (CRITICAL - per CLAUDE.md):
   ```typescript
   window.__db_conn?.reducers.chooseDialogueOption({
     characterId: props.selectedCharacterId,
     npcId: selectedNpcBigint,
     optionId: option.id,
   });
   ```

**Update `src/components/LocationGrid.vue`:**

1. Add "Give Gift" option to the NPC context menu (below existing "Talk" and "Open Store" options):
   ```typescript
   items.push({
     label: 'Give Gift',
     action: () => emit('gift-npc', npc.id),
   });
   ```

2. Add the new emit declaration:
   ```typescript
   (e: 'gift-npc', npcId: bigint): void;
   ```

**Update `src/App.vue`:**

1. Pass `npcAffinities`, `npcDialogueOptions`, `selectedCharacterId`, and `factionStandings` props to `NpcDialogPanel`.

2. Handle the `gift-npc` event from LocationGrid. When triggered, implement the gift selection flow **inline within App.vue** using reactive state -- do NOT create a separate component file. The approach:
   - Add reactive state: `giftTargetNpcId` (ref, null when no gift flow active) and a computed `giftableItems` that filters the player's inventory to non-equipped items.
   - When the `gift-npc` event fires, set `giftTargetNpcId` to the NPC's id.
   - In the template, add a conditional overlay section (v-if="giftTargetNpcId") that renders a simple positioned div (absolute/fixed overlay matching existing modal patterns in the codebase) listing giftable inventory items as clickable rows showing item name and quantity.
   - On item click, call `window.__db_conn?.reducers.giveGiftToNpc({ characterId, npcId: giftTargetNpcId, itemInstanceId: item.id })` and then set `giftTargetNpcId = null` to close the overlay.
   - Add a close/cancel button or click-outside handler to dismiss.
   - Style using the existing inline `styles` object pattern, matching the codebase's overlay/modal conventions (dark semi-transparent backdrop, centered panel with border).

3. Add NPC affinity/dialogue tables to subscription builder if not already done in useGameData.

Note on styling: Follow the existing inline styles pattern used throughout the codebase (the `styles` object pattern). Do NOT use CSS files or Tailwind classes. Use the existing color palette and font sizes from other panels.
  </action>
  <verify>
Run `npx vue-tsc --noEmit` (or the project's existing type check command) to verify no type errors. Start the dev server and verify:
1. NPC dialog panel shows affinity tier badge next to each NPC name
2. Selecting an NPC shows available dialogue options
3. Locked options appear dimmed with requirement text
4. Clicking available option triggers reducer call and shows response in history
5. Right-clicking NPC in location grid shows "Give Gift" option
6. Gift flow shows inline overlay with inventory items, consumes item and increases affinity
  </verify>
  <done>
NpcDialogPanel shows affinity tier + progress bar per NPC. Available dialogue options display with unlocked/locked styling. Clicking unlocked option calls chooseDialogueOption reducer. LocationGrid NPC context menu has "Give Gift" option. Gift selection overlay renders inline in App.vue (no separate component file) listing non-equipped inventory items. Clicking an item calls giveGiftToNpc reducer and closes overlay. npcAffinity and npcDialogueOption tables subscribed in useGameData. All reducer calls use object syntax per CLAUDE.md rules.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify NPC interaction system end-to-end</name>
  <what-built>Complete NPC relationship system: affinity tracking, dynamic greetings, branching dialogue options, gift-giving, and UI integration.</what-built>
  <how-to-verify>
1. Navigate to Hollowmere where all 3 NPCs are located
2. Right-click on Marla the Guide and select "Talk" -- should see default stranger greeting
3. Open the NPC Dialog panel (Journal tab) -- should show Marla with "Stranger" affinity tier
4. Verify dialogue options appear: "Tell me about this area" and "Which way should I go?" should be available
5. Verify "How did you become a guide?" (requires 25 affinity) appears locked/dimmed
6. Click an available dialogue option -- should see player text + NPC response in history
7. Verify affinity changed (small increase shown in progress bar)
8. Right-click Marla and select "Give Gift" -- should show inventory items in overlay
9. Select an item to gift -- item should be consumed, affinity should increase
10. Repeat greeting after affinity reaches 25+ -- greeting text should change
11. Verify dialogue options unlock as affinity increases
12. Test with Elder Soren and Quartermaster Jyn to confirm all NPCs work
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- NpcDialogPanel shows affinity tier name and color-coded progress bar for each NPC
- Available dialogue options filter by affinity/faction/renown requirements
- Locked options show dimmed with requirement text
- Clicking option calls chooseDialogueOption reducer (object syntax, not positional)
- Player text and NPC response both appear in conversation history
- Gift context menu appears in LocationGrid NPC right-click
- Gift selection overlay renders inline in App.vue with inventory items
- Gifting consumes item from inventory (stack-aware)
- Affinity gain from gift based on vendor value (1-20 range)
- Dynamic greetings change based on affinity tier
- useGameData subscribes to npc_affinity and npc_dialogue_option tables
- All data reactively updates via SpacetimeDB subscriptions
</verification>

<success_criteria>
Full NPC interaction loop verified by human: talk to NPC (dynamic greeting), choose dialogue options (with requirement gating), give gifts (item consumed, affinity gained), affinity progress visible in UI, dialogue options unlock at higher tiers. All 3 existing NPCs functional.
</success_criteria>

<output>
After completion, create `.planning/phases/19-npc-interactions-deepen-relationships-dialogue-complexity-affinity-systems-and-dynamic-npc-reactions-to-player-actions/19-03-SUMMARY.md`
</output>
