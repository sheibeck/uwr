---
phase: 19-npc-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/helpers/npc_affinity.ts
  - spacetimedb/src/data/npc_data.ts
  - spacetimedb/src/data/dialogue_data.ts
  - spacetimedb/src/seeding/ensure_world.ts
autonomous: true

must_haves:
  truths:
    - "NpcAffinity table exists with per-character, per-NPC affinity scores"
    - "Npc table has factionId, personalityJson, and baseMood fields"
    - "NpcDialogueOption table stores branching dialogue with affinity/faction/renown requirements"
    - "Affinity helper can award, clamp, and query affinity for a character-NPC pair"
    - "Dialogue seed data exists for all 3 existing NPCs with at least 3 tiers of options each"
  artifacts:
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "NpcAffinity and NpcDialogueOption table definitions, expanded Npc table"
      contains: "NpcAffinity"
    - path: "spacetimedb/src/helpers/npc_affinity.ts"
      provides: "awardNpcAffinity, getAffinityForNpc, canConverseWithNpc helpers"
      exports: ["awardNpcAffinity", "getAffinityForNpc"]
    - path: "spacetimedb/src/data/npc_data.ts"
      provides: "AFFINITY_TIERS constant, NPC personality archetypes"
      exports: ["AFFINITY_TIERS"]
    - path: "spacetimedb/src/data/dialogue_data.ts"
      provides: "Dialogue option seed data for all NPCs"
      exports: ["NPC_DIALOGUE_OPTIONS"]
    - path: "spacetimedb/src/seeding/ensure_world.ts"
      provides: "Updated NPC seeding with factionId/personality, dialogue option seeding"
      exports: ["ensureNpcs", "ensureDialogueOptions"]
  key_links:
    - from: "spacetimedb/src/helpers/npc_affinity.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "ctx.db.npcAffinity index lookups"
      pattern: "npcAffinity\\.by_character\\.filter"
    - from: "spacetimedb/src/seeding/ensure_world.ts"
      to: "spacetimedb/src/data/dialogue_data.ts"
      via: "imports NPC_DIALOGUE_OPTIONS for seeding"
      pattern: "NPC_DIALOGUE_OPTIONS"
---

<objective>
Create the backend foundation for NPC relationship system: NpcAffinity table for per-character per-NPC affinity tracking, expand the Npc table with personality/faction fields, create NpcDialogueOption table for threshold-gated dialogue trees, and seed dialogue data for existing NPCs.

Purpose: Foundation tables and helpers that all NPC interaction features depend on. Without affinity tracking and dialogue options, dynamic greetings, gift-giving, and UI cannot function.
Output: New tables (NpcAffinity, NpcDialogueOption), expanded Npc table, affinity helper module, dialogue seed data, NPC personality data.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@spacetimedb/src/schema/tables.ts
@spacetimedb/src/helpers/renown.ts
@spacetimedb/src/helpers/events.ts
@spacetimedb/src/seeding/ensure_world.ts
@spacetimedb/src/data/faction_data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NpcAffinity and NpcDialogueOption tables, expand Npc table</name>
  <files>
    spacetimedb/src/schema/tables.ts
    spacetimedb/src/data/npc_data.ts
  </files>
  <action>
In `spacetimedb/src/schema/tables.ts`:

1. **Expand the existing Npc table** by adding 3 optional columns at the end (for automatic SpacetimeDB migration):
   - `factionId: t.u64().optional()` -- NPC's faction affiliation (references Faction table)
   - `personalityJson: t.string().optional()` -- JSON with personality traits (openness, agreeableness, affinityMultiplier)
   - `baseMood: t.string().optional()` -- 'cheerful', 'grumpy', 'neutral', 'contemplative', 'irritable'

2. **Create NpcAffinity table** (public, following FactionStanding pattern):
   ```typescript
   export const NpcAffinity = table(
     {
       name: 'npc_affinity',
       public: true,
       indexes: [
         { name: 'by_character', algorithm: 'btree', columns: ['characterId'] },
         { name: 'by_npc', algorithm: 'btree', columns: ['npcId'] },
       ],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       characterId: t.u64(),
       npcId: t.u64(),
       affinity: t.i64(),              // -100 to +100
       lastInteraction: t.timestamp(),
       giftsGiven: t.u64(),
       conversationCount: t.u64(),
     }
   );
   ```

3. **Create NpcDialogueOption table** (public, for dialogue trees):
   ```typescript
   export const NpcDialogueOption = table(
     {
       name: 'npc_dialogue_option',
       public: true,
       indexes: [
         { name: 'by_npc', algorithm: 'btree', columns: ['npcId'] },
       ],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       npcId: t.u64(),
       parentOptionId: t.u64().optional(),  // null = root dialogue option
       optionKey: t.string(),               // unique key like 'greet_stranger'
       playerText: t.string(),              // What the player says
       npcResponse: t.string(),             // What the NPC responds
       requiredAffinity: t.i64(),           // Minimum affinity to see this option
       requiredFactionId: t.u64().optional(),
       requiredFactionStanding: t.i64().optional(),
       requiredRenownRank: t.u64().optional(),
       affinityChange: t.i64(),             // Affinity delta if chosen
       sortOrder: t.u64(),                  // Display order
     }
   );
   ```

4. **Add NpcAffinity and NpcDialogueOption to the schema export** at the bottom of tables.ts (the `schema()` call).

In `spacetimedb/src/data/npc_data.ts` (NEW FILE):

Create affinity tier constants and personality archetypes:
```typescript
export const AFFINITY_TIERS = {
  HOSTILE: -50,
  UNFRIENDLY: -25,
  STRANGER: 0,
  ACQUAINTANCE: 25,
  FRIEND: 50,
  CLOSE_FRIEND: 75,
  DEVOTED: 100,
} as const;

export const AFFINITY_TIER_NAMES: Record<number, string> = {
  [-50]: 'Hostile',
  [-25]: 'Unfriendly',
  [0]: 'Stranger',
  [25]: 'Acquaintance',
  [50]: 'Friend',
  [75]: 'Close Friend',
  [100]: 'Devoted',
};

export function getAffinityTierName(affinity: number): string {
  if (affinity >= 100) return 'Devoted';
  if (affinity >= 75) return 'Close Friend';
  if (affinity >= 50) return 'Friend';
  if (affinity >= 25) return 'Acquaintance';
  if (affinity >= 0) return 'Stranger';
  if (affinity >= -25) return 'Unfriendly';
  return 'Hostile';
}

export const CONVERSATION_COOLDOWN_MICROS = 3600_000_000n; // 1 hour
export const MAX_GIFTS_PER_DAY = 3n;
export const GIFT_COOLDOWN_MICROS = 86400_000_000n; // 24 hours for gift reset

export const NPC_PERSONALITIES = {
  friendly_merchant: {
    openness: 70,
    conscientiousness: 80,
    extraversion: 90,
    agreeableness: 85,
    neuroticism: 20,
    affinityMultiplier: 1.2,
  },
  grumpy_guard: {
    openness: 30,
    conscientiousness: 95,
    extraversion: 20,
    agreeableness: 40,
    neuroticism: 60,
    affinityMultiplier: 0.8,
  },
  wise_elder: {
    openness: 95,
    conscientiousness: 70,
    extraversion: 30,
    agreeableness: 60,
    neuroticism: 50,
    affinityMultiplier: 1.0,
  },
  veteran_scout: {
    openness: 60,
    conscientiousness: 85,
    extraversion: 50,
    agreeableness: 70,
    neuroticism: 30,
    affinityMultiplier: 1.1,
  },
} as const;
```
  </action>
  <verify>
Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to confirm no type errors. Verify NpcAffinity and NpcDialogueOption appear in the schema export. Verify Npc table has the 3 new optional fields.
  </verify>
  <done>
NpcAffinity table defined with by_character and by_npc indexes. NpcDialogueOption table defined with by_npc index. Npc table expanded with factionId, personalityJson, baseMood optional columns. AFFINITY_TIERS, AFFINITY_TIER_NAMES, NPC_PERSONALITIES, and cooldown constants exported from npc_data.ts. All tables included in schema export. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create affinity helper, dialogue data, and update NPC seeding</name>
  <files>
    spacetimedb/src/helpers/npc_affinity.ts
    spacetimedb/src/data/dialogue_data.ts
    spacetimedb/src/seeding/ensure_world.ts
    spacetimedb/src/seeding/ensure_content.ts
  </files>
  <action>
**Create `spacetimedb/src/helpers/npc_affinity.ts`** (NEW FILE):

Helper functions following the same pattern as `helpers/renown.ts`:

```typescript
import { CONVERSATION_COOLDOWN_MICROS } from '../data/npc_data';
import { appendSystemMessage } from './events';

export function getAffinityForNpc(ctx: any, characterId: bigint, npcId: bigint): bigint {
  for (const row of ctx.db.npcAffinity.by_character.filter(characterId)) {
    if (row.npcId === npcId) return row.affinity;
  }
  return 0n;
}

export function getAffinityRow(ctx: any, characterId: bigint, npcId: bigint): any | null {
  for (const row of ctx.db.npcAffinity.by_character.filter(characterId)) {
    if (row.npcId === npcId) return row;
  }
  return null;
}

export function awardNpcAffinity(ctx: any, character: any, npcId: bigint, baseChange: bigint) {
  const npc = ctx.db.npc.id.find(npcId);
  if (!npc) return;

  // Apply personality modifier
  let multiplier = 1.0;
  if (npc.personalityJson) {
    try {
      const personality = JSON.parse(npc.personalityJson);
      multiplier = personality.affinityMultiplier || 1.0;
    } catch {}
  }
  const adjustedChange = BigInt(Math.round(Number(baseChange) * multiplier));

  // Get or create affinity row
  const existing = getAffinityRow(ctx, character.id, npcId);

  if (existing) {
    // Clamp to -100..100 range
    let newAffinity = existing.affinity + adjustedChange;
    if (newAffinity > 100n) newAffinity = 100n;
    if (newAffinity < -100n) newAffinity = -100n;

    ctx.db.npcAffinity.id.update({
      ...existing,
      affinity: newAffinity,
      lastInteraction: ctx.timestamp,
      conversationCount: existing.conversationCount + 1n,
    });
  } else {
    let initial = adjustedChange;
    if (initial > 100n) initial = 100n;
    if (initial < -100n) initial = -100n;

    ctx.db.npcAffinity.insert({
      id: 0n,
      characterId: character.id,
      npcId,
      affinity: initial,
      lastInteraction: ctx.timestamp,
      giftsGiven: 0n,
      conversationCount: 1n,
    });
  }
}

export function canConverseWithNpc(ctx: any, characterId: bigint, npcId: bigint): boolean {
  const row = getAffinityRow(ctx, characterId, npcId);
  if (!row) return true; // First conversation always allowed
  const now = ctx.timestamp.microsSinceUnixEpoch;
  return (now - row.lastInteraction.microsSinceUnixEpoch) >= CONVERSATION_COOLDOWN_MICROS;
}

export function getAvailableDialogueOptions(ctx: any, characterId: bigint, npcId: bigint, parentOptionId: bigint | null): any[] {
  const affinity = getAffinityForNpc(ctx, characterId, npcId);
  const options: any[] = [];

  for (const opt of ctx.db.npcDialogueOption.by_npc.filter(npcId)) {
    // Filter by parent
    if (parentOptionId === null) {
      if (opt.parentOptionId !== undefined && opt.parentOptionId !== null) continue;
    } else {
      if (opt.parentOptionId !== parentOptionId) continue;
    }

    // Check affinity requirement
    if (affinity < opt.requiredAffinity) continue;

    // Check faction requirement
    if (opt.requiredFactionId) {
      let hasFaction = false;
      const minStanding = opt.requiredFactionStanding ?? 0n;
      for (const fs of ctx.db.factionStanding.by_character.filter(characterId)) {
        if (fs.factionId === opt.requiredFactionId && fs.standing >= minStanding) {
          hasFaction = true;
          break;
        }
      }
      if (!hasFaction) continue;
    }

    // Check renown requirement
    if (opt.requiredRenownRank) {
      let renownRow: any = null;
      for (const r of ctx.db.renown.by_character.filter(characterId)) {
        renownRow = r;
        break;
      }
      if (!renownRow || renownRow.currentRank < opt.requiredRenownRank) continue;
    }

    options.push(opt);
  }

  // Sort by sortOrder
  options.sort((a: any, b: any) => {
    const diff = a.sortOrder - b.sortOrder;
    return diff < 0n ? -1 : diff > 0n ? 1 : 0;
  });

  return options;
}
```

**Create `spacetimedb/src/data/dialogue_data.ts`** (NEW FILE):

Dialogue option seed data for the 3 existing NPCs (Marla the Guide, Elder Soren, Quartermaster Jyn). Each NPC gets at least 3 root-level dialogue options across different affinity tiers:

```typescript
export interface DialogueOptionSeed {
  npcName: string;
  optionKey: string;
  parentOptionKey: string | null;
  playerText: string;
  npcResponse: string;
  requiredAffinity: bigint;
  affinityChange: bigint;
  sortOrder: bigint;
}

export const NPC_DIALOGUE_OPTIONS: DialogueOptionSeed[] = [
  // === Marla the Guide (quest NPC) ===
  // Tier 0 - Stranger
  {
    npcName: 'Marla the Guide',
    optionKey: 'marla_greet',
    parentOptionKey: null,
    playerText: 'Tell me about this area.',
    npcResponse: 'The lands beyond Hollowmere are unforgiving. Ash jackals prowl the lowlands, and worse things lurk in the deep.',
    requiredAffinity: 0n,
    affinityChange: 1n,
    sortOrder: 1n,
  },
  {
    npcName: 'Marla the Guide',
    optionKey: 'marla_directions',
    parentOptionKey: null,
    playerText: 'Which way should I go?',
    npcResponse: 'Stick to the river paths if you value your skin. The Scorchlands will eat you alive unprepared.',
    requiredAffinity: 0n,
    affinityChange: 1n,
    sortOrder: 2n,
  },
  // Tier 25 - Acquaintance
  {
    npcName: 'Marla the Guide',
    optionKey: 'marla_past',
    parentOptionKey: null,
    playerText: 'How did you become a guide?',
    npcResponse: 'Lost my whole company to a bog wyrm three winters back. Only one who made it out. Figured I should learn the land better than it knows me.',
    requiredAffinity: 25n,
    affinityChange: 3n,
    sortOrder: 3n,
  },
  // Tier 50 - Friend
  {
    npcName: 'Marla the Guide',
    optionKey: 'marla_secret_path',
    parentOptionKey: null,
    playerText: 'Know any shortcuts through the wilds?',
    npcResponse: 'There is an old smuggler trail through the Thornveil. Dangerous, but it cuts the journey in half. I will mark it on your map.',
    requiredAffinity: 50n,
    affinityChange: 5n,
    sortOrder: 4n,
  },
  // Tier 75 - Close Friend
  {
    npcName: 'Marla the Guide',
    optionKey: 'marla_trust',
    parentOptionKey: null,
    playerText: 'What really happened to your company?',
    npcResponse: 'They were not just soldiers. They were family. Every name is carved into my belt. I will not lose anyone else if I can help it.',
    requiredAffinity: 75n,
    affinityChange: 5n,
    sortOrder: 5n,
  },

  // === Elder Soren (lore NPC) ===
  // Tier 0 - Stranger
  {
    npcName: 'Elder Soren',
    optionKey: 'soren_greet',
    parentOptionKey: null,
    playerText: 'What can you tell me about Hollowmere?',
    npcResponse: 'This town has stood since before the Ashfall. We endure because we remember. Others forget and perish.',
    requiredAffinity: 0n,
    affinityChange: 1n,
    sortOrder: 1n,
  },
  {
    npcName: 'Elder Soren',
    optionKey: 'soren_factions',
    parentOptionKey: null,
    playerText: 'Tell me about the factions.',
    npcResponse: 'Four powers carve this land between them. The Iron Compact trades in steel and coin. The Verdant Circle guards what green remains. The Ashen Order hoards forbidden knowledge. And the Free Blades sell their swords to whoever pays.',
    requiredAffinity: 0n,
    affinityChange: 1n,
    sortOrder: 2n,
  },
  // Tier 25 - Acquaintance
  {
    npcName: 'Elder Soren',
    optionKey: 'soren_history',
    parentOptionKey: null,
    playerText: 'What was this land before the Ashfall?',
    npcResponse: 'Green. Impossibly green. Rivers ran clear and the sky did not taste of cinder. But that was before the Hollowed emerged from beneath.',
    requiredAffinity: 25n,
    affinityChange: 3n,
    sortOrder: 3n,
  },
  // Tier 50 - Friend
  {
    npcName: 'Elder Soren',
    optionKey: 'soren_warning',
    parentOptionKey: null,
    playerText: 'You seem troubled, Elder.',
    npcResponse: 'The ground trembles more often now. The old seals are weakening. Something stirs beneath the Deephollow that should remain buried.',
    requiredAffinity: 50n,
    affinityChange: 5n,
    sortOrder: 4n,
  },
  // Tier 75 - Close Friend
  {
    npcName: 'Elder Soren',
    optionKey: 'soren_secret',
    parentOptionKey: null,
    playerText: 'What do you know about the sealed chambers?',
    npcResponse: 'I have the key to the Archive beneath the town hall. The records there... they speak of things the Iron Compact would rather stay forgotten. Come, I will show you.',
    requiredAffinity: 75n,
    affinityChange: 5n,
    sortOrder: 5n,
  },

  // === Quartermaster Jyn (vendor NPC) ===
  // Tier 0 - Stranger
  {
    npcName: 'Quartermaster Jyn',
    optionKey: 'jyn_greet',
    parentOptionKey: null,
    playerText: 'What do you have for sale?',
    npcResponse: 'Standard issue. Blades, armor, rations. Nothing fancy, but it will keep you breathing.',
    requiredAffinity: 0n,
    affinityChange: 1n,
    sortOrder: 1n,
  },
  // Tier 25 - Acquaintance
  {
    npcName: 'Quartermaster Jyn',
    optionKey: 'jyn_supply',
    parentOptionKey: null,
    playerText: 'Having trouble with supplies?',
    npcResponse: 'The southern caravans stopped running two weeks ago. Something on the road is hitting them hard. If you find out what, I would owe you one.',
    requiredAffinity: 25n,
    affinityChange: 3n,
    sortOrder: 2n,
  },
  // Tier 50 - Friend
  {
    npcName: 'Quartermaster Jyn',
    optionKey: 'jyn_discount',
    parentOptionKey: null,
    playerText: 'Any deals for a friend?',
    npcResponse: 'For you? I might have some stock set aside. The good stuff, not the rust-buckets I sell to strangers.',
    requiredAffinity: 50n,
    affinityChange: 3n,
    sortOrder: 3n,
  },
  // Tier 75 - Close Friend
  {
    npcName: 'Quartermaster Jyn',
    optionKey: 'jyn_confide',
    parentOptionKey: null,
    playerText: 'Something on your mind, Jyn?',
    npcResponse: 'My sister went north with a supply convoy. Three weeks, no word. The Compact says do not worry, but I know that silence. Help me find her?',
    requiredAffinity: 75n,
    affinityChange: 5n,
    sortOrder: 4n,
  },
];
```

**Update `spacetimedb/src/seeding/ensure_world.ts`:**

1. Update the `upsertNpcByName` function to accept and set the new optional fields: `factionId`, `personalityJson`, `baseMood`.

2. Update existing NPC seed data:
   - Marla the Guide: baseMood='focused', personalityJson=NPC_PERSONALITIES.veteran_scout, factionId=undefined (neutral)
   - Elder Soren: baseMood='contemplative', personalityJson=NPC_PERSONALITIES.wise_elder, factionId=undefined
   - Quartermaster Jyn: baseMood='brisk', personalityJson=NPC_PERSONALITIES.friendly_merchant, factionId=look up Iron Compact faction by iterating ctx.db.faction

3. Add `ensureDialogueOptions(ctx: any)` function:
   - Import NPC_DIALOGUE_OPTIONS from dialogue_data.ts
   - For each option: resolve npcName to npcId, resolve parentOptionKey to parentOptionId (if set), upsert by optionKey
   - Use the pattern: check if existing by iterating `ctx.db.npcDialogueOption.by_npc.filter(npcId)` and matching optionKey

**Update `spacetimedb/src/seeding/ensure_content.ts`:**

1. Import `ensureDialogueOptions` from ensure_world.ts
2. Call `ensureDialogueOptions(ctx)` after `ensureNpcs(ctx)` in the syncAllContent function

Note: Do NOT use `.iter()` in any views. Use index lookups only. The NpcAffinity and NpcDialogueOption tables are public so client-side filtering will work.
  </action>
  <verify>
Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to confirm no type errors. Verify ensureDialogueOptions is called in syncAllContent. Verify all 3 NPCs have personality data. Verify at least 14 dialogue options exist in NPC_DIALOGUE_OPTIONS array.
  </verify>
  <done>
awardNpcAffinity helper awards affinity with personality multiplier and -100..100 clamping. getAffinityForNpc and canConverseWithNpc helpers work via by_character index lookup. NPC_DIALOGUE_OPTIONS contains 14+ dialogue options across 4 affinity tiers for 3 NPCs. ensureNpcs seeds personality/mood data. ensureDialogueOptions seeds all dialogue options with npcId/parentOptionId resolution. ensure_content calls both in correct order. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
- NpcAffinity table has by_character and by_npc btree indexes
- NpcDialogueOption table has by_npc btree index
- Npc table has factionId, personalityJson, baseMood optional columns
- awardNpcAffinity clamps values to -100..100 range
- awardNpcAffinity applies personality multiplier from NPC's personalityJson
- canConverseWithNpc enforces 1-hour cooldown
- getAvailableDialogueOptions filters by affinity, faction standing, and renown rank
- All 3 existing NPCs have personality archetypes assigned
- 14+ dialogue options seeded across 4 affinity tiers (0, 25, 50, 75)
- No .iter() usage in views (tables are public, client filters)
- TypeScript compiles without errors
</verification>

<success_criteria>
Backend foundation complete: NpcAffinity and NpcDialogueOption tables defined, Npc table expanded, affinity helper module working, dialogue seed data for 3 NPCs across 4 tiers, NPC personality data seeded. All code compiles cleanly. Ready for Plan 02 to add reducers and interactions.
</success_criteria>

<output>
After completion, create `.planning/phases/19-npc-interactions-deepen-relationships-dialogue-complexity-affinity-systems-and-dynamic-npc-reactions-to-player-actions/19-01-SUMMARY.md`
</output>
