---
phase: 18-world-events-system-expansion
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - src/components/WorldEventPanel.vue
  - src/composables/useGameData.ts
  - src/App.vue
  - src/components/ActionBar.vue
  - src/ui/styles.ts
autonomous: false

must_haves:
  truths:
    - "WorldEventPanel has two tabs: Active and History (locked decision)"
    - "Active tab shows event name, region, objective progress bar, and rewards preview"
    - "History tab shows event name, outcome (success/fail), consequence triggered, and when resolved"
    - "Dedicated action bar button with badge/highlight when at least one event is active"
    - "Banner overlay notification fires when a new world event begins (log entry + brief banner)"
    - "Banner auto-dismisses after a few seconds"
    - "Players can see their contribution tier (Bronze/Silver/Gold) in the active event card"
    - "Event spawns (enemies, items) visible in location if character is in event region"
  artifacts:
    - path: "src/components/WorldEventPanel.vue"
      provides: "WorldEventPanel with Active + History tabs, progress bars, contribution display"
      min_lines: 100
    - path: "src/composables/useGameData.ts"
      provides: "useTable subscriptions for worldEvent, eventContribution, eventSpawnEnemy, eventSpawnItem, eventObjective"
      contains: "worldEvent"
    - path: "src/App.vue"
      provides: "WorldEventPanel wiring, banner overlay, panel mount, useGameData subscriptions"
      contains: "WorldEventPanel"
    - path: "src/components/ActionBar.vue"
      provides: "Events button with active-event badge indicator"
      contains: "worldEvents"
  key_links:
    - from: "src/components/WorldEventPanel.vue"
      to: "src/module_bindings"
      via: "tables.worldEvent, tables.eventContribution props from App.vue"
      pattern: "worldEvent"
    - from: "src/App.vue"
      to: "src/components/WorldEventPanel.vue"
      via: "component import and rendering with props"
      pattern: "WorldEventPanel"
    - from: "src/App.vue"
      to: "src/composables/useGameData.ts"
      via: "worldEvents destructured from useGameData for banner watch and panel props"
      pattern: "worldEvents"
    - from: "src/components/ActionBar.vue"
      to: "src/App.vue"
      via: "emit('toggle', 'worldEvents') button click"
      pattern: "worldEvents"
---

<objective>
Build the client UI for the World Events System: WorldEventPanel component with Active and History tabs, banner overlay notification on event fire, action bar button with active-event badge, useGameData subscriptions for all event tables. Wire everything into App.vue and verify with human testing.

Purpose: Give players visibility into world events with contribution tracking, reward previews, and event history as a narrative record of the server's story.
Output: Functional WorldEventPanel integrated into the game UI, banner notification system, human-verified.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-world-events-system-expansion-regional-event-spawning-ripple-system-event-types-and-objectives-faction-and-overall-renown-rewards-event-participation-tracking/18-CONTEXT.md
@.planning/phases/18-world-events-system-expansion-regional-event-spawning-ripple-system-event-types-and-objectives-faction-and-overall-renown-rewards-event-participation-tracking/18-RESEARCH.md
@.planning/phases/18-world-events-system-expansion-regional-event-spawning-ripple-system-event-types-and-objectives-faction-and-overall-renown-rewards-event-participation-tracking/18-02-SUMMARY.md

Key existing UI patterns:
@src/components/RenownPanel.vue — Multi-tab panel pattern (Factions/Renown/Leaderboard tabs)
@src/components/ActionBar.vue — Button + emit toggle pattern, PanelKey type, badge styling
@src/composables/useGameData.ts — useTable subscription pattern, composable return object
@src/App.vue — Panel toggle, floating panel registration, usePanelManager, watcher patterns
@src/ui/styles.ts — Shared inline style objects used by all panels
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subscriptions and create WorldEventPanel with Active + History tabs</name>
  <files>
    src/composables/useGameData.ts
    src/components/WorldEventPanel.vue
    src/ui/styles.ts
  </files>
  <action>
**CRITICAL CONTEXT DECISIONS (from 18-CONTEXT.md):**
- Panel has TWO tabs: Active (ongoing events) and History (resolved events, permanent record)
- Active event cards show: event name, region, objective progress bar, rewards preview
- History shows: event name, outcome (success/fail), consequence triggered, when it resolved
- Contribution tiers: Bronze/Silver/Gold displayed per-event
- Event history is the narrative record of the server's history

**In `src/composables/useGameData.ts`:**

Add useTable subscriptions for the 5 new tables alongside existing table subscriptions:
```typescript
const [worldEvents, worldEventsLoading] = useTable(tables.worldEvent);
const [eventContributions, eventContributionsLoading] = useTable(tables.eventContribution);
const [eventSpawnEnemies] = useTable(tables.eventSpawnEnemy);
const [eventSpawnItems] = useTable(tables.eventSpawnItem);
const [eventObjectives] = useTable(tables.eventObjective);
```

Add all 5 to the composable's return object. Also add to the subscription SQL list:
```
'SELECT * FROM world_event',
'SELECT * FROM event_contribution',
'SELECT * FROM event_spawn_enemy',
'SELECT * FROM event_spawn_item',
'SELECT * FROM event_objective',
```

**In `src/ui/styles.ts`:**

Add a `worldEventBanner` style for the banner overlay:
```typescript
worldEventBanner: {
  position: 'fixed' as const,
  top: '80px',
  left: '50%',
  transform: 'translateX(-50%)',
  background: 'linear-gradient(135deg, rgba(250, 204, 21, 0.95), rgba(245, 158, 11, 0.95))',
  color: '#1a1a2e',
  padding: '12px 32px',
  borderRadius: '8px',
  fontWeight: 700,
  fontSize: '16px',
  fontFamily: "'Courier New', monospace",
  zIndex: 9999,
  textAlign: 'center' as const,
  boxShadow: '0 4px 20px rgba(250, 204, 21, 0.4)',
  pointerEvents: 'none' as const,
},
```

**Create `src/components/WorldEventPanel.vue`:**

Build following the RenownPanel.vue tab pattern (identical tab bar styling, same resultCard pattern for items).

Props (received from App.vue):
- `worldEvents` — array of WorldEvent rows
- `eventContributions` — array of EventContribution rows
- `eventObjectives` — array of EventObjective rows
- `regions` — array of Region rows (for name lookup)
- `selectedCharacter` — current character (for contribution display)

Template structure:

1. **Tab bar** (Active | History) — identical inline style pattern to RenownPanel.vue tabs:
```html
<div :style="{ display: 'flex', gap: '0', borderBottom: '1px solid rgba(255,255,255,0.1)', marginBottom: '8px' }">
  <button type="button" @click="activeTab = 'active'" :style="tabStyle('active')">Active</button>
  <button type="button" @click="activeTab = 'history'" :style="tabStyle('history')">History</button>
</div>
```

2. **Active tab** — events where status === 'active':
   For each active event card (using styles.resultCard):
   - Event name (bold, amber color)
   - Region name (lookup from regions by regionId)
   - Objective progress bar: show kill_count objective currentCount/targetCount if EventObjective exists
   - For threshold_race events: show successCounter/successThreshold progress
   - For time-based events: show time remaining (if deadlineAtMicros available)
   - Contribution tier display: show character's current count and which tier they're in (Bronze/Silver/Gold) based on parsed rewardTiersJson thresholds
   - Rewards preview: parse rewardTiersJson, show next tier reward preview (renown, gold amounts)
   - "No active world events." message if empty

3. **History tab** — events where status === 'success' or 'failed':
   Sorted by resolvedAt descending (most recent first). For each:
   - Event name
   - Outcome badge: green "Success" or red "Failed"
   - Consequence text (from event.consequenceText or fallback description)
   - Resolved timestamp formatted
   - "No resolved events yet." message if empty

Computed properties:
- `activeEvents` — worldEvents filtered by status === 'active'
- `historyEvents` — worldEvents filtered by status !== 'active', sorted by resolvedAt desc
- `myContributions` — Map of eventId -> contribution count for selected character
- `regionNameMap` — Map of regionId -> region.name
- `tierForCount(count, rewardTiersJson)` — returns 'gold' | 'silver' | 'bronze' based on parsed thresholds

Helper functions:
- `tabStyle(tab)` — returns active/inactive tab styling (follow RenownPanel exactly)
- `progressPercent(event)` — calculate percentage for progress bar
- `rewardsPreview(event, tier)` — format reward preview string
- `formatTimestamp(ts)` — format resolvedAt for history display
- `tierColor(tier)` — gold=#facc15, silver=#c0c0c0, bronze=#cd7f32
  </action>
  <verify>
1. `npx tsc --noEmit` passes (client compiles)
2. WorldEventPanel.vue has Active and History tabs (two distinct sections controlled by activeTab ref)
3. Active tab shows: event name, region, progress bar, contribution tier, rewards preview
4. History tab shows: event name, outcome badge (green/red), consequence text, resolved timestamp
5. useGameData.ts exports worldEvents, eventContributions, eventSpawnEnemies, eventSpawnItems, eventObjectives
6. styles.ts exports worldEventBanner style
  </verify>
  <done>
WorldEventPanel component exists with Active + History tabs. Active shows event name, region, objective progress, contribution tier (Bronze/Silver/Gold), and rewards preview. History shows event name, outcome (color-coded), consequence, and timestamp. useGameData subscriptions wired for all 5 event tables. Banner style defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire WorldEventPanel into App.vue with action bar badge and banner overlay</name>
  <files>
    src/App.vue
    src/components/ActionBar.vue
  </files>
  <action>
**CRITICAL CONTEXT DECISIONS:**
- Dedicated action bar button with badge/highlight when at least one event is active
- Banner overlay: log entry + brief banner on event fire, auto-dismisses after a few seconds
- Same notification for all events regardless of trigger source

**In `src/components/ActionBar.vue`:**

Add "Events" button following the existing button pattern. Include a badge dot when active events exist:

1. Add `hasActiveEvents` to the component's props (Boolean, passed from App.vue)
2. Add the button in the template near the Renown button:
```html
<button
  @click="emit('toggle', 'worldEvents')"
  :style="{ ...actionStyle('worldEvents'), position: 'relative' }"
>
  Events
  <span
    v-if="hasActiveEvents"
    :style="{ position: 'absolute', top: '2px', right: '2px', width: '8px', height: '8px',
              background: '#facc15', borderRadius: '50%', display: 'block' }"
  ></span>
</button>
```

3. Add 'worldEvents' to the PanelKey type if it uses one
4. Register emit for the toggle event if not already generic

**In `src/App.vue`:**

Follow the exact pattern used for RenownPanel wiring:

1. **Import** WorldEventPanel component
2. **Destructure** worldEvents, eventContributions, eventObjectives from useGameData (add to existing destructuring)
3. **Panel management** — register 'worldEvents' in usePanelManager if used, or add showWorldEventPanel ref
4. **Computed** hasActiveEvents: `computed(() => worldEvents.value?.some((e: any) => e.status === 'active') ?? false)`

5. **Banner overlay** — Add a watch on worldEvents for new active events:
```typescript
const activeBanner = ref<string | null>(null);
let bannerTimer: ReturnType<typeof setTimeout> | null = null;

watch(worldEvents, (newRows, oldRows) => {
  if (!oldRows) return;
  const prevIds = new Set((oldRows as any[]).map((r: any) => r.id.toString()));
  for (const row of (newRows as any[])) {
    if (!prevIds.has(row.id.toString()) && row.status === 'active') {
      activeBanner.value = `World Event: ${row.name} has begun!`;
      if (bannerTimer) clearTimeout(bannerTimer);
      bannerTimer = setTimeout(() => { activeBanner.value = null; }, 5000);
    }
  }
}, { deep: true });
```

6. **Banner template** — Add above floating panels:
```html
<div v-if="activeBanner" :style="styles.worldEventBanner">
  {{ activeBanner }}
</div>
```

7. **Panel rendering** — Add WorldEventPanel where other panels are rendered:
```html
<WorldEventPanel
  v-if="showWorldEventPanel or panelManager check"
  :worldEvents="worldEvents"
  :eventContributions="eventContributions"
  :eventObjectives="eventObjectives"
  :regions="regions"
  :selectedCharacter="selectedCharacter"
/>
```
Pass correct props based on existing panel patterns. Wrap in PanelShell if other panels use it.

8. **Action bar props** — Pass hasActiveEvents to ActionBar component
  </action>
  <verify>
1. `npx tsc --noEmit` passes (client compiles)
2. ActionBar has "Events" button with yellow badge dot when active events exist
3. App.vue has banner overlay that appears on new world events and auto-dismisses after ~5 seconds
4. WorldEventPanel receives all required props from App.vue
5. Panel shows/hides when Events button is clicked
6. hasActiveEvents computed correctly filters worldEvents by status === 'active'
  </verify>
  <done>
WorldEventPanel fully wired into App.vue with action bar toggle button and active-event badge. Banner overlay fires on new world events, auto-dismisses after 5 seconds. All props passed from useGameData subscriptions. Panel shows/hides on button click. Client compiles.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of World Events System</name>
  <files>src/components/WorldEventPanel.vue, src/App.vue, src/components/ActionBar.vue</files>
  <action>
Human verifies the complete World Events System:
- WorldEventPanel opens from action bar with Active + History tabs
- Banner overlay fires on new world events and auto-dismisses
- Event fire, contribution tracking, and tiered resolve all functional
- Ripple consequences apply on resolution
- One-time events cannot be re-fired after resolution
  </action>
  <verify>
1. Open the game client in the browser
2. Click the "Events" button in the action bar — WorldEventPanel should open with Active and History tabs
3. Verify both tabs exist and Active tab shows "No active world events."
4. Fire a test event via browser console:
   `window.__db_conn.reducers.fireWorldEvent({ eventKey: 'ashen_awakening' })`
   (This will fail if your identity is not in ADMIN_IDENTITIES — add your hex first if needed)
5. Verify banner overlay appears at top: "World Event: The Ashen Awakening has begun!" and auto-dismisses after ~5 seconds
6. Verify the action bar Events button now shows a yellow badge dot
7. Verify the Active tab shows the event card with:
   - Event name (The Ashen Awakening)
   - Region name
   - Progress bar (if kill_count objectives exist)
   - Contribution tier display
   - Rewards preview
8. Travel to the event region — verify EventContribution auto-registration (you should see your contribution at 0/Bronze)
9. If event-spawned enemies exist in the region, engage in combat and kill one
10. Verify contribution count increments and tier may advance
11. Resolve the event via console:
    `window.__db_conn.reducers.resolveWorldEvent({ worldEventId: 1n, outcome: 'success' })`
12. Verify rewards fire (renown, gold, faction standing per your tier)
13. Verify event moves from Active tab to History tab with green "Success" badge
14. Verify History tab shows: event name, "Success", consequence description, resolved timestamp
15. Verify event spawns linger briefly (~2 min) then despawn
16. Try firing the same one-time event again — should be rejected
  </verify>
  <done>
World Events System human-verified: panel displays active/resolved events with tabs, banner fires on event start, contribution tracks with Bronze/Silver/Gold tiers, tiered rewards fire on resolve, Ripple consequences apply, one-time events locked permanently.
  </done>
</task>

</tasks>

<verification>
1. WorldEventPanel.vue exists with Active and History tabs (two distinct sections)
2. Active tab: event name, region, objective progress bar, contribution tier, rewards preview
3. History tab: event name, outcome (success green / failed red), consequence text, resolved timestamp
4. ActionBar has Events button with yellow badge when active events exist
5. Banner overlay fires on new world events, auto-dismisses after ~5 seconds
6. useGameData.ts exports subscriptions for all 5 event tables
7. App.vue wires WorldEventPanel with all required props
8. Client TypeScript compiles without errors
9. Human verifies: event fire, banner, contribution, resolve, tiered rewards, history display
</verification>

<success_criteria>
Players can see active world events in a dedicated panel with Active and History tabs. Active cards show name, region, progress, contribution tier, and reward preview. History shows outcome and consequence as a narrative record. Banner overlay fires on new events. Action bar badge indicates active events. Events auto-register participants on region entry, track Bronze/Silver/Gold contributions, and award tiered rewards on resolution. Human verified functional.
</success_criteria>

<output>
After completion, create `.planning/phases/18-world-events-system-expansion-regional-event-spawning-ripple-system-event-types-and-objectives-faction-and-overall-renown-rewards-event-participation-tracking/18-03-SUMMARY.md`
</output>
