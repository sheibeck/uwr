---
phase: 18-world-events-system-expansion
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - src/components/WorldEventPanel.vue
  - src/composables/useGameData.ts
  - src/App.vue
autonomous: false

must_haves:
  truths:
    - "Players can see a list of active world events with type, region, and objective progress"
    - "Players can join an active world event from the panel"
    - "Players can see their participation status (joined/not joined) per event"
    - "Resolved events show completion status and are visually distinct from active events"
    - "World event button appears in the action bar to toggle the panel"
    - "Stat trackers display current progress toward next threshold"
  artifacts:
    - path: "src/components/WorldEventPanel.vue"
      provides: "World event list with join button, objective progress, participation status"
      min_lines: 80
    - path: "src/composables/useGameData.ts"
      provides: "useTable subscriptions for worldEvent, worldEventParticipant, worldStatTracker, regionAdjacency"
      contains: "worldEvent"
    - path: "src/App.vue"
      provides: "WorldEventPanel wiring, action bar button, panel toggle"
      contains: "WorldEventPanel"
  key_links:
    - from: "src/components/WorldEventPanel.vue"
      to: "src/module_bindings"
      via: "tables.worldEvent, tables.worldEventParticipant subscriptions"
      pattern: "worldEvent"
    - from: "src/components/WorldEventPanel.vue"
      to: "src/module_bindings"
      via: "conn.reducers.joinWorldEvent call"
      pattern: "joinWorldEvent"
    - from: "src/App.vue"
      to: "src/components/WorldEventPanel.vue"
      via: "component import and rendering"
      pattern: "WorldEventPanel"
---

<objective>
Build the client UI for the World Events System: a WorldEventPanel component showing active/resolved events, join buttons, objective progress bars, participation status, and stat tracker progress. Wire into App.vue with action bar button.

Purpose: Give players visibility into world events and the ability to participate in them.
Output: Functional WorldEventPanel integrated into the game UI, human-verified.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-world-events-system-expansion-regional-event-spawning-ripple-system-event-types-and-objectives-faction-and-overall-renown-rewards-event-participation-tracking/18-RESEARCH.md
@.planning/phases/18-world-events-system-expansion-regional-event-spawning-ripple-system-event-types-and-objectives-faction-and-overall-renown-rewards-event-participation-tracking/18-02-SUMMARY.md

Key existing UI patterns:
@src/components/RenownPanel.vue — Tabbed panel pattern, action bar button, panel style conventions
@src/composables/useGameData.ts — useTable subscription pattern
@src/App.vue — Panel toggle pattern, action bar button wiring, component props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subscriptions and create WorldEventPanel component</name>
  <files>
    src/composables/useGameData.ts
    src/components/WorldEventPanel.vue
  </files>
  <action>
**In `src/composables/useGameData.ts`:**

Add useTable subscriptions for the 4 new tables alongside existing table subscriptions. Follow the exact pattern used for other tables (e.g., renown, factionStandings):

```typescript
const [worldEvents, worldEventsLoading] = useTable(tables.worldEvent);
const [worldEventParticipants, worldEventParticipantsLoading] = useTable(tables.worldEventParticipant);
const [worldStatTrackers, worldStatTrackersLoading] = useTable(tables.worldStatTracker);
const [regionAdjacencies, regionAdjacenciesLoading] = useTable(tables.regionAdjacency);
```

Add all 4 to the composable's return object so components can access them.

Also add these tables to the subscription SQL list if the composable manages subscriptions (check existing pattern — typically `SELECT * FROM table_name`):
```
'SELECT * FROM world_event',
'SELECT * FROM world_stat_tracker',
'SELECT * FROM world_event_participant',
'SELECT * FROM region_adjacency',
```

**Create `src/components/WorldEventPanel.vue`:**

Build a panel component following the RenownPanel.vue style conventions (dark background, amber accents, monospace font, draggable window pattern).

Props (received from App.vue):
- `worldEvents` — array of WorldEvent rows
- `worldEventParticipants` — array of WorldEventParticipant rows
- `worldStatTrackers` — array of WorldStatTracker rows
- `regions` — array of Region rows (for name lookup)
- `selectedCharacter` — current character (for join button and participation check)

Template sections:

1. **Active Events** section — list of events with `status === 'fired'`:
   - Event type label (formatted: capitalize first letter)
   - Region name (lookup from regions by regionId, or "Global" if null)
   - Objective progress bar (if objectiveTarget exists): `objectiveCurrent / objectiveTarget` with percentage fill
   - Participation badge: "Joined" if character has a participant row, else "Join" button
   - Join button calls `conn.reducers.joinWorldEvent({ worldEventId: event.id, characterId: selectedCharacter.id })`
   - Reward preview: renown amount if set

2. **Resolved Events** section — list of events with `status === 'resolved'`:
   - Same info but dimmed (opacity 0.5) and no join button
   - Show "Resolved" badge instead
   - Limit to most recent 5 resolved events

3. **Server Progress** section — stat tracker display:
   - For each tracker: stat label (formatted from statKey), current/next threshold, progress bar
   - e.g., "Total Enemies Killed: 342 / 500"

Styling (follow existing panel conventions):
- Dark background (#1a1a2e or similar from existing panels)
- Amber (#f5a623) for active event highlights and join buttons
- Green (#4ade80) for "Joined" badges
- Grey (#666) for resolved events
- Progress bars: dark container (#333), colored fill (amber for active, green for tracker)
- Panel width ~350px, max-height with overflow scroll

Computed properties:
- `activeEvents` — filter worldEvents by status === 'fired'
- `resolvedEvents` — filter worldEvents by status === 'resolved', sorted by resolvedAt descending, limit 5
- `myParticipation` — Set of worldEventIds the selected character has joined (from worldEventParticipants filtered by characterId)
- `regionNameMap` — Map of regionId -> region.name for display

Event handling:
- `joinEvent(eventId)` — calls reducer with object syntax: `window.__db_conn?.reducers.joinWorldEvent({ worldEventId: eventId, characterId: props.selectedCharacter.id })`
  </action>
  <verify>
1. `npx tsc --noEmit` passes (client compiles)
2. WorldEventPanel.vue has active events list, resolved events list, stat tracker display
3. useGameData.ts exports worldEvents, worldEventParticipants, worldStatTrackers, regionAdjacencies
4. Join button uses correct reducer call syntax (object args, not positional)
  </verify>
  <done>
WorldEventPanel component exists with 3 sections (active events with join, resolved events, stat trackers). useGameData subscriptions wired for all 4 new tables. Panel follows existing UI conventions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire WorldEventPanel into App.vue with action bar button</name>
  <files>
    src/App.vue
  </files>
  <action>
Follow the exact pattern used for RenownPanel wiring in App.vue:

1. **Import** WorldEventPanel component at top of script section:
```typescript
import WorldEventPanel from './components/WorldEventPanel.vue';
```

2. **Panel toggle state** — add `showWorldEventPanel` ref (follow showRenownPanel pattern):
```typescript
const showWorldEventPanel = ref(false);
```

3. **Action bar button** — add a "World Events" button in the action bar section, following the Renown button pattern. Use a label like "Events" or "World" to keep it short. Place it near the Renown button in the action bar.

4. **Panel rendering** — add WorldEventPanel component in the template section where other panels are rendered (near RenownPanel). Pass required props:
```html
<WorldEventPanel
  v-if="showWorldEventPanel"
  :worldEvents="worldEvents"
  :worldEventParticipants="worldEventParticipants"
  :worldStatTrackers="worldStatTrackers"
  :regions="regions"
  :selectedCharacter="selectedCharacter"
  @close="showWorldEventPanel = false"
/>
```

5. **Destructure from useGameData** — add worldEvents, worldEventParticipants, worldStatTrackers, regionAdjacencies to the destructured values from useGameData composable (if not already).

6. **Panel position** — if the project uses usePanelManager for window positioning, register 'worldEvents' as a panel key.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (client compiles)
2. Action bar has "Events" button that toggles showWorldEventPanel
3. WorldEventPanel receives all required props from App.vue
4. Panel renders when button is clicked
  </verify>
  <done>
WorldEventPanel fully wired into App.vue with action bar toggle button, all props passed from useGameData subscriptions. Panel shows/hides on button click. Client compiles.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of World Events System</name>
  <files>src/components/WorldEventPanel.vue, src/App.vue</files>
  <action>
Human verifies the complete World Events System:
- World Events panel opens from action bar button
- Active events display with type, region, objective progress
- Join button allows participation in events
- Combat kills increment stat trackers and event contribution
- Event auto-resolves when objective target met
- Resolved events appear dimmed in history section
- Ripple spawns follow-up events in neighboring regions
- EventWorld log shows event messages
  </action>
  <verify>
1. Open the game client in the browser
2. Click the "Events" button in the action bar — World Events panel should open
3. Verify the "Server Progress" section shows stat trackers (total_enemies_killed, total_quests_completed) at 0/500 and 0/25 respectively
4. Use browser console to fire a world event:
   `window.__db_conn.reducers.fireWorldEvent({ eventType: 'invasion', targetId: 'Embermarch Fringe', regionName: 'Embermarch Fringe' })`
5. Verify the event appears in the "Active Events" section with type, region name, and objective progress (0/50)
6. Click "Join" button on the event — verify it changes to "Joined" badge
7. Enter combat and kill some enemies — verify the stat tracker increments and event contribution increments
8. Verify the EventWorld log shows "A world event has begun" message
9. If objective reaches target, verify event auto-resolves and appears in "Resolved Events" section with dimmed styling
10. If the event had a ripple type (invasion -> defense), verify a defense event spawns in a neighboring region
  </verify>
  <done>
World Events System human-verified: panel displays active/resolved events, join works, contribution tracks, objectives progress, auto-resolve fires, ripple cascade creates neighbor events, stat trackers increment correctly.
  </done>
</task>

</tasks>

<verification>
1. WorldEventPanel.vue exists with active events, resolved events, and stat tracker sections
2. useGameData.ts exports subscriptions for all 4 new tables
3. App.vue has action bar button and panel rendering for WorldEventPanel
4. Client TypeScript compiles without errors
5. Human verifies: events display, join works, contribution tracks, resolution awards, ripple cascades
</verification>

<success_criteria>
Players can see active world events in a dedicated panel, join them, track objective progress, see their participation status, view resolved events, and monitor server-wide stat tracker progress. Events auto-fire from stat thresholds, ripple to neighboring regions, and award renown + faction standing to participants on resolution. Human verified functional.
</success_criteria>

<output>
After completion, create `.planning/phases/18-world-events-system-expansion-regional-event-spawning-ripple-system-event-types-and-objectives-faction-and-overall-renown-rewards-event-participation-tracking/18-03-SUMMARY.md`
</output>
