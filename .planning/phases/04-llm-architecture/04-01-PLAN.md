---
phase: 04-llm-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/index.ts
  - spacetimedb/src/data/llm_content.ts
  - spacetimedb/src/reducers/llm.ts
  - spacetimedb/src/reducers/index.ts
autonomous: true

must_haves:
  truths:
    - "LlmConfig table exists as private (no public: true) with singletonKey, apiKey, defaultModel, circuitState, failureCount, lastFailureAtMicros fields"
    - "GeneratedQuestText table exists as public with id, questTemplateId, status, text, generatedAt, model fields"
    - "GeneratedEventText table exists as public with id, eventId, status, text, generatedAt, model fields"
    - "LlmCircuit scheduled table exists targeting reset_llm_circuit reducer"
    - "Admin can set API key via set_llm_config reducer with secret validation"
    - "reset_llm_circuit reducer resets circuit state to closed and failureCount to 0"
    - "request_content reducer inserts a 'pending' row into the appropriate content table (idempotent)"
    - "SHADESLINGER_SYSTEM_PROMPT constant contains 1200+ tokens of tone instructions and 5 examples"
    - "FALLBACK_CONTENT constant has 3+ fallbacks per content type in Shadeslinger tone"
    - "Prompt builder and sanitization functions are exported"
  artifacts:
    - path: "spacetimedb/src/index.ts"
      provides: "LlmConfig, GeneratedQuestText, GeneratedEventText, LlmCircuit table definitions + schema export + reducerDeps"
      contains: "LlmConfig"
    - path: "spacetimedb/src/data/llm_content.ts"
      provides: "SHADESLINGER_SYSTEM_PROMPT, FALLBACK_CONTENT, buildAnthropicRequest, buildUserPrompt, sanitizeForPrompt"
      exports: ["SHADESLINGER_SYSTEM_PROMPT", "FALLBACK_CONTENT", "buildAnthropicRequest", "buildUserPrompt", "sanitizeForPrompt"]
    - path: "spacetimedb/src/reducers/llm.ts"
      provides: "set_llm_config reducer, reset_llm_circuit scheduled reducer, request_content reducer"
      exports: ["registerLlmReducers"]
    - path: "spacetimedb/src/reducers/index.ts"
      provides: "Updated to import and call registerLlmReducers"
      contains: "registerLlmReducers"
  key_links:
    - from: "spacetimedb/src/reducers/llm.ts"
      to: "spacetimedb/src/index.ts"
      via: "deps object (spacetimedb, LlmConfig, LlmCircuit, GeneratedQuestText, GeneratedEventText, etc.)"
      pattern: "deps\\.spacetimedb\\.reducer"
    - from: "spacetimedb/src/index.ts"
      to: "spacetimedb/src/reducers/llm.ts"
      via: "reducerDeps includes LlmConfig, GeneratedQuestText, GeneratedEventText, LlmCircuit"
      pattern: "LlmConfig"
    - from: "spacetimedb/src/reducers/index.ts"
      to: "spacetimedb/src/reducers/llm.ts"
      via: "import registerLlmReducers"
      pattern: "registerLlmReducers"
---

<objective>
Define all LLM backend tables, data constants (system prompt, fallbacks, prompt builders), admin reducer, circuit reset reducer, and request_content reducer that inserts 'pending' rows.

Purpose: Establish the complete backend foundation that the generate_content procedure (Plan 02) will consume. Tables store config and generated text. Data constants provide prompt engineering and fallback content. Reducers handle admin config, circuit reset, and pending row insertion.

Output: 4 new tables in schema, 1 data file with prompt/fallback constants, 1 reducer file with admin + circuit reset + request_content reducers.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-llm-architecture/04-RESEARCH.md
@spacetimedb/src/index.ts
@spacetimedb/src/reducers/index.ts
@spacetimedb/src/reducers/hunger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LLM tables to index.ts and wire into schema + reducerDeps</name>
  <files>spacetimedb/src/index.ts</files>
  <action>
Add 4 new table definitions to `spacetimedb/src/index.ts`, placed after the FactionStanding table definition (before the `export const spacetimedb = schema(...)` line):

1. **LlmConfig** (PRIVATE -- no `public: true`):
```typescript
const LlmConfig = table(
  { name: 'llm_config' },
  {
    singletonKey: t.u64().primaryKey(),  // always 0n
    apiKey: t.string(),
    defaultModel: t.string(),
    circuitState: t.string(),         // 'closed' | 'open'
    failureCount: t.u32(),
    lastFailureAtMicros: t.u64(),
  }
);
```

2. **GeneratedQuestText** (PUBLIC):
```typescript
const GeneratedQuestText = table(
  {
    name: 'generated_quest_text',
    public: true,
    indexes: [{ name: 'by_quest_template', algorithm: 'btree', columns: ['questTemplateId'] }],
  },
  {
    id: t.u64().primaryKey().autoInc(),
    questTemplateId: t.u64(),
    status: t.string(),        // 'pending' | 'ready' | 'failed'
    text: t.string(),
    generatedAt: t.timestamp().optional(),
    model: t.string(),
  }
);
```

3. **GeneratedEventText** (PUBLIC):
```typescript
const GeneratedEventText = table(
  {
    name: 'generated_event_text',
    public: true,
    indexes: [{ name: 'by_event', algorithm: 'btree', columns: ['eventId'] }],
  },
  {
    id: t.u64().primaryKey().autoInc(),
    eventId: t.u64(),
    status: t.string(),        // 'pending' | 'ready' | 'failed'
    text: t.string(),
    generatedAt: t.timestamp().optional(),
    model: t.string(),
  }
);
```

4. **LlmCircuit** (SCHEDULED):
```typescript
const LlmCircuit = table(
  { name: 'llm_circuit', scheduled: 'reset_llm_circuit' },
  { scheduledId: t.u64().primaryKey().autoInc(), scheduledAt: t.scheduleAt() }
);
```

Then:
- Add all 4 tables to the `schema()` call (after FactionStanding): `LlmConfig, GeneratedQuestText, GeneratedEventText, LlmCircuit`
- Add to `reducerDeps` object (before the closing `};`): `LlmConfig, GeneratedQuestText, GeneratedEventText, LlmCircuit`

Do NOT add `public: true` to LlmConfig -- the API key must never reach clients.
  </action>
  <verify>Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to confirm no type errors. Grep for `LlmConfig` in index.ts to confirm all 4 tables are in schema() and reducerDeps.</verify>
  <done>4 new tables defined in index.ts, all registered in schema export, all available in reducerDeps for reducers/procedures to consume.</done>
</task>

<task type="auto">
  <name>Task 2: Create LLM data constants, reducer file with request_content, and wire into reducers/index.ts</name>
  <files>spacetimedb/src/data/llm_content.ts, spacetimedb/src/reducers/llm.ts, spacetimedb/src/reducers/index.ts</files>
  <action>
**File 1: `spacetimedb/src/data/llm_content.ts`** (NEW)

Create this file with the following exports:

1. **`ADMIN_SECRET`** constant:
```typescript
// TODO: Change before production deployment
export const ADMIN_SECRET = 'changeme-shadeslinger-admin';
```

2. **`SHADESLINGER_SYSTEM_PROMPT`** -- a long string (must be >1200 tokens to enable Anthropic prompt caching on haiku). Content should include:
   - Role: "You are the narrator of Shadeslinger, a dark fantasy RPG. Your voice is dry, sarcastic, deeply witty, and tinged with gallows humor. You love the world you narrate even as you mock its absurdities."
   - Tone rules: Never sterile game-copy. Never earnest without irony. Brief and punchy -- 2-4 sentences max for quest descriptions, 1-2 for event consequences. Dark humor welcome, cruelty is not.
   - Output format: Always respond with valid JSON matching the requested schema. No markdown, no code fences, just raw JSON.
   - 5 example outputs (quest_description and event_consequence types) in Shadeslinger tone, each as a JSON example. Examples should demonstrate: dry wit, world-weary narrator voice, dark humor, brevity. E.g.:
     - Quest: `{"title":"The Lost Shipment","description":"The Iron Compact's latest caravan has gone missing, which is corporate-speak for 'bandits happened.' Find the wreckage, salvage what you can, and try not to join the cargo manifest."}`
     - Quest: `{"title":"Fungal Bloom","description":"Something in the Verdant Circle's territory is growing faster than it should and thinking slower than it ought to. Put it down before it starts a HOA."}`
     - Event: `{"consequence":"The ground shuddered. The dead rose. The living ran. Same old Tuesday in the Ashen Wastes."}`
     - Event: `{"consequence":"The Hollowed emerged from beneath the Scar, blinking at a sun they hadn't seen in centuries. The world didn't welcome them. The world rarely welcomes anything."}`
     - Quest: `{"title":"A Test of Mettle","description":"The Free Blades want to see if you can fight. This is not a metaphor. Show up, hit things, try to remain upright. Bonus points for style."}`
   - Pad the prompt with additional tone guidance paragraphs to ensure >1200 tokens total. Include: description of the world's aesthetic (post-apocalyptic fantasy, factions struggling over ruins of something grander), guidance on character naming conventions (gritty, short, memorable), vocabulary preferences (favor "wreckage" over "ruins", "crawled" over "walked", "survived" over "lived").

3. **`FALLBACK_CONTENT`** -- an object with arrays of pre-written fallback strings per content type:
```typescript
export const FALLBACK_CONTENT: Record<string, string[]> = {
  quest_description: [
    '{"title":"An Errand","description":"Someone needs something done. The details are vague, the pay is worse, and the odds of survival are -- well, let\\'s not talk about that."}',
    '{"title":"Unfinished Business","description":"There\\'s a mess that needs cleaning. Not the mop-and-bucket kind. The sword-and-regret kind."}',
    '{"title":"A Simple Task","description":"Nothing in this world is simple. But the quest giver insists, and you\\'re not in a position to argue with someone who has coin."}',
  ],
  event_consequence: [
    '{"consequence":"Something changed. The world shrugged, adjusted, and kept spinning -- as it always does."}',
    '{"consequence":"The dust settled. The survivors took stock. The dead had no opinion on the matter."}',
    '{"consequence":"A shift in the balance. The factions will squabble over what it means. The rest of us will deal with the fallout."}',
  ],
};
```

4. **`sanitizeForPrompt`** function:
```typescript
export function sanitizeForPrompt(input: string, maxLength: number = 100): string {
  return input.replace(/[\x00-\x1f\x7f]/g, ' ').replace(/\s+/g, ' ').trim().slice(0, maxLength);
}
```

5. **`buildUserPrompt`** function -- takes contentType and contextJson, returns the user message string. Use XML delimiters for user-provided data:
```typescript
export function buildUserPrompt(contentType: string, contextJson: string): string {
  return `Generate a ${contentType} in JSON format.\n\n<context>${contextJson}</context>`;
}
```

6. **`buildAnthropicRequest`** function -- builds the full Anthropic API request body:
```typescript
export function buildAnthropicRequest(contentType: string, contextJson: string, model: string): object {
  return {
    model: model || 'claude-haiku-4-5-20251001',
    max_tokens: 512,
    system: [{ type: 'text', text: SHADESLINGER_SYSTEM_PROMPT, cache_control: { type: 'ephemeral' } }],
    messages: [{ role: 'user', content: buildUserPrompt(contentType, contextJson) }],
  };
}
```

**File 2: `spacetimedb/src/reducers/llm.ts`** (NEW)

Create with `registerLlmReducers` export following the existing deps pattern (see `hunger.ts` for reference):

```typescript
export const registerLlmReducers = (deps: any) => {
  const { spacetimedb, t, SenderError, LlmConfig, LlmCircuit, GeneratedQuestText, GeneratedEventText } = deps;
```

Define 3 reducers:

1. **`set_llm_config`** reducer:
   - Args: `{ adminSecret: t.string(), apiKey: t.string(), defaultModel: t.string() }`
   - Import `ADMIN_SECRET` from `../data/llm_content`
   - Validate `adminSecret === ADMIN_SECRET`, throw SenderError if not
   - Check if LlmConfig row exists via `[...ctx.db.llmConfig.iter()][0]`
   - If exists: update with new apiKey and defaultModel (keep circuitState, failureCount, lastFailureAtMicros unchanged)
   - If not exists: insert with `{ singletonKey: 0n, apiKey, defaultModel: defaultModel || 'claude-haiku-4-5-20251001', circuitState: 'closed', failureCount: 0, lastFailureAtMicros: 0n }`

2. **`reset_llm_circuit`** reducer (scheduled -- receives LlmCircuit row):
   - Args: `{ arg: LlmCircuit.rowType }`
   - Find the LlmConfig singleton: `[...ctx.db.llmConfig.iter()][0]`
   - If exists and circuitState is 'open': update to `{ ...config, circuitState: 'closed', failureCount: 0, lastFailureAtMicros: 0n }`
   - (Row auto-deletes after scheduled reducer completes)

3. **`request_content`** reducer:
   - Args: `{ contentType: t.string(), contentId: t.u64() }`
   - This reducer inserts a 'pending' row into the appropriate content table, if one does not already exist for that contentId. It is idempotent.
   - Logic:
     ```typescript
     if (contentType === 'quest_description') {
       const existing = [...ctx.db.generatedQuestText.by_quest_template.filter(contentId)][0];
       if (!existing) {
         ctx.db.generatedQuestText.insert({
           id: 0n,
           questTemplateId: contentId,
           status: 'pending',
           text: '',
           generatedAt: null,
           model: '',
         });
       }
     } else if (contentType === 'event_consequence') {
       const existing = [...ctx.db.generatedEventText.by_event.filter(contentId)][0];
       if (!existing) {
         ctx.db.generatedEventText.insert({
           id: 0n,
           eventId: contentId,
           status: 'pending',
           text: '',
           generatedAt: null,
           model: '',
         });
       }
     } else {
       throw new SenderError(`Unknown content type: ${contentType}`);
     }
     ```
   - Purpose: Ensures a 'pending' row exists before the client calls the generate_content procedure, making the "pending -> ready/failed" lifecycle observable. Phase 5 (Quests) and Phase 6 (World Events) will call this reducer first, then call the procedure.

Close the function with `};`.

**File 3: Update `spacetimedb/src/reducers/index.ts`**

Add import: `import { registerLlmReducers } from './llm';`
Add call: `registerLlmReducers(deps);` at the end of `registerReducers`.
  </action>
  <verify>Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to confirm no type errors. Verify SHADESLINGER_SYSTEM_PROMPT length by counting words (should be 300+ words / 1200+ tokens). Verify FALLBACK_CONTENT has at least 3 entries per type. Grep for `registerLlmReducers` in reducers/index.ts. Grep for `request_content` in reducers/llm.ts to confirm the reducer exists.</verify>
  <done>llm_content.ts exports ADMIN_SECRET, SHADESLINGER_SYSTEM_PROMPT (>1200 tokens), FALLBACK_CONTENT (3+ per type), sanitizeForPrompt, buildUserPrompt, buildAnthropicRequest. llm.ts exports registerLlmReducers with set_llm_config, reset_llm_circuit, and request_content reducers. reducers/index.ts wires registerLlmReducers.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project spacetimedb/tsconfig.json` passes with no errors
- 4 new tables visible in schema() export
- reducerDeps contains LlmConfig, GeneratedQuestText, GeneratedEventText, LlmCircuit
- SHADESLINGER_SYSTEM_PROMPT is >300 words
- FALLBACK_CONTENT has quest_description (3 entries) and event_consequence (3 entries)
- set_llm_config, reset_llm_circuit, and request_content reducers defined
- registerLlmReducers called from reducers/index.ts
- request_content inserts 'pending' row idempotently
</verification>

<success_criteria>
All LLM backend tables exist in schema. Admin can configure API key via reducer. Circuit breaker reset reducer is wired to LlmCircuit scheduled table. request_content reducer creates 'pending' rows for the observable lifecycle. Prompt constants and builder functions are exported and ready for procedure consumption in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/04-llm-architecture/04-01-SUMMARY.md`
</output>
