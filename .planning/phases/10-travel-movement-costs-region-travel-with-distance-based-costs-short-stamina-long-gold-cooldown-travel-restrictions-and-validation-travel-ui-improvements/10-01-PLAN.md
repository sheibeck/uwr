---
phase: 10-travel-movement-costs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/data/travel_config.ts
  - spacetimedb/src/reducers/movement.ts
autonomous: true

must_haves:
  truths:
    - "Within-region travel deducts 5 stamina from every group member"
    - "Cross-region travel deducts 10 stamina from every group member"
    - "Cross-region travel applies a 5-minute cooldown per character"
    - "If any group member lacks sufficient stamina, the entire group move fails with a named error"
    - "Travel cooldown blocks cross-region travel only, not within-region travel"
    - "Expired cooldowns are cleaned up opportunistically"
  artifacts:
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "TravelCooldown table definition"
      contains: "TravelCooldown"
    - path: "spacetimedb/src/data/travel_config.ts"
      provides: "Travel cost constants"
      contains: "TRAVEL_CONFIG"
    - path: "spacetimedb/src/reducers/movement.ts"
      provides: "Updated move_character reducer with stamina costs and cooldown"
      contains: "TRAVEL_CONFIG"
  key_links:
    - from: "spacetimedb/src/reducers/movement.ts"
      to: "spacetimedb/src/data/travel_config.ts"
      via: "import TRAVEL_CONFIG"
      pattern: "import.*TRAVEL_CONFIG.*travel_config"
    - from: "spacetimedb/src/reducers/movement.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "TravelCooldown table access via ctx.db"
      pattern: "ctx\\.db\\.travelCooldown"
    - from: "spacetimedb/src/schema/tables.ts"
      to: "schema export"
      via: "TravelCooldown included in schema()"
      pattern: "TravelCooldown"
---

<objective>
Add travel cost system backend: TravelCooldown table, travel config constants, and updated move_character reducer implementing within-region (5 stamina) and cross-region (10 stamina + 5min cooldown) costs with all-or-nothing group validation.

Purpose: Enforce resource costs for movement, making travel a strategic decision rather than free teleportation. Cross-region travel has higher stakes with cooldown timer.
Output: Updated move_character reducer with full cost/cooldown logic, TravelCooldown table, TRAVEL_CONFIG constants.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-CONTEXT.md

@spacetimedb/src/schema/tables.ts
@spacetimedb/src/reducers/movement.ts
@spacetimedb/src/helpers/location.ts
@spacetimedb/src/reducers/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TravelCooldown table and TRAVEL_CONFIG constants</name>
  <files>
    spacetimedb/src/schema/tables.ts
    spacetimedb/src/data/travel_config.ts
  </files>
  <action>
1. Create `spacetimedb/src/data/travel_config.ts` with travel cost constants:
   ```typescript
   export const TRAVEL_CONFIG = {
     WITHIN_REGION_STAMINA: 5n,     // Stamina cost per character for same-region travel
     CROSS_REGION_STAMINA: 10n,     // Stamina cost per character for cross-region travel
     CROSS_REGION_COOLDOWN_MICROS: 5n * 60n * 1_000_000n, // 5 minutes in microseconds
   };
   ```
   Per user decision: NO gold costs, NO BFS distance calculation, NO per-step scaling. Costs are flat per-character.

2. Add TravelCooldown table to `spacetimedb/src/schema/tables.ts`:
   ```typescript
   export const TravelCooldown = table(
     {
       name: 'travel_cooldown',
       public: true,
       indexes: [{ name: 'by_character', algorithm: 'btree', columns: ['characterId'] }],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       characterId: t.u64(),
       readyAtMicros: t.u64(),
     }
   );
   ```
   Follow the existing ItemCooldown/AbilityCooldown pattern. Public table so client can read cooldown state for UI countdown display. Use `by_character` btree index matching existing cooldown table conventions.

3. Add TravelCooldown to the `schema()` call at the bottom of tables.ts. Place it after UiPanelLayout in the schema registration list.

IMPORTANT: Do NOT add gold cost fields, distance fields, or any other fields not specified above. Per user decision, the cost model is simple: flat stamina + optional cooldown.
  </action>
  <verify>
Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to verify no TypeScript errors. Confirm TravelCooldown is in the schema() export and travel_config.ts exports TRAVEL_CONFIG.
  </verify>
  <done>
TravelCooldown table defined in schema with by_character index and registered in schema(). TRAVEL_CONFIG exported with WITHIN_REGION_STAMINA (5n), CROSS_REGION_STAMINA (10n), CROSS_REGION_COOLDOWN_MICROS (5 minutes). No gold costs, no BFS, no distance scaling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update move_character reducer with stamina costs, cooldown validation, and group-wide stamina check</name>
  <files>
    spacetimedb/src/reducers/movement.ts
  </files>
  <action>
Modify the existing `move_character` reducer in `spacetimedb/src/reducers/movement.ts`. The reducer already handles solo vs group travel with `moveOne()` pattern. Extend it with cost validation and deduction.

**Key changes to move_character reducer:**

1. **Import TRAVEL_CONFIG** from `../data/travel_config` at the top of registerMovementReducers (add to deps or import directly).

2. **Determine region crossing:** After the existing validations (combat check, gather check, connection check), determine if travel crosses regions:
   ```typescript
   const fromLocation = ctx.db.location.id.find(character.locationId);
   const toLocation = ctx.db.location.id.find(args.locationId);
   // fromLocation already validated to exist (character is there)
   // toLocation already validated as `location` variable
   const isCrossRegion = fromLocation!.regionId !== toLocation!.regionId;
   const staminaCost = isCrossRegion ? TRAVEL_CONFIG.CROSS_REGION_STAMINA : TRAVEL_CONFIG.WITHIN_REGION_STAMINA;
   ```

3. **Collect all traveling characters** (before the existing moveOne logic):
   - Solo: just `[character]`
   - Group leader: leader + all following members at same location (same logic as existing group travel)
   - Build array of characters who will move

4. **Validate ALL-OR-NOTHING stamina** (per user decision):
   ```typescript
   for (const traveler of travelingCharacters) {
     if (traveler.stamina < staminaCost) {
       // Show error to the INITIATOR (the leader/solo player)
       return fail(ctx, character, `${traveler.name} does not have enough stamina to travel`);
     }
   }
   ```
   The error message format MUST be `"[CharacterName] does not have enough stamina to travel"` per locked decision. Use `fail()` which calls `appendSystemMessage` to show the message.

5. **Check cross-region cooldown** (only for cross-region travel):
   ```typescript
   if (isCrossRegion) {
     for (const traveler of travelingCharacters) {
       const cooldowns = [...ctx.db.travelCooldown.by_character.filter(traveler.id)];
       const activeCooldown = cooldowns.find(cd => cd.readyAtMicros > ctx.timestamp.microsSinceUnixEpoch);
       if (activeCooldown) {
         const remainingSec = Number((activeCooldown.readyAtMicros - ctx.timestamp.microsSinceUnixEpoch) / 1_000_000n);
         return fail(ctx, character, `${traveler.name} cannot travel to another region yet (${remainingSec}s remaining)`);
       }
       // Clean up expired cooldowns opportunistically
       for (const cd of cooldowns) {
         if (cd.readyAtMicros <= ctx.timestamp.microsSinceUnixEpoch) {
           ctx.db.travelCooldown.id.delete(cd.id);
         }
       }
     }
   }
   ```

6. **Deduct stamina and apply cooldowns** (validate-then-mutate pattern):
   After ALL validations pass, for each traveling character:
   ```typescript
   for (const traveler of travelingCharacters) {
     ctx.db.character.id.update({ ...traveler, stamina: traveler.stamina - staminaCost });
     if (isCrossRegion) {
       const existingCd = [...ctx.db.travelCooldown.by_character.filter(traveler.id)][0];
       const readyAt = ctx.timestamp.microsSinceUnixEpoch + TRAVEL_CONFIG.CROSS_REGION_COOLDOWN_MICROS;
       if (existingCd) {
         ctx.db.travelCooldown.id.update({ ...existingCd, readyAtMicros: readyAt });
       } else {
         ctx.db.travelCooldown.insert({ id: 0n, characterId: traveler.id, readyAtMicros: readyAt });
       }
     }
   }
   ```

7. **Then execute existing moveOne logic** for each traveling character (location update, events, spawns). The existing `moveOne()` function handles location update, departure/arrival events, and spawn ensuring. Keep it, but refactor so it only handles the location change and events -- stamina deduction is done in step 6 above. NOTE: moveOne currently updates the character row via `ctx.db.character.id.update({ ...row, locationId: location.id })`. Since we already updated the character row for stamina, we need to re-read the character to get the updated stamina value before the moveOne location update, OR do the stamina deduction AFTER moveOne. Simplest approach: Do stamina deduction and cooldown BEFORE moveOne calls, then in moveOne, re-read the character to get the latest row:
   ```typescript
   const moveOne = (charId: bigint) => {
     const row = ctx.db.character.id.find(charId)!;
     ctx.db.character.id.update({ ...row, locationId: location.id });
     // ... rest of events
   };
   ```

**Restructure the group travel flow:**

Replace the current solo vs group branching at the bottom of the reducer. The new flow:
1. Build `travelingCharacters` array
2. Validate all stamina
3. Validate all cooldowns (if cross-region)
4. Deduct all stamina + apply all cooldowns
5. Execute moveOne for each character (re-reading fresh row for location update)

IMPORTANT per user decision:
- Every character in the group pays stamina (no "leader pays, followers free")
- NO gold costs anywhere
- Cooldown is per-character, NOT group-wide
- Within-region travel has NO cooldown
  </action>
  <verify>
Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to verify no TypeScript errors. Read the modified file and verify:
1. TRAVEL_CONFIG is imported and used
2. Region crossing detection uses `fromLocation.regionId !== toLocation.regionId`
3. All-or-nothing stamina check iterates all traveling characters
4. Error message format matches "[CharacterName] does not have enough stamina to travel"
5. Cross-region cooldown check only runs for cross-region travel
6. Stamina deduction happens for ALL characters in the group
7. Cooldown applied per-character for cross-region travel
8. No gold costs exist anywhere in the reducer
  </verify>
  <done>
move_character reducer validates and deducts stamina from all group members (5 within-region, 10 cross-region), applies 5-minute per-character cooldown for cross-region travel, fails with "[CharacterName] does not have enough stamina to travel" if any member lacks stamina, and properly gates cross-region travel on cooldown status. No gold costs, no BFS, no distance scaling.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes with no errors
2. TravelCooldown table exists in schema with by_character index
3. TRAVEL_CONFIG constants match spec (5n, 10n, 5min cooldown)
4. move_character reducer has all-or-nothing stamina validation
5. Cross-region detection compares regionId values
6. Cooldown only applies to cross-region travel
7. No gold costs, no BFS, no distance calculations
</verification>

<success_criteria>
- TravelCooldown table defined and registered in schema
- TRAVEL_CONFIG exported with correct values
- move_character reducer enforces flat stamina costs (5 within-region, 10 cross-region)
- All group members must have enough stamina or move fails entirely
- Cross-region travel applies per-character 5-minute cooldown
- Within-region travel has no cooldown
- Error messages use "[CharacterName] does not have enough stamina to travel" format
- Code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-01-SUMMARY.md`
</output>
