---
phase: 10-travel-movement-costs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/helpers/location.ts
  - spacetimedb/src/data/travel_config.ts
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/index.ts
  - spacetimedb/src/reducers/movement.ts
autonomous: true

must_haves:
  truths:
    - "Short-distance travel (1-2 steps) deducts stamina from the character"
    - "Long-distance travel (3+ steps) deducts gold and applies a cooldown"
    - "Travel is blocked when character is on cooldown"
    - "Travel is blocked when character has insufficient stamina or gold"
    - "Group leader travel applies costs only to the leader, not followers"
  artifacts:
    - path: "spacetimedb/src/helpers/location.ts"
      provides: "BFS calculateDistance function for shortest path between locations"
      contains: "calculateDistance"
    - path: "spacetimedb/src/data/travel_config.ts"
      provides: "Travel cost constants (thresholds, stamina cost, gold cost, cooldown duration)"
      exports: ["TRAVEL_CONFIG"]
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "TravelCooldown table definition"
      contains: "TravelCooldown"
    - path: "spacetimedb/src/reducers/movement.ts"
      provides: "move_character reducer with distance-based cost validation and deduction"
      contains: "calculateDistance"
  key_links:
    - from: "spacetimedb/src/reducers/movement.ts"
      to: "spacetimedb/src/helpers/location.ts"
      via: "import calculateDistance"
      pattern: "calculateDistance"
    - from: "spacetimedb/src/reducers/movement.ts"
      to: "spacetimedb/src/data/travel_config.ts"
      via: "import TRAVEL_CONFIG"
      pattern: "TRAVEL_CONFIG"
    - from: "spacetimedb/src/reducers/movement.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "ctx.db.travelCooldown"
      pattern: "travelCooldown"
---

<objective>
Implement server-side distance-based travel costs with BFS pathfinding, dual-resource cost system (stamina for short, gold+cooldown for long), and travel cooldown tracking.

Purpose: Characters pay meaningful resource costs to travel, making short exploration cheap (stamina) and long-distance jumps strategic decisions (gold + cooldown). Per user decision: distance 1-2 = stamina only, distance 3+ = gold + cooldown.

Output: Working backend travel cost system with BFS distance calculation, TravelCooldown table, and updated move_character reducer.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@spacetimedb/src/reducers/movement.ts
@spacetimedb/src/helpers/location.ts
@spacetimedb/src/schema/tables.ts
@spacetimedb/src/data/travel_config.ts
@spacetimedb/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BFS distance helper, travel config constants, and TravelCooldown table</name>
  <files>
    spacetimedb/src/helpers/location.ts
    spacetimedb/src/data/travel_config.ts
    spacetimedb/src/schema/tables.ts
    spacetimedb/src/index.ts
  </files>
  <action>
1. Create `spacetimedb/src/data/travel_config.ts` with exported TRAVEL_CONFIG constant:
   ```typescript
   export const TRAVEL_CONFIG = {
     SHORT_DISTANCE_MAX: 2,          // 1-2 steps = short (stamina only)
     STAMINA_COST_PER_STEP: 5n,      // stamina per step for short travel
     LONG_DISTANCE_GOLD_BASE: 10n,   // gold cost for long travel (3+ steps)
     LONG_DISTANCE_GOLD_PER_STEP: 5n,// additional gold per step beyond SHORT_DISTANCE_MAX
     COOLDOWN_MICROS: 30_000_000n,   // 30-second cooldown for long travel
   };
   ```
   Per user decision: short = <=2 steps (stamina only), long = >=3 steps (gold + cooldown).

2. Add `calculateDistance` function to `spacetimedb/src/helpers/location.ts`:
   - Takes `ctx`, `fromLocationId: bigint`, `toLocationId: bigint`
   - Returns `number | null` (null = unreachable)
   - Uses BFS on the location connection graph via `ctx.db.locationConnection.by_from.filter()`
   - CRITICAL: Use `visited` Set with `.toString()` for BigInt keys (BigInt reference equality won't work in Set)
   - Mark nodes visited when enqueued, not when dequeued (prevents parent revisit)
   - Handle same-location case (return 0)
   - Place this function near `areLocationsConnected` for logical grouping

3. Add `TravelCooldown` table to `spacetimedb/src/schema/tables.ts`:
   ```typescript
   export const TravelCooldown = table(
     {
       name: 'travel_cooldown',
       public: true,
       indexes: [{ name: 'by_character', algorithm: 'btree', columns: ['characterId'] }],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       characterId: t.u64(),
       readyAtMicros: t.u64(),
     }
   );
   ```
   Follow the existing AbilityCooldown pattern exactly. Public table for client-side filtering (per project convention from quick-46).

4. Register TravelCooldown in the schema export in `spacetimedb/src/index.ts`:
   - Import TravelCooldown from schema/tables.ts
   - Add to the `schema()` call at the bottom of index.ts
   - Also add TravelCooldown to the deps object passed to registerMovementReducers so the reducer can reference it
  </action>
  <verify>
    - `spacetimedb/src/data/travel_config.ts` exists with TRAVEL_CONFIG exported
    - `spacetimedb/src/helpers/location.ts` contains `calculateDistance` function
    - `spacetimedb/src/schema/tables.ts` contains TravelCooldown table definition
    - TravelCooldown appears in schema() call in index.ts
    - No TypeScript compilation errors in the new/modified files
  </verify>
  <done>
    BFS distance calculation function exists and handles edge cases (same location, unreachable, BigInt keys). TravelCooldown table defined with by_character index. TRAVEL_CONFIG constants defined with user-decided thresholds (<=2 short, >=3 long).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate distance-based costs into move_character reducer</name>
  <files>
    spacetimedb/src/reducers/movement.ts
  </files>
  <action>
Modify the `move_character` reducer in `spacetimedb/src/reducers/movement.ts` to calculate distance and apply costs:

1. Import `calculateDistance` from helpers/location.ts and `TRAVEL_CONFIG` from data/travel_config.ts into the deps destructuring or directly.

2. After the existing validation checks (not in combat, not gathering, locations connected), add distance-based cost logic:

   a. Calculate distance: `const distance = calculateDistance(ctx, character.locationId, args.locationId)`
      - If distance is null, fail with 'Location not reachable'
      - If distance is 0, return early (already there - existing check handles this)

   b. Determine cost type based on TRAVEL_CONFIG.SHORT_DISTANCE_MAX:
      - If distance <= SHORT_DISTANCE_MAX (short travel):
        - Calculate stamina cost: `BigInt(distance) * TRAVEL_CONFIG.STAMINA_COST_PER_STEP`
        - Validate: `if (character.stamina < staminaCost) return fail(ctx, character, 'Not enough stamina to travel (need ' + staminaCost + ')')`
      - If distance > SHORT_DISTANCE_MAX (long travel):
        - Calculate gold cost: `TRAVEL_CONFIG.LONG_DISTANCE_GOLD_BASE + BigInt(distance - TRAVEL_CONFIG.SHORT_DISTANCE_MAX) * TRAVEL_CONFIG.LONG_DISTANCE_GOLD_PER_STEP`
        - Check cooldown: query `ctx.db.travelCooldown.by_character.filter(character.id)`, find first row, check if `readyAtMicros > ctx.timestamp.microsSinceUnixEpoch`
        - If on cooldown, fail with remaining seconds message
        - Validate gold: `if (character.gold < goldCost) return fail(ctx, character, 'Not enough gold to travel (need ' + goldCost + ')')`

   c. VALIDATE-THEN-MUTATE: All checks above must pass BEFORE any mutations.

   d. Apply costs in the `moveOne` function or just before it:
      - For short travel: deduct stamina from character before moveOne
      - For long travel: deduct gold from character before moveOne, and upsert cooldown:
        - If existing cooldown row: update readyAtMicros
        - If no cooldown row: insert new TravelCooldown row

   e. IMPORTANT: Only the leader pays costs for group travel. Followers move free. The existing logic already handles leader check (`isGroupLeaderOrSolo`). Apply cost deduction to the `character` (leader) once, before the group loop. Do NOT deduct costs per follower.

   f. Clean up expired cooldown rows opportunistically: before the cooldown check, delete any expired cooldown rows for this character (where readyAtMicros <= now). This prevents table growth.

   g. Add travel cost feedback to the private event message. For short travel: "You travel to X. (-N stamina)". For long travel: "You travel to X. (-N gold, 30s cooldown)".

3. IMPORTANT: The `areLocationsConnected` check still runs first (direct connection check). But distance calculation uses BFS to find shortest path across the FULL graph. Currently, `move_character` only allows travel to directly connected locations. With distance-based costs, we need to allow travel to ANY reachable location, not just adjacent ones.

   CHANGE the validation flow:
   - REMOVE the `areLocationsConnected` check
   - REPLACE with: calculate distance via BFS. If null, fail with 'Location not reachable'. If distance > 0, proceed with cost calculation.
   - This allows players to travel to non-adjacent locations (the whole point of long-distance travel costing gold+cooldown).

4. Update the `moveOne` helper to include cost info in the travel message (append cost description to the private event).
  </action>
  <verify>
    - Read the modified movement.ts and verify:
      - calculateDistance is called
      - Short travel deducts stamina
      - Long travel deducts gold and creates/updates cooldown
      - Cooldown check blocks travel when active
      - Validate-then-mutate pattern followed (all checks before mutations)
      - Group leader pays costs once, followers free
      - Expired cooldowns cleaned up
      - areLocationsConnected replaced with BFS reachability
  </verify>
  <done>
    move_character reducer validates distance-based costs: stamina for 1-2 step travel, gold + cooldown for 3+ step travel. Group leader pays costs, followers travel free. Expired cooldowns cleaned up. Travel to any reachable location (not just adjacent) is now supported.
  </done>
</task>

</tasks>

<verification>
- BFS distance from Hollowmere to Ashen Road = 1 (short, stamina only)
- BFS distance from Hollowmere to Fogroot Crossing = 2 (short, stamina only)
- BFS distance from Hollowmere to Bramble Hollow = 3 (long, gold + cooldown)
- BFS distance from Hollowmere to Embermarch Gate = 3 (long, gold + cooldown)
- BFS distance from Hollowmere to Furnace Crypt = 5 (long, gold + cooldown)
- Attempting long travel on cooldown is rejected
- Attempting travel with insufficient stamina/gold is rejected
- Travel still blocked during combat and gathering
</verification>

<success_criteria>
- Distance calculation returns correct shortest path for all location pairs
- Short travel (1-2 steps) deducts stamina proportional to distance
- Long travel (3+ steps) deducts gold and applies 30-second cooldown
- Cooldown prevents repeat long-distance travel
- Group travel costs only apply to leader
- No regression in existing travel behavior (combat lock, gathering lock)
</success_criteria>

<output>
After completion, create `.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-01-SUMMARY.md`
</output>
