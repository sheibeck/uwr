---
phase: 10-travel-movement-costs
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/module_bindings/
  - src/components/TravelPanel.vue
  - src/composables/useMovement.ts
  - src/App.vue
autonomous: false

must_haves:
  truths:
    - "Player sees stamina cost on travel buttons for short-distance locations"
    - "Player sees gold cost and cooldown info on travel buttons for long-distance locations"
    - "Travel buttons are disabled when player cannot afford the cost"
    - "Travel buttons are disabled when travel cooldown is active"
    - "Cooldown countdown is visible to the player"
    - "All reachable locations appear in the travel panel, not just adjacent ones"
  artifacts:
    - path: "src/components/TravelPanel.vue"
      provides: "Travel panel with cost indicators, affordability checks, cooldown display"
      contains: "getCost"
    - path: "src/composables/useMovement.ts"
      provides: "Movement composable with travel cooldown tracking"
      contains: "travelCooldown"
    - path: "src/App.vue"
      provides: "Wiring of travel cooldown data and all reachable locations to TravelPanel"
      contains: "travelCooldown"
  key_links:
    - from: "src/components/TravelPanel.vue"
      to: "src/composables/useMovement.ts"
      via: "props from App.vue"
      pattern: "travelCooldown|cooldown"
    - from: "src/App.vue"
      to: "src/composables/useGameData.ts"
      via: "locationConnections for BFS"
      pattern: "locationConnections"
---

<objective>
Publish the updated module, regenerate client bindings, and update the travel UI to show distance-based costs, affordability indicators, cooldown countdown, and all reachable locations (not just adjacent).

Purpose: Players need to see what travel costs before committing. Short distances show stamina cost, long distances show gold cost + cooldown indicator. Disabled state communicates unaffordable/cooldown-locked travel. All reachable destinations appear in the travel list.

Output: Working travel UI with cost previews, cooldown display, and full reachable-location list.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-01-SUMMARY.md
@src/components/TravelPanel.vue
@src/composables/useMovement.ts
@src/composables/useGameData.ts
@src/App.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Publish module, regenerate bindings, and update client data wiring</name>
  <files>
    src/module_bindings/
    src/composables/useGameData.ts
    src/composables/useMovement.ts
    src/App.vue
  </files>
  <action>
1. Publish the SpacetimeDB module with `--clear-database` flag (new table requires schema change):
   ```bash
   spacetime publish uwr --clear-database -y --project-path spacetimedb
   ```

2. Regenerate client bindings:
   ```bash
   spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb
   ```

3. In `src/composables/useGameData.ts`:
   - Add subscription to `tables.travelCooldown` using `useTable(tables.travelCooldown)`
   - Export `travelCooldowns` from the composable return object

4. In `src/composables/useMovement.ts`:
   - Add `travelCooldowns` as a dependency (passed in args)
   - Add `locationConnections` as a dependency (passed in args)
   - Add `locations` as a dependency (passed in args)
   - Compute `activeTravelCooldown` for the selected character: find cooldown row where characterId matches and readyAtMicros > current time (use server clock offset pattern from useHotbar.ts if available, otherwise use Date.now() * 1000)
   - Compute `isOnTravelCooldown` boolean ref
   - Compute `travelCooldownRemainingMs` for countdown display
   - Add a `reachableLocations` computed that does BFS on the client-side location graph:
     - Uses `locationConnections` to build adjacency from selectedCharacter's current locationId
     - Returns array of `{ location: LocationRow, distance: number }` for all reachable locations (excluding current location)
     - BFS uses same algorithm as server (Set with toString() for BigInt keys)
   - Add `getTravelCost(distance: number)` function that mirrors server logic:
     - If distance <= 2: `{ type: 'stamina' as const, amount: distance * 5 }`
     - If distance >= 3: `{ type: 'gold' as const, amount: 10 + (distance - 2) * 5, cooldownSec: 30 }`
   - Add `canAffordTravel(distance: number)` function checking resources and cooldown
   - Export: `activeTravelCooldown`, `isOnTravelCooldown`, `travelCooldownRemainingMs`, `reachableLocations`, `getTravelCost`, `canAffordTravel`

5. In `src/App.vue`:
   - Import travelCooldowns from useGameData
   - Pass travelCooldowns, locationConnections, and locations into useMovement args
   - Replace `connectedLocations` computed with the `reachableLocations` from useMovement
   - Pass new props to TravelPanel: `getTravelCost`, `canAffordTravel`, `isOnTravelCooldown`, `travelCooldownRemainingMs`
   - The `reachableLocations` already includes distance info, so TravelPanel gets `{ location, distance }` entries instead of just locations
  </action>
  <verify>
    - `spacetime publish` completes without errors
    - `spacetime generate` produces updated bindings with TravelCooldown types
    - useGameData exports travelCooldowns
    - useMovement exports reachableLocations, getTravelCost, canAffordTravel, isOnTravelCooldown
    - App.vue passes travel cost data to TravelPanel
  </verify>
  <done>
    Module published with TravelCooldown table. Client bindings regenerated. useMovement provides BFS-based reachable locations with distance, cost calculation, affordability checks, and cooldown state. App.vue wires all travel data to TravelPanel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TravelPanel UI with cost indicators, cooldown display, and affordability</name>
  <files>
    src/components/TravelPanel.vue
    src/ui/styles.ts
  </files>
  <action>
1. Update TravelPanel.vue props to accept the new data:
   - `reachableLocations: { location: LocationRow, distance: number }[]` (replaces `locations: LocationRow[]`)
   - `getTravelCost: (distance: number) => { type: string, amount: number, cooldownSec?: number }`
   - `canAffordTravel: (distance: number) => boolean`
   - `isOnTravelCooldown: boolean`
   - `travelCooldownRemainingMs: number`
   - Keep existing props: `styles`, `connActive`, `selectedCharacter`, `regions`
   - Remove old `locations` prop

2. Update the `sortedLocations` computed to work with `reachableLocations`:
   - Map over `reachableLocations` (which has `{ location, distance }`)
   - Include distance in the output
   - Still compute targetLevel and conStyle as before

3. Update the travel tile template to show cost information:
   - For each location tile, compute cost via `getTravelCost(entry.distance)`
   - Show cost next to the "Go" button:
     - Short travel: show stamina icon/text, e.g. "(5 sta)" in a muted color
     - Long travel: show gold icon/text, e.g. "(15g + 30s cd)" in gold color
   - Use small font size (0.7rem) for cost text, positioned to the left of the Go button
   - Color cost text: stamina costs in a blue-ish color (#7eb8da), gold costs in amber/gold (#d4a844)

4. Update the Go button disabled state:
   - Disabled when: `!connActive || !canAffordTravel(entry.distance)` (canAffordTravel already checks cooldown, resources, and same-location)
   - Add opacity: 0.4 for disabled tiles (via inline style)

5. Add cooldown indicator at the top of the travel panel:
   - If `isOnTravelCooldown` is true, show a small banner: "Travel cooldown: Xs" with countdown
   - Use amber/warning color (#d4a844) for the cooldown text
   - Update countdown every second using a setInterval in onMounted/onUnmounted (or a reactive timer)
   - Format: show seconds remaining, rounded up

6. Sort locations by distance first (nearest first), then by targetLevel within same distance:
   - This gives players a natural near-to-far ordering
   - Show distance as a subtle label, e.g. "[2 steps]" or "[4 steps]" in muted text

7. Add distance label to each travel tile:
   - Show step count next to region name in muted text: e.g. "2 steps" in the subtitle line
   - This helps players understand WHY the cost differs

8. Optional style additions in `src/ui/styles.ts`:
   - Add `travelCostStamina` style: `{ fontSize: '0.7rem', color: '#7eb8da', marginRight: '0.3rem' }`
   - Add `travelCostGold` style: `{ fontSize: '0.7rem', color: '#d4a844', marginRight: '0.3rem' }`
   - Add `travelCooldownBanner` style: `{ fontSize: '0.75rem', color: '#d4a844', padding: '0.2rem 0.5rem', marginBottom: '0.3rem', textAlign: 'center' }`
  </action>
  <verify>
    - TravelPanel renders all reachable locations (not just adjacent)
    - Short-distance tiles show stamina cost in blue text
    - Long-distance tiles show gold + cooldown cost in amber text
    - Go button disabled when player can't afford or is on cooldown
    - Cooldown banner shows countdown when active
    - Locations sorted by distance (nearest first)
    - Step count visible on each tile
  </verify>
  <done>
    Travel panel shows all reachable locations with distance labels, cost previews (stamina for short, gold+cooldown for long), affordability-based disabled states, and a cooldown countdown banner. Players can make informed travel decisions before committing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of travel cost system</name>
  <files>
    src/components/TravelPanel.vue
  </files>
  <action>
    Human verifies the complete distance-based travel cost system works end-to-end:
    - Short travel costs stamina
    - Long travel costs gold + cooldown
    - UI shows correct costs, disabled states, and cooldown countdown
    - All reachable locations appear in the travel panel
  </action>
  <verify>
    1. Open the game and select a character at Hollowmere
    2. Open the Travel panel - verify ALL reachable locations appear (not just adjacent)
    3. Verify Ashen Road shows as 1 step with stamina cost (e.g. "5 sta")
    4. Verify Fogroot Crossing shows as 2 steps with stamina cost (e.g. "10 sta")
    5. Verify Bramble Hollow shows as 3 steps with gold + cooldown cost (e.g. "15g + 30s cd")
    6. Travel to Ashen Road (1 step) - verify stamina deducted, no cooldown applied
    7. Travel to Bramble Hollow from Ashen Road (2 steps) - verify stamina cost
    8. Travel to Furnace Crypt from Bramble Hollow (long distance) - verify gold deducted and cooldown appears
    9. While cooldown is active, verify long-distance travel buttons are disabled
    10. Verify short-distance travel still works during cooldown
    11. Wait for cooldown to expire (30s) and verify long-distance travel re-enables
    12. Verify travel is still blocked during combat
    13. Check log messages show cost information (e.g. "You travel to X. (-5 stamina)")
  </verify>
  <done>
    Human confirms travel cost system works correctly: short travel deducts stamina, long travel deducts gold and applies cooldown, UI shows costs and countdown accurately, all reachable locations visible.
  </done>
</task>

</tasks>

<verification>
- All reachable locations visible in travel panel with distance labels
- Short travel (1-2 steps): stamina cost shown and deducted
- Long travel (3+ steps): gold cost shown and deducted, cooldown applied
- Cooldown prevents long-distance travel but not short-distance
- Cooldown countdown visible in UI
- Go button disabled when cannot afford
- Travel still blocked during combat and gathering
- Group leader pays costs, followers travel free
- Log messages include cost information
</verification>

<success_criteria>
- Travel panel shows all reachable locations with distance and cost indicators
- Short travel deducts stamina proportional to distance
- Long travel deducts gold and applies 30-second cooldown with visible countdown
- Disabled states correctly reflect affordability and cooldown
- Human verifies end-to-end travel flow works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-02-SUMMARY.md`
</output>
