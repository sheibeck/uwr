---
phase: 10-travel-movement-costs
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/components/TravelPanel.vue
  - src/composables/useMovement.ts
  - src/App.vue
autonomous: false

must_haves:
  truths:
    - "Travel buttons show stamina cost (5 for within-region, 10 for cross-region)"
    - "Travel buttons are disabled when character lacks stamina"
    - "Cross-region cooldown countdown is visible when cooldown is active"
    - "Travel buttons for cross-region destinations are disabled during cooldown"
    - "Client regenerated bindings include TravelCooldown table"
    - "Module publishes and travel works end-to-end with costs and cooldowns"
  artifacts:
    - path: "src/components/TravelPanel.vue"
      provides: "Travel UI with cost indicators and cooldown display"
      contains: "staminaCost"
    - path: "src/module_bindings/index.ts"
      provides: "Regenerated bindings with TravelCooldown"
      contains: "TravelCooldown"
  key_links:
    - from: "src/components/TravelPanel.vue"
      to: "src/App.vue"
      via: "TravelCooldown subscription passed as prop"
      pattern: "travelCooldown|cooldown"
    - from: "src/App.vue"
      to: "src/module_bindings"
      via: "useTable(tables.travelCooldown)"
      pattern: "travelCooldown"
---

<objective>
Publish module, regenerate client bindings, update TravelPanel with stamina cost display, cooldown countdown, and affordability checks. Human verification of full end-to-end travel flow.

Purpose: Players see travel costs before committing, understand region boundaries via cost differences, and see cooldown timers after cross-region travel.
Output: Working travel UI with cost indicators, published module with travel costs enforced server-side.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-CONTEXT.md
@.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-01-SUMMARY.md

@src/components/TravelPanel.vue
@src/composables/useMovement.ts
@src/App.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Publish module and regenerate client bindings</name>
  <files>
    src/module_bindings/
  </files>
  <action>
1. Publish the SpacetimeDB module with `--clear-database` to pick up the new TravelCooldown table:
   ```bash
   spacetime publish uwr --clear-database -y --project-path spacetimedb
   ```
   Note: --clear-database is required because we added a new table (TravelCooldown) to the schema.

2. Regenerate client bindings:
   ```bash
   spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb
   ```

3. Verify the generated bindings include:
   - `TravelCooldownTable` type in module_bindings
   - `tables.travelCooldown` accessor
   - `TravelCooldownRow` type with `id`, `characterId`, `readyAtMicros` fields

If publish fails, check `spacetime logs uwr` for errors and fix any schema issues from Plan 01.
  </action>
  <verify>
Run `ls src/module_bindings/` to confirm bindings regenerated. Grep for `travelCooldown` in `src/module_bindings/` to confirm the new table is present in generated code.
  </verify>
  <done>
Module published with TravelCooldown table. Client bindings regenerated and include TravelCooldownRow type and tables.travelCooldown accessor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TravelPanel with cost indicators, cooldown display, and affordability gating</name>
  <files>
    src/components/TravelPanel.vue
    src/App.vue
  </files>
  <action>
**App.vue changes:**

1. Subscribe to TravelCooldown table. Add to existing useTable/useGameData section:
   ```typescript
   const [travelCooldowns] = useTable(tables.travelCooldown);
   ```

2. Add TravelCooldown subscription to the SQL subscription list (find where other subscriptions are added, e.g. `SELECT * FROM travel_cooldown`).

3. Pass travelCooldowns, regions, and locationConnections to TravelPanel:
   ```html
   <TravelPanel
     :styles="styles"
     :conn-active="conn.isActive"
     :selected-character="selectedCharacter"
     :locations="connectedLocations"
     :regions="regions"
     :travel-cooldowns="travelCooldowns"
     :all-locations="locations"
     :location-connections="locationConnections"
     @move="moveTo"
   />
   ```
   We need `all-locations` and `location-connections` so TravelPanel can determine region of each connected location. Alternatively, compute `connectedLocationsWithRegion` in App.vue. Choose whichever is simpler.

**TravelPanel.vue changes:**

1. **Add new props:**
   ```typescript
   import type { TravelCooldownRow, LocationConnectionRow } from '../module_bindings';

   const props = defineProps<{
     styles: Record<string, Record<string, string | number>>;
     connActive: boolean;
     selectedCharacter: CharacterRow | null;
     locations: LocationRow[];
     regions: RegionRow[];
     travelCooldowns: TravelCooldownRow[];
     allLocations: LocationRow[];
     locationConnections: LocationConnectionRow[];
   }>();
   ```

2. **Determine current character's region:**
   ```typescript
   const currentRegionId = computed(() => {
     if (!props.selectedCharacter) return null;
     const currentLoc = props.allLocations.find(
       l => l.id.toString() === props.selectedCharacter!.locationId.toString()
     );
     return currentLoc?.regionId ?? null;
   });
   ```

3. **Determine if each connected location is cross-region:**
   In the `sortedLocations` computed, add `isCrossRegion` flag:
   ```typescript
   const isCrossRegion = currentRegionId.value !== null &&
     location.regionId.toString() !== currentRegionId.value.toString();
   const staminaCost = isCrossRegion ? 10 : 5;
   ```

4. **Check active cooldown for current character:**
   ```typescript
   const activeCooldown = computed(() => {
     if (!props.selectedCharacter) return null;
     const charId = props.selectedCharacter.id.toString();
     const cd = props.travelCooldowns.find(
       c => c.characterId.toString() === charId
     );
     if (!cd) return null;
     // readyAtMicros is server timestamp - need to account for clock offset
     // Use window.__server_clock_offset if available (from quick-55)
     const offsetMs = (window as any).__server_clock_offset ?? 0;
     const nowMicros = BigInt(Math.round((Date.now() + offsetMs) * 1000));
     if (cd.readyAtMicros > nowMicros) return cd;
     return null; // Expired
   });
   ```

5. **Add cooldown countdown display** at the top of the travel section (when cooldown active):
   ```html
   <div v-if="cooldownRemainingText" :style="{ fontSize: '0.75rem', color: '#d4a574', marginBottom: '0.3rem' }">
     Region travel cooldown: {{ cooldownRemainingText }}
   </div>
   ```
   Implement `cooldownRemainingText` as a reactive computed that shows "Xm Ys" format. Use a 1-second interval timer (onMounted/onUnmounted) to update a `now` ref for live countdown.

6. **Show stamina cost on each travel button:**
   Replace the plain "Go" text with cost indicator:
   ```html
   <button
     :style="styles.gridTileGoButton"
     @click="$emit('move', entry.location.id)"
     :disabled="!connActive || entry.location.id === selectedCharacter.locationId || !canAffordTravel(entry) || (entry.isCrossRegion && !!activeCooldown)"
   >
     <span>{{ entry.staminaCost }} sta</span>
   </button>
   ```

7. **Add canAffordTravel helper:**
   ```typescript
   const canAffordTravel = (entry: { staminaCost: number }) => {
     if (!props.selectedCharacter) return false;
     return Number(props.selectedCharacter.stamina) >= entry.staminaCost;
   };
   ```

8. **Visual differentiation for cross-region destinations:**
   Add a small indicator next to the region name for cross-region locations, e.g., a different color or a small icon. The region name already shows below the location name. Add a subtle color difference (e.g., amber/orange text for cross-region region name vs normal subdued text).

9. **Dim/gray out unaffordable travel options:**
   Add opacity reduction or gray styling when `!canAffordTravel(entry)` or when on cooldown for cross-region entries.

IMPORTANT per user decision:
- Display stamina costs as "5 sta" or "10 sta" (discretion on exact format)
- NO gold cost display (there are no gold costs)
- NO distance display (there is no distance calculation)
- Cooldown indicator only shows for cross-region travel
  </action>
  <verify>
Run `npx vue-tsc --noEmit` or equivalent TypeScript check to verify no type errors. Visually inspect the component code to confirm:
1. Cost indicators show on each travel button
2. Cooldown countdown appears when active
3. Buttons disabled when insufficient stamina or on cooldown
4. Cross-region vs within-region distinction is visible
5. No gold cost display exists
  </verify>
  <done>
TravelPanel shows stamina cost per destination (5 within-region, 10 cross-region), disables travel when character lacks stamina, shows cooldown countdown timer for cross-region cooldown, and visually distinguishes cross-region destinations. No gold costs displayed. Module published and bindings regenerated.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of travel cost system</name>
  <files>none</files>
  <action>
Present the completed travel cost system for human verification. The system includes: within-region travel costs 5 stamina, cross-region travel costs 10 stamina + 5-minute cooldown. All group members must have enough stamina or move fails. TravelPanel shows cost indicators and cooldown countdown.

Steps for verification:
1. Open the game in browser and select a character
2. Within-region travel test: Note stamina, click Go on same-region location, verify -5 stamina, verify "5 sta" label, verify NO cooldown
3. Cross-region travel test: Travel to different region, verify -10 stamina, verify "10 sta" label, verify cooldown timer appears (~5 min), try cross-region again (blocked), within-region still works
4. Insufficient stamina test: Get low stamina character, attempt travel, verify error "[CharacterName] does not have enough stamina to travel", verify button disabled
5. Group travel test (if applicable): Create group, set one member low stamina, try group travel, verify named error, verify all members deducted on success
6. Cooldown expiry: Wait for cooldown, verify cross-region works again
  </action>
  <verify>Human confirms all scenarios pass by typing "approved" or describes issues.</verify>
  <done>Human has verified travel cost system works correctly end-to-end: stamina costs, cooldowns, group validation, and UI indicators all function as specified.</done>
</task>

</tasks>

<verification>
1. Module publishes without errors
2. Client bindings include TravelCooldown table
3. TravelPanel shows correct stamina costs per destination
4. Cooldown countdown displays and counts down in real-time
5. Buttons disabled when insufficient stamina
6. Cross-region buttons disabled during cooldown
7. Within-region travel unaffected by cooldown
8. Group travel validates all members' stamina
9. No gold costs anywhere in UI or backend
10. Error messages follow "[CharacterName] does not have enough stamina to travel" format
</verification>

<success_criteria>
- Module published and client bindings regenerated with TravelCooldown
- TravelPanel shows "5 sta" for within-region, "10 sta" for cross-region destinations
- Cooldown countdown timer visible after cross-region travel
- Travel buttons disabled when character can't afford or on cooldown
- Cross-region visual distinction visible in travel UI
- Human verification confirms all travel scenarios work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/10-travel-movement-costs-region-travel-with-distance-based-costs-short-stamina-long-gold-cooldown-travel-restrictions-and-validation-travel-ui-improvements/10-02-SUMMARY.md`
</output>
