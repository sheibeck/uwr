---
phase: 14-loot-gear-progression
plan: 04
type: execute
wave: 4
depends_on: ["14-03"]
files_modified:
  - spacetimedb/src/index.ts
  - src/composables/useCombat.ts
  - src/composables/useInventory.ts
  - src/components/LootPanel.vue
  - src/components/InventoryPanel.vue
  - src/App.vue
  - src/ui/styles.ts
autonomous: false

must_haves:
  truths:
    - "Loot panel shows quality-colored item names (white/green/blue/purple/orange)"
    - "Item tooltips display affix stat lines below base stats"
    - "Epic and Legendary drops get a brief animated flash in loot panel"
    - "Inventory items show colored tile borders matching quality tier"
    - "Salvage option appears in inventory context menu for gear items"
    - "Inventory tooltip shows affixed item display name and all affix bonuses"
  artifacts:
    - path: "src/composables/useCombat.ts"
      provides: "pendingLoot includes qualityTier and affix stats from CombatLoot/ItemAffix"
      contains: "qualityTier"
    - path: "src/components/LootPanel.vue"
      provides: "Quality-colored names, affix lines in tooltip, Epic/Legendary flash"
      contains: "lootFlash"
    - path: "src/components/InventoryPanel.vue"
      provides: "Quality border colors, affix tooltip lines, Salvage context menu item"
      contains: "Salvage"
    - path: "src/ui/styles.ts"
      provides: "Flash animation styles for Epic/Legendary drops"
      contains: "lootFlash"
  key_links:
    - from: "src/composables/useCombat.ts"
      to: "src/module_bindings"
      via: "useTable(tables.itemAffix) subscription and CombatLoot.qualityTier"
      pattern: "itemAffix"
    - from: "src/components/LootPanel.vue"
      to: "src/composables/useCombat.ts"
      via: "pendingLoot includes quality color and affix stats"
      pattern: "qualityTier|affixStats"
    - from: "src/components/InventoryPanel.vue"
      to: "src/module_bindings"
      via: "ItemAffix table subscription for equipped/inventory item tooltips"
      pattern: "itemAffix"
---

<objective>
Publish the module, regenerate bindings, and integrate the loot/affix system into the client UI: quality-colored names, affix tooltip lines, Epic/Legendary flash animation, salvage context menu.

Purpose: The backend is complete from Plans 01-03. This plan makes it visible and interactive for the player â€” colored names to communicate quality at a glance, detailed tooltips to evaluate gear, visual flash for exciting drops, and salvage for gear recycling.
Output: Published module, regenerated bindings, complete client-side loot quality experience.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-loot-gear-progression-magic-item-properties-and-affixes-gear-quality-tiers-common-to-legendary-drop-tables-and-rarity-system-endgame-gear-hunting-loop/14-03-SUMMARY.md
@src/composables/useCombat.ts
@src/components/LootPanel.vue
@src/components/InventoryPanel.vue
@src/App.vue
@src/ui/styles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Publish module, regenerate bindings, wire up ItemAffix subscription and extend loot/inventory composables</name>
  <files>spacetimedb/src/index.ts, src/composables/useCombat.ts, src/composables/useInventory.ts, src/App.vue</files>
  <action>
**Step 1: Publish and regenerate bindings.**

Run:
```bash
spacetime publish uwr --project-path spacetimedb
spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb
```

If publish fails due to schema migration issues (new columns that aren't optional), add `--clear-database -y` flag. New optional fields at end of tables should auto-migrate in SpacetimeDB 1.11.

**Step 2: Add ItemAffix table subscription in App.vue.**

In App.vue where `useTable(tables.*)` calls are listed (the subscription block), add:
```typescript
const [itemAffixes] = useTable(tables.itemAffix);
```

Also ensure the SQL subscription includes `item_affix`:
Find the subscription query array and add `'SELECT * FROM item_affix'` to it.

Pass `itemAffixes` down to composables/components that need it (useCombat, useInventory).

**Step 3: Extend useCombat.ts pendingLoot.**

In `useCombat.ts`, the `pendingLoot` computed property maps CombatLoot rows to display objects. Extend it:

1. Read `qualityTier` from the CombatLoot row (new field from bindings).
2. Use `qualityTier` (if present) instead of `template.rarity` for determining display color.
3. Parse `affixDataJson` from CombatLoot to show affix preview in the loot tooltip:
   ```typescript
   const affixData = loot.affixDataJson ? JSON.parse(loot.affixDataJson) : [];
   const affixStats = affixData.map((a: any) => ({
     label: formatAffixStatKey(a.statKey),
     value: `+${a.magnitude}`,
     affixName: a.affixName,
   }));
   ```
4. Include the display name (build from template name + prefix/suffix) in the loot display object.
5. Add a helper `formatAffixStatKey(key: string): string` that maps statKey to human-readable labels:
   - 'strBonus' -> 'STR'
   - 'dexBonus' -> 'DEX'
   - 'intBonus' -> 'INT'
   - 'wisBonus' -> 'WIS'
   - 'chaBonus' -> 'CHA'
   - 'hpBonus' -> 'Max HP'
   - 'armorClassBonus' -> 'Armor'
   - 'magicResistanceBonus' -> 'Magic Resist'
   - 'lifeOnHit' -> 'Life on Hit'
   - 'cooldownReduction' -> 'Cooldown Reduction %'
   - 'manaRegen' -> 'Mana Regen'
   - 'weaponBaseDamage' -> 'Damage'

**Step 4: Extend useInventory (or the relevant composable) for affix display.**

For inventory items, extend the tooltip data to include affix lines:
1. For each inventory item, look up its `ItemAffix` rows via `itemAffixes.filter(a => a.itemInstanceId === instance.id)`.
2. Map each affix to a display line: `{ label: formatAffixStatKey(a.statKey), value: `+${a.magnitude} (${a.affixName})` }`.
3. Use `instance.displayName ?? template.name` for the item display name.
4. Use `instance.qualityTier ?? template.rarity ?? 'common'` for the quality color.
  </action>
  <verify>
Module published successfully. Bindings regenerated (verify `src/module_bindings/item_affix_table.ts` exists). App.vue subscribes to itemAffix table. pendingLoot includes qualityTier and affix stats. No TypeScript errors in client build.
  </verify>
  <done>
Module published with new schema. Bindings regenerated with ItemAffix type. ItemAffix subscription wired in App.vue. pendingLoot includes qualityTier, affix stats, and display name. Inventory composable reads ItemAffix rows for tooltip display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add quality colors, affix tooltip lines, Epic/Legendary flash, and salvage context menu to UI components</name>
  <files>src/components/LootPanel.vue, src/components/InventoryPanel.vue, src/ui/styles.ts</files>
  <action>
**In styles.ts**, add flash animation styles:

```typescript
lootFlashEpic: {
  animation: 'lootFlash 0.6s ease-in-out 2',
},
lootFlashLegendary: {
  animation: 'lootFlashLegendary 0.8s ease-in-out 3',
},
```

Also add border style helpers for quality tiers:
```typescript
qualityBorderCommon: { borderColor: '#555555' },
qualityBorderUncommon: { borderColor: '#00ff00' },
qualityBorderRare: { borderColor: '#4488ff' },
qualityBorderEpic: { borderColor: '#aa44ff' },
qualityBorderLegendary: { borderColor: '#ff8800' },
```

**In LootPanel.vue:**

1. The existing rarity color mapping (`rarityCommon` through `rarityLegendary` styles) already exists. Update the logic that picks the color:
   - Use `lootItem.qualityTier` (from extended pendingLoot) to pick the style, falling back to `template.rarity`.
   - Apply the corresponding `rarity{Tier}` style to the item name span.

2. Add affix stat lines to the tooltip/detail section:
   - Below the existing base stats, render each affix stat as a line:
     ```
     +2 STR (Mighty)
     +2 DEX (of Precision)
     ```
   - Affix lines should be colored with the quality tier color (green for uncommon affixes, blue for rare, etc.).

3. Use the display name (e.g., "Mighty Scout Jerkin of Precision") instead of the base template name when `lootItem.displayName` is available.

4. Add colored tile border matching quality tier (apply `qualityBorder{Tier}` style to the loot tile container).

5. Epic/Legendary flash: When a new loot item appears with qualityTier 'epic' or 'legendary', apply the `lootFlashEpic` or `lootFlashLegendary` style to that loot row. This requires:
   - Inject a CSS `@keyframes lootFlash` rule in the component's `<style>` block or in App.vue:
     ```css
     @keyframes lootFlash {
       0%, 100% { background-color: transparent; }
       50% { background-color: rgba(170, 68, 255, 0.3); }
     }
     @keyframes lootFlashLegendary {
       0%, 100% { background-color: transparent; }
       50% { background-color: rgba(255, 136, 0, 0.3); }
     }
     ```
   - Apply the animation style to the loot item container conditionally.

**In InventoryPanel.vue:**

1. Update item tile borders: apply a colored border matching `instance.qualityTier ?? template.rarity ?? 'common'`. Use 2px solid border with the quality tier color from the mapping.

2. Update item name display: use `instance.displayName ?? template.name`. Apply the rarity color style to the name text.

3. Extend tooltip to show affix lines below base stats (same format as LootPanel).

4. Add "Salvage" option to the context menu (the right-click menu on inventory items):
   - Only show for equipment items (not junk, consumable, food, resource, quest).
   - Only show for unequipped items.
   - On click, call `conn.reducers.salvageItem({ characterId: selectedCharacter.id, itemInstanceId: instance.id })`.
   - Add a confirmation prompt before salvaging (use browser confirm dialog matching existing delete confirmation pattern from quick-45).

**IMPORTANT:** The existing rarity color styles in styles.ts (`rarityCommon` through `rarityLegendary`) use `color: '#ffcc00'` for legendary (yellow). Per user decision, legendary should be orange (#ff8800). Update `rarityLegendary` color to `'#ff8800'` if it's currently yellow.
  </action>
  <verify>
Client builds without errors (`npm run build` or `npx vite build`). LootPanel shows colored item names. Inventory items have colored borders. Affix stats visible in tooltips. Salvage option appears in context menu for gear items. Epic/Legendary flash animation plays.
  </verify>
  <done>
LootPanel displays quality-colored names using qualityTier, affix stat lines in tooltips, and Epic/Legendary flash animation on new drops. InventoryPanel shows colored tile borders, affix tooltip lines, and Salvage context menu option with confirmation dialog. All 5 quality tiers properly colored (Common=white, Uncommon=green, Rare=blue, Epic=purple, Legendary=orange).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify loot quality and affix system end-to-end</name>
  <files>src/components/LootPanel.vue, src/components/InventoryPanel.vue</files>
  <action>
Human verifies the complete loot quality and affix system:
- Quality tier rolling on enemy kills (Common/Uncommon in Tier 1 regions)
- Prefix/suffix affixes on dropped gear with fixed values per tier
- Equipped affix bonuses applied to character stats
- Quality-colored item names and tile borders in loot and inventory panels
- Affix stat lines in tooltips below base stats
- Epic/Legendary animated flash in loot panel
- Salvage gear recycling via context menu with confirmation
- Named Legendary drops from boss enemies (if testable)
  </action>
  <verify>
1. Kill enemies in a Tier 1 region (level 1-10). Verify drops are Common or Uncommon only.
2. Check that Uncommon drops have 1 affix (prefix), a colored green name, and a green tile border.
3. Equip an affix item and verify the stat bonus appears in your character stats.
4. Right-click an unequipped gear item in inventory and verify "Salvage" appears in context menu.
5. Salvage an item and verify you receive materials/gold and the item is deleted.
6. If possible, use a test command or fight higher-level enemies to get Rare+ drops:
   - Rare should have 2 affixes (prefix + suffix), blue color.
   - Epic should have 3 affixes, purple color, with flash animation.
7. Verify item tooltips show base stats + affix lines with affix names.
8. Verify display names use prefix/suffix format (e.g., "Mighty Blade of Power").
  </verify>
  <done>
Human confirms: quality-colored names display correctly, affix tooltips show stat bonuses, flash animation triggers for Epic/Legendary drops, salvage works for gear recycling, equipped affix bonuses appear in character stats.
  </done>
</task>

</tasks>

<verification>
- Module publishes and bindings regenerate successfully
- Client builds without errors
- 5 quality tier colors render correctly in both loot and inventory panels
- Affix stat lines appear in tooltips for non-Common items
- Epic/Legendary flash animation triggers on those quality drops
- Salvage context menu works for gear items only
- All quality tiers display correctly: white/green/blue/purple/orange
</verification>

<success_criteria>
- Player sees quality-colored item names in loot panel and inventory
- Tooltips show all affix bonuses with human-readable labels
- Epic drops flash purple, Legendary drops flash orange
- Salvage option available for unwanted gear
- Equipped affix bonuses reflected in character stats
- Human verification confirms end-to-end flow
</success_criteria>

<output>
After completion, create `.planning/phases/14-loot-gear-progression-magic-item-properties-and-affixes-gear-quality-tiers-common-to-legendary-drop-tables-and-rarity-system-endgame-gear-hunting-loop/14-04-SUMMARY.md`
</output>
