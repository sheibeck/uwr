---
phase: 14-loot-gear-progression
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/data/affix_catalog.ts
autonomous: true

must_haves:
  truths:
    - "ItemAffix table exists with by_instance btree index"
    - "ItemInstance has qualityTier, displayName, and isNamed optional fields"
    - "CombatLoot has qualityTier, affixDataJson, and isNamed optional fields"
    - "Affix catalog contains prefixes and suffixes organized by slot and tier"
    - "Legendary definitions exist mapping boss enemies to fixed-affix unique items"
  artifacts:
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "ItemAffix table definition, extended ItemInstance, extended CombatLoot"
      contains: "ItemAffix"
    - path: "spacetimedb/src/data/affix_catalog.ts"
      provides: "PREFIXES, SUFFIXES, LEGENDARIES arrays"
      contains: "AffixDef"
  key_links:
    - from: "spacetimedb/src/data/affix_catalog.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "ItemAffix statKey values match AffixDef statKey values"
      pattern: "statKey"
---

<objective>
Define the foundational schema extensions and affix data catalog for the loot quality/affix system.

Purpose: All downstream plans (loot generation, take_loot, combat bonuses, client display) depend on these schema changes and data definitions existing first. This is the horizontal foundation that enables everything else.
Output: Extended tables.ts with ItemAffix table + ItemInstance/CombatLoot new fields, and a complete affix_catalog.ts data file.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@spacetimedb/src/schema/tables.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema with ItemAffix table, ItemInstance and CombatLoot quality fields</name>
  <files>spacetimedb/src/schema/tables.ts</files>
  <action>
1. Add new ItemAffix table definition after ItemInstance:
```typescript
export const ItemAffix = table(
  {
    name: 'item_affix',
    public: true,
    indexes: [{ name: 'by_instance', algorithm: 'btree', columns: ['itemInstanceId'] }],
  },
  {
    id: t.u64().primaryKey().autoInc(),
    itemInstanceId: t.u64(),
    affixType: t.string(),      // 'prefix' | 'suffix'
    affixKey: t.string(),       // e.g., 'sturdy', 'of_haste'
    affixName: t.string(),      // display name, e.g., 'Sturdy', 'of Haste'
    statKey: t.string(),        // e.g., 'strBonus', 'lifeOnHit', 'cooldownReduction'
    magnitude: t.i64(),         // fixed per tier; positive = bonus
  }
);
```

2. Extend ItemInstance with 3 new optional fields at the END of the column list (CRITICAL for SpacetimeDB auto-migration):
   - `qualityTier: t.string().optional()` — 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary'; undefined = 'common'
   - `displayName: t.string().optional()` — null for common, e.g., "Sturdy Scout Jerkin of Haste"
   - `isNamed: t.bool().optional()` — true only for Legendary unique items

3. Extend CombatLoot with 3 new optional fields at the END of the column list:
   - `qualityTier: t.string().optional()` — rolled quality, e.g., 'uncommon'
   - `affixDataJson: t.string().optional()` — JSON array of affix keys to apply at take time
   - `isNamed: t.bool().optional()` — true for Legendary uniques

4. Add ItemAffix to the schema export at the end of the file (the `schema(...)` call). Insert it near the existing ItemInstance and CombatLoot entries.

IMPORTANT: Use single-column indexes only (multi-column indexes broken in SpacetimeDB 1.11 per CLAUDE.md). The `by_instance` index on `itemInstanceId` is sufficient for looking up affixes by item.
  </action>
  <verify>
Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` (or the project's build check) to confirm the schema compiles without errors. Verify ItemAffix appears in the schema export.
  </verify>
  <done>
ItemAffix table defined with id, itemInstanceId, affixType, affixKey, affixName, statKey, magnitude columns and by_instance index. ItemInstance has qualityTier, displayName, isNamed optional fields. CombatLoot has qualityTier, affixDataJson, isNamed optional fields. Schema compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create affix catalog data file with prefixes, suffixes, and legendary definitions</name>
  <files>spacetimedb/src/data/affix_catalog.ts</files>
  <action>
Create a new file `spacetimedb/src/data/affix_catalog.ts` following the established data catalog pattern (like `ability_catalog.ts`).

Define the following types and data:

```typescript
export interface AffixDef {
  key: string;
  name: string;              // display: 'Sturdy', 'of Haste'
  type: 'prefix' | 'suffix';
  slots: string[];           // which gear slots this applies to
  statKey: string;           // which stat it modifies (matches ItemAffix.statKey)
  minTier: number;           // minimum quality tier number (1=uncommon, 2=rare, 3=epic, 4=legendary)
  magnitudeByTier: bigint[]; // index 0 = tier 1 magnitude, index 1 = tier 2, etc.
}

export interface LegendaryDef {
  key: string;
  name: string;                // display name, e.g., 'Soulrender'
  baseTemplateName: string;    // name of the ItemTemplate this is based on
  slot: string;                // equipment slot
  affixes: { affixKey: string; type: 'prefix' | 'suffix'; statKey: string; magnitude: bigint; affixName: string }[];
  enemyTemplateName: string;   // which named enemy drops this
}
```

**PREFIXES array** (Tier 1-2 = stat bonuses, Tier 3+ = procs/sustain per user decision):
Weapon-slot (mainHand, offHand) offensive prefixes:
- `mighty` (Mighty) — strBonus, minTier 1, [1n, 2n, 3n, 4n]
- `swift` (Swift) — dexBonus, minTier 1, [1n, 2n, 3n, 4n]
- `arcane` (Arcane) — intBonus, minTier 1, [1n, 2n, 3n, 4n]
- `wise` (Wise) — wisBonus, minTier 1, [1n, 2n, 3n, 4n]
- `keen` (Keen) — weaponBaseDamage, minTier 1, [2n, 4n, 7n, 10n]
- `vampiric` (Vampiric) — lifeOnHit, minTier 3, [0n, 0n, 3n, 5n]

Armor-slot (chest, legs, boots, head, hands, wrists, belt) defensive prefixes:
- `sturdy` (Sturdy) — armorClassBonus, minTier 1, [1n, 2n, 3n, 5n]
- `vital` (Vital) — hpBonus, minTier 1, [5n, 10n, 20n, 35n]
- `warded` (Warded) — magicResistanceBonus, minTier 1, [1n, 2n, 4n, 6n]
- `fortified` (Fortified) — armorClassBonus, minTier 2, [0n, 3n, 5n, 8n]

Accessory-slot (neck, earrings, cloak) mixed prefixes:
- `empowered` (Empowered) — intBonus, minTier 1, [1n, 2n, 3n, 4n]
- `resolute` (Resolute) — wisBonus, minTier 1, [1n, 2n, 3n, 4n]

**SUFFIXES array:**
Weapon-slot offensive suffixes:
- `of_power` (of Power) — strBonus, minTier 1, [1n, 2n, 3n, 4n]
- `of_precision` (of Precision) — dexBonus, minTier 1, [1n, 2n, 3n, 4n]
- `of_haste` (of Haste) — cooldownReduction, minTier 3, [0n, 0n, 10n, 15n]

Armor-slot defensive suffixes:
- `of_endurance` (of Endurance) — hpBonus, minTier 1, [5n, 10n, 20n, 35n]
- `of_strength` (of Strength) — strBonus, minTier 1, [1n, 2n, 3n, 4n]
- `of_the_mind` (of the Mind) — intBonus, minTier 1, [1n, 2n, 3n, 4n]
- `of_warding` (of Warding) — magicResistanceBonus, minTier 2, [0n, 2n, 4n, 7n]
- `of_resilience` (of Resilience) — armorClassBonus, minTier 1, [1n, 2n, 3n, 5n]

Accessory-slot mixed suffixes:
- `of_mana_flow` (of Mana Flow) — manaRegen, minTier 3, [0n, 0n, 5n, 8n]
- `of_insight` (of Insight) — wisBonus, minTier 1, [1n, 2n, 3n, 4n]
- `of_vigor` (of Vigor) — hpBonus, minTier 1, [5n, 10n, 15n, 25n]

**LEGENDARIES array** (3-5 items, Claude's discretion on exact names/stats):
Create 4 legendary items:
1. `soulrender` — weapon (mainHand), drops from a boss enemy template. Fixed affixes: Vampiric prefix (lifeOnHit 5n) + of Haste suffix (cooldownReduction 15n).
2. `ironveil` — chest armor, drops from a boss. Fixed affixes: Fortified prefix (armorClassBonus 8n) + of Endurance suffix (hpBonus 35n).
3. `whisperwind` — cloak accessory, drops from a boss. Fixed affixes: Resolute prefix (wisBonus 4n) + of Mana Flow suffix (manaRegen 8n).
4. `dreadmaw` — weapon (mainHand), drops from a boss. Fixed affixes: Keen prefix (weaponBaseDamage 10n) + of Power suffix (strBonus 4n).

For `enemyTemplateName`, use existing boss-type enemy names from the NamedEnemy/EnemyTemplate system. Read `seeding/ensure_enemies.ts` to find real boss names. If unsure, use placeholder names and note they need mapping.

Also export helper constants:
```typescript
export const QUALITY_TIERS = ['common', 'uncommon', 'rare', 'epic', 'legendary'] as const;
export type QualityTier = typeof QUALITY_TIERS[number];

export const AFFIX_COUNT_BY_QUALITY: Record<string, number> = {
  common: 0,
  uncommon: 1,
  rare: 2,
  epic: 3,
  legendary: 0,  // legendaries use fixed affixes, not rolled
};

export const QUALITY_TIER_COLORS: Record<string, string> = {
  common: '#ffffff',
  uncommon: '#00ff00',
  rare: '#4488ff',
  epic: '#aa44ff',
  legendary: '#ff8800',
};
```

No utility affixes (no gold find, XP boost, travel cost reduction) per user decision. All affixes are combat-focused.
  </action>
  <verify>
Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to confirm the data file compiles. Verify PREFIXES, SUFFIXES, and LEGENDARIES arrays are exported and all slots use valid equipment slot names from EQUIPMENT_SLOTS in helpers/items.ts.
  </verify>
  <done>
affix_catalog.ts exports AffixDef, LegendaryDef types, PREFIXES array (~12 entries), SUFFIXES array (~12 entries), LEGENDARIES array (4 entries), QUALITY_TIERS, AFFIX_COUNT_BY_QUALITY, and QUALITY_TIER_COLORS constants. All affix statKeys match actual stat field names. No utility affixes present.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project spacetimedb/tsconfig.json` passes
- ItemAffix table has by_instance single-column index
- ItemInstance and CombatLoot have new optional fields at END of column list
- ItemAffix is included in schema export
- affix_catalog.ts is importable from other spacetimedb/src files
- No multi-column indexes added
</verification>

<success_criteria>
- Schema compiles with all new tables and fields
- Affix catalog has meaningful combat-focused affixes across all slot types
- Tier 1-2 affixes are stat-only; Tier 3+ includes lifeOnHit, cooldownReduction, manaRegen
- 4 Legendary items defined with specific boss drop sources
- Foundation ready for Plan 02 (loot generation logic)
</success_criteria>

<output>
After completion, create `.planning/phases/14-loot-gear-progression-magic-item-properties-and-affixes-gear-quality-tiers-common-to-legendary-drop-tables-and-rarity-system-endgame-gear-hunting-loop/14-01-SUMMARY.md`
</output>
