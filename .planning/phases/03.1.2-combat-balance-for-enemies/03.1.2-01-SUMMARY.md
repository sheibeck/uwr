---
phase: 03.1.2-combat-balance-for-enemies
plan: 01
subsystem: combat
tags: [enemy-scaling, power-budget, metadata, foundation]
dependency_graph:
  requires: []
  provides:
    - enemy-power-scaling-constants
    - enemy-ability-power-metadata
    - enemy-damage-type-routing
    - enemy-heal-abilities
    - enemy-aoe-abilities
    - enemy-buff-abilities
  affects:
    - combat_scaling.ts
    - ability_catalog.ts
tech_stack:
  added: []
  patterns:
    - declarative-power-budget-metadata
    - level-based-enemy-scaling
key_files:
  created: []
  modified:
    - spacetimedb/src/data/combat_scaling.ts
    - spacetimedb/src/data/ability_catalog.ts
decisions:
  - "Enemy power scales by level only (no stats): ENEMY_BASE_POWER + (level * ENEMY_LEVEL_POWER_SCALING)"
  - "Enemy DoT abilities use 50% power split (matching player DoT scaling)"
  - "Enemy debuff abilities cost 25% power budget (matching player debuff cost)"
  - "Enemy AoE abilities have NO dotPowerSplit (direct damage only, no DoT on AoE)"
  - "Damage type routing: poison/venom/bite/gore/bleed/stone/bog = physical, ember/fire/shadow/hex/curse/searing = magic"
metrics:
  duration: 4min
  completed: 2026-02-13
  tasks_completed: 2
  files_modified: 2
  commits: 2
---

# Phase 03.1.2 Plan 01: Enemy Power Scaling & Ability Metadata

**One-liner:** Enemy-specific power scaling constants (ENEMY_BASE_POWER, ENEMY_LEVEL_POWER_SCALING) and full power budget metadata on all ~27 existing enemy abilities plus 6 new ability types (2 heal, 2 AoE, 2 buff)

## Objective

Establish the declarative metadata foundation for enemy ability power scaling by adding enemy-specific constants to combat_scaling.ts and extending ENEMY_ABILITIES catalog with power budget metadata (power, damageType, budget splits) plus new heal, AoE, and buff ability types.

## Tasks Completed

### Task 1: Add Enemy Power Scaling Constants
**Status:** Complete
**Commit:** 1b7f86c
**Files:** spacetimedb/src/data/combat_scaling.ts

Added two new exported constants after DEBUFF_POWER_COST_PERCENT:
- `ENEMY_BASE_POWER = 10n` — Level 1 baseline power for enemy abilities
- `ENEMY_LEVEL_POWER_SCALING = 5n` — Per-level power increase

Formula: `ENEMY_BASE_POWER + (enemyLevel * ENEMY_LEVEL_POWER_SCALING)`
- Level 1 = 15 power
- Level 5 = 35 power
- Level 10 = 60 power

Enemies do NOT have stats — damage is purely level-based + ability power rating.

### Task 2: Extend ENEMY_ABILITIES with Power Budget Metadata
**Status:** Complete
**Commit:** d148f75
**Files:** spacetimedb/src/data/ability_catalog.ts

**Part A: Extended all ~27 existing enemy abilities**

Every existing enemy ability now has:
- `power: bigint` — Ability-specific power rating (2n-5n based on magnitude)
- `damageType: 'physical' | 'magic'` — Routes through armor or magic resist mitigation
- DoT abilities: `dotPowerSplit: 0.5` — 50% of power allocated to periodic damage
- Debuff abilities: `debuffPowerCost: 0.25` — 25% of power consumed by debuff application

Damage type assignments:
- **Physical:** poison_bite, rending_bite, bleeding_shot, bog_slime, quick_nip, thorn_venom, blood_drain, rusty_bleed, stone_cleave, crushing_gore, quake_stomp
- **Magic:** ember_burn, shadow_rend, scorching_snap, ember_spark, searing_talon, shadow_bleed, cinder_blight, molten_bleed, sapping_chant, withering_hex, mire_curse, ember_slam, chill_touch, grave_shield_break, vault_crush, soot_hex

Power ratings:
- magnitude 1n → power 2n
- magnitude 2n → power 3n
- magnitude 3n → power 4n
- magnitude 4n → power 5n

**Part B: Added 6 new ability types**

**Heal abilities (2):**
- `shaman_heal`: power 5n, healPowerSplit 0.6, hotDuration 3n, targetRule 'lowest_hp'
- `dark_mend`: power 6n, healPowerSplit 0.5, hotDuration 2n, targetRule 'lowest_hp'

**AoE damage abilities (2):**
- `flame_burst`: power 6n, damageType 'magic', NO dotPowerSplit (direct damage only)
- `quake_wave`: power 7n, damageType 'physical', NO dotPowerSplit (direct damage only)

**Buff abilities (2):**
- `warchief_rally`: effectType 'damage_bonus', magnitude 3n, rounds 5n, targetRule 'all_allies'
- `bolster_defenses`: effectType 'armor_up', magnitude 3n, rounds 4n, targetRule 'all_allies'

## Deviations from Plan

None — plan executed exactly as written.

## Self-Check

**Verification results:**

File existence:
- FOUND: spacetimedb/src/data/combat_scaling.ts
- FOUND: spacetimedb/src/data/ability_catalog.ts

Commit existence:
- FOUND: 1b7f86c (enemy power scaling constants)
- FOUND: d148f75 (enemy abilities power budget metadata)

Metadata counts:
- 2 heal abilities (expected: 2) ✓
- 2 aoe_damage abilities (expected: 2) ✓
- 2 buff abilities (expected: 2) ✓
- 21 dotPowerSplit entries (17 enemy DoTs + 4 player DoTs) ✓
- 10 debuffPowerCost entries (all enemy debuff abilities) ✓
- 110 damageType entries (player + enemy abilities) ✓

**Self-Check: PASSED**

## Decisions Made

1. **Enemy power formula:** `ENEMY_BASE_POWER + (enemyLevel * ENEMY_LEVEL_POWER_SCALING)` — enemies scale by level only, no stats
2. **DoT power split:** All enemy DoT abilities use 0.5 (50% direct/periodic) to match player DoT scaling
3. **Debuff power cost:** All enemy debuff abilities cost 0.25 (25% of power budget) to match player debuff cost
4. **AoE has no DoT:** Enemy AoE abilities (flame_burst, quake_wave) have NO dotPowerSplit — per user decision, AoE cannot apply DoTs
5. **Damage type routing:** Physical abilities route through armor mitigation, magic abilities route through magic resist
6. **Physical damage types:** poison/venom/bite/rending/gore/bleed/stone/crushing/bog/rusty
7. **Magic damage types:** ember/fire/cinder/scorching/searing/shadow/hex/curse/blight/vault/soot

## Next Steps

Plan 02 will implement the executeEnemyAbility rewrite using these constants and metadata:
- Level-based power calculation using ENEMY_BASE_POWER + ENEMY_LEVEL_POWER_SCALING
- Power budget splits for DoT/HoT (dotPowerSplit, healPowerSplit)
- Debuff power cost deduction (debuffPowerCost)
- Damage type routing (damageType → armor vs magic resist)
- New ability kind handlers (heal, aoe_damage, buff)

## Output Artifacts

**combat_scaling.ts:**
- Added `ENEMY_BASE_POWER = 10n`
- Added `ENEMY_LEVEL_POWER_SCALING = 5n`

**ability_catalog.ts:**
- Extended all ~27 existing enemy abilities with power/damageType/budget metadata
- Added 2 heal abilities (shaman_heal, dark_mend)
- Added 2 AoE damage abilities (flame_burst, quake_wave)
- Added 2 buff abilities (warchief_rally, bolster_defenses)

Total abilities with complete metadata: 33 enemy abilities (27 existing + 6 new)
