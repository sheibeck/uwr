---
phase: 03.1.2-combat-balance-for-enemies
plan: 02
subsystem: combat
tags: [combat-balance, enemy-abilities, power-scaling, ability-kinds, spacetimedb]

# Dependency graph
requires:
  - phase: 03.1.2-01
    provides: "ENEMY_BASE_POWER, ENEMY_LEVEL_POWER_SCALING constants and enemy ability metadata (power, dotPowerSplit, damageType, etc.)"
provides:
  - "Level-scaled enemy ability damage using ENEMY_BASE_POWER + enemyLevel * ENEMY_LEVEL_POWER_SCALING formula"
  - "Power budget splits for DoT (dotPowerSplit) and debuff (debuffPowerCost) enemy abilities"
  - "Damage type routing: physical abilities mitigated by armor, magic abilities bypass armor"
  - "Heal ability kind: targets lowest HP enemy ally with direct heal + optional HoT"
  - "AoE damage ability kind: hits all active players at 65% damage per target"
  - "Buff ability kind: applies effects to all living enemy allies"
  - "Six new enemy abilities seeded: 2 healers, 2 AoE, 2 buffers"
affects: [combat-system, enemy-ai, ability-system, player-combat-experience]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Enemy ability damage calculated as: ENEMY_BASE_POWER + (enemyLevel * ENEMY_LEVEL_POWER_SCALING) + (abilityPower * 5n)"
    - "DoT abilities: direct damage (1.0 - dotPowerSplit) + periodic damage (dotPowerSplit / rounds)"
    - "Debuff abilities: direct damage (1.0 - debuffPowerCost) + debuff effect (fixed magnitude)"
    - "Heal abilities: find lowest HP ally, direct heal + optional HoT based on healPowerSplit"
    - "AoE abilities: enumerate all active combat participants, apply 65% damage per target"
    - "Buff abilities: enumerate all living allies, apply effect to each"
    - "Damage routing: physical → applyArmorMitigation, magic → applyMagicResistMitigation"

key-files:
  created: []
  modified:
    - "spacetimedb/src/index.ts"

key-decisions:
  - "Enemy ability power scales ONLY by level (no stats): ENEMY_BASE_POWER (10n) + enemyLevel * ENEMY_LEVEL_POWER_SCALING (5n)"
  - "Ability power multiplied by 5n to match player ABILITY_POWER_BASE_MULTIPLIER from Phase 3.1"
  - "DoT/debuff power budget splits mirror player system: 50% default dotPowerSplit, 25% default debuffPowerCost"
  - "Enemy AoE abilities deal direct damage only (no DoTs applied) per user decision"
  - "Heal abilities target lowest HP ally (not random or highest aggro)"
  - "Physical damage type (poison/venom/bite/gore/bleed/stone/bog) routes through armor mitigation"
  - "Magic damage type (ember/fire/shadow/hex/curse/searing) bypasses armor, routes through magic resist"

patterns-established:
  - "applyEnemyAbilityDamage helper: encapsulates damage type routing (physical vs magic) and HP updates"
  - "Heal/buff abilities log to all active combat participants (not just target character)"
  - "AoE abilities enumerate combatParticipant.by_combat.filter() for multi-target damage"
  - "Enemy abilities share power budget tradeoff concept with player abilities (DoT/debuff cost power)"

# Metrics
duration: 5min
completed: 2026-02-13
---

# Phase 03.1.2 Plan 02: Enemy Ability Execution Summary

**Level-scaled enemy abilities with DoT/debuff power budgets, damage type routing (physical/magic), and three new ability kinds (heal, AoE, buff)**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-13T04:15:29Z
- **Completed:** 2026-02-13T04:20:51Z
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments
- Rewrote executeEnemyAbility with level-based power scaling (ENEMY_BASE_POWER + enemyLevel * ENEMY_LEVEL_POWER_SCALING)
- Implemented power budget splits for DoT (dotPowerSplit) and debuff (debuffPowerCost) abilities with direct damage component
- Added damage type routing helper: physical damage mitigated by armor, magic damage bypasses armor
- Implemented heal kind: targets lowest HP enemy ally with direct heal + optional HoT
- Implemented aoe_damage kind: hits all active players at 65% damage per target
- Implemented buff kind: applies effects to all living enemy allies
- Seeded 6 new enemy abilities: Fen Witch + Grave Acolyte (heal), Cinder Sentinel + Basalt Brute (AoE), Hexbinder + Sootbound Mystic (buff)

## Task Commits

Each task was committed atomically:

1. **Task 1: Rewrite executeEnemyAbility with power scaling and all ability kinds** - `1c13cd7` (feat)
2. **Task 2: Seed new enemy abilities and publish module** - `b983ba1` (feat)

## Files Created/Modified
- `spacetimedb/src/index.ts` - Added applyEnemyAbilityDamage helper, rewrote executeEnemyAbility with 6 ability kind handlers (dot, debuff, heal, aoe_damage, buff, direct), seeded 6 new enemy abilities

## Decisions Made

**All key decisions documented in frontmatter key-decisions section.**

- Enemy power scaling formula mirrors player hybrid formula pattern (base + level scaling + ability power)
- Ability power multiplier (5n) matches player ABILITY_POWER_BASE_MULTIPLIER from Phase 3.1 decision #35
- DoT/debuff budget splits use same percentages as player abilities (50% periodic, 25% debuff cost)
- Heal targeting uses lowest HP ally algorithm (deterministic, no randomness)
- AoE damage enumerates all active participants (no group size scaling per Phase 3.1.2-01)
- Physical vs magic damage types map to armor vs magic resist mitigation paths

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all code compiled, module published successfully, no runtime errors in logs.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Enemy ability execution system complete with:
- Level-appropriate damage scaling (enemies gain power as levels increase)
- Tactical variety (healers support allies, AoE threatens groups, buffers enhance enemies)
- Consistent power budget tradeoffs (DoT/debuff cost power like player abilities)
- Damage type routing (physical vs magic mitigation paths)

Ready for:
- Phase 4 (LLM Architecture) - procedural combat scenario generation
- Enemy AI enhancements - ability selection logic based on combat situation
- Additional enemy ability types (CC, dispel, shields, etc.)

No blockers or concerns.

## Self-Check: PASSED

- ✓ SUMMARY.md created
- ✓ Commit 1c13cd7 exists (Task 1)
- ✓ Commit b983ba1 exists (Task 2)

---
*Phase: 03.1.2-combat-balance-for-enemies*
*Completed: 2026-02-13*
