---
phase: 11-death-corpse-system
plan: 03
status: ready_to_start
last_updated: 2026-02-14T14:35:55.966Z
---

<current_state>
Phase 11 Plans 01-02 are complete. Ready to execute Plan 03 (UI integration) after generating client bindings.

**Immediate blocker:** Client bindings need to be regenerated after Quick-93 schema changes (PendingSpellCast table).

**Session work completed:**
1. Resolved SpacetimeDB 500 error (fixed `combatStateFor` missing argument in ensure_items.ts:764)
2. Completed Quick-93: Refactored resurrection/corpse summon system (unified PendingSpellCast table, moved Corpse Summon to Necromancer/Summoner, removed cooldowns, added 10s cast time and flat mana costs 50/60)
3. Completed Quick-95: Created `/spawncorpse` admin command for testing
4. Fixed duplicate table definitions (NpcAffinity, NpcDialogueOption were listed twice in schema)
5. Successfully published module with `--clear-database`

**Next immediate action:** Run `spacetime generate` to regenerate client bindings, then execute Phase 11 Plan 03.
</current_state>

<completed_work>

**Phase 11 Plan 01 (Backend corpse foundation):** ✅ Complete
- Corpse and CorpseItem tables with indexes
- Level 5+ gating
- Same-location corpse combining
- 30-day decay with opportunistic cleanup
- Ownership-verified looting reducers

**Phase 11 Plan 02 (Resurrection & Corpse Summon):** ✅ Complete
- PendingSpellCast table (unified from PendingResurrect + PendingCorpseSummon in Quick-93)
- Resurrect ability (Cleric level 6, 50 mana, 10s cast, 0 cooldown)
- Corpse Summon ability (Necromancer/Summoner level 6, 60 mana, 10s cast, 0 cooldown)
- 6 reducers: initiate/accept/decline for both spells
- executeResurrect helper (teleport to corpse, 50% HP/mana restore)
- executeCorpseSummon helper (merge all corpses to caster location)

**Quick Tasks This Session:**
- Quick-93: Design refactoring (PendingSpellCast unification, class reassignment, resource-gating)
- Quick-95: `/spawncorpse` testing command

</completed_work>

<remaining_work>

**Phase 11 Plan 03 (UI Integration):** Not started
- Add "Points of Interest" section to Location panel showing corpses
- Corpse right-click context menu with "Loot Corpse" option
- Resurrection confirmation prompt UI (when cleric targets corpse)
- Corpse Summon confirmation prompt UI (when necromancer/summoner targets character with corpses)
- Wire up accept/decline reducer calls from UI prompts

**Phase 11 completion criteria:**
- Corpses visible in Location panel
- Looting works via context menu
- Resurrection flow complete (prompt → teleport → loot)
- Corpse Summon flow complete (prompt → merge → loot)
- 30-day decay functional
- `/spawncorpse` available for testing

</remaining_work>

<decisions_made>

1. **Unified confirmation table (Quick-93):** Merged PendingResurrect + PendingCorpseSummon into single PendingSpellCast table with `spellType` discriminator. Eliminates code duplication, better architecture for future spell confirmations.

2. **Class reassignment (Quick-93):** Moved Corpse Summon from Cleric to Necromancer/Summoner. Better thematic fit for entity-manipulation classes.

3. **Resource-gated vs time-gated (Quick-93):** Changed both spells from cooldown-based to flat mana costs (50 Resurrect, 60 Corpse Summon) with 0 cooldown and 10s cast time. Resource management is more interesting than time gates.

4. **Schema changes require --clear-database:** PendingSpellCast replaces two tables, so incremental migration not possible.

</decisions_made>

<blockers>

~~**SpacetimeDB 500 error:**~~ RESOLVED - Was caused by missing `entry` argument in `combatStateFor(key)` call at ensure_items.ts:764.

~~**Duplicate table definitions:**~~ RESOLVED - NpcAffinity and NpcDialogueOption were listed twice in schema() call, removed duplicates from lines 1491-1492.

**Current blocker:** Client bindings outdated
- **Status:** Actionable
- **Resolution:** Run `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb`
- **Impact:** Phase 11 Plan 03 cannot start until bindings are current

</blockers>

<context>

**Mental state:** Clean slate. Server error resolved, schema refactored, module published. Ready for UI work.

**Approach for Plan 03:**
1. Generate bindings first (blocking step)
2. Add "Points of Interest" section to LocationPanel.vue
3. Filter corpses by location and owner online status
4. Add corpse context menu with "Loot Corpse" option
5. Implement confirmation prompts for Resurrect/Corpse Summon
6. Wire up PendingSpellCast table subscriptions
7. Call accept/decline reducers from prompt UI

**Key files for Plan 03:**
- `src/components/LocationPanel.vue` - Add Points of Interest section
- `src/composables/useCorpses.ts` - Corpse filtering composable (create new)
- `src/components/ConfirmationPrompt.vue` - Generic prompt component (may already exist)
- `src/module_bindings/pending_spell_cast_table.ts` - Generated binding
- `src/module_bindings/accept_resurrect_reducer.ts` - Generated binding
- `src/module_bindings/decline_resurrect_reducer.ts` - Generated binding
- (similar for corpse_summon)

**Testing strategy:**
1. Use `/spawncorpse` to create test corpses
2. Verify corpses appear in Points of Interest
3. Test context menu looting
4. Test resurrection flow with two characters (one dead, one cleric)
5. Test corpse summon flow with necromancer/summoner

</context>

<next_action>

**First command when resuming:**

```bash
spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb
```

Then commit the generated bindings:

```bash
git add src/module_bindings/
git commit -m "feat(phase-11): regenerate bindings after Quick-93 schema changes"
```

Then execute Phase 11 Plan 03:

```bash
/gsd:execute-phase 11
```

**Alternative if Plan 03 doesn't exist yet:**

```bash
/gsd:plan-phase 11
```

Then execute after planning.

</next_action>
