---
phase: 11-death-corpse-system
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - spacetimedb/src/data/ability_catalog.ts
  - spacetimedb/src/helpers/combat.ts
  - src/App.vue
  - src/composables/useCharacters.ts
  - src/components/LocationGrid.vue
  - src/components/CharacterActionsPanel.vue
autonomous: false

must_haves:
  truths:
    - "Cleric has a Resurrect ability at level 6 that restores a dead ally to 50% HP/mana and removes ghost state"
    - "Death modal shows different text and buttons for ghost state (has corpse) vs simple death (no corpse)"
    - "Location panel shows corpse indicator when character's corpse is at current location"
    - "Ghost characters see a 'Retrieve Corpse' button when at their corpse location"
    - "Ghost characters see a 'Summon Corpse' button when at a bind stone location"
    - "Ghost characters have a visual indicator (translucent/grey styling) in the UI"
    - "Characters at a location can see other characters' corpses listed in the location panel"
  artifacts:
    - path: "spacetimedb/src/data/ability_catalog.ts"
      provides: "cleric_resurrect ability definition"
      contains: "cleric_resurrect"
    - path: "spacetimedb/src/helpers/combat.ts"
      provides: "Resurrect ability execution in executeAbility switch"
      contains: "cleric_resurrect"
    - path: "src/App.vue"
      provides: "Updated death modal with ghost state handling"
      contains: "isGhost"
    - path: "src/composables/useCharacters.ts"
      provides: "retrieveCorpse and summonCorpse reducer wrappers"
      contains: "retrieveCorpse"
    - path: "src/components/LocationGrid.vue"
      provides: "Corpse display in location"
      contains: "corpse"
  key_links:
    - from: "src/App.vue"
      to: "src/composables/useCharacters.ts"
      via: "retrieveCorpse and summonCorpse functions"
      pattern: "retrieveCorpse|summonCorpse"
    - from: "src/components/LocationGrid.vue"
      to: "module_bindings"
      via: "corpse table subscription"
      pattern: "tables\\.corpse"
    - from: "spacetimedb/src/helpers/combat.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "corpse table access for resurrect"
      pattern: "ctx\\.db\\.corpse"
---

<objective>
Add Cleric Resurrect ability and build frontend UI for death/ghost/corpse system.

Purpose: Complete the death system with the healer class resurrection ability and the client-side experience. Players see ghost state indicators, can retrieve or summon their corpse, and clerics can resurrect dead allies to prevent corpse runs.

Output: Cleric resurrect ability (level 6), updated death modal, ghost state UI, corpse retrieval/summon buttons, corpse indicators in location panel, republished module.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-death-corpse-system-corpse-mechanic-for-level-5-characters-equipped-items-stay-while-inventory-drops-to-corpse-corpse-retrieval-mechanics-death-penalties-and-resurrection/11-RESEARCH.md
@.planning/phases/11-death-corpse-system-corpse-mechanic-for-level-5-characters-equipped-items-stay-while-inventory-drops-to-corpse-corpse-retrieval-mechanics-death-penalties-and-resurrection/11-01-SUMMARY.md
@spacetimedb/src/data/ability_catalog.ts
@spacetimedb/src/helpers/combat.ts
@src/App.vue
@src/composables/useCharacters.ts
@src/components/LocationGrid.vue
@src/components/CharacterActionsPanel.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Cleric Resurrect ability and wire into combat system</name>
  <files>
    spacetimedb/src/data/ability_catalog.ts
    spacetimedb/src/helpers/combat.ts
  </files>
  <action>
    1. In `spacetimedb/src/data/ability_catalog.ts`, add `cleric_resurrect` to the ABILITIES object after `cleric_heal`:
       ```
       cleric_resurrect: {
         name: 'Resurrect',
         description: 'Channels divine power to restore life to a fallen ally, returning them to half health and mana.',
         className: 'cleric',
         resource: 'mana',
         level: 6n,
         power: 0n,
         cooldownSeconds: 600n,
         castSeconds: 6n,
         damageType: 'none' as DamageType,
       },
       ```
       This is a level 6 ability with a 10-minute cooldown and 6-second cast time. No damage, pure utility.

    2. In `spacetimedb/src/helpers/combat.ts`, add a case for `cleric_resurrect` in the `executeAbility` switch statement (before the `default` case):
       ```
       case 'cleric_resurrect': {
         if (!targetCharacter) throw new SenderError('Target required');
         if (targetCharacter.hp > 0n) {
           appendPrivateEvent(ctx, character.id, character.ownerUserId, 'ability', 'Target is not dead.');
           return;
         }
         // Check for corpse
         const corpse = [...ctx.db.corpse.by_character.filter(targetCharacter.id)][0];
         // Must be at same location as target
         if (character.locationId !== targetCharacter.locationId) {
           throw new SenderError('Target is too far away.');
         }
         // Restore to 50% HP/mana, clear ghost state
         const halfHp = targetCharacter.maxHp / 2n > 0n ? targetCharacter.maxHp / 2n : 1n;
         const halfMana = targetCharacter.maxMana / 2n;
         ctx.db.character.id.update({
           ...targetCharacter,
           hp: halfHp,
           mana: halfMana,
           isGhost: false,
         });
         // If corpse exists, clean up corpse items and delete corpse
         if (corpse) {
           for (const ci of ctx.db.corpseItem.by_corpse.filter(corpse.id)) {
             ctx.db.corpseItem.id.delete(ci.id);
           }
           ctx.db.corpse.id.delete(corpse.id);
         }
         // Update combat participant status if in combat
         if (combatId) {
           for (const p of ctx.db.combatParticipant.by_combat.filter(combatId)) {
             if (p.characterId === targetCharacter.id && p.status === 'dead') {
               ctx.db.combatParticipant.id.update({ ...p, status: 'active' });
               break;
             }
           }
         }
         appendPrivateEvent(ctx, targetCharacter.id, targetCharacter.ownerUserId, 'combat',
           `${character.name} resurrects you!`);
         appendPrivateEvent(ctx, character.id, character.ownerUserId, 'ability',
           `You resurrect ${targetCharacter.name}.`);
         logGroup('ability', `${character.name} resurrects ${targetCharacter.name}!`);
         return;
       }
       ```

    3. Publish module and regenerate bindings:
       - `spacetime publish uwr --clear-database -y --project-path spacetimedb`
       - `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb`
  </action>
  <verify>
    - `spacetime publish` succeeds.
    - Grep for `cleric_resurrect` in ability_catalog.ts and combat.ts confirms both exist.
    - `spacetime logs uwr` shows no errors.
    - Module bindings include the resurrect ability template row after seeding.
  </verify>
  <done>
    Cleric Resurrect ability defined at level 6, 600s cooldown, 6s cast.
    executeAbility handles resurrection: validates target is dead, restores 50% HP/mana, clears ghost, cleans up corpse, updates combat participant status.
    Module published and bindings regenerated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend ghost state UI, corpse indicators, and retrieval/summon controls</name>
  <files>
    src/App.vue
    src/composables/useCharacters.ts
    src/components/LocationGrid.vue
    src/components/CharacterActionsPanel.vue
  </files>
  <action>
    1. **useCharacters.ts** - Add corpse-related reducer wrappers:
       - Import `useReducer` for `retrieveCorpse` and `summonCorpse` reducers (they'll exist in generated bindings after Plan 01).
       - Add: `const retrieveCorpseReducer = useReducer(reducers.retrieveCorpse);`
       - Add: `const summonCorpseReducer = useReducer(reducers.summonCorpse);`
       - Create wrapper functions:
         ```
         const retrieveCorpse = () => {
           if (!connActive.value || !selectedCharacter.value) return;
           retrieveCorpseReducer({ characterId: selectedCharacter.value.id });
         };
         const summonCorpse = () => {
           if (!connActive.value || !selectedCharacter.value) return;
           summonCorpseReducer({ characterId: selectedCharacter.value.id });
         };
         ```
       - Return `retrieveCorpse` and `summonCorpse` from the composable.

    2. **App.vue** - Update death modal and add ghost state handling:
       - In the data/composable setup, destructure `retrieveCorpse` and `summonCorpse` from `useCharacters`.
       - Add `useTable(tables.corpse)` subscription: `const [corpses] = useTable(tables.corpse);` (import tables from module_bindings).
       - Add `useTable(tables.corpseItem)` subscription: `const [corpseItems] = useTable(tables.corpseItem);`
       - Add computed for character's corpse:
         ```
         const myCorpse = computed(() => {
           if (!selectedCharacter.value) return null;
           return corpses.value.find(c => c.characterId === selectedCharacter.value!.id) ?? null;
         });
         ```
       - Add computed for ghost state:
         ```
         const isGhost = computed(() => Boolean(selectedCharacter.value?.isGhost));
         ```
       - Add computed for whether character is at corpse location:
         ```
         const atCorpseLocation = computed(() => {
           if (!myCorpse.value || !selectedCharacter.value) return false;
           return selectedCharacter.value.locationId === myCorpse.value.locationId;
         });
         ```
       - Add computed for whether character is at a bind stone:
         ```
         const atBindStone = computed(() => {
           if (!selectedCharacter.value) return false;
           const loc = locations.value.find(l => l.id === selectedCharacter.value!.locationId);
           return Boolean(loc?.bindStone);
         });
         ```
       - Add computed for corpse item IDs (to filter inventory):
         ```
         const corpseItemIds = computed(() => new Set(corpseItems.value.map(ci => ci.itemInstanceId)));
         ```
       - Keep `showDeathModal` as `hp === 0n && !activeCombat` (unchanged - death modal only for dead, not ghost).
       - **Add ghost banner**: Add a new div rendered when `isGhost` is true, positioned at the top of the game area (below header):
         ```html
         <div v-if="isGhost" :style="ghostBannerStyle">
           <span>You are a ghost. Your belongings lie at your corpse.</span>
           <button v-if="atCorpseLocation" :style="styles.primaryButton" @click="retrieveCorpse">
             Retrieve Corpse
           </button>
           <button v-else-if="atBindStone" :style="styles.primaryButton" @click="summonCorpse">
             Summon Corpse
           </button>
           <span v-else>Travel to your corpse or a bind stone to recover.</span>
         </div>
         ```
       - Add `ghostBannerStyle` to styles: a fixed banner at top of game area with a dark translucent background, ghostly blue-grey text (#8899aa), centered, z-index above panels but below footer, padding 8px 16px.
       - **Ghost visual effect**: When `isGhost` is true, apply an opacity/desaturation CSS filter to the main game content (wrap the game content area in a div with `filter: saturate(0.3) opacity(0.8)` when ghost). This makes the world look washed out while in ghost form.
       - **Inventory filtering**: Pass `corpseItemIds` to the InventoryPanel or filter items in the inventory data. Items whose id is in `corpseItemIds` should be hidden from the inventory display.

    3. **LocationGrid.vue** - Show corpses at the current location:
       - Add a `corpses` prop: `corpses: Array<{ id: bigint; characterId: bigint; locationId: bigint }>`.
       - Also accept a `characters` prop (or use existing one) to look up character names.
       - In the template, add a CORPSES section (similar to PLAYERS section) that renders when there are corpses at the location:
         ```
         <div v-if="localCorpses.length > 0">
           <div :style="sectionHeader">CORPSES</div>
           <div v-for="corpse in localCorpses" :key="String(corpse.id)" :style="corpseTileStyle">
             {{ corpse.characterName }}'s corpse
           </div>
         </div>
         ```
       - Compute `localCorpses` by filtering corpses prop where `corpse.locationId === props.locationId`, then look up character name from characters data.
       - Style corpse tiles with a muted dark red/brown color (#664444 background, #aa8866 text) to distinguish from other elements.

    4. **App.vue** - Pass corpses and characters to LocationGrid:
       - Pass the `corpses` array to LocationGrid component: `:corpses="corpses"`.

    5. **CharacterActionsPanel.vue** - Disable actions for ghosts:
       - Add an `isGhost` prop (boolean).
       - If `isGhost`, disable gather, pull, and other action buttons. Show a disabled state indicating ghosts cannot perform these actions.

    Important notes:
    - Do NOT show ghost modal blocking the screen - use a banner instead so ghosts can still navigate.
    - CorpseItem links exist as a "marker" that items are in the corpse. On the client, filter inventory to exclude items that have a CorpseItem entry. This prevents ghost characters from seeing or using their dropped items.
  </action>
  <verify>
    - Frontend builds without errors: `npm run build` or `npx vite build`.
    - App.vue has ghost banner rendering.
    - LocationGrid.vue shows corpse indicators.
    - useCharacters.ts exports retrieveCorpse and summonCorpse.
    - CharacterActionsPanel disables actions for ghosts.
  </verify>
  <done>
    Ghost banner shows at top of screen with contextual Retrieve/Summon buttons.
    Location panel shows corpses at the current location.
    Ghost characters see desaturated world view.
    Inventory filters out items in corpse.
    Action buttons disabled for ghosts.
    Cleric Resurrect ability available at level 6.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of complete death and corpse system</name>
  <files>n/a</files>
  <action>
    Human verifies the complete death and corpse system end-to-end.
  </action>
  <what-built>
    Complete death and corpse system:
    - Level 5+ death creates corpse with inventory items (equipped items stay)
    - Ghost state with travel-to-corpse mechanic
    - Retrieve corpse at death location, summon corpse at bind stone
    - Ghost immunity to combat
    - Cleric Resurrect ability (level 6, 10 min CD, 6s cast)
    - Ghost banner UI with contextual buttons
    - Corpse indicators in location panel
    - Desaturated ghost visual effect
  </what-built>
  <how-to-verify>
    1. Create a level 1 character, die in combat, respawn - verify NO corpse is created, normal respawn
    2. Create or use a level 5+ character, note their inventory items
    3. Die in combat - verify death modal shows, click Respawn
    4. Verify character respawns at bind point as ghost (ghost banner visible, world looks desaturated)
    5. Verify inventory items are hidden (in corpse)
    6. Verify equipped items are still visible/equipped
    7. Verify ghost cannot initiate combat (try pulling an enemy)
    8. Travel to corpse location
    9. Verify "Retrieve Corpse" button appears in ghost banner
    10. Click Retrieve - verify items return to inventory, ghost state clears, world returns to normal
    11. Test summon corpse: die again, respawn as ghost, go to bind stone, click "Summon Corpse"
    12. Verify corpse is summoned and items retrieved
    13. Check location panel shows corpse indicators for dead characters
    14. (Optional) Test Cleric Resurrect if you have a level 6 cleric available
  </how-to-verify>
  <verify>Human completes verification checklist and approves or reports issues.</verify>
  <done>Human types "approved" confirming death and corpse system works correctly.</done>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Death at level 5+ creates corpse containing unequipped inventory items.
- Death at level 1-5 creates no corpse (existing behavior).
- Ghost state set on respawn when corpse exists.
- Ghost banner displays with correct contextual buttons.
- Retrieve corpse works at corpse location, summon works at bind stones.
- Ghost characters cannot enter combat.
- Cleric Resurrect restores 50% HP/mana, clears ghost, removes corpse.
- Corpse indicators visible in location panel.
- Inventory correctly hides items in corpse.
- Equipped items unaffected by death.
- Gold stays on character.
</verification>

<success_criteria>
- Full death -> ghost -> corpse retrieval flow works end-to-end.
- Cleric can resurrect dead allies (preventing corpse run).
- UI clearly communicates ghost state and available recovery options.
- No items lost or duplicated during death/retrieval cycle.
- Human approves the complete system.
</success_criteria>

<output>
After completion, create `.planning/phases/11-death-corpse-system-corpse-mechanic-for-level-5-characters-equipped-items-stay-while-inventory-drops-to-corpse-corpse-retrieval-mechanics-death-penalties-and-resurrection/11-02-SUMMARY.md`
</output>
