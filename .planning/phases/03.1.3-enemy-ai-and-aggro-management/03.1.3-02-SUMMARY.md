---
phase: 03.1.3-enemy-ai-and-aggro-management
plan: 02
subsystem: combat
tags: [enemy-ai, leashing, combat-state-awareness, intelligent-targeting]
dependencies:
  requires:
    - 03.1.3-01-PLAN.md (role-based threat system)
  provides:
    - Combat-state-aware AI scoring (healers prioritize low-HP allies, buffers buff early)
    - Leashing mechanics (enemies evade and reset when all players flee/die)
  affects:
    - Enemy AI decision-making in combat_loop
    - Combat exploit prevention (no more kiting)
tech_stack:
  added: []
  patterns:
    - Dynamic scoring bonuses based on combat state (HP%, combat age, threat)
    - Leash check with spawn reconstruction and full HP reset
key_files:
  created: []
  modified:
    - spacetimedb/src/reducers/combat.ts (AI scoring + leash check)
decisions:
  - Heal priority: +100 score when ally below 30% HP, +40 below 60%, +80 self-preservation
  - Buff priority: +50 score in first 10 seconds, +20 in first 30 seconds
  - Debuff priority: +25 score when targeting highest-threat player
  - Leash triggers on activeParticipants.length === 0 (all fled or dead between ticks)
  - Enemies reset to full HP and spawn returns to 'available' state
  - Evade message "The enemies lose interest and return to their posts."
  - Leash check runs BEFORE any combat processing (early-exit pattern)
metrics:
  duration: 4min
  tasks_completed: 2
  files_modified: 1
  commits: 2
  completed_date: 2026-02-13
---

# Phase 03.1.3 Plan 02: Combat-State-Aware AI and Leashing

**One-liner:** Enemy healers prioritize dying allies (+100 score), buffers buff early in combat (+50 score), and enemies evade to full HP when all players flee (anti-kiting leash)

---

## What Was Built

### Task 1: Combat-State-Aware AI Scoring Bonuses
Enhanced enemy AI ability scoring with dynamic bonuses based on combat state.

**Enhanced scoring logic in combat_loop (combat.ts lines 1601-1660):**

**Heal priority:**
- +100 score when any ally below 30% HP
- +40 score when any ally below 60% HP
- +80 score for self-preservation when caster below 30% HP
- Ally HP calculation uses full HP% check across all living combat enemies

**Buff priority:**
- +50 score in first 10 seconds of combat (combatAge < 10_000_000 microseconds)
- +20 score in first 30 seconds of combat (combatAge < 30_000_000 microseconds)
- Uses `combat.createdAt.microsSinceUnixEpoch` to calculate combat age

**Debuff priority:**
- +25 score when targeting the highest-threat player
- Finds highest aggro entry for current enemy, compares to current target
- Encourages debuffing tanks (slowdown the threat leader)

**Static bonuses (preserved):**
- +30 for DoT abilities
- +20 for lowest_hp targeting
- +10 for aggro targeting
- Jitter randomness still applies on top of all bonuses

**Commit:** ddaabdd

---

### Task 2: Leashing Mechanics for Combat Reset
Added early-exit leash check to prevent kiting exploits by resetting enemies when all players flee.

**Leash check in combat_loop (combat.ts lines 1462-1522):**

**Trigger condition:**
- `activeParticipants.length === 0` at start of combat_loop tick
- All participants either dead or fled (left combat between ticks)

**Reset sequence:**
1. Reset all enemies to full HP (using enemyTemplate.maxHp)
2. Reconstruct spawn members from surviving enemies
3. Update spawn state to 'available' and clear lockedCombatId
4. Log evade message to all participants (including dead ones)
5. Clean up combat artifacts via clearCombatArtifacts
6. Mark encounter as 'resolved'
7. Early return (no further combat processing)

**Anti-exploit design:**
- Enemies fully heal on leash (no partial-damage kiting)
- Spawn immediately available for re-engagement
- Works for both "all fled" and "all died between ticks" scenarios
- Complements existing TPK check at end of tick (handles mid-tick deaths)

**Commit:** 813bf65

---

## Deviations from Plan

None — plan executed exactly as written.

---

## Verification

1. `spacetime build --project-path spacetimedb` compiles without errors ✓
2. Heal abilities score +100 when ally below 30% HP ✓
3. Buff abilities score +50 in first 10 seconds of combat ✓
4. Debuff abilities score +25 when targeting highest-threat player ✓
5. Leash check triggers when `activeParticipants.length === 0` ✓
6. Leashed enemies reset to full HP and spawn returns to 'available' ✓
7. Evade message logged to all combat participants ✓

**All verification checks passed.**

---

## Key Decisions

1. **Heal priority thresholds: 30% and 60%** — Below 30% is "urgent healing" (+100 score, effectively guaranteed top priority). Below 60% is "moderate concern" (+40 score). Self-preservation at 30% gets +80 (slightly less than ally-heal urgency).

2. **Buff priority windows: 10s and 30s** — First 10 seconds is "opening buff window" (+50 strong priority). First 30 seconds is "setup phase" (+20 moderate priority). After 30s, buffs compete on base weight only.

3. **Debuff targeting bonus: +25** — Modest bonus to encourage debuffing high-threat targets (tanks) without overriding other priorities. Debuffers still use their base targeting rules (lowest_hp, random, etc.) but get a small boost when hitting the tank.

4. **Leash check placement: early-exit at top of tick** — Runs BEFORE enemy abilities, auto-attacks, or any combat processing. If all participants gone, enemies immediately evade (no partial-tick processing).

5. **Evade message wording** — "The enemies lose interest and return to their posts." Clear feedback that enemies reset. Sent to all participants (including dead ones who may have contributed to combat).

6. **Spawn reconstruction from combat enemies** — When enemies evade, spawn members are rebuilt from the enemyRoleTemplateId of surviving combat enemies. Preserves the exact composition that was fighting (no random role re-roll).

---

## Self-Check: PASSED

**Files exist:**
```
FOUND: spacetimedb/src/reducers/combat.ts
```

**Commits exist:**
```
FOUND: ddaabdd
FOUND: 813bf65
```

**Content verification:**
- Heal priority logic confirmed in combat.ts (lines ~1613-1640)
- Buff priority logic confirmed in combat.ts (lines ~1643-1650)
- Debuff priority logic confirmed in combat.ts (lines ~1653-1660)
- Leash check confirmed in combat.ts (lines ~1462-1522)
- "lose interest and return to their posts" message confirmed
- activeParticipants.length === 0 check confirmed
- Enemy HP reset to tmpl.maxHp confirmed
- Spawn state 'available' update confirmed

All claims verified.

---

## Impact

**Before this plan:**
- Enemy healers used static scoring (didn't prioritize healing dying allies)
- Enemy buffers used static scoring (didn't prioritize buffs at combat start)
- Enemy debuffers used static scoring (no threat-based targeting)
- Enemies could be kited indefinitely (no leash, remained damaged)
- Combat exploits: pull, flee, return for partial-HP kills

**After this plan:**
- Enemy healers urgently heal allies below 30% HP (+100 score makes it top priority)
- Enemy buffers strongly prioritize buffs in first 10 seconds (+50 score)
- Enemy debuffers prefer targeting high-threat players like tanks (+25 score)
- Enemies evade and reset to full HP when all players flee
- Spawn immediately available for re-engagement (no "stuck in combat" state)
- Kiting exploit eliminated (enemies heal to full on reset)

**Behavioral changes:**
- Healer enemies now feel intelligent (actually respond to ally HP crisis)
- Buffer enemies now feel tactical (buff early, not randomly mid-combat)
- Debuffer enemies now feel targeted (slow down the tank, not random DPS)
- Combat feels more "fair" (no exploit-friendly partial damage kiting)

**Next steps:**
- Plan 03: Taunt mechanics and aggro transfer abilities (if planned)
- Playtesting: Verify heal priority threshold tuning (30%/60% may need adjustment)
- Playtesting: Verify buff priority window tuning (10s/30s may need adjustment)
- Future: Add "kiting detection" variant that triggers leash when combat moves too far from spawn location (current version only handles "all fled" scenario)

---

## Commits

| Hash    | Message                                                      |
| ------- | ------------------------------------------------------------ |
| ddaabdd | feat(03.1.3-02): add combat-state-aware AI scoring bonuses   |
| 813bf65 | feat(03.1.3-02): add leashing mechanics for combat reset     |
