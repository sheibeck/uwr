---
phase: 03.1.3-enemy-ai-and-aggro-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/data/class_stats.ts
  - spacetimedb/src/data/combat_scaling.ts
  - spacetimedb/src/reducers/combat.ts
  - spacetimedb/src/index.ts
autonomous: true
must_haves:
  truths:
    - "Tank abilities (warrior_slam, warrior_crushing_blow, paladin_holy_strike) generate more threat per damage than DPS abilities"
    - "Healing abilities generate threat split across all enemies in combat"
    - "Dead characters' aggro entries are cleaned up so enemies retarget living players"
    - "Auto-attack threat is multiplied by role-based modifier (tanks 1.5x, healers 0.5x)"
  artifacts:
    - path: "spacetimedb/src/data/class_stats.ts"
      provides: "TANK_CLASSES and HEALER_CLASSES role sets"
      contains: "TANK_CLASSES"
    - path: "spacetimedb/src/data/combat_scaling.ts"
      provides: "Threat multiplier constants"
      contains: "TANK_THREAT_MULTIPLIER"
    - path: "spacetimedb/src/reducers/combat.ts"
      provides: "Role-based auto-attack threat and death aggro cleanup"
      contains: "TANK_CLASSES"
    - path: "spacetimedb/src/index.ts"
      provides: "Threat multipliers on ability damage and healing threat generation"
      contains: "healingThreat"
  key_links:
    - from: "spacetimedb/src/data/class_stats.ts"
      to: "spacetimedb/src/reducers/combat.ts"
      via: "TANK_CLASSES and HEALER_CLASSES imports"
      pattern: "TANK_CLASSES\\.has"
    - from: "spacetimedb/src/data/combat_scaling.ts"
      to: "spacetimedb/src/reducers/combat.ts"
      via: "Threat multiplier constant imports"
      pattern: "TANK_THREAT_MULTIPLIER|HEALER_THREAT_MULTIPLIER"
    - from: "spacetimedb/src/data/combat_scaling.ts"
      to: "spacetimedb/src/index.ts"
      via: "Healing threat constant import"
      pattern: "HEALING_THREAT_PERCENT"
---

<objective>
Add role-based threat multipliers to the aggro system and clean up dead character aggro entries.

Purpose: Currently all characters generate threat 1:1 with damage dealt, making tanks unable to hold aggro against DPS classes. Healers generate zero threat, meaning enemies never target them. Dead characters retain stale aggro entries that can cause enemies to "target" dead players. These three gaps break the tank/healer/DPS trinity that group combat requires.

Output: Tank classes generate 1.5x threat per damage (auto-attacks and abilities), healer classes generate 0.5x threat per damage, healing generates threat split across all enemies, and dead character aggro entries are removed.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1.3-enemy-ai-and-aggro-management/03.1.3-RESEARCH.md
@spacetimedb/src/data/class_stats.ts
@spacetimedb/src/data/combat_scaling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role classification and threat multiplier constants</name>
  <files>spacetimedb/src/data/class_stats.ts, spacetimedb/src/data/combat_scaling.ts</files>
  <action>
In `class_stats.ts`, add two new exported `Set<string>` constants after the existing `MANA_CLASSES` set:

```typescript
export const TANK_CLASSES = new Set([
  'warrior',
  'paladin',
]);

export const HEALER_CLASSES = new Set([
  'cleric',
  'druid',
  'shaman',
]);
```

Tank classes: warrior and paladin (plate wearers with high-threat abilities like warrior_slam's existing threatBonus: 10n).
Healer classes: cleric, druid, shaman (all WIS-primary classes with healing abilities).
Other classes (rogue, wizard, necromancer, ranger, beastmaster, monk, enchanter, summoner, spellblade, reaver, bard) remain at baseline 1.0x threat.

In `combat_scaling.ts`, add three new exported constants after `ENEMY_LEVEL_POWER_SCALING`:

```typescript
/** Tank threat multiplier (150n = 1.5x on 100n scale) */
export const TANK_THREAT_MULTIPLIER = 150n;

/** Healer threat multiplier (50n = 0.5x on 100n scale) */
export const HEALER_THREAT_MULTIPLIER = 50n;

/** Healing threat as percentage of healing done (50n = 50% on 100n scale) */
export const HEALING_THREAT_PERCENT = 50n;
```

These follow the same 100n-scale pattern used by existing constants (AOE_DAMAGE_MULTIPLIER = 65n, DEBUFF_POWER_COST_PERCENT = 25n). The multiplier values come from the research recommendation: tank 1.5-2x (starting conservative at 1.5x), healer 0.5x, healing 50% of actual healing done split across all enemies.
  </action>
  <verify>
Run `spacetime build --project-path spacetimedb` to verify no compilation errors. Grep for `TANK_CLASSES` in class_stats.ts and `TANK_THREAT_MULTIPLIER` in combat_scaling.ts to confirm exports exist.
  </verify>
  <done>
TANK_CLASSES contains warrior and paladin. HEALER_CLASSES contains cleric, druid, shaman. TANK_THREAT_MULTIPLIER = 150n, HEALER_THREAT_MULTIPLIER = 50n, HEALING_THREAT_PERCENT = 50n all exported from combat_scaling.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement threat multipliers and dead-character aggro cleanup</name>
  <files>spacetimedb/src/reducers/combat.ts, spacetimedb/src/index.ts</files>
  <action>
**Part A: Auto-attack threat multipliers in combat.ts**

Import the new constants at the top of `combat.ts`:
```typescript
import { TANK_CLASSES, HEALER_CLASSES } from '../data/class_stats';
import { TANK_THREAT_MULTIPLIER, HEALER_THREAT_MULTIPLIER, HEALING_THREAT_PERCENT } from '../data/combat_scaling';
```

Locate the auto-attack aggro update block (around line 1707-1713, the code inside `if (finalDamage > 0n)` where `entry.value` is updated with `entry.value + finalDamage`). Change the threat update to apply role-based multiplier:

```typescript
if (finalDamage > 0n) {
  const className = character.className?.toLowerCase() ?? '';
  const threatMult = TANK_CLASSES.has(className) ? TANK_THREAT_MULTIPLIER
    : HEALER_CLASSES.has(className) ? HEALER_THREAT_MULTIPLIER : 100n;
  const threat = (finalDamage * threatMult) / 100n;
  for (const entry of ctx.db.aggroEntry.by_combat.filter(combat.id)) {
    if (entry.characterId === character.id && entry.enemyId === currentEnemy.id) {
      ctx.db.aggroEntry.id.update({ ...entry, value: entry.value + threat });
      break;
    }
  }
}
```

**Part B: Dead character aggro cleanup in combat.ts**

In the combat_loop reducer, right after the block that marks dead participants (around lines 1440-1447, the `for (const p of participants)` loop that checks `character.hp === 0n` and updates participant status to 'dead'), add aggro cleanup for newly dead characters:

```typescript
// Clean up aggro entries for dead characters so enemies retarget
if (character && character.hp === 0n) {
  ctx.db.combatParticipant.id.update({ ...p, status: 'dead' });
  clearCharacterEffectsOnDeath(ctx, character);
  // Remove all aggro entries for this dead character
  for (const entry of ctx.db.aggroEntry.by_combat.filter(combat.id)) {
    if (entry.characterId === character.id && !entry.petId) {
      ctx.db.aggroEntry.id.delete(entry.id);
    }
  }
}
```

This ensures enemies immediately retarget to the next highest-threat living player instead of "attacking" a dead character.

**Part C: Ability threat multipliers in index.ts**

In `index.ts`, find the `executeAbilityAction` function's `applyDamage` inner function. Locate the existing aggro update block (around line 2209-2217) where `entry.value` is updated with `entry.value + totalDamage + (options?.threatBonus ?? 0n)`. Import the needed constants at the top of `index.ts` (or in the registerCombat function scope where combat_scaling is already imported):

```typescript
import { TANK_CLASSES, HEALER_CLASSES } from './data/class_stats';
import { TANK_THREAT_MULTIPLIER, HEALER_THREAT_MULTIPLIER, HEALING_THREAT_PERCENT } from './data/combat_scaling';
```

Update the ability damage aggro line to apply role-based multiplier:

```typescript
const className = character.className?.toLowerCase() ?? '';
const threatMult = TANK_CLASSES.has(className) ? TANK_THREAT_MULTIPLIER
  : HEALER_CLASSES.has(className) ? HEALER_THREAT_MULTIPLIER : 100n;
const threat = (totalDamage * threatMult) / 100n + (options?.threatBonus ?? 0n);
ctx.db.aggroEntry.id.update({ ...entry, value: entry.value + threat });
```

Note: The existing `options?.threatBonus` for warrior_slam (10n) and warrior_crushing_blow (5n) is ADDITIVE on top of the multiplied base — this preserves their extra-high-threat nature while the 1.5x multiplier applies to their base damage threat too.

Also update the AoE ability aggro update (around line 2140-2148) with the same multiplier logic.

**Part D: Healing threat in index.ts**

In the `applyHeal` function (around line 2287), after the healing is applied and logged, add healing threat generation. After the line `logGroup('heal', message);` (end of applyHeal), add:

```typescript
// Healing generates threat: 50% of healing done, split across all enemies
if (combatId) {
  const healingThreat = (scaledAmount * HEALING_THREAT_PERCENT) / 100n;
  if (healingThreat > 0n) {
    const enemiesInCombat = [...ctx.db.combatEnemy.by_combat.filter(combatId)]
      .filter((e: any) => e.currentHp > 0n);
    if (enemiesInCombat.length > 0) {
      const threatPerEnemy = healingThreat / BigInt(enemiesInCombat.length);
      if (threatPerEnemy > 0n) {
        for (const en of enemiesInCombat) {
          for (const entry of ctx.db.aggroEntry.by_combat.filter(combatId)) {
            if (entry.characterId === character.id && entry.enemyId === en.id) {
              ctx.db.aggroEntry.id.update({ ...entry, value: entry.value + threatPerEnemy });
              break;
            }
          }
        }
      }
    }
  }
}
```

This uses the `combatId` already available in the `executeAbilityAction` closure scope. Healing threat is 50% of actual healing done (HEALING_THREAT_PERCENT = 50n), split evenly across all living enemies. A cleric healing for 20 HP generates 10 threat total, split 5/5 across 2 enemies — enough to put healers on the threat table but not enough to surpass tanks (who generate 1.5x their damage as threat).
  </action>
  <verify>
Run `spacetime build --project-path spacetimedb` to verify compilation. Grep for `TANK_THREAT_MULTIPLIER` in both combat.ts and index.ts to confirm imports. Grep for `healingThreat` in index.ts to confirm healing threat generation. Grep for `aggroEntry.id.delete` in combat.ts to confirm dead character cleanup.
  </verify>
  <done>
Auto-attack damage generates threat at role-modified rate (1.5x for tanks, 0.5x for healers, 1.0x for DPS). Ability damage uses same role multiplier plus additive threatBonus. Healing generates 50% threat split across all living enemies. Dead characters' aggro entries are deleted immediately upon death in combat_loop.
  </done>
</task>

</tasks>

<verification>
1. `spacetime build --project-path spacetimedb` compiles without errors
2. TANK_CLASSES contains exactly warrior and paladin
3. HEALER_CLASSES contains exactly cleric, druid, shaman
4. TANK_THREAT_MULTIPLIER = 150n, HEALER_THREAT_MULTIPLIER = 50n, HEALING_THREAT_PERCENT = 50n
5. Auto-attack aggro in combat.ts uses role multiplier (not raw damage)
6. Ability aggro in index.ts uses role multiplier (not raw damage)
7. Healing generates threat in applyHeal function
8. Dead character aggro entries deleted in combat_loop
</verification>

<success_criteria>
The aggro system now supports role-based threat: tanks generate 50% more threat per damage, healers generate 50% less threat per damage but DO generate threat from healing (50% of healing done, split across enemies). Dead characters are removed from the threat table immediately. The tank/healer/DPS trinity is mechanically functional.
</success_criteria>

<output>
After completion, create `.planning/phases/03.1.3-enemy-ai-and-aggro-management/03.1.3-01-SUMMARY.md`
</output>
