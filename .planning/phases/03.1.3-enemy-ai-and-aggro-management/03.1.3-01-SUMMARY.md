---
phase: 03.1.3-enemy-ai-and-aggro-management
plan: 01
subsystem: combat
tags: [aggro, threat, tanks, healers, combat-balance]
dependencies:
  requires:
    - 03.1.2-01-PLAN.md (enemy combat balance foundation)
  provides:
    - Role-based threat system (tank/healer/DPS trinity)
    - Dead character aggro cleanup
  affects:
    - Combat enemy targeting behavior
    - Group combat dynamics
tech_stack:
  added: []
  patterns:
    - Role-based multipliers on 100n scale
    - Healing threat split across all enemies
key_files:
  created: []
  modified:
    - spacetimedb/src/data/class_stats.ts (TANK_CLASSES, HEALER_CLASSES)
    - spacetimedb/src/data/combat_scaling.ts (threat multiplier constants)
    - spacetimedb/src/reducers/combat.ts (auto-attack threat + dead cleanup)
    - spacetimedb/src/index.ts (ability threat + healing threat)
decisions:
  - Tank threat multiplier: 150n (1.5x) — conservative starting point, can tune up to 2.0x if needed
  - Healer threat multiplier: 50n (0.5x) — low damage threat but generates healing threat
  - Healing threat: 50% of healing done, split across all living enemies
  - threatBonus is ADDITIVE on top of role multiplier (warrior_slam keeps extra-high threat)
  - Dead character aggro cleanup: immediate deletion in combat_loop, not deferred
metrics:
  duration: 3min
  tasks_completed: 2
  files_modified: 4
  commits: 2
  completed_date: 2026-02-13
---

# Phase 03.1.3 Plan 01: Role-Based Threat Multipliers and Aggro Cleanup

**One-liner:** Tank/healer/DPS trinity threat system with role-based multipliers (tanks 1.5x, healers 0.5x) and healing threat generation

---

## What Was Built

### Task 1: Role Classification and Threat Constants
Added role sets and threat multiplier constants to enable role-based threat calculations.

**Files modified:**
- `spacetimedb/src/data/class_stats.ts`
  - Added `TANK_CLASSES` set (warrior, paladin)
  - Added `HEALER_CLASSES` set (cleric, druid, shaman)
- `spacetimedb/src/data/combat_scaling.ts`
  - Added `TANK_THREAT_MULTIPLIER = 150n` (1.5x on 100n scale)
  - Added `HEALER_THREAT_MULTIPLIER = 50n` (0.5x on 100n scale)
  - Added `HEALING_THREAT_PERCENT = 50n` (50% on 100n scale)

**Commit:** 925159d

### Task 2: Threat Multipliers and Dead Character Cleanup
Implemented role-based threat multipliers on auto-attacks, abilities, and healing, plus aggro cleanup for dead characters.

**Part A: Auto-attack threat (combat.ts)**
- Imported role sets and threat multiplier constants
- Modified auto-attack aggro update to apply role multiplier
- Tanks generate 1.5x threat per damage
- Healers generate 0.5x threat per damage
- DPS classes generate 1.0x threat per damage

**Part B: Dead character aggro cleanup (combat.ts)**
- Added aggro entry deletion in combat_loop when character dies
- Enemies immediately retarget to next highest-threat living player
- Prevents stale "targeting dead players" behavior

**Part C: Ability threat multipliers (index.ts)**
- Updated single-target ability aggro to apply role multiplier
- Updated AoE ability aggro to apply role multiplier per target
- threatBonus (warrior_slam +10n, warrior_crushing_blow +5n) remains additive on top of multiplied base

**Part D: Healing threat generation (index.ts)**
- Added healing threat in `applyHeal` function
- Healing generates 50% of healing done as total threat
- Threat split evenly across all living enemies in combat
- Example: 20 HP healing → 10 threat total → 5/5 split across 2 enemies

**Commit:** 5acd565

---

## Deviations from Plan

None — plan executed exactly as written.

---

## Verification

1. `spacetime build --project-path spacetimedb` compiles without errors ✓
2. TANK_CLASSES contains exactly warrior and paladin ✓
3. HEALER_CLASSES contains exactly cleric, druid, shaman ✓
4. TANK_THREAT_MULTIPLIER = 150n, HEALER_THREAT_MULTIPLIER = 50n, HEALING_THREAT_PERCENT = 50n ✓
5. Auto-attack aggro in combat.ts uses role multiplier (not raw damage) ✓
6. Ability aggro in index.ts uses role multiplier (not raw damage) ✓
7. Healing generates threat in applyHeal function ✓
8. Dead character aggro entries deleted in combat_loop ✓

**All verification checks passed.**

---

## Key Decisions

1. **Tank threat multiplier: 150n (1.5x)** — Started at conservative end of 1.5-2x range. If tanks struggle to hold aggro against DPS in playtesting, can increase to 175n or 200n.

2. **Healer threat multiplier: 50n (0.5x)** — Low damage threat, but healers now generate significant threat from healing (50% of healing done).

3. **Healing threat: 50% split across enemies** — Puts healers on the threat table without surpassing tanks. A cleric healing 20 HP generates 10 total threat (5/5 across 2 enemies) vs a warrior dealing 15 damage generating 22.5 threat (1.5x multiplier).

4. **threatBonus is additive** — warrior_slam's +10n threatBonus is added AFTER the 1.5x multiplier, preserving its extra-high-threat nature. Total threat = (damage * 1.5x) + 10n.

5. **Dead character cleanup is immediate** — Aggro entries deleted in combat_loop when character marked dead, not deferred to end-of-combat cleanup. Ensures enemies retarget immediately.

---

## Self-Check: PASSED

**Files exist:**
```
FOUND: spacetimedb/src/data/class_stats.ts
FOUND: spacetimedb/src/data/combat_scaling.ts
FOUND: spacetimedb/src/reducers/combat.ts
FOUND: spacetimedb/src/index.ts
```

**Commits exist:**
```
FOUND: 925159d
FOUND: 5acd565
```

**Content verification:**
- TANK_CLASSES export confirmed in class_stats.ts
- TANK_THREAT_MULTIPLIER export confirmed in combat_scaling.ts
- Role multiplier logic confirmed in combat.ts auto-attack section
- Role multiplier logic confirmed in index.ts ability sections
- healingThreat variable confirmed in index.ts applyHeal
- aggroEntry.id.delete confirmed in combat.ts combat_loop

All claims verified.

---

## Impact

**Before this plan:**
- All characters generated threat 1:1 with damage dealt
- Tanks unable to hold aggro against DPS classes
- Healers generated zero threat (enemies never targeted them)
- Dead characters retained stale aggro entries (enemies "targeted" dead players)

**After this plan:**
- Tanks generate 1.5x threat per damage (auto-attacks and abilities)
- Healers generate 0.5x threat per damage + 50% of healing done
- DPS classes generate 1.0x threat (baseline)
- Dead characters' aggro entries immediately deleted
- Tank/healer/DPS trinity mechanically functional

**Next steps:**
- Plan 02: Enemy AI targeting intelligence (prioritize healers/casters, avoid tanks)
- Plan 03: Aggro transfer abilities (taunt, misdirection)
- Playtesting: May need to tune tank multiplier higher if aggro holding is weak

---

## Commits

| Hash    | Message                                                                 |
| ------- | ----------------------------------------------------------------------- |
| 925159d | feat(03.1.3-01): add role classification and threat multiplier constants |
| 5acd565 | feat(03.1.3-01): implement threat multipliers and dead-character aggro cleanup |
