---
phase: 03.1.1-combat-balance-part-2
plan: 01
subsystem: combat-balance
tags: [metadata, scaling, abilities, infrastructure]
completed: 2026-02-13

dependencies:
  requires: []
  provides:
    - DoT/HoT/AoE/Debuff scaling constants
    - Extended ability catalog metadata
  affects:
    - spacetimedb/src/data/combat_scaling.ts
    - spacetimedb/src/data/ability_catalog.ts

tech-stack:
  added: []
  patterns:
    - Declarative metadata for periodic effects
    - Power budget split approach

key-files:
  created: []
  modified:
    - spacetimedb/src/data/combat_scaling.ts (3 new constants)
    - spacetimedb/src/data/ability_catalog.ts (interface + 9 abilities annotated)

decisions:
  - DoT/HoT use 50% scaling rate modifier (prevents double-dipping)
  - AoE abilities deal 65% damage per target
  - Debuffs cost 25% of ability power budget
  - All debuff types cost the same power budget
  - Debuff magnitude is stat-independent (fixed values)

metrics:
  duration: 3min
  tasks: 3
  files: 2
  commits: 2
---

# Phase 3.1.1 Plan 01: Combat Balance Metadata Foundation Summary

**One-liner:** Added DoT/HoT/AoE/debuff metadata infrastructure with power budget constants (50% DoT scaling, 65% AoE damage, 25% debuff cost) and annotated 9 abilities across 5 effect types.

## Context

This plan establishes the declarative metadata foundation for periodic effects (DoT/HoT), multi-target abilities (AoE), and debuffs without changing combat logic. The metadata enables Plan 02 to implement power budget splitting and reduced scaling for these effect types.

## What Was Built

### 1. Scaling Constants (combat_scaling.ts)

Added three new exported constants after existing scaling values:

- **DOT_SCALING_RATE_MODIFIER = 50n**: DoT/HoT effects use 50% of direct damage scaling rate to prevent double-dipping (since they tick multiple times)
- **AOE_DAMAGE_MULTIPLIER = 65n**: AoE abilities deal 65% damage per target (balances multi-target vs single-target damage)
- **DEBUFF_POWER_COST_PERCENT = 25n**: Abilities with debuffs allocate 25% of their power budget to the debuff effect

All constants include JSDoc comments documenting user decisions and design rationale.

### 2. Extended Ability Catalog (ability_catalog.ts)

**AbilityMetadata Interface:**
Added TypeScript interface defining optional metadata fields:

- **DoT metadata**: `dotPowerSplit` (0-1 fraction), `dotDuration` (ticks)
- **HoT metadata**: `hotPowerSplit` (0-1 fraction), `hotDuration` (ticks)
- **Debuff metadata**: `debuffType` (string), `debuffMagnitude` (bigint), `debuffDuration` (ticks)
- **AoE metadata**: `aoeTargets` ('all_enemies' | 'all_allies' | 'all_party')

**Annotated Abilities:**

DoT abilities (3):
- `rogue_shadow_cut`: 40% DoT split, 2 ticks (6 seconds)
- `rogue_bleed`: 60% DoT split, 3 ticks (9 seconds)
- `necromancer_plague_spark`: 50% DoT split, 3 ticks (9 seconds)

HoT abilities (2):
- `shaman_spirit_mender`: 50% HoT split, 2 ticks (6 seconds)
- `druid_natures_gift`: 60% HoT split, 3 ticks (9 seconds)

Debuff abilities (2):
- `shaman_hex`: AC bonus debuff, -2 magnitude, 3 ticks (9 seconds)
- `enchanter_slow`: Slow debuff, -3 magnitude, 3 ticks (9 seconds)

AoE abilities (2):
- `warrior_cleave`: Targets all enemies
- `paladin_devotion`: Targets all party members

### 3. Module Publication

Successfully published module to local SpacetimeDB and regenerated TypeScript client bindings. No schema table changes (constants only), so no --clear-database flag required.

## Deviations from Plan

None - plan executed exactly as written.

## Decisions Made

1. **DoT/HoT scaling reduction**: 50% modifier balances multi-tick effects vs single-hit damage
2. **AoE damage multiplier**: 65% per target (starting point for playtesting, can tune 60-70% range)
3. **Debuff power cost**: 25% unified cost for all debuff types (simplifies balance)
4. **Stat-independent debuffs**: Fixed magnitude values prevent scaling issues
5. **Metadata as optional fields**: Preserves backward compatibility with existing abilities

## Performance Notes

- Module published successfully with no breaking changes
- Client bindings regenerated (280+ files updated)
- Circular dependency warning (combat_scaling.ts â†” class_stats.ts) is expected and benign

## Next Steps

Plan 02 will implement the power budget split logic using these metadata fields:
- Apply `dotPowerSplit` to calculate direct damage vs periodic damage
- Use `DOT_SCALING_RATE_MODIFIER` when calculating per-tick damage
- Apply `AOE_DAMAGE_MULTIPLIER` when targeting multiple enemies
- Reduce ability power by `DEBUFF_POWER_COST_PERCENT` when debuff metadata present

## Files Changed

**spacetimedb/src/data/combat_scaling.ts** (+21 lines)
- Added DOT_SCALING_RATE_MODIFIER constant (50n)
- Added AOE_DAMAGE_MULTIPLIER constant (65n)
- Added DEBUFF_POWER_COST_PERCENT constant (25n)

**spacetimedb/src/data/ability_catalog.ts** (+46 lines)
- Added AbilityMetadata interface with optional DoT/HoT/debuff/AoE fields
- Annotated 9 abilities with metadata (3 DoT, 2 HoT, 2 debuff, 2 AoE)

## Commits

- `60050fb`: feat(03.1.1-01): add DoT/HoT/AoE/debuff scaling constants
- `e90d8f0`: feat(03.1.1-01): extend ability catalog with DoT/HoT/debuff/AoE metadata

## Self-Check: PASSED

All created constants exist:
```bash
$ grep -c "DOT_SCALING_RATE_MODIFIER" spacetimedb/src/data/combat_scaling.ts
1
$ grep -c "AOE_DAMAGE_MULTIPLIER" spacetimedb/src/data/combat_scaling.ts
1
$ grep -c "DEBUFF_POWER_COST_PERCENT" spacetimedb/src/data/combat_scaling.ts
1
```

All ability annotations exist:
```bash
$ grep "dotPowerSplit" spacetimedb/src/data/ability_catalog.ts
    dotPowerSplit: 0.4,
    dotPowerSplit: 0.6,
    dotPowerSplit: 0.5,

$ grep "hotPowerSplit" spacetimedb/src/data/ability_catalog.ts
    hotPowerSplit: 0.5,
    hotPowerSplit: 0.6,

$ grep "aoeTargets" spacetimedb/src/data/ability_catalog.ts
    aoeTargets: 'all_enemies',
    aoeTargets: 'all_party',

$ grep "debuffType" spacetimedb/src/data/ability_catalog.ts
    debuffType: 'ac_bonus',
    debuffType: 'slow',
```

All commits exist:
```bash
$ git log --oneline | grep "60050fb"
60050fb feat(03.1.1-01): add DoT/HoT/AoE/debuff scaling constants

$ git log --oneline | grep "e90d8f0"
e90d8f0 feat(03.1.1-01): extend ability catalog with DoT/HoT/debuff/AoE metadata
```

Module published successfully and client bindings regenerated.
