---
phase: 03.1.1-combat-balance-part-2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/data/ability_catalog.ts
  - spacetimedb/src/data/combat_scaling.ts
autonomous: true

must_haves:
  truths:
    - "DOT_SCALING_RATE_MODIFIER constant exists in combat_scaling.ts (value: 50n)"
    - "AOE_DAMAGE_MULTIPLIER constant exists in combat_scaling.ts (value: 65n)"
    - "DEBUFF_POWER_COST_PERCENT constant exists in combat_scaling.ts (value: 25n)"
    - "Shadow Cut (rogue_shadow_cut) has DoT metadata fields populated"
    - "Spirit Mender (shaman_spirit_mender) has HoT metadata fields populated"
    - "Warrior Cleave (warrior_cleave) has AoE metadata fields populated"
    - "At least 2 abilities have debuff metadata fields populated"
    - "Module publishes successfully with extended ability catalog"
  artifacts:
    - path: "spacetimedb/src/data/combat_scaling.ts"
      provides: "DoT/HoT/AoE/Debuff scaling constants"
      exports: ["DOT_SCALING_RATE_MODIFIER", "AOE_DAMAGE_MULTIPLIER", "DEBUFF_POWER_COST_PERCENT"]
    - path: "spacetimedb/src/data/ability_catalog.ts"
      provides: "Extended ability metadata with DoT/HoT/debuff/AoE fields"
      contains: "dotPowerSplit"
  key_links:
    - from: "spacetimedb/src/data/ability_catalog.ts"
      to: "ABILITIES object"
      via: "Extended interface with optional DoT/HoT/debuff/AoE fields"
      pattern: "dotPowerSplit\\?:"
    - from: "spacetimedb/src/data/combat_scaling.ts"
      to: "Export constants"
      via: "Public export for use in index.ts"
      pattern: "export const DOT_SCALING_RATE_MODIFIER"
---

<objective>
Extend ability catalog and combat scaling with DoT/HoT/debuff/AoE metadata infrastructure. Add constants for reduced DoT scaling, AoE damage reduction, and debuff power costs. Annotate existing abilities with appropriate metadata fields to support power budget splitting in Plan 02.

Purpose: Establish declarative metadata foundation for periodic effects and multi-target abilities without changing combat logic yet.

Output: Extended ability catalog with metadata, new scaling constants, regenerated client bindings.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/projects/uwr/.planning/PROJECT.md
@C:/projects/uwr/.planning/ROADMAP.md
@C:/projects/uwr/.planning/STATE.md
@C:/projects/uwr/.planning/phases/03.1.1-combat-balance-part-2/03.1.1-CONTEXT.md
@C:/projects/uwr/.planning/phases/03.1.1-combat-balance-part-2/03.1.1-RESEARCH.md
@C:/projects/uwr/spacetimedb/src/data/combat_scaling.ts
@C:/projects/uwr/spacetimedb/src/data/ability_catalog.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DoT/HoT/AoE/Debuff constants to combat_scaling.ts</name>
  <files>spacetimedb/src/data/combat_scaling.ts</files>
  <action>
Add three new scaling constants to combat_scaling.ts after the existing constants (after MAGIC_RESIST_SCALING constant):

```typescript
/**
 * DoT/HoT stat scaling reduction factor (50% of direct damage scaling)
 * Prevents double-dipping: DoTs tick multiple times, so per-tick scaling is halved
 * User decision: DoTs use reduced scaling rate compared to direct damage
 */
export const DOT_SCALING_RATE_MODIFIER = 50n;  // 50% on 100n scale

/**
 * AoE damage multiplier per target (65% of single-target damage)
 * User decision: AoE abilities deal 60-70% damage per target
 * Starting point: 65%, tune via playtesting if needed
 */
export const AOE_DAMAGE_MULTIPLIER = 65n;  // 65% on 100n scale

/**
 * Debuff power cost percentage (25% of ability power budget)
 * User decision: Abilities with debuffs deal reduced damage proportionally
 * All debuff types cost the same power budget
 */
export const DEBUFF_POWER_COST_PERCENT = 25n;  // 25% on 100n scale
```

These constants integrate with existing Phase 3.1 scaling system (ABILITY_STAT_SCALING_PER_POINT, getAbilityMultiplier, etc.).
  </action>
  <verify>
Verify constants added:
```bash
cd C:/projects/uwr/spacetimedb
grep -A 3 "DOT_SCALING_RATE_MODIFIER" src/data/combat_scaling.ts
grep -A 3 "AOE_DAMAGE_MULTIPLIER" src/data/combat_scaling.ts
grep -A 3 "DEBUFF_POWER_COST_PERCENT" src/data/combat_scaling.ts
```
All three constants should appear with JSDoc comments.
  </verify>
  <done>
combat_scaling.ts exports DOT_SCALING_RATE_MODIFIER (50n), AOE_DAMAGE_MULTIPLIER (65n), and DEBUFF_POWER_COST_PERCENT (25n) with full JSDoc comments explaining user decisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend ability catalog interface and annotate abilities</name>
  <files>spacetimedb/src/data/ability_catalog.ts</files>
  <action>
**Step 1: Add TypeScript interface extension**

After the DamageType export (line 3), add interface for ability metadata (DO NOT create a new type, just add optional fields inline):

```typescript
// Ability entries use this shape (extended with DoT/HoT/debuff/AoE metadata)
export interface AbilityMetadata {
  name: string;
  className: string;
  resource: string;
  level: bigint;
  power: bigint;
  cooldownSeconds: bigint;
  castSeconds: bigint;
  damageType: DamageType;

  // DoT metadata (damage over time)
  dotPowerSplit?: number;        // 0-1, fraction of power allocated to DoT total damage
  dotDuration?: bigint;          // Duration in ticks (1 tick = 3 seconds)

  // HoT metadata (heal over time)
  hotPowerSplit?: number;        // 0-1, fraction of power allocated to HoT total healing
  hotDuration?: bigint;          // Duration in ticks

  // Debuff metadata
  debuffType?: string;           // 'ac_bonus' | 'damage_down' | 'armor_down' | 'slow'
  debuffMagnitude?: bigint;      // Fixed magnitude value (stat-independent per user decision)
  debuffDuration?: bigint;       // Duration in ticks

  // AoE metadata
  aoeTargets?: 'all_enemies' | 'all_allies' | 'all_party';  // Target type
}
```

**Step 2: Annotate abilities with DoT metadata**

Add DoT metadata to these abilities:
- `rogue_shadow_cut`: Add `dotPowerSplit: 0.4, dotDuration: 2n` (40% DoT, 2 ticks = 6 seconds)
- `rogue_bleed`: Add `dotPowerSplit: 0.6, dotDuration: 3n` (60% DoT-heavy, 3 ticks = 9 seconds)
- `necromancer_plague_spark`: Add `dotPowerSplit: 0.5, dotDuration: 3n` (50% split, 3 ticks)

**Step 3: Annotate abilities with HoT metadata**

Add HoT metadata to these abilities:
- `shaman_spirit_mender`: Add `hotPowerSplit: 0.5, hotDuration: 2n` (50% split, 2 ticks = 6 seconds)
- `druid_natures_gift`: Add `hotPowerSplit: 0.6, hotDuration: 3n` (60% HoT-heavy, 3 ticks)

**Step 4: Annotate abilities with debuff metadata**

Add debuff metadata to these abilities:
- `shaman_hex`: Add `debuffType: 'ac_bonus', debuffMagnitude: -2n, debuffDuration: 3n` (AC reduction debuff)
- `enchanter_slow`: Add `debuffType: 'slow', debuffMagnitude: -3n, debuffDuration: 3n` (Slow debuff)

**Step 5: Annotate AoE abilities**

Add AoE metadata to these abilities:
- `warrior_cleave`: Add `aoeTargets: 'all_enemies'` (hits all enemies in combat)
- `paladin_devotion`: Add `aoeTargets: 'all_party'` (affects all party members)

Follow existing ABILITIES object pattern (lines 5-800+). Add fields as comma-separated properties after damageType.
  </action>
  <verify>
Verify ability metadata added:
```bash
cd C:/projects/uwr/spacetimedb
grep -A 10 "rogue_shadow_cut:" src/data/ability_catalog.ts | grep "dotPowerSplit"
grep -A 10 "shaman_spirit_mender:" src/data/ability_catalog.ts | grep "hotPowerSplit"
grep -A 10 "warrior_cleave:" src/data/ability_catalog.ts | grep "aoeTargets"
grep -A 10 "shaman_hex:" src/data/ability_catalog.ts | grep "debuffType"
```
All four patterns should appear.
  </verify>
  <done>
ability_catalog.ts has AbilityMetadata interface with optional DoT/HoT/debuff/AoE fields. At least 3 abilities have dotPowerSplit, 2 have hotPowerSplit, 2 have debuffType, and 2 have aoeTargets.
  </done>
</task>

<task type="auto">
  <name>Task 3: Publish module and regenerate client bindings</name>
  <files>spacetimedb/package.json, client/src/module_bindings/</files>
  <action>
Publish the updated SpacetimeDB module to apply schema changes and regenerate TypeScript client bindings to include updated ability catalog metadata.

**Step 1: Publish module**
```bash
cd C:/projects/uwr
spacetime publish uwr --project-path spacetimedb
```

If publish fails with errors about missing SpacetimeDB server, start it first:
```bash
spacetime start
spacetime publish uwr --project-path spacetimedb
```

**Step 2: Regenerate client bindings**
```bash
spacetime generate --lang typescript --out-dir client/src/module_bindings --project-path spacetimedb
```

**Step 3: Verify bindings updated**
Check that client bindings directory has updated timestamps:
```bash
ls -la client/src/module_bindings/*.ts
```

No schema table changes in this plan (only TypeScript constant changes), so module should publish without requiring --clear-database flag.
  </action>
  <verify>
Verify successful publish and binding generation:
```bash
cd C:/projects/uwr
spacetime logs uwr --tail 20
```
Should see "Module published successfully" or similar message. No errors about schema mismatches.

Check bindings exist:
```bash
ls client/src/module_bindings/index.ts
```
File should exist with recent modification timestamp.
  </verify>
  <done>
Module published successfully to SpacetimeDB. Client bindings regenerated in client/src/module_bindings/. No schema errors. ability_catalog.ts changes are live.
  </done>
</task>

</tasks>

<verification>
After plan completion:

1. **Constants verified:**
   - `grep -c "DOT_SCALING_RATE_MODIFIER" spacetimedb/src/data/combat_scaling.ts` returns 1
   - `grep -c "AOE_DAMAGE_MULTIPLIER" spacetimedb/src/data/combat_scaling.ts` returns 1
   - `grep -c "DEBUFF_POWER_COST_PERCENT" spacetimedb/src/data/combat_scaling.ts` returns 1

2. **Ability metadata verified:**
   - Shadow Cut has `dotPowerSplit: 0.4, dotDuration: 2n`
   - Spirit Mender has `hotPowerSplit: 0.5, hotDuration: 2n`
   - Warrior Cleave has `aoeTargets: 'all_enemies'`
   - Shaman Hex has `debuffType: 'ac_bonus', debuffMagnitude: -2n, debuffDuration: 3n`

3. **Module published:**
   - `spacetime logs uwr` shows successful publish
   - Client bindings regenerated with recent timestamps
</verification>

<success_criteria>
- [ ] DOT_SCALING_RATE_MODIFIER = 50n exported from combat_scaling.ts
- [ ] AOE_DAMAGE_MULTIPLIER = 65n exported from combat_scaling.ts
- [ ] DEBUFF_POWER_COST_PERCENT = 25n exported from combat_scaling.ts
- [ ] AbilityMetadata interface exists with optional DoT/HoT/debuff/AoE fields
- [ ] rogue_shadow_cut has dotPowerSplit and dotDuration
- [ ] shaman_spirit_mender has hotPowerSplit and hotDuration
- [ ] warrior_cleave has aoeTargets
- [ ] shaman_hex has debuffType, debuffMagnitude, debuffDuration
- [ ] Module published without errors
- [ ] Client bindings regenerated
</success_criteria>

<output>
After completion, create `.planning/phases/03.1.1-combat-balance-part-2/03.1.1-01-SUMMARY.md`
</output>
