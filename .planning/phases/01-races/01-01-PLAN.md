---
phase: 01-races
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/index.ts
  - spacetimedb/src/data/races.ts
  - spacetimedb/src/reducers/characters.ts
autonomous: true

must_haves:
  truths:
    - "Race table exists in SpacetimeDB with 4 unlocked starter races after syncAllContent"
    - "create_character reducer accepts raceId, validates race is unlocked, validates class is allowed for that race, and applies racial stat bonuses"
    - "Invalid race-class combos are rejected with SenderError"
    - "Racial stat bonuses are baked into character base stats at creation (not a separate layer)"
  artifacts:
    - path: "spacetimedb/src/data/races.ts"
      provides: "RACE_DATA constant and ensureRaces function"
      exports: ["RACE_DATA", "ensureRaces"]
    - path: "spacetimedb/src/index.ts"
      provides: "Race table definition, schema export, syncAllContent wiring, reducerDeps.RACE_DATA"
      contains: "Race"
    - path: "spacetimedb/src/reducers/characters.ts"
      provides: "Updated create_character reducer with raceId validation and racial stat application"
      contains: "raceId"
  key_links:
    - from: "spacetimedb/src/data/races.ts"
      to: "spacetimedb/src/index.ts"
      via: "import { RACE_DATA, ensureRaces }"
      pattern: "import.*ensureRaces.*from.*races"
    - from: "spacetimedb/src/index.ts"
      to: "syncAllContent"
      via: "ensureRaces(ctx) call inside syncAllContent"
      pattern: "ensureRaces\\(ctx\\)"
    - from: "spacetimedb/src/index.ts"
      to: "spacetimedb/src/reducers/characters.ts"
      via: "RACE_DATA passed through reducerDeps"
      pattern: "RACE_DATA"
    - from: "spacetimedb/src/reducers/characters.ts"
      to: "ctx.db.race"
      via: "race row lookup by raceId in create_character"
      pattern: "ctx\\.db\\.race\\.id\\.find"
---

<objective>
Add the Race table, race data seeding, and race-validated character creation to the SpacetimeDB backend.

Purpose: Establishes the server-side foundation for race selection — table, seed data, validation, and stat application. Frontend (Plan 02) depends on this being published and bindings regenerated.

Output: Race table in schema, RACE_DATA constant with 4 starter races, ensureRaces seeding function, and updated create_character reducer that validates raceId and applies racial stat bonuses.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-races/01-RESEARCH.md
@spacetimedb/src/index.ts
@spacetimedb/src/reducers/characters.ts
@spacetimedb/src/data/class_stats.ts
@spacetimedb/src/data/ability_catalog.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Race table and RACE_DATA seed file</name>
  <files>spacetimedb/src/data/races.ts, spacetimedb/src/index.ts</files>
  <action>
**Create `spacetimedb/src/data/races.ts`:**

Define and export `RACE_DATA` as an array of race objects and `ensureRaces` function. Follow the exact pattern used in `spacetimedb/src/data/ability_catalog.ts` + `ensureAbilityTemplates` in index.ts.

```typescript
export const RACE_DATA: Array<{
  name: string;
  description: string;
  availableClasses: string;
  strBonus: bigint;
  dexBonus: bigint;
  chaBonus: bigint;
  wisBonus: bigint;
  intBonus: bigint;
  unlocked: boolean;
}> = [
  {
    name: 'Human',
    description: 'Adaptable and resourceful, humans can pursue any path.',
    availableClasses: '',
    strBonus: 0n, dexBonus: 0n, chaBonus: 1n, wisBonus: 0n, intBonus: 0n,
    unlocked: true,
  },
  {
    name: 'Eldrin',
    description: 'Ancient scholars attuned to arcane and divine forces.',
    availableClasses: 'bard,enchanter,cleric,wizard,necromancer,spellblade,shaman,druid,reaver,summoner,paladin,ranger',
    strBonus: 0n, dexBonus: 0n, chaBonus: 0n, wisBonus: 1n, intBonus: 2n,
    unlocked: true,
  },
  {
    name: 'Ironclad',
    description: 'Forged in industry, masters of strength and craft.',
    availableClasses: 'warrior,paladin,monk,beastmaster,spellblade,ranger,shaman',
    strBonus: 2n, dexBonus: 0n, chaBonus: 0n, wisBonus: 0n, intBonus: 0n,
    unlocked: true,
  },
  {
    name: 'Wyldfang',
    description: 'Swift hunters bonded with the untamed wild.',
    availableClasses: 'rogue,ranger,monk,beastmaster,druid,shaman',
    strBonus: 0n, dexBonus: 2n, chaBonus: 0n, wisBonus: 1n, intBonus: 0n,
    unlocked: true,
  },
];
```

**CRITICAL:** Human's `availableClasses` MUST be `''` (empty string), NOT `'all'`. The existing `isClassAllowed()` function at index.ts:2946 has `if (!allowedClasses || allowedClasses.trim().length === 0) return true;` as its first guard — empty string correctly means "allow all classes". Using `'all'` would break because the function would treat `'all'` as a class name and reject every valid class.

The `ensureRaces` function follows the exact upsert pattern from `ensureAbilityTemplates`:
- Iterate over `RACE_DATA`
- For each entry, find existing row by `name` using `[...ctx.db.race.iter()].find(row => row.name === data.name)`
- If found, update: `ctx.db.race.id.update({ ...existing, ...data })`
- If not found, insert: `ctx.db.race.insert({ id: 0n, ...data })`

**Modify `spacetimedb/src/index.ts`:**

1. **Add Race table definition** — Insert BEFORE the `schema()` export at line 1177. Place it near other game data tables (after the Character table definition area). Use `public: true` since all clients need to see races. No indexes needed beyond the auto-increment primary key.

```typescript
const Race = table(
  { name: 'race', public: true },
  {
    id: t.u64().primaryKey().autoInc(),
    name: t.string(),
    description: t.string(),
    availableClasses: t.string(),
    strBonus: t.u64(),
    dexBonus: t.u64(),
    chaBonus: t.u64(),
    wisBonus: t.u64(),
    intBonus: t.u64(),
    unlocked: t.bool(),
  }
);
```

2. **Add Race to schema() export** at line 1177 — Add `Race` to the `schema(...)` call. Place it after `Character` (line 1194) for logical grouping.

3. **Import ensureRaces** — Add `import { RACE_DATA, ensureRaces } from './data/races';` near the existing data imports (around line 31 where `import ... from './data/xp'` is).

4. **Wire into syncAllContent** at line 4316 — Add `ensureRaces(ctx);` as the FIRST call inside `syncAllContent`, before `ensureWorldLayout(ctx)`. Races should seed first since they're foundational data.

5. **Add to reducerDeps** at line 5643 — Add `RACE_DATA,` to the `reducerDeps` object so the character reducer can access it. Also add `Race,` so the reducer can reference the table type if needed. Place after `isClassAllowed` (line 5692).
  </action>
  <verify>
Verify the file compiles: search for `Race` in index.ts to confirm it appears in:
- Table definition (const Race = table(...))
- schema() call
- syncAllContent function (ensureRaces call)
- reducerDeps object

Verify races.ts exports: `RACE_DATA` array has 4 entries, `ensureRaces` function is exported.

Verify Human's availableClasses is `''` (empty string), NOT `'all'`.
  </verify>
  <done>
Race table is defined in index.ts with all required columns (id, name, description, availableClasses, strBonus, dexBonus, chaBonus, wisBonus, intBonus, unlocked). Race is in the schema() export. ensureRaces(ctx) is called from syncAllContent. RACE_DATA has 4 unlocked starter races. Human's availableClasses is '' (empty string) so isClassAllowed allows all classes. RACE_DATA is available in reducerDeps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update create_character reducer to validate raceId and apply racial bonuses</name>
  <files>spacetimedb/src/reducers/characters.ts</files>
  <action>
**Modify `spacetimedb/src/reducers/characters.ts`:**

1. **Destructure new deps** — At line 1-25, add `isClassAllowed` to the destructured `deps` object. `isClassAllowed` is already in `reducerDeps` (line 5692 of index.ts). Do NOT add `RACE_DATA` to the destructure — it is not needed in this file; the reducer looks up races via `ctx.db.race` instead.

2. **Change reducer parameter** — At line 100, change the `create_character` reducer signature from:
   ```typescript
   { name: t.string(), race: t.string(), className: t.string() }
   ```
   to:
   ```typescript
   { name: t.string(), raceId: t.u64(), className: t.string() }
   ```
   And update the destructured args from `{ name, race, className }` to `{ name, raceId, className }`.

3. **Add race validation** — After the existing name validation (line 109, after the duplicate name check), add:
   ```typescript
   // Race validation
   const raceRow = ctx.db.race.id.find(raceId);
   if (!raceRow) throw new SenderError('Invalid race');
   if (!raceRow.unlocked) throw new SenderError('Race not yet unlocked');

   // Class restriction check — reuses isClassAllowed from index.ts
   if (!isClassAllowed(raceRow.availableClasses, className)) {
     throw new SenderError(`${className} is not available for ${raceRow.name}`);
   }
   ```

4. **Apply racial stat bonuses** — At line 118, the current code is:
   ```typescript
   const baseStats = computeBaseStats(className, 1n);
   const manaStat = manaStatForClass(className, baseStats);
   const maxHp = BASE_HP + baseStats.str * 5n;
   ```
   Change to apply racial bonuses BEFORE computing derived values:
   ```typescript
   const classStats = computeBaseStats(className, 1n);
   const baseStats = {
     str: classStats.str + raceRow.strBonus,
     dex: classStats.dex + raceRow.dexBonus,
     cha: classStats.cha + raceRow.chaBonus,
     wis: classStats.wis + raceRow.wisBonus,
     int: classStats.int + raceRow.intBonus,
   };
   const manaStat = manaStatForClass(className, baseStats);
   const maxHp = BASE_HP + baseStats.str * 5n;
   ```
   This ensures racial bonuses flow into ALL derived stats (maxHp, hitChance, critMelee, etc.) because the rest of the reducer already uses `baseStats.str`, `baseStats.dex`, etc.

5. **Update character insert** — At line 127, change `race: race.trim()` to `race: raceRow.name` — we store the race display name, looked up from the validated Race row.

IMPORTANT: Do NOT change the Character table's `race: t.string()` column. The column stays as a display string. Only the reducer parameter changes from `race` to `raceId`.
  </action>
  <verify>
Search characters.ts for:
- `raceId: t.u64()` in the reducer signature
- `ctx.db.race.id.find(raceId)` for race lookup
- `isClassAllowed(raceRow.availableClasses` for class restriction
- `raceRow.strBonus` (or similar) for racial bonus application
- `race: raceRow.name` in the character insert

Ensure `baseStats` is the name of the object used in the character insert (str: baseStats.str, etc.) and that it includes racial bonuses.
  </verify>
  <done>
create_character reducer accepts `raceId: t.u64()` instead of `race: t.string()`. It validates the race exists and is unlocked, checks class is allowed for that race using isClassAllowed, computes base stats with racial bonuses added on top, and stores `race: raceRow.name` on the character row. All derived stats (maxHp, hitChance, critMelee, etc.) naturally incorporate racial bonuses because they're computed from the adjusted baseStats object.
  </done>
</task>

<task type="auto">
  <name>Task 3: Publish module and regenerate client bindings</name>
  <files>src/module_bindings/</files>
  <action>
After Tasks 1 and 2 are complete, publish the updated module and regenerate TypeScript bindings so the frontend has access to the new Race table and updated createCharacter reducer signature.

1. **Publish the module** — Run `spacetime publish` with `--clear-database -y` since we're adding a new table (Race). Use the project's standard publish command. Check `spacetime server list` first to confirm the default server.

   ```bash
   spacetime publish uwr --clear-database -y --project-path spacetimedb
   ```

   If publish fails, check `spacetime logs uwr` for errors. Common issues: Race not in schema() export, syntax error in races.ts.

2. **Regenerate bindings** — Run the project's generate script:

   ```bash
   npm run spacetime:generate
   ```

   This runs: `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb`

3. **Verify bindings** — Confirm the generated bindings include:
   - `tables.race` accessor (check for a file like `src/module_bindings/race_table.ts` or `Race` in the generated types)
   - Updated `createCharacter` reducer type that now expects `{ name: string, raceId: bigint, className: string }` (not `race: string`)
   - `RaceRow` type export (or equivalent generated row type)

If bindings don't show Race, the table was not added to schema() — go back and fix Task 1.
  </action>
  <verify>
After generate, verify:
- `src/module_bindings/` contains race-related generated file(s)
- Search generated bindings for `race` table accessor
- Search generated bindings for `raceId` in createCharacter reducer type
- `npm run build` or `npx tsc --noEmit` passes (no TypeScript errors in generated code)
  </verify>
  <done>
Module is published with Race table. Client bindings are regenerated with `tables.race` accessor and updated `createCharacter` reducer signature accepting `raceId: bigint` instead of `race: string`.
  </done>
</task>

</tasks>

<verification>
1. Race table definition exists in index.ts with correct columns and `public: true`
2. Race is included in the `schema()` export call
3. `ensureRaces(ctx)` is called inside `syncAllContent`
4. `RACE_DATA` has exactly 4 entries, all with `unlocked: true`
5. Human's `availableClasses` is `''` (empty string), NOT `'all'`
6. `create_character` reducer accepts `raceId: t.u64()` (not `race: t.string()`)
7. Reducer validates race exists, is unlocked, and class is allowed
8. Racial stat bonuses are added to computeBaseStats output before computing derived stats
9. Character row stores `race: raceRow.name` (display name from the Race row)
10. Module publishes without errors
11. Generated bindings include `tables.race` and updated reducer type
</verification>

<success_criteria>
- `spacetime publish` succeeds
- `spacetime logs uwr` shows no errors on init (syncAllContent seeds 4 races)
- Generated bindings contain Race table type and updated createCharacter signature
- No TypeScript errors in generated bindings
</success_criteria>

<output>
After completion, create `.planning/phases/01-races/01-01-SUMMARY.md`
</output>
