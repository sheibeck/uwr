---
phase: 03-renown-foundation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/composables/useGameData.ts
  - src/components/RenownPanel.vue
  - src/components/ActionBar.vue
  - src/App.vue
autonomous: false

must_haves:
  truths:
    - "Renown button appears in ActionBar when player has an active character"
    - "Clicking Renown button opens the RenownPanel"
    - "RenownPanel shows all 4 factions with their names and descriptions"
    - "Each faction displays current standing value and computed rank name (Hostile/Unfriendly/Neutral/Friendly/Honored/Revered/Exalted)"
    - "Each faction displays a progress bar showing progress within the current rank tier"
    - "Each faction shows the next rank requirement (or 'Exalted (max)' if already at top)"
    - "Standing values of 0 show as Neutral rank for newly created characters"
  artifacts:
    - path: "src/components/RenownPanel.vue"
      provides: "Faction standing display with rank computation, progress bars, next rank info"
      contains: "FACTION_RANKS"
    - path: "src/composables/useGameData.ts"
      provides: "factions and factionStandings table subscriptions"
      contains: "factionStandings"
    - path: "src/components/ActionBar.vue"
      provides: "Renown button in action bar"
      contains: "renown"
  key_links:
    - from: "src/composables/useGameData.ts"
      to: "src/module_bindings/"
      via: "useTable(tables.faction) and useTable(tables.myFactionStandings)"
      pattern: "useTable.*faction"
    - from: "src/App.vue"
      to: "src/components/RenownPanel.vue"
      via: "v-else-if activePanel === renown renders RenownPanel with props"
      pattern: "RenownPanel"
    - from: "src/components/ActionBar.vue"
      to: "src/App.vue"
      via: "emit toggle renown event"
      pattern: "renown"
---

<objective>
Frontend renown panel: client-side FACTION_RANKS constant, RenownPanel Vue component showing all factions with standing bars and rank tiers, ActionBar wiring, App.vue panel routing.

Purpose: Displays the faction standing data from the backend to the player. Each faction shows its name, the player's current rank (computed client-side from standing thresholds), a progress bar within the current tier, and the next rank requirement.

Output: Functional RenownPanel accessible from the ActionBar, rendering live faction standing data from SpacetimeDB subscriptions.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-renown-foundation/03-RESEARCH.md
@.planning/phases/03-renown-foundation/03-01-SUMMARY.md

# Key source files to read before starting
@src/composables/useGameData.ts
@src/components/ActionBar.vue
@src/components/QuestPanel.vue
@src/App.vue
@src/module_bindings/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add faction subscriptions and create RenownPanel with rank computation</name>
  <files>
    src/composables/useGameData.ts
    src/components/RenownPanel.vue
    src/components/ActionBar.vue
    src/App.vue
  </files>
  <action>
**1. Update `src/composables/useGameData.ts`:**
Add two new `useTable` subscriptions for the faction data. Read the file first to understand the existing pattern (other `useTable` calls with destructured tuples).

```typescript
const [factions] = useTable(tables.faction);
const [factionStandings] = useTable(tables.myFactionStandings);
```

Add `factions` and `factionStandings` to the return object.

Note: The generated table name for the view `my_faction_standings` may be `myFactionStandings` in camelCase. Check `src/module_bindings/index.ts` to find the exact generated table accessor name. Use whatever name was generated.

**2. Create `src/components/RenownPanel.vue`** (new file) following the QuestPanel.vue component pattern:

The component should:
- Accept props: `factions` (array of Faction rows), `factionStandings` (array of FactionStanding rows), `selectedCharacter` (Character row or null)
- Define `FACTION_RANKS` constant inside `<script setup>`:
  ```typescript
  const FACTION_RANKS = [
    { name: 'Hostile',    min: -Infinity, max: -5001,   color: '#c55' },
    { name: 'Unfriendly', min: -5000,     max: -1,      color: '#c85' },
    { name: 'Neutral',    min: 0,         max: 999,     color: '#aaa' },
    { name: 'Friendly',   min: 1000,      max: 2999,    color: '#8af' },
    { name: 'Honored',    min: 3000,      max: 5999,    color: '#5af' },
    { name: 'Revered',    min: 6000,      max: 8999,    color: '#a5f' },
    { name: 'Exalted',    min: 9000,      max: Infinity, color: '#fa5' },
  ];
  ```
- Define helper functions:
  - `getRankIndex(standing: number): number` — returns the index in FACTION_RANKS for a given standing value (iterate from end, find first where `standing >= rank.min`)
  - `getProgress(standing: number, rankIdx: number): number` — compute percentage progress within current rank tier: `((standing - rank.min) / (rank.max - rank.min + 1)) * 100`, clamped to 0-100. For Exalted (max = Infinity), show 100%.

- Define a computed `factionRows` that merges factions + factionStandings:
  ```typescript
  const factionRows = computed(() => {
    if (!props.selectedCharacter) return [];
    return props.factions.map(faction => {
      const standingRow = props.factionStandings.find(
        s => s.factionId === faction.id
      );
      const standing = Number(standingRow?.standing ?? 0n);
      const rankIdx = getRankIndex(standing);
      const rank = FACTION_RANKS[rankIdx];
      const nextRank = rankIdx < FACTION_RANKS.length - 1 ? FACTION_RANKS[rankIdx + 1] : null;
      const progress = getProgress(standing, rankIdx);
      return {
        factionId: faction.id,
        factionName: faction.name,
        description: faction.description,
        standing,
        rank,
        nextRank,
        progress,
      };
    });
  });
  ```

- Template structure (follow existing panel styling — read QuestPanel.vue or StatsPanel.vue for the `styles` object pattern):
  - If no selectedCharacter: show "Select a character." in subtle text
  - If no factionRows: show "No faction data." in subtle text
  - Otherwise, for each faction row:
    - Faction name (bold/header style)
    - Description in subtle/small text
    - Rank name with rank color: e.g., "Neutral (0)" using `rank.color`
    - Progress bar: container div with dark background (#333), inner div with `rank.color` background, width = `progress%`, height 6px, border-radius 3px
    - Next rank text: "Next: Friendly (1000)" or "Exalted (max)" if at top

- Use inline styles following the existing `styles` pattern from other panels. Read the styles object from an existing panel for consistency.

**3. Update `src/components/ActionBar.vue`:**
- Add `'renown'` to the `PanelKey` type union. Find the line with `type PanelKey = 'none' | 'character' | ...` and add `| 'renown'`.
- Add a Renown button in the template, inside the `v-if="hasActiveCharacter"` section, following the pattern of existing buttons (e.g., Quests, Stats). Place it near the other progression-related buttons:
  ```vue
  <button @click="emit('toggle', 'renown')" :style="actionStyle('renown')" :disabled="isLocked('renown')">
    Renown
  </button>
  ```

**4. Update `src/App.vue`:**
- Import `RenownPanel` component.
- Destructure `factions` and `factionStandings` from the `useGameData()` return (they were added in step 1).
- Add the panel case in the template's panel switch section. Find where other panels are conditionally rendered (e.g., `v-else-if="activePanel === 'quests'"`). Add:
  ```vue
  <RenownPanel
    v-else-if="activePanel === 'renown'"
    :factions="factions"
    :factionStandings="factionStandings"
    :selectedCharacter="selectedCharacter"
  />
  ```
  The exact prop names for `selectedCharacter` may vary — read App.vue to find the correct prop name used in other panel components.

- Add `'my_faction_standings'` (or whatever the view name is) to the subscription SQL array if one exists. Check how other views like `my_quests` are subscribed — if there's an explicit subscription list, add the faction standings view to it.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no TypeScript errors.
2. Start the app (`npm run dev`) and verify:
   - ActionBar shows a "Renown" button when a character is active
   - Clicking "Renown" opens the RenownPanel
   - RenownPanel shows 4 factions (Iron Compact, Verdant Circle, Ashen Order, Free Blades)
   - Each faction shows "Neutral (0)" rank for a newly created character
   - Progress bars are visible and render correctly
  </verify>
  <done>
RenownPanel component created with FACTION_RANKS constant, rank computation, and progress bars. ActionBar has Renown button. App.vue routes to RenownPanel. useGameData provides factions and factionStandings subscriptions. All 4 factions display with correct Neutral rank for new characters.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify renown panel end-to-end</name>
  <files>n/a</files>
  <action>
Human verifies the complete faction standing system works end-to-end. Everything was built in Plan 01 (backend) and Task 1 (frontend) — this checkpoint confirms it works visually and functionally.

Steps to verify:
1. Open the app in browser (dev server should be running)
2. Create a new character (any race/class)
3. Click the "Renown" button in the ActionBar
4. Verify you see 4 factions: Iron Compact, Verdant Circle, Ashen Order, Free Blades
5. Verify each faction shows "Neutral" rank and standing of 0
6. Verify each faction has a description displayed
7. Verify progress bars are visible (should be at 0% within Neutral rank)
8. Verify "Next: Friendly (1000)" or similar next-rank text is shown for each faction
9. (Optional) If you can trigger combat against a faction-associated enemy, verify standing changes after the kill and the RenownPanel updates live

Expected state after verification:
- 4 factions visible with names and descriptions
- All factions at Neutral rank for newly created characters
- Progress bars render correctly
- Next rank info displayed per faction
  </action>
  <verify>Human confirms all verification steps pass.</verify>
  <done>Renown panel works end-to-end: 4 factions displayed, standing and rank computed correctly, progress bars render, next rank info shown, live subscription updates work.</done>
</task>

</tasks>

<verification>
1. ActionBar shows "Renown" button for active characters
2. RenownPanel renders 4 factions with names, descriptions, standing, and rank
3. Rank computation correctly maps standing 0 to "Neutral"
4. Progress bar renders within current rank tier
5. Next rank requirement displayed for each faction
6. No TypeScript errors in the project
7. Live subscription updates panel when standing changes
</verification>

<success_criteria>
- Renown button visible in ActionBar when character is active
- RenownPanel shows all 4 factions with correct data
- Standing of 0 correctly displays as Neutral rank
- Progress bars render with appropriate width and color
- Next rank information shown per faction
- Panel updates reactively when standing data changes via subscription
- Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/03-renown-foundation/03-02-SUMMARY.md`
</output>
