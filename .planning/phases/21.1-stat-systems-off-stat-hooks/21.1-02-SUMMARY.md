---
phase: 21.1-stat-systems-off-stat-hooks
plan: "02"
subsystem: combat
tags: [spacetimedb, typescript, combat, stats, dex, str, wis, block, pull]

# Dependency graph
requires:
  - phase: 21.1-01
    provides: statOffset() helper, BLOCK_CHANCE_BASE/DEX, BLOCK_MITIGATION_BASE/STR, WIS_PULL_BONUS_PER_POINT constants in combat_scaling.ts

provides:
  - Parameterized blockChanceBasis and blockMitigationPercent in rollAttackOutcome (helpers/combat.ts)
  - DEX-derived block chance and STR-derived block mitigation computed at enemy-attacks-character site
  - WIS hook in resolve_pull shifting success%/fail% before the dice roll

affects: [combat, pull system, stat progression, block mechanics, pull probability]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Stat-derived combat parameters threaded as optional params with ?? defaults for backward compatibility"
    - "IIFE block for clamped bigint computation keeps call site readable"
    - "WIS hook follows same adjustment pattern as pull_veil effect for consistency"

key-files:
  created: []
  modified:
    - spacetimedb/src/helpers/combat.ts
    - spacetimedb/src/reducers/combat.ts

key-decisions:
  - "Block chance clamped to [10n, 200n] on 1000-scale (1%-20%); mitigation clamped to [10n, 80n] on 100n-scale"
  - "Character-attacks-enemy call site passes no blockChanceBasis/blockMitigationPercent — enemies have no DEX/STR, rollAttackOutcome ?? 50n defaults apply"
  - "WIS hook placed after awarenessAlert adjustment and partial recalc, before dice roll — matches pull_veil pattern"

patterns-established:
  - "Optional stat params with ?? N defaults: all existing callers get unchanged behavior without passing new params"
  - "Signed statOffset clamped to safe range via IIFE before passing to combat function"

requirements-completed: [STAT-03, STAT-04]

# Metrics
duration: 18min
completed: 2026-02-20
---

# Phase 21.1 Plan 02: DEX/STR Block System and WIS Pull Hook Summary

**DEX-scaled block chance and STR-scaled block mitigation wired into auto-attack combat loop; WIS shifts pull success/fail probability in resolve_pull**

## Performance

- **Duration:** 18 min
- **Started:** 2026-02-20T20:00:38Z
- **Completed:** 2026-02-20T20:18:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- `rollAttackOutcome` in helpers/combat.ts now accepts optional `blockChanceBasis` and `blockMitigationPercent` with backward-compatible `?? 50n` defaults
- Block multiplier now represents damage taken (100n - mitigation), floored at 1n — previously was always 50n
- `resolveAttack` wrapper in reducers/combat.ts extended to accept and thread both new params through
- At the enemy-attacks-character call site, `blockChanceBasis` and `blockMitigationPercent` are computed from `targetCharacter.dex` and `targetCharacter.str` using `statOffset()` with clamping
- WIS hook added to `resolve_pull` after awarenessAlert adjustment, before dice roll — follows same success/fail shift pattern as pull_veil

## Task Commits

Each task was committed atomically:

1. **Task 1: Parameterize rollAttackOutcome block values** - `e6106c9` (feat)
2. **Task 2: Wire DEX/STR block values and WIS hook in reducers/combat.ts** - `505e5bf` (feat)

**Plan metadata:** _(final commit below)_

## Files Created/Modified

- `spacetimedb/src/helpers/combat.ts` - Added `blockChanceBasis?` and `blockMitigationPercent?` to `rollAttackOutcome` opts type; updated block resolution branch
- `spacetimedb/src/reducers/combat.ts` - Extended `resolveAttack` param type; threaded params through to `rollAttackOutcome`; added stat computation at enemy-attacks-character call site; added WIS hook in `resolve_pull`

## Decisions Made

- Block chance clamped to [10n, 200n] on 1000-scale (1%-20% block chance range) — prevents degenerate low/high DEX values
- Block mitigation clamped to [10n, 80n] on 100n-scale — 10% min prevents absorbing nothing; 80% max preserves meaningful damage
- Character-attacks-enemy call site: no block params passed — enemies have no DEX/STR, `rollAttackOutcome` `?? 50n` defaults give the 5% / 50% baseline
- WIS hook uses same additive pattern as `pull_veil` (±N pp to success/fail) for consistency and predictability
- Pre-existing 224 TypeScript errors (in other files, unrelated to this plan) are out of scope — error count unchanged after changes

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation matched plan exactly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Block system is now stat-driven: DEX=14 → 7% block chance (50+20=70n on 1000-scale); STR=14 → 38% mitigation (30+8=38n on 100n-scale)
- WIS=14 → +8pp success and -8pp fail on pulls (4 points above 10 × 2pp/point)
- All constants tunable in combat_scaling.ts without code changes
- Ready for INT salvage hook (Plan 03) or CHA hooks (Plan 04)

---
*Phase: 21.1-stat-systems-off-stat-hooks*
*Completed: 2026-02-20*
