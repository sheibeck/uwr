---
phase: 21.1-stat-systems-off-stat-hooks
verified: 2026-02-21T00:00:00Z
status: passed
score: 16/16 must-haves verified
re_verification: false
human_verification_approved: 2026-02-21
---

# Phase 21.1: Stat Systems & Off-Stat Hooks — Verification Report

**Phase Goal:** Stat scaling is symmetric around base 10, all five off-stats (WIS, INT, CHA, STR, DEX) have live hooks affecting gameplay, the block system uses DEX chance and STR mitigation, and salvage drops recipe scrolls with INT-boosted probability instead of auto-learning.

**Verified:** 2026-02-21
**Status:** PASSED
**Human Verification:** Approved 2026-02-21 (block stats visible in UI, shield restriction works, salvage drops scrolls, vendor CHA pricing active, no server panics)
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | `statOffset()` helper exists and returns signed bigint based on `(statValue - 10n) * bonusPerPoint` | VERIFIED | `combat_scaling.ts` line 390: `export function statOffset(statValue: bigint, bonusPerPoint: bigint): bigint { return (statValue - STAT_BASE) * bonusPerPoint; }` |
| 2 | Shield is a valid armor type recognized by the equip system without falling back to 'cloth' | VERIFIED | `class_stats.ts` line 34: `ARMOR_TYPES_WITH_NONE = ['none', ...ARMOR_TYPES, 'shield']`; `normalizeArmorType('shield')` returns `'shield'` |
| 3 | Only warrior, paladin, cleric, spellblade, shaman can equip shields — others rejected | VERIFIED | `CLASS_ARMOR` in `class_stats.ts` lines 76-90: only those five classes have `'shield'` in their arrays; `SHIELD_CLASSES` Set exported at line 92 |
| 4 | Wooden Shield has `armorType: 'shield'` and `allowedClasses` matching the five shield classes | VERIFIED | `item_defs.ts` line 271: `armorType: 'shield'`, `allowedClasses: 'warrior,paladin,cleric,spellblade,shaman'` |
| 5 | Block chance scales with DEX: higher DEX = higher block chance on 1000-scale | VERIFIED | `combat.ts` lines 2980-2985: `statOffset(targetCharacter.dex, BLOCK_CHANCE_DEX_PER_POINT)` with clamp [10n, 200n] |
| 6 | Block mitigation scales with STR: higher STR = more damage absorbed on block | VERIFIED | `combat.ts` lines 2986-2991: `statOffset(targetCharacter.str, BLOCK_MITIGATION_STR_PER_POINT)` with clamp [10n, 80n] |
| 7 | Block only triggers when a shield is equipped in the off-hand slot | VERIFIED | `combat.ts` line 3007: `canBlock: hasShieldEquipped(ctx, targetCharacter.id)` — existing shield check unchanged |
| 8 | WIS reduces probability of bad pull outcome: higher WIS shifts success% up and fail% down | VERIFIED | `combat.ts` lines 978-984: `wisOffset = Number(statOffset(character.wis, WIS_PULL_BONUS_PER_POINT))` applied before dice roll at line 986 |
| 9 | Salvage no longer auto-learns recipes — drops `Scroll: <RecipeName>` item instead | VERIFIED | `items.ts` line 1880-1904: INT-boosted scroll drop block present; `RecipeDiscovered.insert` has zero occurrences in `salvage_item` (grep confirms no matches in that path) |
| 10 | INT stat boosts salvage scroll drop chance | VERIFIED | `items.ts` line 1887: `intOffset = statOffset(character.int, INT_SALVAGE_BONUS_PER_POINT)` used to compute `scrollChance` |
| 11 | CHA boosts vendor buy discounts and sell bonuses | VERIFIED | `items.ts` lines 164-166, 207-209: `character.vendorBuyMod` applied as `(finalPrice * (1000n - character.vendorBuyMod)) / 1000n` in `buy_item`; sell bonus wired similarly |
| 12 | `vendorBuyMod`/`vendorSellMod` in `recomputeCharacterDerived` use `(cha - 10n) * scale` formula | VERIFIED | `character.ts` lines 113-116: `statOffset(totalStats.cha, CHA_VENDOR_SCALE)` with clamp to 0n for u64 columns |
| 13 | CHA boosts faction gains: positive standing changes multiplied by CHA-derived factor | VERIFIED | `economy.ts` lines 17-22: `chaOffset = statOffset(character.cha, CHA_FACTION_BONUS_PER_POINT)` applied to `effectiveDelta` |
| 14 | CHA boosts NPC affinity gains: positive affinity changes multiplied by CHA-derived factor | VERIFIED | `npc_affinity.ts` lines 52-55: `chaOffsetPct = Number(statOffset(character.cha, CHA_AFFINITY_BONUS_PER_POINT))` applied to `multiplier` |
| 15 | Block chance and mitigation values are visible to the player in the stats panel | VERIFIED | `StatsPanel.vue` lines 86-89: "Block Chance" and "Block Mitigation" rows rendered; computed properties at lines 149-166 |
| 16 | Stats panel shows computed block chance (from DEX) and block mitigation (from STR) using correct formula | VERIFIED | `StatsPanel.vue` lines 149-166: inline constants mirror `combat_scaling.ts` exactly; formula matches server |

**Score:** 16/16 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `spacetimedb/src/data/combat_scaling.ts` | `statOffset()` helper + all system constants | VERIFIED | Lines 390-447: `statOffset`, `STAT_BASE`, `BLOCK_CHANCE_BASE`, `BLOCK_CHANCE_DEX_PER_POINT`, `BLOCK_MITIGATION_BASE`, `BLOCK_MITIGATION_STR_PER_POINT`, `WIS_PULL_BONUS_PER_POINT`, `INT_SALVAGE_BONUS_PER_POINT`, `SALVAGE_SCROLL_CHANCE_BASE`, `CHA_FACTION_BONUS_PER_POINT`, `CHA_AFFINITY_BONUS_PER_POINT`, `CHA_VENDOR_SCALE`, `CHA_VENDOR_SELL_SCALE` all present |
| `spacetimedb/src/data/class_stats.ts` | Shield in armor type list, CLASS_ARMOR for five classes, SHIELD_CLASSES | VERIFIED | Line 34: shield in ARMOR_TYPES_WITH_NONE; lines 76-90: warrior/paladin/cleric/spellblade/shaman have shield in CLASS_ARMOR; lines 92-94: SHIELD_CLASSES exported |
| `spacetimedb/src/data/item_defs.ts` | Wooden Shield with `armorType: 'shield'` and correct allowedClasses | VERIFIED | Line 271: `armorType: 'shield'`, `allowedClasses: 'warrior,paladin,cleric,spellblade,shaman'` |
| `spacetimedb/src/helpers/combat.ts` | `rollAttackOutcome` with `blockChanceBasis` and `blockMitigationPercent` opts | VERIFIED | Lines 149-178: opts type and function body both use the parameterized values with `?? 50n` defaults |
| `spacetimedb/src/reducers/combat.ts` | `resolveAttack` param type with block fields; DEX/STR computed at enemy-attacks-character site; WIS hook in resolve_pull | VERIFIED | Lines 515-516: param type; lines 2980-3009: stat-derived values computed and passed; lines 978-984: WIS hook before dice roll |
| `spacetimedb/src/reducers/items.ts` | INT scroll drop in salvage_item; CHA applied in buy_item/sell_item | VERIFIED | Lines 1880-1904: scroll drop logic; lines 164-166, 207-209: CHA vendor modifiers applied |
| `spacetimedb/src/helpers/character.ts` | Updated `vendorBuyMod`/`vendorSellMod` formula using symmetric CHA scaling | VERIFIED | Lines 113-116: symmetric formula with `statOffset` and clamp to 0n |
| `spacetimedb/src/helpers/economy.ts` | CHA faction gains hook in `mutateStanding` | VERIFIED | Lines 17-22: `chaOffset` computed and applied to `effectiveDelta` |
| `spacetimedb/src/helpers/npc_affinity.ts` | CHA affinity gains hook in `awardNpcAffinity` | VERIFIED | Lines 52-55: `chaOffsetPct` computed and applied to `multiplier` |
| `src/components/StatsPanel.vue` | Block chance and mitigation display computed from character.dex and character.str | VERIFIED | Lines 149-166: computed properties using inline constants; lines 86-89: template rows rendered |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| `reducers/combat.ts` | `data/combat_scaling.ts` | `statOffset` import + block/WIS constants | VERIFIED | Line 6: `statOffset` imported; lines 11, 2981, 2987 use block constants; line 979 uses `WIS_PULL_BONUS_PER_POINT` |
| `reducers/combat.ts` | `helpers/combat.ts` | `rollAttackOutcome` called with `blockChanceBasis` and `blockMitigationPercent` | VERIFIED | Lines 491-492 thread through `resolveAttack`; lines 553-554 pass into `rollAttackOutcome` |
| `reducers/items.ts` | `data/combat_scaling.ts` | `statOffset` + `INT_SALVAGE_BONUS_PER_POINT` imports for scroll drop | VERIFIED | Line 5 of items.ts: imports confirmed; line 1887 uses `INT_SALVAGE_BONUS_PER_POINT` |
| `reducers/items.ts` | scroll drop flow | `addItemToInventory` drops `Scroll: <RecipeName>` item | VERIFIED | Lines 1893-1897: `findItemTemplateByName` + `addItemToInventory` call confirmed |
| `helpers/economy.ts` | `data/combat_scaling.ts` | `statOffset` + `CHA_FACTION_BONUS_PER_POINT` for faction gains | VERIFIED | Line 2: import; line 18: usage in `mutateStanding` |
| `helpers/character.ts` | `data/combat_scaling.ts` | `statOffset` + `CHA_VENDOR_SCALE`/`CHA_VENDOR_SELL_SCALE` | VERIFIED | Line 14: import; lines 113-116: usage in `recomputeCharacterDerived` |
| `helpers/npc_affinity.ts` | `data/combat_scaling.ts` | `statOffset` + `CHA_AFFINITY_BONUS_PER_POINT` | VERIFIED | Line 4: import; line 52: usage in `awardNpcAffinity` |
| `StatsPanel.vue` | character.dex / character.str | `props.selectedCharacter.dex` and `.str` in computed properties | VERIFIED | Lines 151, 161: `props.selectedCharacter.dex`/`.str` accessed directly |

---

### Requirements Coverage

| Requirement | Source Plans | Description | Status | Evidence |
|-------------|-------------|-------------|--------|---------|
| STAT-01 | 21.1-01, 21.1-04 | `statOffset()` helper with symmetric scaling around base 10 | SATISFIED | `combat_scaling.ts` lines 374-392: implementation matches spec exactly |
| STAT-02 | 21.1-01, 21.1-04 | Shield armor type + class restrictions (5 classes) | SATISFIED | `class_stats.ts` ARMOR_TYPES_WITH_NONE, CLASS_ARMOR, SHIELD_CLASSES; `item_defs.ts` Wooden Shield |
| STAT-03 | 21.1-02, 21.1-04 | DEX/STR block system: chance from DEX, mitigation from STR | SATISFIED | `helpers/combat.ts` parameterized opts; `reducers/combat.ts` stat derivation at enemy-attacks-character site |
| STAT-04 | 21.1-02 | WIS pull hook: shifts success%/fail% | SATISFIED | `reducers/combat.ts` lines 978-984 in `resolve_pull`, placed before dice roll |
| STAT-05 | 21.1-03 | INT salvage scroll drop + CHA vendor/faction/affinity hooks | SATISFIED | All four hooks verified across `items.ts`, `character.ts`, `economy.ts`, `npc_affinity.ts` |

---

### Anti-Patterns Found

No blocker or warning anti-patterns found in phase 21.1 files.

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `21.1-04-SUMMARY.md` | - | Pre-existing TypeScript errors noted (not caused by this phase) | Info | No impact on phase 21.1 functionality; `spacetime publish` uses esbuild, not strict tsc |

---

### Human Verification

Human verification was approved 2026-02-21. The following were confirmed by the user:

1. **Block stats visible in UI** — StatsPanel shows "Block Chance" and "Block Mitigation" rows with numeric values (5.0% chance at base DEX=10, 30% mitigation at base STR=10)
2. **Shield restriction works** — Trying to equip a shield on non-shield classes is rejected; warrior equip succeeds
3. **Salvage drops scrolls** — Salvaging a craftable gear item drops a `Scroll: <RecipeName>` item to inventory rather than auto-learning the recipe
4. **Vendor CHA pricing active** — Characters with CHA above 10 receive buy discounts and sell bonuses at vendors
5. **No server panics** — `spacetime logs uwr` shows no PANIC or ERROR from the new stat hooks

---

### Notable Implementation Deviations

**SALVAGE_SCROLL_CHANCE_BASE: 25n in plan vs 8n in code.**

The plan specified a base scroll drop chance of `25n` (25% on 100n scale). The actual implementation uses `8n` (8% on 100n scale). This is an intentional design decision made during implementation — the inline comment in `combat_scaling.ts` reads: *"Lower base — scrolls are tradeable and valuable, so they should be rare finds. INT=10: 8%. INT=14: 20%. INT=6: down to 5% clamp."*

This is a tuning decision within the scope of the plan's goal (INT-boosted scroll drop with a configurable base). The mechanism is fully implemented; only the balance constant was adjusted. Human verification confirmed the system functions correctly with this value.

---

### Gaps Summary

No gaps. All 16 observable truths are verified against the actual codebase. All artifacts exist, are substantive (not stubs), and are correctly wired. Human verification was approved. Phase 21.1 goal is achieved.

---

_Verified: 2026-02-21_
_Verifier: Claude (gsd-verifier)_
