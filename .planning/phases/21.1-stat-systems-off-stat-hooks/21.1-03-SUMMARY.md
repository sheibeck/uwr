---
phase: 21.1-stat-systems-off-stat-hooks
plan: "03"
subsystem: gameplay
tags: [spacetimedb, typescript, stats, economy, crafting, salvage, vendors, faction, npc-affinity]

# Dependency graph
requires:
  - phase: 21.1-01
    provides: statOffset() helper and combat_scaling.ts constants (INT_SALVAGE_BONUS_PER_POINT, SALVAGE_SCROLL_CHANCE_BASE, CHA_VENDOR_SCALE, CHA_VENDOR_SELL_SCALE, CHA_FACTION_BONUS_PER_POINT, CHA_AFFINITY_BONUS_PER_POINT)
provides:
  - INT-boosted recipe scroll drops from salvage (replacing auto-learn of RecipeDiscovered)
  - Symmetric CHA formula for vendorBuyMod/vendorSellMod in recomputeCharacterDerived
  - CHA vendor discount applied in buy_item reducer (1000-scale)
  - CHA vendor bonus applied in sell_item reducer (1000-scale)
  - CHA faction gains multiplier in mutateStanding (positive deltas only)
  - CHA affinity gains multiplier in awardNpcAffinity (positive changes only)
affects: [economy, vendors, salvage, crafting, faction-standing, npc-affinity]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "statOffset pattern: (stat - 10) * bonusPerPoint gives signed bigint, used for all off-stat hooks"
    - "Clamp-to-zero for u64 DB columns: vendorBuyMod/vendorSellMod clamped >= 0n to avoid u64 underflow"
    - "1000-scale for price modifiers: (price * (1000 +/- mod)) / 1000n for integer arithmetic"
    - "Float multiplier for affinity: Number(statOffset) / 100.0 converts to float for multiplier stacking"

key-files:
  created: []
  modified:
    - spacetimedb/src/reducers/items.ts
    - spacetimedb/src/helpers/character.ts
    - spacetimedb/src/helpers/economy.ts
    - spacetimedb/src/helpers/npc_affinity.ts

key-decisions:
  - "Salvage drops Scroll: <RecipeName> item to inventory instead of inserting RecipeDiscovered — scrolls are tradeable and more valuable than auto-learn"
  - "Scroll drop chance clamped to [5n, 95n] — always a chance but never guaranteed"
  - "Missing scroll template logs debug event rather than crashing — graceful degradation"
  - "vendorBuyMod/vendorSellMod clamped to 0n minimum (no penalty for low CHA) — consistent with u64 column type"
  - "CHA faction hook uses floor at 1n — prevents reducing positive delta to 0 or negative (which would flip standing direction)"
  - "CHA affinity hook uses float multiplier with 0.01 floor — prevents sign flip while allowing reduction"

patterns-established:
  - "Off-stat hook pattern: statOffset(stat, bonusPerPoint) inside guard (delta > 0n or similar) to only affect positive direction"

requirements-completed: [STAT-05]

# Metrics
duration: 25min
completed: 2026-02-20
---

# Phase 21.1 Plan 03: INT/CHA Off-Stat Hooks Summary

**INT-boosted recipe scroll drops from salvage (replaces auto-learn), CHA symmetric vendor formula, and CHA faction/affinity gain multipliers applied across economy and NPC systems**

## Performance

- **Duration:** ~25 min
- **Started:** 2026-02-20T00:00:00Z
- **Completed:** 2026-02-20T00:25:00Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments

- Salvage no longer auto-inserts RecipeDiscovered; instead drops "Scroll: RecipeName" to inventory with INT-boosted chance (25% base + 3% per INT point above 10, clamped 5-95%)
- vendorBuyMod and vendorSellMod in recomputeCharacterDerived now use symmetric statOffset formula: `max(0, (cha-10) * scale)` replacing the old `cha * constant` formula
- buy_item and sell_item reducers apply character.vendorBuyMod/vendorSellMod as 1000-scale price modifiers
- mutateStanding applies CHA-derived percentage multiplier to positive faction deltas (1% per CHA point above/below 10)
- awardNpcAffinity applies CHA-derived percentage multiplier to positive affinity changes via float multiplier stack

## Task Commits

Each task was committed atomically:

1. **Task 1: Replace salvage auto-learn with INT-boosted scroll drop** - `2f2e52e` (feat)
2. **Task 2: Update CHA vendor formula and apply in buy_item/sell_item** - `563578b` (feat)
3. **Task 3: CHA faction and affinity hooks** - `f447be8` (feat)

## Files Created/Modified

- `spacetimedb/src/reducers/items.ts` - Added combat_scaling imports; replaced recipe auto-learn block with INT-boosted scroll drop; added CHA vendor discount in buy_item and CHA sell bonus in sell_item
- `spacetimedb/src/helpers/character.ts` - Added CHA_VENDOR_SCALE/CHA_VENDOR_SELL_SCALE imports; replaced cha*constant vendor formulas with statOffset-based symmetric formula clamped >= 0
- `spacetimedb/src/helpers/economy.ts` - Added CHA_FACTION_BONUS_PER_POINT import and chaOffset hook inside mutateStanding positive delta guard
- `spacetimedb/src/helpers/npc_affinity.ts` - Added CHA_AFFINITY_BONUS_PER_POINT import and chaOffsetPct hook inside awardNpcAffinity positive baseChange guard

## Decisions Made

- Scroll drop chance uses same deterministic roll formula as before: `(timestamp + characterId) % 100n` — consistent with rest of codebase
- CHA vendor clamped at 0n (no penalty) — the u64 column type makes negative clamping necessary, and design intent is bonus-only
- CHA faction floor at 1n on positive delta — protects against reducing positive standing change to zero
- CHA affinity uses 0.01 multiplier floor — prevents zero/negative affinity change from a positive baseChange

## Deviations from Plan

None - plan executed exactly as written. The linter auto-removed import-only edits before usages were added; resolved by writing imports and usages in a single operation.

## Issues Encountered

- Linter stripped newly added import lines from economy.ts and npc_affinity.ts when imports were added as a separate edit before the usage code. Resolved by writing the full file content (import + usage) in a single Write operation.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Plan 21.1-03 complete. INT and CHA off-stat hooks are fully wired alongside WIS/DEX/STR hooks from Plan 21.1-02
- Full off-stat hook system now operational: STR (auto-attack), DEX (crit/block), WIS (healing/pull), INT (salvage scrolls), CHA (vendors/faction/affinity)
- Scroll item templates ("Scroll: RecipeName") need to exist in the DB for scroll drops to work — these are seeded via ensureRecipeTemplates if they include scroll item template creation

---
*Phase: 21.1-stat-systems-off-stat-hooks*
*Completed: 2026-02-20*

## Self-Check: PASSED

- FOUND: spacetimedb/src/reducers/items.ts
- FOUND: spacetimedb/src/helpers/character.ts
- FOUND: spacetimedb/src/helpers/economy.ts
- FOUND: spacetimedb/src/helpers/npc_affinity.ts
- FOUND: .planning/phases/21.1-stat-systems-off-stat-hooks/21.1-03-SUMMARY.md
- FOUND commit 2f2e52e: feat(21.1-03): replace salvage auto-learn with INT-boosted scroll drop
- FOUND commit 563578b: feat(21.1-03): update CHA vendor formula and apply in buy_item/sell_item
- FOUND commit f447be8: feat(21.1-03): CHA faction and affinity hooks in mutateStanding and awardNpcAffinity
