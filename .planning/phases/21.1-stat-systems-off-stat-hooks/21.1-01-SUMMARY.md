---
phase: 21.1-stat-systems-off-stat-hooks
plan: "01"
subsystem: combat
tags: [combat-scaling, stat-hooks, shield, armor-types, bigint]

# Dependency graph
requires: []
provides:
  - "statOffset() helper for symmetric stat scaling around STAT_BASE=10"
  - "STAT_BASE, BLOCK_CHANCE_BASE/DEX_PER_POINT, BLOCK_MITIGATION_BASE/STR_PER_POINT constants"
  - "WIS_PULL_BONUS_PER_POINT, INT_SALVAGE_BONUS_PER_POINT, SALVAGE_SCROLL_CHANCE_BASE constants"
  - "CHA_FACTION_BONUS_PER_POINT, CHA_AFFINITY_BONUS_PER_POINT, CHA_VENDOR_SCALE/SELL_SCALE constants"
  - "Shield armor type recognized in ARMOR_TYPES_WITH_NONE (no fallback to cloth)"
  - "CLASS_ARMOR: warrior, paladin, cleric, spellblade, shaman allow shield; all others do not"
  - "SHIELD_CLASSES Set exported from class_stats.ts"
  - "Wooden Shield has armorType:'shield' and correct allowedClasses"
affects:
  - "21.1-02 and later plans that wire statOffset() into pull/salvage/faction/combat reducers"
  - "equip_item reducer — now enforces shield class restrictions via isArmorAllowedForClass"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "statOffset(statValue, bonusPerPoint) = (statValue - 10n) * bonusPerPoint — symmetric, signed bigint"
    - "All off-stat hooks share one formula; constants in combat_scaling.ts specify per-hook magnitudes"
    - "Shield is a slot-level armor restriction, not a separate equipment slot"

key-files:
  created: []
  modified:
    - spacetimedb/src/data/combat_scaling.ts
    - spacetimedb/src/data/class_stats.ts
    - spacetimedb/src/data/item_defs.ts

key-decisions:
  - "statOffset uses STAT_BASE=10n; values below 10 produce negative offsets (bigint handles negatives natively)"
  - "Five shield classes: warrior, paladin, cleric, spellblade, shaman — bard removed (was legacy error)"
  - "CHA vendor columns stay u64; formula changed to (cha-10)*scale clamped at 0n — CHA<10 gives no penalty not negative"
  - "normalizeArmorType('shield') now returns 'shield' (was 'cloth') — CLASS_ARMOR routes correctly"

patterns-established:
  - "Off-stat scaling: import statOffset + specific constant from combat_scaling.ts, compute inline at call site"
  - "Shield as armor type: check isArmorAllowedForClass(className, 'shield') — no special case code needed"

requirements-completed:
  - STAT-01
  - STAT-02

# Metrics
duration: 15min
completed: 2026-02-20
---

# Phase 21.1 Plan 01: Stat Systems Off-Stat Hooks Foundation Summary

**Symmetric statOffset() helper with bigint signed arithmetic, shield armor type in CLASS_ARMOR for five restricted classes, and Wooden Shield armorType corrected from 'none' to 'shield'**

## Performance

- **Duration:** ~15 min
- **Started:** 2026-02-20T14:51:57Z
- **Completed:** 2026-02-20T15:06:00Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments
- Added `statOffset(statValue, bonusPerPoint)` pure helper function to combat_scaling.ts — returns signed bigint offset relative to STAT_BASE=10n
- Added 11 scaling constants covering block system (DEX/STR), WIS pull hook, INT salvage scroll, and CHA social/vendor hooks
- Added 'shield' to ARMOR_TYPES_WITH_NONE so normalizeArmorType('shield') returns 'shield' instead of falling back to 'cloth'
- Added 'shield' to CLASS_ARMOR for warrior, paladin, cleric, spellblade, shaman — all other classes excluded
- Exported SHIELD_CLASSES Set as canonical reference for the five shield-allowed classes
- Fixed Wooden Shield in item_defs.ts: armorType 'none' -> 'shield', allowedClasses corrected (bard removed, spellblade added)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add statOffset() helper to combat_scaling.ts** - `c33e245` (feat)
2. **Task 2: Add shield armor type and class restrictions in class_stats.ts** - `c864669` (feat)
3. **Task 3: Fix Wooden Shield item data and audit seeding for shield items** - `73f6b21` (fix)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `spacetimedb/src/data/combat_scaling.ts` - Added statOffset() helper + STAT_BASE + 10 off-stat scaling constants (81 lines appended)
- `spacetimedb/src/data/class_stats.ts` - Added 'shield' to ARMOR_TYPES_WITH_NONE, 'shield' to 5 CLASS_ARMOR entries, SHIELD_CLASSES Set
- `spacetimedb/src/data/item_defs.ts` - Fixed Wooden Shield: armorType 'shield', allowedClasses corrected to 5 shield classes

## Decisions Made
- `statOffset()` uses signed bigint arithmetic — TypeScript bigint naturally handles negative values so no special casing needed
- CHA vendor modifier columns remain u64; formula uses `(cha - 10n) * scale` clamped at 0n to avoid u64 underflow — CHA < 10 gives no bonus rather than a penalty, which is intentional for the u64 constraint
- Five locked shield classes: warrior, paladin, cleric, spellblade, shaman — bard was in the old Wooden Shield allowedClasses as a legacy error (bard is a cloth/chain caster)
- No changes needed to isArmorAllowedForClass() or any equip reducer — updating CLASS_ARMOR is sufficient for routing

## Deviations from Plan

None - plan executed exactly as written. The seeding audit confirmed no additional shield items in ensure_items.ts beyond Wooden Shield in item_defs.ts.

## Issues Encountered

Pre-existing TypeScript errors exist in combat.ts, corpse.ts, and location.ts (RowBuilder property access patterns from a SpacetimeDB SDK change). These are out of scope and not caused by this plan's changes. Verified that combat_scaling.ts, class_stats.ts, and item_defs.ts have zero TypeScript errors.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- statOffset() ready to be imported and used at all five off-stat call sites (Phase 21.1-02+)
- Shield restriction data in place — equip_item reducer will automatically enforce it via isArmorAllowedForClass
- All scaling constants documented with their scale (1000-scale vs 100-scale) and intent

## Self-Check: PASSED

- FOUND: spacetimedb/src/data/combat_scaling.ts
- FOUND: spacetimedb/src/data/class_stats.ts
- FOUND: spacetimedb/src/data/item_defs.ts
- FOUND: .planning/phases/21.1-stat-systems-off-stat-hooks/21.1-01-SUMMARY.md
- FOUND commit c33e245: feat(21.1-01): add statOffset() helper and off-stat scaling constants
- FOUND commit c864669: feat(21.1-01): add shield armor type and class restrictions
- FOUND commit 73f6b21: fix(21.1-01): correct Wooden Shield armorType and allowedClasses

---
*Phase: 21.1-stat-systems-off-stat-hooks*
*Completed: 2026-02-20*
