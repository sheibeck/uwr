---
phase: 21.1-stat-systems-off-stat-hooks
plan: "04"
subsystem: ui
tags: [vue, spacetimedb, combat-stats, block-system, dex-str-hooks]

# Dependency graph
requires:
  - phase: 21.1-stat-systems-off-stat-hooks/01
    provides: statOffset helper and shield armor type restriction
  - phase: 21.1-stat-systems-off-stat-hooks/02
    provides: DEX/STR block system in combat loop, WIS pull hook
  - phase: 21.1-stat-systems-off-stat-hooks/03
    provides: INT salvage scroll drop, CHA vendor/faction/affinity hooks
provides:
  - Local SpacetimeDB running all Phase 21.1 off-stat hook changes
  - Regenerated client bindings synced with current schema
  - StatsPanel.vue block chance (DEX) and block mitigation (STR) display
  - Human-verified confirmation of all Phase 21.1 systems (pending checkpoint)
affects: [combat, inventory, stats-display, vendor-system]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Block stat display uses inline constants mirroring combat_scaling.ts for client/server parity"
    - "bigint arithmetic in Vue computed: keep as bigint until final Number() conversion"

key-files:
  created: []
  modified:
    - src/components/StatsPanel.vue
    - src/module_bindings/pull_state_table.ts
    - src/module_bindings/pull_state_type.ts

key-decisions:
  - "Block chance/mitigation computed client-side from character base stats (not gear-boosted totals) to match server combat loop"
  - "Constants inlined in StatsPanel instead of imported (client cannot import from spacetimedb/src/)"
  - "Block stats shown unconditionally with '(with shield)' note — standard RPG convention for potential values"

patterns-established:
  - "Stat display: bigint arithmetic for formula fidelity, Number() only at display boundary"

requirements-completed: [STAT-01, STAT-02, STAT-03, STAT-04, STAT-05]

# Metrics
duration: ~25min
completed: 2026-02-20
---

# Phase 21.1 Plan 04: Deploy & Display Block Stats Summary

**Local SpacetimeDB updated with all Phase 21.1 off-stat hooks; StatsPanel displays block chance (DEX, 5.0% base) and block mitigation (STR, 30% base) with shield notation**

## Performance

- **Duration:** ~25 min
- **Started:** 2026-02-20T20:00:00Z
- **Completed:** 2026-02-20T20:25:00Z
- **Tasks:** 3 of 3 complete (Task 3 human-verify checkpoint approved 2026-02-21)
- **Files modified:** 3

## Accomplishments
- Backend published to local SpacetimeDB with zero errors and no PANIC/ERROR in module logs
- Client bindings regenerated (pull_state_table/type updated to match current schema)
- StatsPanel.vue shows Block Chance (DEX-derived, 1000-scale→%) and Block Mitigation (STR-derived, 100-scale→%) rows
- Formula matches server exactly: STAT_BASE=10, clamp [1%,20%] for chance, [10%,80%] for mitigation

## Task Commits

Each task was committed atomically:

1. **Task 1: Publish backend and regenerate bindings** - `0648246` (chore)
2. **Task 2: Display block chance and mitigation in StatsPanel** - `9a857d1` (feat)
3. **Task 3: Human verify** - APPROVED (2026-02-21)

## Files Created/Modified
- `src/components/StatsPanel.vue` - Added blockChancePercent and blockMitigationPercent computed properties and two new Derived rows
- `src/module_bindings/pull_state_table.ts` - Regenerated: removed resolveAtMicros field (schema sync)
- `src/module_bindings/pull_state_type.ts` - Regenerated: removed resolveAtMicros field (schema sync)

## Decisions Made
- Block stats computed from `selectedCharacter.dex` and `.str` (raw base stats from DB row) to match the server's `targetCharacter.dex` / `.str` access in the combat loop — NOT gear-boosted totals
- Constants (`STAT_BASE`, `BLOCK_CHANCE_BASE`, etc.) inlined in StatsPanel.vue because the client cannot import from `spacetimedb/src/` — values match `combat_scaling.ts` exactly

## Deviations from Plan

### Out-of-Scope Pre-Existing Errors Noted (Not Fixed)

The backend TypeScript compiler (tsc) reports pre-existing errors across combat.ts, location.ts, items.ts, corpse.ts, etc. involving `RowBuilder<CoerceRow<...>>` type issues and implicit `any` parameters. These are NOT caused by Phase 21.1 changes — they are structural SpacetimeDB SDK type inference issues that existed before this phase.

Similarly, the client has pre-existing TypeScript errors in App.vue and composables involving `readonly` array types and `XxxRow refers to a value, but is being used as a type` patterns.

**Per SCOPE BOUNDARY rule:** These are out-of-scope discoveries unrelated to Phase 21.1 task changes. They are deferred — the module still builds and publishes successfully (SpacetimeDB uses its own bundler), and the app runs.

**None of the above affect correctness of the Phase 21.1 features.**

---

**Total deviations:** 0 auto-fixes required (plan executed as specified)
**Impact on plan:** None.

## Issues Encountered
- `tsc --noEmit` in backend reports pre-existing type errors but `spacetime publish` succeeds (SpacetimeDB uses esbuild, not tsc strict check)
- Client `tsc --noEmit` also reports pre-existing errors in App.vue/composables — these pre-date Phase 21.1 and are unrelated to StatsPanel changes

## Next Phase Readiness
- All Phase 21.1 server-side stat hooks deployed and running
- Client displays block stats derived from DEX/STR with correct formula
- Human verification approved 2026-02-21
- Phase 21.1 fully complete

---
*Phase: 21.1-stat-systems-off-stat-hooks*
*Completed: 2026-02-20*
