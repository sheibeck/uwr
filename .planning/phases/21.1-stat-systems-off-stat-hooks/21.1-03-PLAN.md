---
phase: 21.1-stat-systems-off-stat-hooks
plan: "03"
type: execute
wave: 2
depends_on:
  - "21.1-01"
files_modified:
  - spacetimedb/src/helpers/character.ts
  - spacetimedb/src/helpers/economy.ts
  - spacetimedb/src/helpers/npc_affinity.ts
  - spacetimedb/src/reducers/items.ts
autonomous: true
requirements:
  - STAT-05

must_haves:
  truths:
    - "Salvage no longer auto-learns recipes — it drops a Scroll: <RecipeName> item into inventory instead"
    - "INT stat boosts salvage scroll drop chance: higher INT means more recipe scrolls from salvage"
    - "CHA boosts vendor buy discounts and sell bonuses: higher CHA means better vendor prices"
    - "CHA boosts faction gains: positive standing changes are multiplied by a CHA-derived factor"
    - "CHA boosts NPC affinity gains: positive affinity changes are multiplied by a CHA-derived factor"
    - "vendorBuyMod and vendorSellMod in recomputeCharacterDerived use (cha - 10n) * scale formula"
  artifacts:
    - path: "spacetimedb/src/helpers/character.ts"
      provides: "Updated vendorBuyMod/vendorSellMod formula using symmetric (cha-10) scaling"
      contains: "CHA_VENDOR_SCALE"
    - path: "spacetimedb/src/helpers/economy.ts"
      provides: "CHA faction gains hook in mutateStanding"
      contains: "CHA_FACTION_BONUS_PER_POINT"
    - path: "spacetimedb/src/helpers/npc_affinity.ts"
      provides: "CHA affinity gains hook in awardNpcAffinity"
      contains: "CHA_AFFINITY_BONUS_PER_POINT"
    - path: "spacetimedb/src/reducers/items.ts"
      provides: "INT scroll drop in salvage_item, CHA applied in buy_item/sell_item"
      contains: "SALVAGE_SCROLL_CHANCE_BASE"
  key_links:
    - from: "spacetimedb/src/reducers/items.ts"
      to: "spacetimedb/src/data/combat_scaling.ts"
      via: "statOffset and INT_SALVAGE_BONUS_PER_POINT imports for scroll drop"
      pattern: "INT_SALVAGE_BONUS_PER_POINT"
    - from: "spacetimedb/src/reducers/items.ts"
      to: "existing learn_recipe_scroll flow"
      via: "addItemToInventory dropping Scroll: RecipeName item"
      pattern: "Scroll:.*addItemToInventory|addItemToInventory.*Scroll:"
    - from: "spacetimedb/src/helpers/economy.ts"
      to: "spacetimedb/src/data/combat_scaling.ts"
      via: "statOffset and CHA_FACTION_BONUS_PER_POINT for faction gains"
      pattern: "CHA_FACTION_BONUS_PER_POINT"
---

<objective>
Wire INT and CHA off-stat hooks: INT-boosted recipe scroll drops from salvage (replacing auto-learn), CHA vendor price modifiers applied in buy/sell, CHA faction gains multiplier, CHA NPC affinity gains multiplier.

Purpose: INT and CHA hooks complete the off-stat system alongside the WIS/DEX/STR hooks in Plan 02. These touch different files (reducers/items.ts, helpers/economy.ts, helpers/npc_affinity.ts, helpers/character.ts) with no overlap with Plan 02, enabling parallel Wave 2 execution.

Output: Salvage drops recipe scrolls with INT-boosted probability; vendorBuyMod/vendorSellMod use symmetric CHA formula; buy/sell reducers apply CHA-derived vendor modifiers; faction and affinity gains multiplied by CHA offset.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21.1-stat-systems-off-stat-hooks/21.1-CONTEXT.md
@.planning/phases/21.1-stat-systems-off-stat-hooks/21.1-RESEARCH.md
@.planning/phases/21.1-stat-systems-off-stat-hooks/21.1-01-SUMMARY.md
@spacetimedb/src/helpers/character.ts
@spacetimedb/src/helpers/economy.ts
@spacetimedb/src/helpers/npc_affinity.ts
@spacetimedb/src/reducers/items.ts
@spacetimedb/src/data/combat_scaling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace salvage auto-learn with INT-boosted scroll drop in reducers/items.ts</name>
  <files>spacetimedb/src/reducers/items.ts</files>
  <action>
    Read `salvage_item` in `spacetimedb/src/reducers/items.ts` (approximately lines 1809-1897 per research). Find the recipe discovery block — the one that currently:
    1. Finds a matching RecipeTemplate by output item
    2. Checks if recipe is already known
    3. Rolls 75% chance and inserts into `RecipeDiscovered`

    This entire block must be replaced. The new behavior:

    ```typescript
    // INT-boosted recipe scroll drop (replaces auto-learn)
    // Import at top of file if not already present:
    //   import { statOffset, INT_SALVAGE_BONUS_PER_POINT, SALVAGE_SCROLL_CHANCE_BASE } from '../data/combat_scaling.js';

    const matchingRecipe = [...ctx.db.recipeTemplate.iter()].find(
      r => r.outputTemplateId === instance.templateId
    );
    if (matchingRecipe) {
      // Compute INT-boosted chance (on 100n scale)
      const intOffset = statOffset(character.int, INT_SALVAGE_BONUS_PER_POINT);
      const rawChance = SALVAGE_SCROLL_CHANCE_BASE + intOffset;
      // Clamp to [5n, 95n]
      const scrollChance = rawChance < 5n ? 5n : rawChance > 95n ? 95n : rawChance;
      const roll = (ctx.timestamp.microsSinceUnixEpoch + character.id) % 100n;
      if (roll < scrollChance) {
        const scrollTemplate = findItemTemplateByName(ctx, `Scroll: ${matchingRecipe.name}`);
        if (scrollTemplate) {
          addItemToInventory(ctx, character.id, scrollTemplate.id, 1n);
          appendPrivateEvent(ctx, character.id, `You found a recipe scroll: Scroll: ${matchingRecipe.name}.`);
        } else {
          // Template missing — log for debugging but don't crash
          appendPrivateEvent(ctx, character.id, `[Debug] No scroll template found for: ${matchingRecipe.name}.`);
        }
      }
    }
    ```

    IMPORTANT: Read the existing salvage_item code carefully before replacing. The existing code has variable names for the character, ctx, item instance etc. — use the exact same variable names that are already in scope. The `appendPrivateEvent` call signature may differ — match the existing pattern in the file.

    Also add the necessary imports at the top of `reducers/items.ts` if not already present:
    - `statOffset`, `INT_SALVAGE_BONUS_PER_POINT`, `SALVAGE_SCROLL_CHANCE_BASE` from `../data/combat_scaling.js`
    - `findItemTemplateByName` from `../helpers/items.js` (verify it's already imported)
    - `addItemToInventory` from `../helpers/items.js` (verify it's already imported)

    The `RecipeDiscovered` import may now be unused in salvage_item — do NOT remove it if it's still used elsewhere in the file (e.g., in `learn_recipe_scroll`). Check before removing.
  </action>
  <verify>
    1. `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit 2>&1 | head -30` — zero errors.
    2. Grep: `grep -n "SALVAGE_SCROLL_CHANCE_BASE\|INT_SALVAGE_BONUS_PER_POINT\|Scroll:" C:/projects/uwr/spacetimedb/src/reducers/items.ts` — scroll drop logic present.
    3. Grep: `grep -n "RecipeDiscovered.insert" C:/projects/uwr/spacetimedb/src/reducers/items.ts` — should show ZERO occurrences in salvage_item (auto-learn removed). learn_recipe_scroll may still have it elsewhere.
  </verify>
  <done>
    - salvage_item no longer inserts into RecipeDiscovered; instead drops a Scroll: item with INT-boosted chance
    - Missing scroll template logs a debug event rather than crashing
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CHA vendor formula and apply in buy_item/sell_item</name>
  <files>spacetimedb/src/helpers/character.ts, spacetimedb/src/reducers/items.ts</files>
  <action>
    **Part A: Update vendorBuyMod/vendorSellMod formula in helpers/character.ts**

    Locate `recomputeCharacterDerived` in `spacetimedb/src/helpers/character.ts` (approximately lines 53-141 per research). Find these two lines:
    ```typescript
    const vendorBuyMod  = totalStats.cha * 10n;
    const vendorSellMod = totalStats.cha * 8n;
    ```

    Replace with the symmetric formula (clamped at 0n since columns are u64):
    ```typescript
    // Import at top: import { statOffset, CHA_VENDOR_SCALE, CHA_VENDOR_SELL_SCALE } from '../data/combat_scaling.js';
    const vendorBuyModRaw  = statOffset(totalStats.cha, CHA_VENDOR_SCALE);
    const vendorSellModRaw = statOffset(totalStats.cha, CHA_VENDOR_SELL_SCALE);
    // Columns are u64 — clamp negative values to 0 (no penalty, just no bonus)
    const vendorBuyMod  = vendorBuyModRaw  < 0n ? 0n : vendorBuyModRaw;
    const vendorSellMod = vendorSellModRaw < 0n ? 0n : vendorSellModRaw;
    ```

    At CHA=10: vendorBuyMod=0, vendorSellMod=0 (no bonus at base)
    At CHA=12: vendorBuyMod=20n (2% on 1000-scale), vendorSellMod=16n (1.6%)
    At CHA=8: vendorBuyMod=0 (clamped, no penalty)

    Add the import for `statOffset`, `CHA_VENDOR_SCALE`, `CHA_VENDOR_SELL_SCALE` from `../data/combat_scaling.js` at the top of `helpers/character.ts`.

    **Part B: Apply vendorBuyMod and vendorSellMod in buy_item and sell_item in reducers/items.ts**

    Locate `buy_item` reducer (approximately lines 135-177 per research). After the renown-perk discount is applied, add the CHA vendor discount:
    ```typescript
    // Apply CHA vendor buy discount (character.vendorBuyMod is on 1000-scale)
    if (character.vendorBuyMod > 0n) {
      finalPrice = (finalPrice * (1000n - character.vendorBuyMod)) / 1000n;
      if (finalPrice < 1n) finalPrice = 1n;
    }
    ```

    Locate `sell_item` reducer (approximately lines 179-240 per research). After the renown-perk sell bonus, add:
    ```typescript
    // Apply CHA vendor sell bonus (character.vendorSellMod is on 1000-scale)
    if (character.vendorSellMod > 0n) {
      finalSellPrice = (finalSellPrice * (1000n + character.vendorSellMod)) / 1000n;
    }
    ```

    Read the actual buy_item and sell_item code before editing — the variable names for price may differ. Use the exact variable names already present (e.g., `price`, `totalCost`, `sellValue`, etc.).
  </action>
  <verify>
    1. `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit 2>&1 | head -30` — zero errors.
    2. Grep: `grep -n "CHA_VENDOR_SCALE\|vendorBuyModRaw" C:/projects/uwr/spacetimedb/src/helpers/character.ts` — new formula present.
    3. Grep: `grep -n "vendorBuyMod\|vendorSellMod" C:/projects/uwr/spacetimedb/src/reducers/items.ts` — two occurrences (buy_item and sell_item).
  </verify>
  <done>
    - vendorBuyMod formula = max(0, (cha - 10) * CHA_VENDOR_SCALE) in recomputeCharacterDerived
    - buy_item applies character.vendorBuyMod as a 1000-scale discount
    - sell_item applies character.vendorSellMod as a 1000-scale bonus
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 3: CHA faction and affinity hooks</name>
  <files>spacetimedb/src/helpers/economy.ts, spacetimedb/src/helpers/npc_affinity.ts</files>
  <action>
    **Part A: CHA faction gains hook in helpers/economy.ts**

    Read `mutateStanding` in `spacetimedb/src/helpers/economy.ts` (approximately lines 6-24 per research). The existing structure:
    ```typescript
    export function mutateStanding(ctx, characterId, factionId, delta) {
      let effectiveDelta = delta;
      if (delta > 0n) {
        const character = ctx.db.character.id.find(characterId);
        const racialBonus = character?.racialFactionBonus ?? 0n;
        if (racialBonus > 0n) {
          effectiveDelta = delta + (delta * racialBonus) / 100n;
        }
        // ← INSERT CHA HOOK HERE
      }
      // ...
    }
    ```

    Add the CHA hook immediately after the racial bonus block, inside the `if (delta > 0n)` guard:
    ```typescript
    // CHA off-stat hook: boosts positive faction gains
    // Import at top: import { statOffset, CHA_FACTION_BONUS_PER_POINT } from '../data/combat_scaling.js';
    if (character) {
      const chaOffset = statOffset(character.cha, CHA_FACTION_BONUS_PER_POINT);
      if (chaOffset !== 0n) {
        effectiveDelta = effectiveDelta + (effectiveDelta * chaOffset) / 100n;
        if (effectiveDelta < 1n) effectiveDelta = 1n; // floor at 1 on positive delta
      }
    }
    ```

    Note: `chaOffset` can be negative (CHA < 10 reduces faction gains). The floor at 1n prevents reducing positive delta to 0 or negative (that would flip standing direction unintentionally).

    Add the import for `statOffset` and `CHA_FACTION_BONUS_PER_POINT` from `../data/combat_scaling.js` at the top of `helpers/economy.ts`. Verify the actual variable names before editing.

    **Part B: CHA affinity gains hook in helpers/npc_affinity.ts**

    Read `awardNpcAffinity` in `spacetimedb/src/helpers/npc_affinity.ts` (approximately lines 31-52 per research). The existing structure near the affinity bonus section:
    ```typescript
    if (baseChange > 0n) {
      const affinityBonus = getPerkBonusByField(ctx, character.id, 'npcAffinityGainBonus', character.level);
      if (affinityBonus > 0) { multiplier = multiplier * (1.0 + affinityBonus / 100.0); }
      // ← INSERT CHA HOOK HERE
    }
    ```

    Add the CHA hook immediately after the perk bonus, inside the `if (baseChange > 0n)` guard:
    ```typescript
    // CHA off-stat hook: boosts positive affinity gains
    // Import at top: import { statOffset, CHA_AFFINITY_BONUS_PER_POINT } from '../data/combat_scaling.js';
    const chaOffsetPct = Number(statOffset(character.cha, CHA_AFFINITY_BONUS_PER_POINT));
    if (chaOffsetPct !== 0) {
      multiplier = multiplier * (1.0 + chaOffsetPct / 100.0);
      if (multiplier < 0.01) multiplier = 0.01; // floor at near-zero, don't flip sign
    }
    ```

    Note: CHA < 10 gives negative chaOffsetPct, reducing the multiplier. This can reduce affinity gains but cannot flip to negative (the 0.01 floor prevents this). The effect is symmetric: CHA=12 boosts by 2%, CHA=8 reduces by 2%.

    Add the import for `statOffset` and `CHA_AFFINITY_BONUS_PER_POINT` from `../data/combat_scaling.js` at the top of `helpers/npc_affinity.ts`. Verify the actual variable names (e.g., `character.cha` vs `char.cha`, `baseChange` vs another variable name) before editing.
  </action>
  <verify>
    1. `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit 2>&1 | head -30` — zero errors.
    2. Grep: `grep -n "CHA_FACTION_BONUS_PER_POINT\|chaOffset" C:/projects/uwr/spacetimedb/src/helpers/economy.ts` — CHA hook present in mutateStanding.
    3. Grep: `grep -n "CHA_AFFINITY_BONUS_PER_POINT\|chaOffsetPct" C:/projects/uwr/spacetimedb/src/helpers/npc_affinity.ts` — CHA hook present in awardNpcAffinity.
    4. Both imports from `../data/combat_scaling.js` are present in each file.
  </verify>
  <done>
    - `mutateStanding` applies CHA-derived percentage multiplier to positive faction deltas using statOffset
    - `awardNpcAffinity` applies CHA-derived percentage multiplier to positive affinity changes using statOffset
    - CHA=10 → chaOffset=0 → no change from current behavior
    - CHA=12 → chaOffset=+2 → 2% bonus on gains
    - CHA=8 → chaOffset=-2 → 2% reduction on gains (floor prevents zeroing or flipping)
    - TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
Run `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit 2>&1`. Zero errors.

Verify the complete INT/CHA hook chain:
- `grep -rn "RecipeDiscovered.insert" C:/projects/uwr/spacetimedb/src/reducers/items.ts` — only in learn_recipe_scroll, NOT in salvage_item
- `grep -n "Scroll:" C:/projects/uwr/spacetimedb/src/reducers/items.ts` — appears in salvage_item scroll drop
- `grep -n "vendorBuyMod\|vendorSellMod" C:/projects/uwr/spacetimedb/src/reducers/items.ts` — appears in buy_item and sell_item
- `grep -n "chaOffset" C:/projects/uwr/spacetimedb/src/helpers/economy.ts C:/projects/uwr/spacetimedb/src/helpers/npc_affinity.ts` — present in both files
</verification>

<success_criteria>
- Salvage of a gear item with a matching recipe: drops "Scroll: RecipeName" to inventory (not auto-learns)
- Salvage scroll drop chance = clamp(25 + (INT - 10) * 3, 5, 95)% — INT=10 gives 25%, INT=14 gives 37%
- A missing scroll template logs a debug event rather than crashing
- buy_item final price reduced by vendorBuyMod/1000 when character.vendorBuyMod > 0
- sell_item final price increased by vendorSellMod/1000 when character.vendorSellMod > 0
- vendorBuyMod = max(0, (cha - 10) * 10) — CHA=12 gives 20n (2% discount); CHA=8 gives 0 (no penalty)
- mutateStanding positive deltas boosted by CHA offset: CHA=12 gives 2% more faction per action
- awardNpcAffinity positive changes boosted by CHA offset: CHA=12 gives 2% more affinity per interaction
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/21.1-stat-systems-off-stat-hooks/21.1-03-SUMMARY.md`
</output>
