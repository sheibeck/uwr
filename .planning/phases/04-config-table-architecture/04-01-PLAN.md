---
phase: 04-config-table-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/index.ts
autonomous: true
must_haves:
  truths:
    - "AbilityTemplate table has optional columns for power, damageType, statScaling, and all DoT/HoT/debuff/AoE metadata"
    - "ensureAbilityTemplates() seeds all new columns from ABILITIES constant and ABILITY_STAT_SCALING"
    - "Every ability row has power, damageType, and statScaling populated after seeding"
    - "Module publishes successfully with schema migration (new columns added at end, all optional)"
  artifacts:
    - path: "spacetimedb/src/index.ts"
      provides: "Extended AbilityTemplate table with 11 new optional columns"
      contains: "power: t.u64().optional()"
    - path: "spacetimedb/src/index.ts"
      provides: "Enhanced ensureAbilityTemplates seeding function"
      contains: "statScaling:"
  key_links:
    - from: "spacetimedb/src/index.ts (ensureAbilityTemplates)"
      to: "spacetimedb/src/data/ability_catalog.ts (ABILITIES)"
      via: "import and iteration"
      pattern: "ability\\.power"
    - from: "spacetimedb/src/index.ts (ensureAbilityTemplates)"
      to: "spacetimedb/src/data/combat_scaling.ts (ABILITY_STAT_SCALING)"
      via: "import and lookup"
      pattern: "ABILITY_STAT_SCALING\\[key\\]"
---

<objective>
Extend the AbilityTemplate table schema with optional columns for all ability metadata (power, damageType, statScaling, DoT/HoT/debuff/AoE fields) and enhance the seeding function to populate them from ABILITIES constant and ABILITY_STAT_SCALING mapping.

Purpose: Create the database-side foundation so ability metadata has a single source of truth in the database rather than scattered across 3 files. This plan adds columns and populates data; Plan 02 switches consumers.

Output: Extended AbilityTemplate table with populated metadata, published module.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-config-table-architecture/04-RESEARCH.md
@spacetimedb/src/index.ts
@spacetimedb/src/data/ability_catalog.ts
@spacetimedb/src/data/combat_scaling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AbilityTemplate table with metadata columns</name>
  <files>spacetimedb/src/index.ts</files>
  <action>
Add 11 new optional columns to the AbilityTemplate table definition (around line 523). Columns MUST be added at the END of the column list (after `description`) to satisfy SpacetimeDB automatic migration rules. All new columns MUST use `.optional()`.

Add these columns after `description: t.string()`:

```
power: t.u64().optional(),
damageType: t.string().optional(),
statScaling: t.string().optional(),
dotPowerSplit: t.f64().optional(),
dotDuration: t.u64().optional(),
hotPowerSplit: t.f64().optional(),
hotDuration: t.u64().optional(),
debuffType: t.string().optional(),
debuffMagnitude: t.i64().optional(),
debuffDuration: t.u64().optional(),
aoeTargets: t.string().optional(),
```

Column semantics:
- `power`: Ability base power from ABILITIES constant (BigInt)
- `damageType`: 'physical' | 'magic' | 'none' from ABILITIES constant
- `statScaling`: 'str' | 'dex' | 'int' | 'wis' | 'cha' | 'hybrid' | 'none' from ABILITY_STAT_SCALING
- `dotPowerSplit`: 0-1 fraction of power for DoT (f64)
- `dotDuration`: DoT duration in ticks (BigInt)
- `hotPowerSplit`: 0-1 fraction of power for HoT (f64)
- `hotDuration`: HoT duration in ticks (BigInt)
- `debuffType`: 'ac_bonus' | 'damage_down' | 'armor_down' | 'slow'
- `debuffMagnitude`: Fixed magnitude (can be negative, so i64)
- `debuffDuration`: Debuff duration in ticks (BigInt)
- `aoeTargets`: 'all_enemies' | 'all_allies' | 'all_party'

Do NOT rename the table (keep `name: 'ability_template'`). Do NOT change existing columns. Do NOT change indexes.
  </action>
  <verify>TypeScript compiles without errors. The table definition has all 11 new columns after `description`.</verify>
  <done>AbilityTemplate table definition extended with 11 optional metadata columns, all at end of column list.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance ensureAbilityTemplates to seed metadata from ABILITIES and ABILITY_STAT_SCALING</name>
  <files>spacetimedb/src/index.ts</files>
  <action>
Update the `ensureAbilityTemplates` function (around line 4332) to populate the new columns during seeding.

**Step 1: Add import for ABILITY_STAT_SCALING**

At the top of index.ts where imports are, add an import for `ABILITY_STAT_SCALING` from `./data/combat_scaling.js`. Check if it is already imported - if so, skip. The import path MUST use `.js` extension (SpacetimeDB module bundling requirement).

**Step 2: Update the seeding loop**

In the `for (const [key, ability] of Object.entries(ABILITIES))` loop (around line 4460), the `entry` type cast currently only includes `name, className, resource, level, castSeconds, cooldownSeconds, description`. Expand the type cast to include all AbilityMetadata fields: `power, damageType, dotPowerSplit, dotDuration, hotPowerSplit, hotDuration, debuffType, debuffMagnitude, debuffDuration, aoeTargets`.

**Step 3: Add new fields to insert and update calls**

In the update call (ctx.db.abilityTemplate.id.update), add:
```
power: entry.power ?? undefined,
damageType: entry.damageType ?? undefined,
statScaling: ABILITY_STAT_SCALING[key] ?? undefined,
dotPowerSplit: entry.dotPowerSplit ?? undefined,
dotDuration: entry.dotDuration ?? undefined,
hotPowerSplit: entry.hotPowerSplit ?? undefined,
hotDuration: entry.hotDuration ?? undefined,
debuffType: entry.debuffType ?? undefined,
debuffMagnitude: entry.debuffMagnitude ?? undefined,
debuffDuration: entry.debuffDuration ?? undefined,
aoeTargets: entry.aoeTargets ?? undefined,
```

Also add the same fields to the `ctx.db.abilityTemplate.insert({...})` call AND the `seenByKey.set(key, {...})` call after update.

IMPORTANT: For optional SpacetimeDB columns, use `undefined` (not `null`) for missing values â€” undefined means "not set" in SpacetimeDB TypeScript SDK.

**Step 4: Verify pet abilities**

The `pet_taunt` and `pet_bleed` keys also exist in ABILITIES. They should get `statScaling: undefined` since they're not in ABILITY_STAT_SCALING. Verify they don't crash the seeding loop.

Do NOT remove legacyDescriptions yet (that's Plan 02). Do NOT remove any existing seeding code. Only ADD the new fields to existing insert/update calls.
  </action>
  <verify>The module compiles. Grep for `statScaling:` in ensureAbilityTemplates confirms seeding is wired. Grep for `power:` in the insert call confirms power is seeded.</verify>
  <done>ensureAbilityTemplates seeds all 11 new metadata columns from ABILITIES constant and ABILITY_STAT_SCALING mapping. Every ability row gets power, damageType, statScaling populated (or undefined for abilities without those fields).</done>
</task>

</tasks>

<verification>
1. Module compiles: `cd spacetimedb && npx tsc --noEmit` passes
2. AbilityTemplate table has 22 columns total (11 original + 11 new)
3. ensureAbilityTemplates references ABILITY_STAT_SCALING for statScaling
4. All ABILITIES entries get power and damageType seeded
5. New columns are ALL at end of table definition, ALL optional
</verification>

<success_criteria>
- AbilityTemplate table extended with 11 optional metadata columns
- ensureAbilityTemplates populates all new columns from ABILITIES + ABILITY_STAT_SCALING
- Module compiles without TypeScript errors
- No existing functionality broken (existing columns unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/04-config-table-architecture/04-01-SUMMARY.md`
</output>
