---
phase: 13.1-dual-axis-gear-system
plan: 02
type: execute
wave: 2
depends_on: ["13.1-01"]
files_modified:
  - spacetimedb/src/reducers/items.ts
  - src/composables/useInventory.ts
  - src/App.vue
  - src/module_bindings/
autonomous: true
must_haves:
  truths:
    - "Crafted gear has craftQuality set based on material tier (standard/reinforced/exquisite)"
    - "Crafted gear has qualityTier set to 'common' by default (rarity independent of craft quality)"
    - "Crafted gear affixes are determined by craft quality level, not rarity"
    - "Client displays craftQuality on gear items in tooltip"
    - "Client reads description from ItemTemplate when available"
    - "Module is published and client bindings are regenerated"
  artifacts:
    - path: "spacetimedb/src/reducers/items.ts"
      provides: "Dual-axis craft_recipe reducer logic"
      contains: "materialTierToCraftQuality"
    - path: "src/composables/useInventory.ts"
      provides: "craftQuality and description field reading"
      contains: "craftQuality"
    - path: "src/App.vue"
      provides: "Tooltip rendering with craftQuality and template description"
      contains: "craftQuality"
    - path: "src/module_bindings/"
      provides: "Regenerated bindings with craftQuality on ItemInstance and description on ItemTemplate"
  key_links:
    - from: "spacetimedb/src/reducers/items.ts"
      to: "spacetimedb/src/data/crafting_materials.ts"
      via: "import materialTierToCraftQuality and getCraftedAffixes"
      pattern: "materialTierToCraftQuality.*getCraftedAffixes"
    - from: "src/composables/useInventory.ts"
      to: "src/module_bindings/"
      via: "reads instance.craftQuality and template.description"
      pattern: "instance\\.craftQuality|template\\.description"
    - from: "src/App.vue"
      to: "src/composables/useInventory.ts"
      via: "renders craftQuality and description from inventory item data"
      pattern: "craftQuality|description"
---

<objective>
Update the craft_recipe reducer for dual-axis logic (craft quality from material tier, rarity independent), publish the module, regenerate client bindings, and update the frontend to display craft quality and item descriptions.

Purpose: Complete the dual-axis gear system so crafted items have independent craft quality (controlling base stat affixes) and rarity (controlling magical power tier). Frontend displays the new craft quality level and reads template descriptions instead of computing them client-side.

Output: Working craft_recipe reducer with dual-axis logic, published module, regenerated bindings, frontend displaying craftQuality and template descriptions.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.1-dual-axis-gear-system-craft-quality-vs-rarity-material-consolidation-essence-material-metadata-consistency/13.1-RESEARCH.md
@.planning/phases/13.1-dual-axis-gear-system-craft-quality-vs-rarity-material-consolidation-essence-material-metadata-consistency/13.1-01-SUMMARY.md
@spacetimedb/src/reducers/items.ts
@src/composables/useInventory.ts
@src/App.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update craft_recipe reducer for dual-axis logic and publish module</name>
  <files>spacetimedb/src/reducers/items.ts</files>
  <action>
**Update the craft_recipe reducer** in `spacetimedb/src/reducers/items.ts` (the gear affix section around lines 980-1030):

1. **Import the new helper** at the top of items.ts (or wherever crafting_materials imports are):
   - Add `materialTierToCraftQuality` to the existing import from `../data/crafting_materials.ts`
   - The import line should include: `import { MATERIAL_DEFS, materialTierToQuality, materialTierToCraftQuality, getCraftedAffixes, ... } from '../data/crafting_materials';`

2. **Refactor the gear recipe affix block** (lines 980-1030). The current code:
   ```typescript
   const qualityTier = materialTierToQuality(materialTier);
   if (qualityTier !== 'common') {
     const craftedAffixes = getCraftedAffixes(materialKey, qualityTier);
     // ... inserts affixes, updates instance with qualityTier + displayName
   }
   ```

   Replace with dual-axis logic:
   ```typescript
   // Dual-axis: craft quality from material tier (controls affixes/base stats)
   const craftQuality = materialTierToCraftQuality(materialTier);
   // Rarity: crafted items always start as 'common' (no random affixes)
   const qualityTier = 'common';

   // Get deterministic affixes based on craft quality level
   const craftedAffixes = getCraftedAffixes(materialKey, craftQuality);

   // Find the newly created ItemInstance
   const newInstance = [...ctx.db.itemInstance.by_owner.filter(character.id)].find(
     (i) => i.templateId === recipe.outputTemplateId && !i.equippedSlot && !i.qualityTier && !i.craftQuality
   );

   if (newInstance) {
     // Insert ItemAffix rows for each crafted affix
     if (craftedAffixes.length > 0) {
       for (const affix of craftedAffixes) {
         ctx.db.itemAffix.insert({
           id: 0n,
           itemInstanceId: newInstance.id,
           affixType: affix.affixType,
           affixKey: affix.affixKey,
           affixName: affix.affixName,
           statKey: affix.statKey,
           magnitude: affix.magnitude,
         });
       }
       // Build display name with prefix/suffix
       craftedDisplayName = buildDisplayName(output.name, craftedAffixes);
     }

     // Update ItemInstance with BOTH axes
     ctx.db.itemInstance.id.update({
       ...newInstance,
       qualityTier,       // rarity = 'common' for all crafted gear
       craftQuality,      // craft quality from material tier
       displayName: craftedAffixes.length > 0 ? craftedDisplayName : undefined,
     });
   }
   ```

   Key changes from current code:
   - `materialTierToCraftQuality` replaces `materialTierToQuality` for the affix lookup
   - `qualityTier` is hardcoded to `'common'` (rarity axis — crafted items are always common rarity)
   - `craftQuality` is set from material tier (the new axis)
   - Affixes are always attempted regardless of quality (no `if (qualityTier !== 'common')` gate — instead, `getCraftedAffixes` returns empty for `'dented'` quality)
   - The `newInstance` find also checks `!i.craftQuality` to match fresh inserts
   - The ItemInstance update now sets BOTH `qualityTier` and `craftQuality`

3. **Remove the outer `if (qualityTier !== 'common')` guard** — all crafted gear should get craftQuality set (even if no affixes). The affixes themselves are gated by `getCraftedAffixes` returning empty for dented quality.

4. **Publish the module:**
   ```bash
   spacetime publish uwr --clear-database -y --project-path spacetimedb
   ```
   (Use `--clear-database` because we added new non-optional schema implications and need a clean slate)

5. **Regenerate client bindings:**
   ```bash
   spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb
   ```
  </action>
  <verify>
- Check that `items.ts` imports `materialTierToCraftQuality` from crafting_materials
- Check that craft_recipe reducer sets `craftQuality` from `materialTierToCraftQuality(materialTier)` and `qualityTier` to `'common'`
- Check that `getCraftedAffixes` is called with `craftQuality` (not the old `qualityTier`)
- Run `spacetime publish uwr --clear-database -y --project-path spacetimedb` — must succeed
- Run `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb` — must succeed
- Check that `src/module_bindings/` contains `craftQuality` field on ItemInstance type and `description` field on ItemTemplate type
  </verify>
  <done>craft_recipe reducer uses dual-axis logic (craftQuality from material tier, qualityTier='common'), module published, bindings regenerated with new fields</done>
</task>

<task type="auto">
  <name>Task 2: Frontend updates for craft quality display and template descriptions</name>
  <files>src/composables/useInventory.ts, src/App.vue</files>
  <action>
**Update `src/composables/useInventory.ts`:**

1. **Read `craftQuality` from ItemInstance** and expose it in the inventory item data. Find where the item data object is built (around line 138 where `qualityTier` is read). After the `qualityTier` line, add:
   ```typescript
   const craftQuality = instance.craftQuality ?? 'standard';
   ```

2. **Read `description` from ItemTemplate** and use it when available. Find where the `description` is computed (around lines 144-153). Change the description logic to prefer the template description:
   ```typescript
   const description =
     template?.description ||
     foodDescription ||
     ([
       tierLabel,
       qualityTier,
       craftQuality !== 'standard' ? craftQuality : null,
       typeField,
       template?.slot,
     ]
       .filter((value) => value && value.length > 0)
       .join(' \u2022 ') ?? '');
   ```
   Note: `template?.description` is checked first — if the template has a stored description, use it directly. Fall back to the computed description only if no stored description exists. Also include `craftQuality` in the computed fallback when it differs from 'standard'.

3. **Include `craftQuality` in the returned item object.** Find where the item data object is returned/constructed and add `craftQuality` to it. It should be available alongside `qualityTier`, `displayName`, `description`, etc.

**Update `src/App.vue`:**

4. **Display craftQuality in item tooltip.** Find the tooltip rendering section (around line 505-506 where `description` is shown). If the item has a `craftQuality` value other than 'standard', show it as a line in the tooltip. For example, before or after the description line:
   ```
   <span v-if="item.craftQuality && item.craftQuality !== 'standard'"
         style="color: #ccc; font-size: 11px; text-transform: capitalize;">
     {{ item.craftQuality }} Quality
   </span>
   ```

5. **Use craftQuality for color styling (optional enhancement).** If a craft quality color mapping exists or can be defined inline:
   - dented: #888 (gray)
   - standard: #ccc (light gray, default)
   - reinforced: #6c9 (green)
   - exquisite: #9cf (blue)
   - mastercraft: #f90 (orange)

   Apply this color to the "Quality" label if rendered.

6. **Ensure description from template is displayed.** The tooltip should already show `item.description` — verify it works with the new template-sourced description. If the description comes from `template.description`, it will be displayed as-is. No additional change needed if the tooltip already renders `item.description`.

**IMPORTANT:** Do NOT change how `qualityTier` (rarity) drives item name colors — that stays as-is. The craft quality is a separate display element.
  </action>
  <verify>
- Check `useInventory.ts` reads `instance.craftQuality` and `template?.description`
- Check `useInventory.ts` returns `craftQuality` in item data
- Check `App.vue` renders craftQuality when present and not 'standard'
- Check that the app compiles without TypeScript errors: `cd src && npx vue-tsc --noEmit` (or equivalent)
- Visually: description from template takes priority over computed description
  </verify>
  <done>Frontend reads and displays craftQuality from ItemInstance, reads description from ItemTemplate, tooltip shows craft quality level with color coding, app compiles without errors</done>
</task>

</tasks>

<verification>
1. Reducer: `craft_recipe` sets `craftQuality` from `materialTierToCraftQuality(materialTier)` (standard/reinforced/exquisite)
2. Reducer: `craft_recipe` sets `qualityTier` to `'common'` for all crafted gear (rarity independent)
3. Reducer: Affixes are looked up by craft quality level, not by rarity tier
4. Module: Published with `--clear-database`, no errors in `spacetime logs uwr`
5. Bindings: Regenerated, `ItemInstance` type has `craftQuality` field, `ItemTemplate` type has `description` field
6. Frontend: `useInventory.ts` exposes `craftQuality` and reads `template.description`
7. Frontend: `App.vue` tooltip shows craft quality when not 'standard'
8. Frontend: Rarity colors (qualityTier) remain unchanged on item names
</verification>

<success_criteria>
- Crafting a gear item with Tier 1 material produces craftQuality='standard', qualityTier='common'
- Crafting a gear item with Tier 2 material produces craftQuality='reinforced', qualityTier='common'
- Crafting a gear item with Tier 3 material produces craftQuality='exquisite', qualityTier='common'
- Affix count/magnitude matches the craft quality level (standard=1 affix, reinforced=2, exquisite=3)
- Client tooltip shows craft quality and uses template description when available
- Module publishes and bindings regenerate without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-dual-axis-gear-system-craft-quality-vs-rarity-material-consolidation-essence-material-metadata-consistency/13.1-02-SUMMARY.md`
</output>
