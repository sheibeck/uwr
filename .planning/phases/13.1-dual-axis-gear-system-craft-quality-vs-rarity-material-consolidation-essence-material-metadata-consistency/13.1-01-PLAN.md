---
phase: 13.1-dual-axis-gear-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/data/crafting_materials.ts
  - spacetimedb/src/seeding/ensure_items.ts
  - spacetimedb/src/seeding/ensure_enemies.ts
autonomous: true
must_haves:
  truths:
    - "ItemInstance schema includes a craftQuality optional string field separate from qualityTier"
    - "ItemTemplate schema includes a description optional string field"
    - "Essence I/II/III are seeded as crafting material ItemTemplates"
    - "All 10 original crafting materials plus 3 Essence variants are in ensureGearMaterialItemTemplates"
    - "Copper Ore is removed from ensureResourceItemTemplates and added to ensureGearMaterialItemTemplates"
    - "Gear recipes require Essence as req3 ingredient"
    - "Essence drops from enemies gated by terrain tier (low/mid/high)"
    - "MATERIAL_AFFIX_MAP inner keys renamed from uncommon/rare/epic to standard/reinforced/exquisite"
    - "materialTierToCraftQuality helper maps tier 1->standard, tier 2->reinforced, tier 3->exquisite"
    - "A single addRecipeTemplate helper replaces both addRecipe and addGearRecipe"
  artifacts:
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "craftQuality field on ItemInstance, description field on ItemTemplate"
      contains: "craftQuality.*optional"
    - path: "spacetimedb/src/data/crafting_materials.ts"
      provides: "materialTierToCraftQuality helper, renamed MATERIAL_AFFIX_MAP keys, Essence MATERIAL_DEFS"
      contains: "materialTierToCraftQuality"
    - path: "spacetimedb/src/seeding/ensure_items.ts"
      provides: "Unified recipe helper, Essence material upserts, Copper Ore consolidation, gear recipe req3"
      contains: "Essence I"
    - path: "spacetimedb/src/seeding/ensure_enemies.ts"
      provides: "Essence loot entries tier-gated by terrain"
      contains: "essenceI"
  key_links:
    - from: "spacetimedb/src/data/crafting_materials.ts"
      to: "MATERIAL_AFFIX_MAP"
      via: "getCraftedAffixes reads renamed keys"
      pattern: "standard.*reinforced.*exquisite"
    - from: "spacetimedb/src/seeding/ensure_items.ts"
      to: "ensureGearMaterialItemTemplates"
      via: "Essence upserts + Copper Ore consolidation"
      pattern: "upsertMaterial.*Essence"
    - from: "spacetimedb/src/seeding/ensure_enemies.ts"
      to: "ensureMaterialLootEntries"
      via: "Essence loot entries using findItemTemplateByName"
      pattern: "essenceI.*essenceII.*essenceIII"
---

<objective>
Schema extension and data foundation for the dual-axis gear system (craft quality vs rarity), material consolidation, Essence material, and metadata consistency.

Purpose: Establish the new data model separating craft quality (Dented/Standard/Reinforced/Exquisite/Mastercraft controlling base stats) from rarity (Common/Uncommon/Rare/Epic/Legendary controlling magical affixes). Consolidate all crafting materials into one seeding path, introduce Essence I/II/III as required gear crafting ingredients, unify recipe helpers, and add item description metadata.

Output: Updated schema tables, refactored crafting_materials.ts with dual-axis helpers, consolidated material seeding with Essence variants, unified recipe system, and Essence enemy drop entries.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.1-dual-axis-gear-system-craft-quality-vs-rarity-material-consolidation-essence-material-metadata-consistency/13.1-RESEARCH.md
@spacetimedb/src/schema/tables.ts
@spacetimedb/src/data/crafting_materials.ts
@spacetimedb/src/seeding/ensure_items.ts
@spacetimedb/src/seeding/ensure_enemies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extension and crafting_materials.ts dual-axis refactor</name>
  <files>spacetimedb/src/schema/tables.ts, spacetimedb/src/data/crafting_materials.ts</files>
  <action>
**Schema changes in `spacetimedb/src/schema/tables.ts`:**

1. Add `craftQuality: t.string().optional()` to `ItemInstance` table — insert AFTER the `qualityTier` field (around line 351). Add comment: `// 'dented'|'standard'|'reinforced'|'exquisite'|'mastercraft'; undefined = 'standard'`
2. Add `description: t.string().optional()` to `ItemTemplate` table — insert AFTER the `wellFedBuffMagnitude` field at end of columns (around line 335). Add comment: `// Flavor text / metadata description`

DO NOT rename or remove the existing `qualityTier` field on `ItemInstance` — it remains as the rarity axis.

**Crafting materials refactor in `spacetimedb/src/data/crafting_materials.ts`:**

1. **Add Essence entries to MATERIAL_DEFS array** (after Void Crystal, before closing bracket):
   ```typescript
   // Essence (drop-only, required for gear crafting)
   { key: 'essence_i', name: 'Essence I', tier: 1n, sources: ['drop'], dropCreatureTypes: ['animal', 'beast', 'humanoid', 'undead'], affinityStats: [] },
   { key: 'essence_ii', name: 'Essence II', tier: 2n, sources: ['drop'], dropCreatureTypes: ['animal', 'beast', 'humanoid', 'undead', 'spirit'], affinityStats: [] },
   { key: 'essence_iii', name: 'Essence III', tier: 3n, sources: ['drop'], dropCreatureTypes: ['beast', 'construct', 'spirit', 'undead'], affinityStats: [] },
   ```

2. **Rename MATERIAL_AFFIX_MAP inner keys** from `'uncommon'|'rare'|'epic'` to `'standard'|'reinforced'|'exquisite'`:
   - For EVERY material entry (copper_ore, rough_hide, bone_shard, iron_ore, tanned_leather, spirit_essence, darksteel_ore, moonweave_cloth, shadowhide, void_crystal):
     - Replace key `uncommon:` with `standard:`
     - Replace key `rare:` with `reinforced:`
     - Replace key `epic:` with `exquisite:`
   - Update the file header comments to reflect the new naming: craft quality levels, not rarity tiers.
   - Update the comment block above MATERIAL_AFFIX_MAP (lines 125-133) to read:
     ```
     // Outer key = material key, Inner key = craft quality level ('standard'|'reinforced'|'exquisite')
     // dented quality = no affixes (no entry needed, getCraftedAffixes returns [])
     // Magnitudes align with affix_catalog.ts PREFIXES/SUFFIXES magnitudeByTier values:
     //   standard:    index 0 -> 1n (stat) or 5n (hp)
     //   reinforced:  index 1 -> 2n (stat) or 8n (hp)
     //   exquisite:   index 2 -> 3n (stat) or 15n (hp)
     ```

3. **Add `materialTierToCraftQuality` function** (after `materialTierToQuality`):
   ```typescript
   /**
    * Maps material tier to a craft quality level string.
    * Tier 1 = standard, Tier 2 = reinforced, Tier 3 = exquisite.
    * Dented and Mastercraft are not achievable via basic crafting.
    */
   export function materialTierToCraftQuality(tier: bigint): string {
     if (tier === 1n) return 'standard';
     if (tier === 2n) return 'reinforced';
     if (tier === 3n) return 'exquisite';
     return 'standard';
   }
   ```

4. **Update `getCraftedAffixes` function** to use craft quality keys instead of rarity keys:
   - Change the early return guard from `if (qualityTier === 'common') return [];` to `if (craftQuality === 'dented' || craftQuality === 'common') return [];`
   - Rename the parameter from `qualityTier` to `craftQuality`
   - Update the JSDoc to say "craft quality level" not "quality tier"
   - The function signature becomes: `getCraftedAffixes(materialKey: string, craftQuality: string): CraftedAffix[]`

5. **Keep `materialTierToQuality` unchanged** — it is still used by the old code paths until Plan 02 updates the reducer. Do NOT delete it.

6. **Add `CRAFT_QUALITY_LEVELS` constant** for client reference:
   ```typescript
   /** Ordered craft quality levels from worst to best */
   export const CRAFT_QUALITY_LEVELS = ['dented', 'standard', 'reinforced', 'exquisite', 'mastercraft'] as const;
   ```
  </action>
  <verify>
- Open `spacetimedb/src/schema/tables.ts` and confirm `craftQuality` is on `ItemInstance` and `description` is on `ItemTemplate`
- Open `spacetimedb/src/data/crafting_materials.ts` and confirm:
  - MATERIAL_AFFIX_MAP has `standard`/`reinforced`/`exquisite` keys (not `uncommon`/`rare`/`epic`)
  - `materialTierToCraftQuality` function exists
  - `getCraftedAffixes` takes `craftQuality` parameter
  - Essence I/II/III entries exist in MATERIAL_DEFS
  - `CRAFT_QUALITY_LEVELS` constant exported
  - `materialTierToQuality` still exists (not deleted)
  </verify>
  <done>ItemInstance has craftQuality field, ItemTemplate has description field, MATERIAL_AFFIX_MAP uses craft quality keys, materialTierToCraftQuality helper exists, Essence defined in MATERIAL_DEFS, getCraftedAffixes accepts craft quality parameter</done>
</task>

<task type="auto">
  <name>Task 2: Material consolidation, recipe unification, Essence seeding, and Essence enemy drops</name>
  <files>spacetimedb/src/seeding/ensure_items.ts, spacetimedb/src/seeding/ensure_enemies.ts</files>
  <action>
**Material consolidation in `spacetimedb/src/seeding/ensure_items.ts`:**

1. **Move Copper Ore from `ensureResourceItemTemplates` to `ensureGearMaterialItemTemplates`:**
   - In `ensureResourceItemTemplates` (line 1189): Remove `{ name: 'Copper Ore', slot: 'resource', vendorValue: 2n }` from the `resources` array.
   - In `ensureGearMaterialItemTemplates` (after the comment on line 1826): Add `upsertMaterial({ name: 'Copper Ore', tier: 1n, vendorValue: 2n });` as the FIRST material (before Rough Hide). The `upsertMaterial` function already guards against duplicates via `findItemTemplateByName`.
   - Update the comment on line 1826 from "Tier 1 (Copper Ore already exists from ensureResourceItemTemplates)" to "Tier 1 (all T1 materials including Copper Ore)".

2. **Add Essence I/II/III upserts to `ensureGearMaterialItemTemplates`:**
   - After the Tier 3 materials (after Void Crystal upsert on line 1840), add:
   ```typescript
   // Essence (required for gear crafting, drop-only)
   upsertMaterial({ name: 'Essence I', tier: 1n, vendorValue: 3n });
   upsertMaterial({ name: 'Essence II', tier: 2n, vendorValue: 6n });
   upsertMaterial({ name: 'Essence III', tier: 3n, vendorValue: 12n });
   ```

**Recipe helper unification in `spacetimedb/src/seeding/ensure_items.ts`:**

3. **Extract a module-level `addRecipeTemplate` helper** to replace both `addRecipe` (inside `ensureRecipeTemplates`, line 1411) and `addGearRecipe` (inside `ensureGearRecipeTemplates`, line 1905).

   Define the unified helper near the top of the file (after imports and before the ensure functions), or just above `ensureRecipeTemplates`:

   ```typescript
   /** Unified recipe template upsert helper — replaces addRecipe and addGearRecipe */
   function addRecipeTemplate(ctx: any, args: {
     key: string;
     name: string;
     output: any;
     outputCount: bigint;
     req1: any;
     req1Count: bigint;
     req2: any;
     req2Count: bigint;
     req3?: any;
     req3Count?: bigint;
     recipeType?: string;
     materialType?: string;
   }) {
     if (!args.output || !args.req1 || !args.req2) return;
     const existing = [...ctx.db.recipeTemplate.iter()].find((row: any) => row.key === args.key);
     if (existing) {
       ctx.db.recipeTemplate.id.update({
         ...existing,
         key: args.key,
         name: args.name,
         outputTemplateId: args.output.id,
         outputCount: args.outputCount,
         req1TemplateId: args.req1.id,
         req1Count: args.req1Count,
         req2TemplateId: args.req2.id,
         req2Count: args.req2Count,
         req3TemplateId: args.req3?.id,
         req3Count: args.req3Count,
         recipeType: args.recipeType ?? existing.recipeType ?? 'consumable',
         materialType: args.materialType ?? existing.materialType,
       });
       return;
     }
     ctx.db.recipeTemplate.insert({
       id: 0n,
       key: args.key,
       name: args.name,
       outputTemplateId: args.output.id,
       outputCount: args.outputCount,
       req1TemplateId: args.req1.id,
       req1Count: args.req1Count,
       req2TemplateId: args.req2.id,
       req2Count: args.req2Count,
       req3TemplateId: args.req3?.id,
       req3Count: args.req3Count,
       recipeType: args.recipeType ?? 'consumable',
       materialType: args.materialType,
     });
   }
   ```

4. **Update `ensureRecipeTemplates`** (line 1388): Remove the inline `addRecipe` definition (lines 1411-1460). Replace all `addRecipe({` calls with `addRecipeTemplate(ctx, {` — the argument shape is already compatible since `addRecipe` used `output`, `req1`, `req2` (template objects, not IDs). No call site changes needed beyond adding `ctx` as first arg.

5. **Update `ensureGearRecipeTemplates`** (line 1900): Remove the inline `addGearRecipe` definition (lines 1905-1947). Rewrite each `addGearRecipe({...})` call to use `addRecipeTemplate(ctx, {...})`. The gear recipe calls currently use `outputName` string — change to look up output template first and pass the template object. Specifically, for each gear recipe call:
   - Look up `const output = findItemTemplateByName(ctx, outputName);`
   - Call `addRecipeTemplate(ctx, { key, name, output, outputCount: 1n, req1: copperOre, req1Count, req2: roughHide, req2Count, req3: essenceByTier, req3Count: 1n, recipeType, materialType: undefined })`

6. **Add Essence as req3 to ALL gear recipes:** In `ensureGearRecipeTemplates`, look up Essence I at top: `const essenceI = findItemTemplateByName(ctx, 'Essence I');`. Then for each gear recipe, add `req3: essenceI, req3Count: 1n`. (Using Essence I for all tier-1 base recipes — the actual Essence tier consumed will depend on the material tier chosen at craft time, but the recipe template only stores the minimum. For now, req3=Essence I with count 1 is the seeded default.)

**IMPORTANT:** Do NOT change recipe keys or outputTemplateIds — the salvage_item reducer matches by outputTemplateId and must continue working.

**Essence enemy loot entries in `spacetimedb/src/seeding/ensure_enemies.ts`:**

7. **Add Essence loot entries to `ensureMaterialLootEntries`:**
   - At the top of the function (after the existing material lookups around line 141), add:
   ```typescript
   const essenceI = findItemTemplateByName(ctx, 'Essence I');
   const essenceII = findItemTemplateByName(ctx, 'Essence II');
   const essenceIII = findItemTemplateByName(ctx, 'Essence III');
   ```
   - Inside the terrain loop, for EACH creature type loot table that already gets material drops, add Essence drops tier-gated:
     - Low-tier terrains (not isMidTier and not isHighTier): Add Essence I with weight 15n
     - Mid-tier terrains (isMidTier): Add Essence I with weight 10n AND Essence II with weight 15n
     - High-tier terrains (isHighTier): Add Essence II with weight 10n AND Essence III with weight 15n
   - Add Essence to all creature type tables that already have material drops (animal, beast, undead, humanoid, spirit, construct). Follow the same pattern as the existing material drops — use `upsertLootEntry` with the appropriate table.
   - Example for animal table:
   ```typescript
   if (animalTable) {
     // ... existing material drops ...
     // Essence drops (tier-gated)
     if (essenceI && !isMidTier && !isHighTier) upsertLootEntry(animalTable.id, essenceI.id, 15n);
     if (isMidTier) {
       if (essenceI) upsertLootEntry(animalTable.id, essenceI.id, 10n);
       if (essenceII) upsertLootEntry(animalTable.id, essenceII.id, 15n);
     }
     if (isHighTier) {
       if (essenceII) upsertLootEntry(animalTable.id, essenceII.id, 10n);
       if (essenceIII) upsertLootEntry(animalTable.id, essenceIII.id, 15n);
     }
   }
   ```
   - Apply same pattern to beast, undead, humanoid, spirit, construct tables.
  </action>
  <verify>
- Check `ensureResourceItemTemplates` no longer contains Copper Ore
- Check `ensureGearMaterialItemTemplates` contains Copper Ore + all 9 original materials + Essence I/II/III (13 total upserts)
- Check that `addRecipeTemplate` is a module-level function in ensure_items.ts
- Check that `ensureRecipeTemplates` no longer has an inline `addRecipe` definition and uses `addRecipeTemplate(ctx, ...)` instead
- Check that `ensureGearRecipeTemplates` no longer has an inline `addGearRecipe` definition and uses `addRecipeTemplate(ctx, ...)` with `req3: essenceI, req3Count: 1n`
- Check `ensureMaterialLootEntries` has Essence I/II/III lookups and tier-gated upsertLootEntry calls
- Verify recipe keys are unchanged (craft_longsword, craft_dagger, etc.) — salvage discovery depends on these
  </verify>
  <done>Copper Ore consolidated into gear materials list, Essence I/II/III seeded as materials and in enemy loot tables, addRecipe and addGearRecipe unified into single addRecipeTemplate helper, all gear recipes have Essence I as req3</done>
</task>

</tasks>

<verification>
1. Schema: `ItemInstance` has `craftQuality` field, `ItemTemplate` has `description` field
2. Data: `materialTierToCraftQuality()` returns standard/reinforced/exquisite for tiers 1/2/3
3. Data: `MATERIAL_AFFIX_MAP` inner keys are `standard`/`reinforced`/`exquisite` (not `uncommon`/`rare`/`epic`)
4. Data: `getCraftedAffixes('copper_ore', 'standard')` returns 1 affix (was: `getCraftedAffixes('copper_ore', 'uncommon')`)
5. Materials: `ensureGearMaterialItemTemplates` seeds all 13 materials (10 original + 3 Essence)
6. Materials: `ensureResourceItemTemplates` does NOT contain Copper Ore
7. Recipes: `addRecipeTemplate` is a single module-level helper; no inline `addRecipe` or `addGearRecipe` closures remain
8. Recipes: All 15 gear recipes have `req3TemplateId` set (Essence I)
9. Loot: `ensureMaterialLootEntries` adds Essence drops for animal/beast/undead/humanoid/spirit/construct tables
10. Loot: Essence drops are tier-gated (I for low, I+II for mid, II+III for high)
</verification>

<success_criteria>
- All schema, data, seeding, and loot changes compile without TypeScript errors
- No existing recipe keys or outputTemplateIds are changed
- MATERIAL_AFFIX_MAP uses craft quality level keys
- Essence material templates and loot entries are properly tier-gated
- Recipe helper is unified into single function used by both consumable and gear recipe seeding
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-dual-axis-gear-system-craft-quality-vs-rarity-material-consolidation-essence-material-metadata-consistency/13.1-01-SUMMARY.md`
</output>
