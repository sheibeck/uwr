---
phase: 13.1-dual-axis-gear-system
plan: 02
subsystem: crafting
tags: [spacetimedb, crafting, gear, quality, affixes, frontend]

# Dependency graph
requires:
  - phase: 13.1-01
    provides: craftQuality field on ItemInstance, description field on ItemTemplate, materialTierToCraftQuality helper, MATERIAL_AFFIX_MAP with renamed keys, getCraftedAffixes updated to use craftQuality parameter
affects:
  - CraftingPanel client UI (players now see craft quality colored label in item tooltips)
  - Any future plan consuming craftQuality on ItemInstance

provides:
  - craft_recipe reducer with dual-axis logic (craftQuality from material tier, qualityTier always 'common')
  - materialTierToCraftQuality imported and used in craft_recipe reducer
  - getCraftedAffixes called with craftQuality (not old qualityTier)
  - Regenerated TypeScript bindings with craftQuality on ItemInstance and description on ItemTemplate
  - useInventory.ts reading craftQuality and deriving tierLabel from it
  - useInventory.ts preferring template.description over computed description
  - App.vue tooltip displaying craft quality with color coding

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Dual-axis ItemInstance update: sets both qualityTier (rarity='common') and craftQuality (craft tier) independently
    - craftQualityColor helper maps craft quality strings to hex colors for tooltip display
    - template.description priority pattern: DB-stored description takes precedence over client-computed description

key-files:
  created: []
  modified:
    - spacetimedb/src/reducers/items.ts
    - src/composables/useInventory.ts
    - src/App.vue
    - src/module_bindings/ (regenerated)

key-decisions:
  - "craft_recipe reducer now always sets craftQuality (from materialTierToCraftQuality) and qualityTier='common' on every crafted gear item — no outer qualityTier guard"
  - "getCraftedAffixes called with craftQuality string (dented/standard/reinforced/exquisite) not the old qualityTier rarity string"
  - "tierLabel in useInventory derives tier number from craftQuality when instance.craftQuality is set, overriding qualityTier-based tier — crafted Reinforced items show Tier 2 not Tier 1"
  - "template.description takes first priority in description fallback chain: template.description || foodDescription || computed fallback"

patterns-established:
  - "Dual-axis craft quality display: craftQuality drives tierLabel number; qualityTier drives item name color — orthogonal concerns"
  - "craftQualityColor maps dented=#888 / standard=#ccc / reinforced=#6c9 / exquisite=#9cf / mastercraft=#f90 — canonical color scheme for craft quality"
  - "Module republished with --clear-database after schema changes that require clean slate, then bindings regenerated immediately"

# Metrics
duration: ~10min
completed: 2026-02-18
---

# Phase 13.1 Plan 02: Dual-Axis craft_recipe Reducer and Frontend Craft Quality Display Summary

**craft_recipe reducer sets independent craftQuality (material tier) and qualityTier='common' (rarity) on all crafted gear; frontend shows craft quality with color-coded tooltip line and derives tier label from craft quality**

## Performance

- **Duration:** ~10 min
- **Started:** 2026-02-18T01:48:00Z
- **Completed:** 2026-02-18T01:58:02Z
- **Tasks:** 2
- **Files modified:** 6 (items.ts, useInventory.ts, App.vue, 3 binding files)

## Accomplishments
- Refactored craft_recipe reducer to use dual-axis logic: `craftQuality = materialTierToCraftQuality(materialTier)`, `qualityTier = 'common'` for all crafted gear
- Removed the outer `if (qualityTier !== 'common')` guard — all crafted gear now gets craftQuality set regardless of affix count
- getCraftedAffixes now called with craftQuality (standard/reinforced/exquisite) instead of old qualityTier (uncommon/rare/epic)
- Published module with --clear-database; regenerated TypeScript bindings confirming craftQuality on ItemInstance and description on ItemTemplate
- Updated useInventory.ts: reads craftQuality, derives tierLabel from it (dented/standard→Tier 1, reinforced→Tier 2, exquisite/mastercraft→Tier 3)
- useInventory.ts: template.description now takes priority over computed description in fallback chain
- App.vue: added craftQualityColor helper and tooltip line showing craft quality with required color coding

## Task Commits

Each task was committed atomically:

1. **Task 1: Update craft_recipe reducer for dual-axis logic and publish module** - `edbcbc0` (feat)
2. **Task 2: Frontend updates for craft quality display and template descriptions** - `65c1628` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `spacetimedb/src/reducers/items.ts` - Added materialTierToCraftQuality import; replaced gear affix block with dual-axis logic (craftQuality from tier, qualityTier='common', no outer guard)
- `src/composables/useInventory.ts` - Added craftQuality to InventoryItem type, craftQualityToTierNumber helper, tierLabel from craftQuality, template.description priority, craftQuality in returned item object
- `src/App.vue` - Added craftQualityColor helper function, craftQuality tooltip div with color-coded span
- `src/module_bindings/` - Regenerated: craftQuality on ItemInstance, description on ItemTemplate, new create_recipe_scroll and learn_recipe_scroll bindings

## Decisions Made
- craft_recipe reducer removes the `if (qualityTier !== 'common')` outer guard — all crafted gear (even dented/standard quality) gets craftQuality set on ItemInstance so the client can always display quality tier correctly
- tierLabel override pattern: when craftQuality is set, client uses craftQualityToTierNumber instead of qualityTierToNumber — crafted items no longer show "Tier 1" regardless of material tier used
- template.description priority: DB-stored description (if any) completely replaces computed description rather than prepending — cleaner for content authored descriptions

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## Next Phase Readiness
- Dual-axis gear system fully operational: craft Reinforced Longsword shows "Tier 2 Quality" tooltip, Exquisite Dagger shows blue "exquisite Quality" line
- craftQuality field populated on all crafted ItemInstance rows going forward
- Essence I requirement already wired in recipe templates (Plan 01) and consumed by existing req3 logic in craft_recipe reducer
- Phase 13.1 Plan 03 can proceed if planned (or phase is complete if 02 was the final plan)

## Self-Check: PASSED

Files exist:
- spacetimedb/src/reducers/items.ts: materialTierToCraftQuality import and dual-axis reducer logic confirmed
- src/composables/useInventory.ts: craftQuality field, craftQualityToTierNumber helper, template.description priority confirmed
- src/App.vue: craftQualityColor function and tooltip div confirmed
- src/module_bindings/item_instance_type.ts: craftQuality field confirmed (string | undefined)
- src/module_bindings/item_template_type.ts: description field confirmed

Commits exist:
- edbcbc0: feat(13.1-02): dual-axis craft_recipe reducer and regenerated bindings
- 65c1628: feat(13.1-02): frontend craft quality display and template descriptions

---
*Phase: 13.1-dual-axis-gear-system*
*Completed: 2026-02-18*
