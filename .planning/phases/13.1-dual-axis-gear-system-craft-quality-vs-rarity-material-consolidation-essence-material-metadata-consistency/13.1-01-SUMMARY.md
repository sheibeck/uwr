---
phase: 13.1-dual-axis-gear-system
plan: 01
subsystem: database
tags: [spacetimedb, crafting, materials, loot, schema]

# Dependency graph
requires:
  - phase: 13-crafting-system
    provides: RecipeTemplate with req3 field, MATERIAL_DEFS, MATERIAL_AFFIX_MAP, getCraftedAffixes, ensureGearMaterialItemTemplates, ensureMaterialLootEntries
provides:
  - craftQuality field on ItemInstance (dual-axis: craft quality vs rarity)
  - description field on ItemTemplate (flavor text/metadata)
  - materialTierToCraftQuality helper (tier->standard/reinforced/exquisite)
  - CRAFT_QUALITY_LEVELS constant
  - getCraftedAffixes updated to use craftQuality parameter (guards dented/common)
  - MATERIAL_AFFIX_MAP with renamed keys (standard/reinforced/exquisite)
  - Essence I/II/III in MATERIAL_DEFS and ensureGearMaterialItemTemplates
  - Copper Ore consolidated into ensureGearMaterialItemTemplates
  - Unified addRecipeTemplate module-level helper replacing addRecipe+addGearRecipe
  - All 15 gear recipes with req3: Essence I as required crafting ingredient
  - Essence I/II/III loot entries in ensureMaterialLootEntries (tier-gated by terrain)
affects:
  - 13.1-02-PLAN.md (craft_recipe reducer using materialTierToCraftQuality and craftQuality field)
  - CraftingPanel client UI (will show Essence as req3 ingredient)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Dual-axis gear quality: craftQuality (craft quality level) separate from qualityTier (rarity)
    - Module-level recipe upsert helper pattern (addRecipeTemplate replaces inline closures)
    - Essence as required binding reagent for all gear crafting recipes

key-files:
  created: []
  modified:
    - spacetimedb/src/schema/tables.ts
    - spacetimedb/src/data/crafting_materials.ts
    - spacetimedb/src/seeding/ensure_items.ts
    - spacetimedb/src/seeding/ensure_enemies.ts

key-decisions:
  - "craftQuality separates craft potency axis (dented/standard/reinforced/exquisite/mastercraft) from qualityTier rarity axis (common/uncommon/rare/epic/legendary)"
  - "MATERIAL_AFFIX_MAP inner keys renamed from uncommon/rare/epic to standard/reinforced/exquisite to match craft quality vocabulary"
  - "Essence I/II/III are drop-only materials required as req3 for all gear recipe templates"
  - "Essence drops are terrain-tier-gated: low=EssenceI, mid=EssenceI+II, high=EssenceII+III"
  - "Copper Ore moved from ensureResourceItemTemplates to ensureGearMaterialItemTemplates for clean material consolidation"
  - "addRecipeTemplate is a single module-level function used by both consumable and gear recipe seeding â€” eliminates duplicate inline helper pattern"
  - "materialTierToQuality kept for backward compatibility (used by craft_recipe reducer until Plan 02 updates it)"

patterns-established:
  - "Dual-axis item quality: craftQuality (craft tier) and qualityTier (rarity) are orthogonal fields on ItemInstance"
  - "Recipe req3 field used for binding reagent (Essence) that gates gear crafting regardless of material choice"
  - "Module-level upsert helpers are preferred over inline closure helpers in seeding functions"

# Metrics
duration: ~5min
completed: 2026-02-18
---

# Phase 13.1 Plan 01: Schema Extension and Dual-Axis Material Foundation Summary

**Dual-axis gear quality schema (craftQuality + qualityTier), Essence I/II/III as required crafting reagent, and unified addRecipeTemplate helper consolidating all material/recipe seeding**

## Performance

- **Duration:** ~5 min
- **Started:** 2026-02-18T01:45:48Z
- **Completed:** 2026-02-18T01:51:09Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Added `craftQuality` optional field to `ItemInstance` separating craft potency from rarity (`qualityTier`)
- Added `description` optional field to `ItemTemplate` for flavor text and metadata
- Renamed MATERIAL_AFFIX_MAP inner keys from `uncommon/rare/epic` to `standard/reinforced/exquisite` (craft quality vocabulary)
- Added `materialTierToCraftQuality` helper and `CRAFT_QUALITY_LEVELS` constant
- Added Essence I/II/III to MATERIAL_DEFS and seeded as gear materials
- Moved Copper Ore from `ensureResourceItemTemplates` into `ensureGearMaterialItemTemplates` (13 total materials seeded together)
- Replaced dual inline helpers (`addRecipe`, `addGearRecipe`) with single module-level `addRecipeTemplate`
- Added Essence I as req3 to all 15 gear recipe templates
- Added Essence I/II/III loot entries to all 6 creature type tables (tier-gated by terrain)

## Task Commits

Each task was committed atomically:

1. **Task 1: Schema extension and crafting_materials dual-axis refactor** - `c0dc18c` (feat)
2. **Task 2: Material consolidation, recipe unification, Essence seeding and enemy drops** - `9bcba07` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `spacetimedb/src/schema/tables.ts` - Added craftQuality to ItemInstance, description to ItemTemplate
- `spacetimedb/src/data/crafting_materials.ts` - Renamed MATERIAL_AFFIX_MAP keys, added Essence MATERIAL_DEFS, materialTierToCraftQuality, CRAFT_QUALITY_LEVELS, updated getCraftedAffixes
- `spacetimedb/src/seeding/ensure_items.ts` - Copper Ore consolidated, Essence I/II/III seeded, addRecipeTemplate module-level helper, all 15 gear recipes use addRecipeTemplate with req3: essenceI
- `spacetimedb/src/seeding/ensure_enemies.ts` - Essence I/II/III template lookups, tier-gated loot entries for all 6 creature types

## Decisions Made
- `craftQuality` uses string values `dented/standard/reinforced/exquisite/mastercraft` to match craft quality vocabulary; `qualityTier` retains existing `common/uncommon/rare/epic/legendary` rarity vocabulary
- Essence is a binding reagent: all 15 gear recipes require 1x Essence I as req3 in recipe template; actual tier consumed at craft time is Plan 02 reducer concern
- `materialTierToQuality` kept unchanged for backward compatibility with existing craft_recipe reducer until Plan 02 refactors it
- `getCraftedAffixes` now guards on both `'dented'` and `'common'` for empty return, accommodating both old and new callers

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## Next Phase Readiness
- Schema fields ready for Plan 02 craft_recipe reducer to populate craftQuality on crafted items
- MATERIAL_AFFIX_MAP correctly indexed by craft quality keys for deterministic affix generation
- Essence loot drops seeded for player acquisition; Essence I required for all gear recipe templates
- Need to republish with --clear-database due to new non-optional columns on item_instance and item_template tables

## Self-Check: PASSED

Files exist:
- spacetimedb/src/schema/tables.ts: craftQuality and description fields confirmed
- spacetimedb/src/data/crafting_materials.ts: materialTierToCraftQuality, CRAFT_QUALITY_LEVELS, updated getCraftedAffixes, Essence MATERIAL_DEFS confirmed
- spacetimedb/src/seeding/ensure_items.ts: addRecipeTemplate module-level, Essence upserts, req3 on gear recipes confirmed
- spacetimedb/src/seeding/ensure_enemies.ts: Essence loot entries confirmed

Commits exist:
- c0dc18c: feat(13.1-01): schema extension and crafting_materials dual-axis refactor
- 9bcba07: feat(13.1-01): material consolidation, recipe unification, Essence seeding and enemy drops

---
*Phase: 13.1-dual-axis-gear-system*
*Completed: 2026-02-18*
