---
plan: 22-01
title: Schema changes and new backend systems
phase: 22
status: pending
estimated_tasks: 4
---

# Plan 22-01: Schema changes and new backend systems

## Goal
Add the new database columns and tables required by Phase 22 abilities, then wire stun/travel_discount/haste/life-drain mechanics into the existing loop reducers.

## Prerequisites
None — this is the foundation plan.

## Tasks

### Task 1: Extend CombatEnemyEffect and ItemInstance in tables.ts

**File:** `spacetimedb/src/schema/tables.ts`

**Action:** Add two optional columns to existing tables.

**Details:**

In the `CombatEnemyEffect` table definition (around line 1031), add `ownerCharacterId` as an optional u64. This is required by Necromancer Wither (life drain DoT) and Reaver Blood Rend/Death's Embrace. The column tracks which character should receive the heal when the DoT ticks. Keep all existing columns.

```typescript
export const CombatEnemyEffect = table(
  {
    name: 'combat_enemy_effect',
    public: true,
    indexes: [
      { name: 'by_combat', algorithm: 'btree', columns: ['combatId'] },
      { name: 'by_enemy', algorithm: 'btree', columns: ['enemyId'] },
    ],
  },
  {
    id: t.u64().primaryKey().autoInc(),
    combatId: t.u64(),
    enemyId: t.u64(),
    effectType: t.string(),
    magnitude: t.i64(),
    roundsRemaining: t.u64(),
    sourceAbility: t.string().optional(),
    ownerCharacterId: t.u64().optional(),  // NEW: for life drain DoTs — character that receives the heal
  }
);
```

In the `ItemInstance` table definition (around line 360), add `isTemporary` as an optional bool. This is required by Summoner Conjure Equipment (L9).

```typescript
export const ItemInstance = table(
  {
    name: 'item_instance',
    public: true,
    indexes: [{ name: 'by_owner', algorithm: 'btree', columns: ['ownerCharacterId'] }],
  },
  {
    id: t.u64().primaryKey().autoInc(),
    templateId: t.u64(),
    ownerCharacterId: t.u64(),
    equippedSlot: t.string().optional(),
    quantity: t.u64(),
    qualityTier: t.string().optional(),
    craftQuality: t.string().optional(),
    displayName: t.string().optional(),
    isNamed: t.bool().optional(),
    isTemporary: t.bool().optional(),  // NEW: true for Summoner Conjure Equipment items — deleted on logout
  }
);
```

**Verify:** `grep -n "ownerCharacterId" spacetimedb/src/schema/tables.ts` shows the new column on CombatEnemyEffect. `grep -n "isTemporary" spacetimedb/src/schema/tables.ts` shows the new column on ItemInstance.

**Done:** Both optional columns appear in their respective table definitions. No existing columns changed.

---

### Task 2: Add ActiveBardSong and BardSongTick tables to tables.ts + schema export

**File:** `spacetimedb/src/schema/tables.ts`

**Action:** Add two new tables for the Bard song system, then include them in the schema export.

**Details:**

The Bard's complete ability set (all 5 abilities + Finale) uses a melody system: casting any Bard ability activates a song that ticks effects on the group every 6 seconds. A new song replaces the old after a 6-second fade. Finale bursts all active/fading songs simultaneously.

Add these two table definitions BEFORE the `export const spacetimedb = schema(...)` line:

```typescript
// Bard active song tracker — one row per bard in combat, replaced when a new song is cast
export const ActiveBardSong = table(
  {
    name: 'active_bard_song',
    public: true,
    indexes: [{ name: 'by_bard', algorithm: 'btree', columns: ['bardCharacterId'] }],
  },
  {
    id: t.u64().primaryKey().autoInc(),
    bardCharacterId: t.u64(),
    combatId: t.u64(),
    songKey: t.string(),       // e.g. 'bard_discordant_note', 'bard_battle_hymn'
    startedAtMicros: t.u64(), // timestamp when song became active (for fade tracking)
    isFading: t.bool(),        // true during the 6-second fade when a new song replaces it
  }
);

// Scheduled song tick — fires every 6 seconds to apply the active song's group effect
export const BardSongTick = table(
  {
    name: 'bard_song_tick',
    scheduled: 'tick_bard_songs',
  },
  {
    scheduledId: t.u64().primaryKey().autoInc(),
    scheduledAt: t.scheduleAt(),
    bardCharacterId: t.u64(),
    combatId: t.u64(),
  }
);
```

In the `schema(...)` export at the bottom of the file, add both new tables:

```typescript
export const spacetimedb = schema(
  // ... all existing tables ...
  ActiveBardSong,
  BardSongTick,
);
```

**Verify:** `grep -n "ActiveBardSong\|BardSongTick" spacetimedb/src/schema/tables.ts` shows both table definitions and their appearance in the schema export.

**Done:** Two new tables exist in tables.ts and are included in the schema export.

---

### Task 3: Add stun handling to combat loop (combat.ts) and travel_discount to movement.ts

**File:** `spacetimedb/src/reducers/combat.ts`

**Action:** Extend the existing "skip" check in the combat loop to also recognize the new 'stun' effect type. Also add life-drain DoT tick processing.

**Details:**

Find the section in `combat.ts` that checks for the 'skip' effect on enemies (to prevent them from acting while skipped). The pattern looks like:

```typescript
// Find the existing skip check — search for effect.effectType === 'skip'
// It will look approximately like:
const isStunned = [...ctx.db.combatEnemyEffect.by_enemy.filter(enemy.id)]
  .some(effect => effect.effectType === 'skip' && effect.roundsRemaining > 0n);
// OR it may appear inline in a condition block
```

Add 'stun' alongside 'skip' in every place the skip check appears:

```typescript
// BEFORE (find exact pattern in file):
effect.effectType === 'skip'

// AFTER:
effect.effectType === 'skip' || effect.effectType === 'stun'
```

Search thoroughly — the check may appear in 2-3 places (enemy auto-attack, enemy cast, enemy ability use).

**Life-drain DoT processing:** In the section of the combat loop that processes `CombatEnemyEffect` dot ticks (where it reads effects with `effectType === 'dot'` and deals damage to enemies or characters), add handling for `ownerCharacterId`. When a dot effect on an enemy has `ownerCharacterId` set, after applying the tick damage to the enemy, heal the owner character for the same tick amount:

```typescript
// After applying dot damage to the enemy:
if (effect.ownerCharacterId && tickDamage > 0n) {
  const drainTarget = ctx.db.character.id.find(effect.ownerCharacterId);
  if (drainTarget && drainTarget.hp > 0n) {
    const healedHp = drainTarget.hp + tickDamage > drainTarget.maxHp
      ? drainTarget.maxHp
      : drainTarget.hp + tickDamage;
    ctx.db.character.id.update({ ...drainTarget, hp: healedHp });
  }
}
```

**File:** `spacetimedb/src/reducers/movement.ts`

In `move_character`, after the racial cost discount calculation block (around line 84-91), check for a `travel_discount` CharacterEffect:

```typescript
// After computing costDiscount from racialTravelCostDiscount:
const abilityDiscount = [...ctx.db.characterEffect.by_character.filter(traveler.id)]
  .filter(e => e.effectType === 'travel_discount' && e.roundsRemaining > 0n)
  .reduce((sum, e) => sum + BigInt(e.magnitude), 0n);
const totalDiscount = costDiscount + abilityDiscount;
const effectiveCost = rawCost > totalDiscount ? rawCost - totalDiscount : 0n;
```

Replace the existing `rawCost > costDiscount ? rawCost - costDiscount : 0n` line with the version using `totalDiscount`. This is what Bard March of Wayfarers (L7) uses.

**Verify:** Search the combat loop for the stun pattern: `grep -n "stun" spacetimedb/src/reducers/combat.ts`. Search movement.ts: `grep -n "travel_discount" spacetimedb/src/reducers/movement.ts`.

**Done:** Stun check covers both 'skip' and 'stun'. Life-drain DoT heals the ownerCharacterId on each tick. travel_discount CharacterEffect reduces stamina cost in move_character.

---

### Task 4: Publish module with --clear-database and regenerate bindings

**Action:** Schema changes (new columns and tables) require a full republish. Then regenerate TypeScript client bindings so the client sees the new table types.

**Details:**

Step 1 — Publish with clear-database:
```bash
spacetime publish uwr --clear-database -y --project-path spacetimedb
```

This wipes all existing data and republishes the updated schema. Expected output: "Published module" or similar success message. If the server is not running locally, start it first: `spacetime start`.

Step 2 — Regenerate client bindings:
```bash
spacetime generate --lang typescript --out-dir client/src/module_bindings --project-path spacetimedb
```

Step 3 — Verify the new tables appear in generated bindings:
```bash
grep -l "ActiveBardSong\|active_bard_song" client/src/module_bindings/
grep -l "isTemporary\|is_temporary" client/src/module_bindings/
```

**Verify:** Both grep commands return at least one file. The module published without errors. Client bindings directory has updated timestamps.

**Done:** Module is live with new schema. Client bindings include `ActiveBardSong`, `BardSongTick`, `ownerCharacterId` on `CombatEnemyEffect`, and `isTemporary` on `ItemInstance`.

## Verification

1. `grep -n "ownerCharacterId" spacetimedb/src/schema/tables.ts` — shows CombatEnemyEffect column
2. `grep -n "isTemporary" spacetimedb/src/schema/tables.ts` — shows ItemInstance column
3. `grep -n "ActiveBardSong\|BardSongTick" spacetimedb/src/schema/tables.ts` — shows both tables and schema export entries
4. `grep -n "stun" spacetimedb/src/reducers/combat.ts` — shows stun in skip checks
5. `grep -n "travel_discount" spacetimedb/src/reducers/movement.ts` — shows discount reading
6. `spacetime logs uwr` — no errors after publish

## Commit Message
`feat(22-01): add schema columns and bard/stun/drain backend systems`
