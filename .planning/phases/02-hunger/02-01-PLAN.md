---
phase: 02-hunger
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/index.ts
  - spacetimedb/src/reducers/hunger.ts
  - spacetimedb/src/reducers/characters.ts
  - spacetimedb/src/reducers/combat.ts
  - spacetimedb/src/reducers/items.ts
  - spacetimedb/src/reducers/index.ts
  - spacetimedb/src/views/hunger.ts
  - spacetimedb/src/views/types.ts
  - spacetimedb/src/views/index.ts
autonomous: true

must_haves:
  truths:
    - "New characters start with hunger at 100 and no Well Fed buff"
    - "Hunger decays by 2 every 5 minutes via scheduled tick"
    - "Eating food consumes the item, sets wellFedUntil and wellFedDamageBonusPercent on Hunger row"
    - "Well Fed bonus applies to auto-attack damage as percentage multiplier"
    - "Well Fed bonus applies to ability damage as percentage multiplier"
    - "Hunger reaching 0 causes no penalty"
    - "4 food item templates seeded (Trail Rations, Basic Meal, Hearty Stew, Feast)"
    - "Deleting a character removes its Hunger row"
  artifacts:
    - path: "spacetimedb/src/index.ts"
      provides: "Hunger table, HungerDecayTick table, ItemTemplate extended with wellFedDurationMicros and wellFedDamageBonusPercent, both tables in schema() export, ensureHungerDecayScheduled function, food template seeding"
      contains: "name: 'hunger'"
    - path: "spacetimedb/src/reducers/hunger.ts"
      provides: "eat_food reducer, decay_hunger scheduled reducer, registerHungerReducers export"
      exports: ["registerHungerReducers"]
    - path: "spacetimedb/src/reducers/characters.ts"
      provides: "Hunger row insert in create_character, Hunger row cleanup in delete_character"
      contains: "ctx.db.hunger.insert"
    - path: "spacetimedb/src/reducers/combat.ts"
      provides: "Well Fed percentage bonus in auto-attack damage formula"
      contains: "wellFedBonusPercent"
    - path: "spacetimedb/src/views/hunger.ts"
      provides: "my_hunger view returning active character's hunger row"
      exports: ["registerHungerViews"]
  key_links:
    - from: "spacetimedb/src/reducers/hunger.ts"
      to: "spacetimedb/src/index.ts"
      via: "Hunger table and HungerDecayTick table imports through deps"
      pattern: "ctx\\.db\\.hunger"
    - from: "spacetimedb/src/reducers/characters.ts"
      to: "spacetimedb/src/index.ts"
      via: "Hunger row insert after character creation"
      pattern: "ctx\\.db\\.hunger\\.insert"
    - from: "spacetimedb/src/reducers/combat.ts"
      to: "spacetimedb/src/index.ts"
      via: "Hunger row lookup for Well Fed check in auto-attack"
      pattern: "ctx\\.db\\.hunger\\.characterId\\.filter"
    - from: "spacetimedb/src/index.ts executeAbilityAction"
      to: "Hunger table"
      via: "Well Fed bonus added to ability damage path"
      pattern: "wellFedBonusPercent"
---

<objective>
Implement the complete hunger system backend: Hunger table, HungerDecayTick scheduled table, ItemTemplate extension for food items, eat_food reducer, decay_hunger reducer, Well Fed combat integration in both auto-attack and ability damage, my_hunger view, and food item template seeding. Publish with --clear-database -y and regenerate client bindings.

Purpose: This is the server-authoritative foundation for the hunger feature. All combat, consumption, and decay logic must be correct before frontend work begins.
Output: Published SpacetimeDB module with working hunger system, regenerated client bindings.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-hunger/02-RESEARCH.md
@spacetimedb/src/index.ts
@spacetimedb/src/reducers/characters.ts
@spacetimedb/src/reducers/combat.ts
@spacetimedb/src/reducers/items.ts
@spacetimedb/src/reducers/index.ts
@spacetimedb/src/views/effects.ts
@spacetimedb/src/views/types.ts
@spacetimedb/src/views/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, reducers, views, and data seeding</name>
  <files>
    spacetimedb/src/index.ts
    spacetimedb/src/reducers/hunger.ts
    spacetimedb/src/reducers/characters.ts
    spacetimedb/src/reducers/items.ts
    spacetimedb/src/reducers/index.ts
    spacetimedb/src/views/hunger.ts
    spacetimedb/src/views/types.ts
    spacetimedb/src/views/index.ts
  </files>
  <action>
**A. Add Hunger table to `spacetimedb/src/index.ts` (before schema() export at line 1194):**

```typescript
const Hunger = table(
  {
    name: 'hunger',
    indexes: [{ name: 'characterId', algorithm: 'btree', columns: ['characterId'] }],
  },
  {
    id: t.u64().primaryKey().autoInc(),
    characterId: t.u64(),
    currentHunger: t.u64(),          // 0-100; 0 has no penalty (REQ-015). Using u64 not u8 (u8 not well-supported in SDK bigint ops)
    wellFedUntil: t.timestamp(),     // epoch/current time if not well fed; future if well fed
    wellFedDamageBonusPercent: t.u64(),  // 0 if not well fed; set when eating (e.g. 5 = +5%)
  }
);
```

**B. Add HungerDecayTick scheduled table to `spacetimedb/src/index.ts` (near HealthRegenTick at line 1012):**

```typescript
const HungerDecayTick = table(
  { name: 'hunger_decay_tick', scheduled: 'decay_hunger' },
  { scheduledId: t.u64().primaryKey().autoInc(), scheduledAt: t.scheduleAt() }
);
```

**C. Add both tables to schema() export (line 1194).** Add `Hunger` and `HungerDecayTick` to the `schema(...)` call, alongside existing tables like `HealthRegenTick`.

**D. Extend ItemTemplate (line 264) with two new fields at the end of the columns object:**

```typescript
wellFedDurationMicros: t.u64(),      // 0 for non-food items
wellFedDamageBonusPercent: t.u64(),  // 0 for non-food items
```

CRITICAL: These go in the COLUMNS (second argument), NOT in OPTIONS. They are column definitions. All existing `ensureStarterItemTemplates` upserts (line 3128+) must include `wellFedDurationMicros: 0n, wellFedDamageBonusPercent: 0n` for non-food items to avoid missing property errors.

**E. Update `create_item_template` reducer in `spacetimedb/src/reducers/items.ts`:**

In `items.ts`, find the `create_item_template` reducer at line ~90 where `ctx.db.itemTemplate.insert(...)` is called. Add the two new required fields to that insert call:

```typescript
ctx.db.itemTemplate.insert({
  // ... existing fields ...
  wellFedDurationMicros: 0n,
  wellFedDamageBonusPercent: 0n,
});
```

Without these fields the TypeScript compiler will fail with a missing property error because `wellFedDurationMicros` and `wellFedDamageBonusPercent` are non-optional columns on ItemTemplate.

**F. Add `ensureFoodTemplates` function in `index.ts` (near `ensureStarterItemTemplates` at line 3128):**

Seed 4 food items using the same upsert pattern (check `findItemTemplateByName` first):

| Name | slot | tier | vendorValue | wellFedDurationMicros | wellFedDamageBonusPercent | stackable |
|------|------|------|-------------|----------------------|--------------------------|-----------|
| Trail Rations | food | 1n | 2n | 1_800_000_000n (30min) | 5n | true |
| Basic Meal | food | 2n | 5n | 3_600_000_000n (60min) | 10n | true |
| Hearty Stew | food | 3n | 10n | 5_400_000_000n (90min) | 15n | true |
| Feast | food | 4n | 20n | 7_200_000_000n (120min) | 20n | true |

All other stats (strBonus, dexBonus, etc.) = 0n. Set armorType: 'none', rarity: 'common', requiredLevel: 1n, allowedClasses: 'any', isJunk: false. Call `ensureFoodTemplates(ctx)` from `syncAllContent` (at line 4337 area, after `ensureStarterItemTemplates`).

**G. Add `ensureHungerDecayScheduled` function (near `ensureHealthRegenScheduled` at line 4244):**

```typescript
const HUNGER_DECAY_INTERVAL_MICROS = 300_000_000n; // 5 minutes

function ensureHungerDecayScheduled(ctx: any) {
  if (!tableHasRows(ctx.db.hungerDecayTick.iter())) {
    ctx.db.hungerDecayTick.insert({
      scheduledId: 0n,
      scheduledAt: ScheduleAt.time(ctx.timestamp.microsSinceUnixEpoch + HUNGER_DECAY_INTERVAL_MICROS),
    });
  }
}
```

Call it from both `spacetimedb.init()` (line 5611) and `spacetimedb.clientConnected()` (line 5621) alongside the other ensure* calls.

**H. Create `spacetimedb/src/reducers/hunger.ts`:**

Export `registerHungerReducers(deps)` that defines two reducers:

1. `decay_hunger` (scheduled reducer) — iterates all Hunger rows via `ctx.db.hunger.iter()`, decrements `currentHunger` by 2 (floor at 0). Reschedules next tick. Pattern from `regen_health`.

```typescript
spacetimedb.reducer('decay_hunger', { arg: HungerDecayTick.rowType }, (ctx: any) => {
  for (const hunger of ctx.db.hunger.iter()) {
    if (hunger.currentHunger <= 0n) continue;
    const next = hunger.currentHunger > 2n ? hunger.currentHunger - 2n : 0n;
    ctx.db.hunger.id.update({ ...hunger, currentHunger: next });
  }
  ctx.db.hungerDecayTick.insert({
    scheduledId: 0n,
    scheduledAt: ScheduleAt.time(ctx.timestamp.microsSinceUnixEpoch + 300_000_000n),
  });
});
```

2. `eat_food` reducer — params: `{ characterId: t.u64(), itemInstanceId: t.u64() }`. Validates:
   - Character owned by sender (use `requireCharacterOwnedBy`)
   - Item instance exists and belongs to character
   - Item template slot is 'food'
   - Hunger row exists for character

   Consumes item (decrement quantity if >1, else delete instance). Sets `wellFedUntil` = max(now + template.wellFedDurationMicros, current wellFedUntil) for refresh-not-stack behavior. Sets `wellFedDamageBonusPercent` from template. NO combat guard (food usable mid-combat per research). Appends private event: "You eat the {name} and feel well fed."

   Follow the `use_item` bandage pattern from `items.ts:829`.

**I. Register hunger reducers in `spacetimedb/src/reducers/index.ts`:**

Import `registerHungerReducers` from `./hunger` and call it in `registerReducers`.

**J. Add `Hunger` and `HungerDecayTick` to `reducerDeps` object (line 5662 in `index.ts`)** so hunger.ts receives them via deps. Also add `HUNGER_DECAY_INTERVAL_MICROS` constant to deps, plus `ensureFoodTemplates` and `ensureHungerDecayScheduled` to deps if needed by reducer file. The hunger reducer needs: `spacetimedb`, `t`, `SenderError`, `ScheduleAt`, `Timestamp`, `Hunger` (table ref for rowType in scheduled reducer signature), `HungerDecayTick` (table ref), `requireCharacterOwnedBy`, `appendPrivateEvent`.

**K. Update `create_character` in `spacetimedb/src/reducers/characters.ts`:**

After `grantStarterItems(ctx, character)` at line 179, insert a Hunger row:

```typescript
ctx.db.hunger.insert({
  id: 0n,
  characterId: character.id,
  currentHunger: 100n,
  wellFedUntil: ctx.timestamp, // Current time = not well fed (already expired)
  wellFedDamageBonusPercent: 0n,
});
```

**L. Update `delete_character` in `spacetimedb/src/reducers/characters.ts`:**

After the `characterEffect` cleanup (line 281-283), add Hunger cleanup:

```typescript
for (const row of ctx.db.hunger.characterId.filter(characterId)) {
  ctx.db.hunger.id.delete(row.id);
}
```

**M. Create `spacetimedb/src/views/hunger.ts`:**

Export `registerHungerViews(deps)`. Define `my_hunger` view following `my_character_effects` pattern (views/effects.ts):

```typescript
export const registerHungerViews = ({ spacetimedb, t, Hunger }: ViewDeps) => {
  spacetimedb.view(
    { name: 'my_hunger', public: true },
    t.array(Hunger.rowType),
    (ctx: any) => {
      const player = ctx.db.player.id.find(ctx.sender);
      if (!player || !player.activeCharacterId) return [];
      return [...ctx.db.hunger.characterId.filter(player.activeCharacterId)];
    }
  );
};
```

CRITICAL: Use `.filter()` on the btree index — NOT `.iter()`. Views cannot scan tables.

**N. Add `Hunger` to ViewDeps in `spacetimedb/src/views/types.ts`:**

Add `Hunger: any;` to the ViewDeps type.

**O. Register hunger views in `spacetimedb/src/views/index.ts`:**

Import `registerHungerViews` from `./hunger` and call it in `registerViews`.

**P. Add `Hunger` to the viewDeps object in `index.ts`** (search for where viewDeps is constructed and registerViews is called — it should be near reducerDeps).
  </action>
  <verify>
Run `spacetime publish uwr --clear-database -y --project-path spacetimedb` (or the project's publish command). Module should compile and publish without errors. Then run `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb` to regenerate bindings. Verify generated bindings include `myHunger` table, `eatFood` reducer, and `ItemTemplate` row type includes `wellFedDurationMicros` and `wellFedDamageBonusPercent` fields.
  </verify>
  <done>
Module published with Hunger table, HungerDecayTick, extended ItemTemplate, 4 food templates seeded, eat_food and decay_hunger reducers working, my_hunger view registered, create_character inserts Hunger row, delete_character cleans up Hunger row. Client bindings regenerated and committed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Well Fed combat integration (auto-attack and ability damage)</name>
  <files>
    spacetimedb/src/reducers/combat.ts
    spacetimedb/src/index.ts
  </files>
  <action>
**A. Add Well Fed bonus to auto-attack damage in `spacetimedb/src/reducers/combat.ts` (line 1607-1612):**

The current auto-attack damage formula at line 1607 is:
```typescript
const damage =
  5n + character.level + weapon.baseDamage + (weapon.dps / 2n) +
  sumEnemyEffect(ctx, combat.id, 'damage_taken', currentEnemy.id);
```

Replace with:
```typescript
const hungerRow = [...ctx.db.hunger.characterId.filter(character.id)][0] ?? null;
const nowMicros = ctx.timestamp.microsSinceUnixEpoch;
const isWellFed = hungerRow && hungerRow.wellFedUntil.microsSinceUnixEpoch > nowMicros;
const wellFedBonusPercent = isWellFed ? hungerRow.wellFedDamageBonusPercent : 0n;
const baseDamage =
  5n + character.level + weapon.baseDamage + (weapon.dps / 2n) +
  sumEnemyEffect(ctx, combat.id, 'damage_taken', currentEnemy.id);
const damage = baseDamage + (baseDamage * wellFedBonusPercent / 100n);
```

Note: `nowMicros` may already be declared in the surrounding scope (check line ~1595 area for `const nowMicros = ctx.timestamp.microsSinceUnixEpoch`). If so, reuse it. Do NOT re-declare.

**B. Add Well Fed bonus to ability damage in `spacetimedb/src/index.ts` (the `executeAbilityAction` function, around line 2850):**

The ability damage path uses `damageUp` from `sumCharacterEffect(ctx, character.id, 'damage_up')` at line 1833. This `damageUp` value flows through to `executeAbilityAction` where it is added to each hit at line 1937-1938.

There are two approaches:
1. Add Well Fed bonus to the existing `damageUp` variable at line 1833 (simplest, keeps the flow)
2. Pass it separately into `executeAbilityAction`

Use approach 1 — add Well Fed bonus to `damageUp` at the call site (line 1833 area). After `const damageUp = sumCharacterEffect(ctx, character.id, 'damage_up');`, compute:

```typescript
const hungerRow = [...ctx.db.hunger.characterId.filter(character.id)][0] ?? null;
const abilityNowMicros = ctx.timestamp.microsSinceUnixEpoch;
const abilityWellFed = hungerRow && hungerRow.wellFedUntil.microsSinceUnixEpoch > abilityNowMicros;
const wellFedFlatBonus = abilityWellFed
  ? (baseWeaponDamage * hungerRow.wellFedDamageBonusPercent / 100n)
  : 0n;
```

Then add `wellFedFlatBonus` to `damageUp` or pass it through to the damage calculation. Check the exact flow: `damageUp` is added as a flat value at line 1938 (`abilityDamageFromWeapon(baseWeaponDamage, percent, bonus) + damageUp`). So computing a flat bonus from `baseWeaponDamage * percent / 100n` and adding it to `damageUp` is correct.

Alternatively, the simpler approach: after `const damageUp = sumCharacterEffect(...)` at line 1833, override it:
```typescript
const hungerRow = [...ctx.db.hunger.characterId.filter(character.id)][0] ?? null;
const abilityNowMicros = ctx.timestamp.microsSinceUnixEpoch;
const abilityIsWellFed = hungerRow && hungerRow.wellFedUntil.microsSinceUnixEpoch > abilityNowMicros;
const wellFedAbilityBonus = abilityIsWellFed ? (baseWeaponDamage * hungerRow.wellFedDamageBonusPercent / 100n) : 0n;
const totalDamageUp = damageUp + wellFedAbilityBonus;
```

Then use `totalDamageUp` instead of `damageUp` in the `executeAbilityAction` call or wherever it flows into the damage calculation. Trace the exact usage to make the substitution cleanly.

CRITICAL: Verify that `nowMicros` or equivalent is available in scope at both injection points. Do NOT use `Date.now()` — use `ctx.timestamp.microsSinceUnixEpoch`.
  </action>
  <verify>
Republish module: `spacetime publish uwr --clear-database -y --project-path spacetimedb`. Check `spacetime logs uwr` for no errors. Create a character, verify Hunger row created at 100. Then test combat — verify damage formula includes Well Fed bonus when character has active Well Fed buff (eat food first, then enter combat, check logs for damage values). Regenerate bindings after any schema changes: `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb`.
  </verify>
  <done>
Auto-attack damage at combat.ts:1607 includes Well Fed percentage bonus. Ability damage at index.ts:1833-1938 area includes Well Fed percentage bonus. Both paths look up the Hunger row by characterId, check wellFedUntil > now, and apply wellFedDamageBonusPercent as a percentage multiplier. Module published and bindings regenerated.
  </done>
</task>

</tasks>

<verification>
1. Module publishes without errors (all new tables, reducers, views compile)
2. `spacetime logs uwr` shows no runtime errors
3. Creating a character inserts a Hunger row with currentHunger=100, wellFedUntil=creation time, wellFedDamageBonusPercent=0
4. 4 food templates exist in item_template table (Trail Rations, Basic Meal, Hearty Stew, Feast)
5. Trail Rations appears in vendor inventory (tier 1, auto-sold)
6. HungerDecayTick fires every 5 minutes, decrementing hunger by 2
7. eat_food reducer consumes food item and sets wellFedUntil + wellFedDamageBonusPercent
8. Client bindings include myHunger view, eatFood reducer, updated ItemTemplate type
</verification>

<success_criteria>
- Hunger table, HungerDecayTick table, extended ItemTemplate all in schema and published
- eat_food and decay_hunger reducers functional
- my_hunger view returns active character's hunger row
- Well Fed bonus integrated into BOTH auto-attack (combat.ts) AND ability damage (index.ts)
- 4 food templates seeded; Trail Rations vendor-purchasable
- create_character creates Hunger row; delete_character cleans it up
- Client bindings regenerated with all new types/reducers/views
</success_criteria>

<output>
After completion, create `.planning/phases/02-hunger/02-01-SUMMARY.md`
</output>
