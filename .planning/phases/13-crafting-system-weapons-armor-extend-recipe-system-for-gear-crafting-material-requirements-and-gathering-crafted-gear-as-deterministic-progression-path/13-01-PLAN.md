---
phase: 13-crafting-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/data/crafting_materials.ts
  - spacetimedb/src/seeding/ensure_items.ts
  - spacetimedb/src/seeding/ensure_enemies.ts
  - spacetimedb/src/seeding/ensure_world.ts
  - spacetimedb/src/seeding/ensure_content.ts
autonomous: true

must_haves:
  truths:
    - "RecipeTemplate table has recipeType and materialType columns for gear crafting classification"
    - "10 material item templates exist in the database covering tiers 1-3 with gather and drop sources"
    - "Gear recipes exist for all major equipment slots using material requirements"
    - "Existing consumable recipes are tagged with recipeType='consumable'"
    - "Enemy loot tables include material drops appropriate to creature type"
    - "Enemy loot tables include recipe scroll drops on mid/high-tier enemies with rare weight"
    - "Scroll ItemTemplates exist for each gear recipe type (Scroll: Longsword, etc.)"
    - "Resource nodes for gatherable materials exist at appropriate terrain locations"
    - "Multiple locations have craftingAvailable=true for crafting access"
  artifacts:
    - path: "spacetimedb/src/data/crafting_materials.ts"
      provides: "Material definitions, affix map, and helper functions"
      contains: "MATERIAL_DEFS"
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "RecipeTemplate with recipeType and materialType columns"
      contains: "recipeType"
    - path: "spacetimedb/src/seeding/ensure_items.ts"
      provides: "Material item templates and gear recipe templates"
      contains: "ensureGearMaterialItemTemplates"
  key_links:
    - from: "spacetimedb/src/data/crafting_materials.ts"
      to: "spacetimedb/src/seeding/ensure_items.ts"
      via: "MATERIAL_DEFS used for seeding material ItemTemplates"
      pattern: "MATERIAL_DEFS"
    - from: "spacetimedb/src/seeding/ensure_items.ts"
      to: "spacetimedb/src/seeding/ensure_content.ts"
      via: "new seeding functions called from syncAllContent"
      pattern: "ensureGearMaterialItemTemplates|ensureGearRecipeTemplates"
---

<objective>
Create the data foundation for the Phase 13 crafting system: extend RecipeTemplate schema with recipeType and materialType columns, define 10 material types with deterministic affix mappings, seed material ItemTemplates, seed gear recipes for all equipment slots, add material drops to enemy loot tables, add gatherable resource nodes, and expand crafting-enabled locations.

Purpose: Establishes all backend data (schema, materials, recipes, loot entries, nodes) that the reducer rework (Plan 02) and frontend UI (Plan 03) depend on.
Output: Extended schema, crafting_materials.ts data file, seeded materials/recipes/loot/nodes.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-crafting-system-weapons-armor-extend-recipe-system-for-gear-crafting-material-requirements-and-gathering-crafted-gear-as-deterministic-progression-path/13-RESEARCH.md
@.planning/phases/14-loot-gear-progression-magic-item-properties-and-affixes-gear-quality-tiers-common-to-legendary-drop-tables-and-rarity-system-endgame-gear-hunting-loop/14-02-SUMMARY.md

@spacetimedb/src/schema/tables.ts
@spacetimedb/src/data/affix_catalog.ts
@spacetimedb/src/seeding/ensure_items.ts
@spacetimedb/src/seeding/ensure_enemies.ts
@spacetimedb/src/seeding/ensure_world.ts
@spacetimedb/src/seeding/ensure_content.ts
@spacetimedb/src/helpers/items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create crafting_materials.ts data file and extend RecipeTemplate schema</name>
  <files>
    spacetimedb/src/data/crafting_materials.ts
    spacetimedb/src/schema/tables.ts
  </files>
  <action>
**Part A: Create `spacetimedb/src/data/crafting_materials.ts` (NEW FILE)**

Define the material taxonomy and deterministic affix map. This is the core data reference for the entire crafting system.

1. Define `MaterialDef` interface:
```typescript
export interface MaterialDef {
  key: string;          // matches ItemTemplate name lowercased with underscores
  name: string;         // display name e.g. 'Darksteel Ore'
  tier: bigint;         // 1n, 2n, or 3n
  sources: ('gather' | 'drop')[];
  dropCreatureTypes?: string[];  // which creature types drop this
  gatherTerrains?: string[];     // which terrain types have nodes
  affinityStats: string[];       // stat keys this material enables
}
```

2. Define `MATERIAL_DEFS` array with 10 materials:
   - Tier 1: `copper_ore` (STR, gather mountains/plains), `rough_hide` (DEX, drop animal/beast), `bone_shard` (HP/AC, drop undead/animal)
   - Tier 2: `iron_ore` (STR+AC, gather mountains), `tanned_leather` (DEX+HP, drop beast/animal), `spirit_essence` (INT+WIS, drop spirit/undead)
   - Tier 3: `darksteel_ore` (STR+weaponBaseDamage, gather dungeon/mountains), `moonweave_cloth` (INT+WIS+mana, gather swamp/woods), `shadowhide` (DEX+cooldownReduction, drop beast/construct), `void_crystal` (magicResistance+manaRegen, drop spirit/construct)

3. Define `MATERIAL_AFFIX_MAP` — a `Record<string, Record<string, CraftedAffix[]>>` where:
   - Outer key = material key (e.g. `'darksteel_ore'`)
   - Inner key = quality tier (`'uncommon'`, `'rare'`, `'epic'`)
   - Value = array of `CraftedAffix` objects with `{ affixKey, statKey, affixName, affixType: 'prefix'|'suffix', magnitude }`
   - Common quality = no affixes (empty array or omitted)
   - Use existing affix keys from `affix_catalog.ts` PREFIXES/SUFFIXES where they match (e.g., 'fierce' for STR prefix). Create new keys only if no existing match.
   - Magnitude progression: uncommon=1n, rare=2n per affix, epic=3n per affix
   - Affix count: uncommon=1, rare=2, epic=3 (matching AFFIX_COUNT_BY_QUALITY from affix_catalog.ts)
   - **POWER PARITY NOTE:** Cross-reference `affix_catalog.ts` when setting magnitudes. Crafted gear must match equivalent-tier dropped gear in stat budget. Check that the magnitudes in MATERIAL_AFFIX_MAP align with the affix magnitude ranges used for dropped gear (see PREFIXES/SUFFIXES magnitude values in affix_catalog.ts). If dropped uncommon gear gets magnitude 1n affixes, crafted uncommon must also get 1n. This ensures the user decision of "equal stat budget" between crafted and dropped gear is honored.

4. Define `materialTierToQuality(tier: bigint): string` helper — Tier 1 = 'common', Tier 2 = 'uncommon', Tier 3 = 'rare'. (Higher tiers possible in future.)

5. Define `getCraftedAffixes(materialKey: string, qualityTier: string): CraftedAffix[]` — looks up MATERIAL_AFFIX_MAP and returns affixes. Returns empty array for 'common' or missing entries.

6. Define `getMaterialForSalvage(slot: string, armorType: string | undefined, tier: bigint): string | undefined` — maps equipment slot+armorType to a material name for salvage yield. Logic:
   - Weapons (mainHand/offHand): return metallic material by tier (copper_ore T1, iron_ore T2, darksteel_ore T3)
   - Light armor (cloth/light): return hide material by tier (rough_hide T1, tanned_leather T2, shadowhide T3)
   - Heavy armor (medium/heavy/plate): return metallic material by tier
   - Jewelry/accessories (earrings, neck, cloak): return essence/crystal by tier (bone_shard T1, spirit_essence T2, void_crystal T3)
   - Return undefined for non-equipment slots (consumable, resource, etc.)

7. Define `SALVAGE_YIELD_BY_TIER: Record<number, bigint>` — { 1: 2n, 2: 2n, 3: 3n } (materials yielded from salvage).

**Part B: Extend RecipeTemplate schema in `spacetimedb/src/schema/tables.ts`**

Add two new columns to the RecipeTemplate table definition:
- `recipeType: t.string()` — 'weapon', 'armor', 'accessory', 'consumable'
- `materialType: t.string().optional()` — e.g. 'darksteel_ore', undefined for consumables

This is a schema change that requires `--clear-database` on next publish.

Also ensure the existing RecipeTemplate columns remain unchanged (id, key, name, outputTemplateId, outputCount, req1TemplateId, req1Count, req2TemplateId, req2Count, req3TemplateId, req3Count).
  </action>
  <verify>
    - `spacetimedb/src/data/crafting_materials.ts` exists with MATERIAL_DEFS (10 entries), MATERIAL_AFFIX_MAP, materialTierToQuality, getCraftedAffixes, getMaterialForSalvage, SALVAGE_YIELD_BY_TIER exports
    - `spacetimedb/src/schema/tables.ts` RecipeTemplate now includes recipeType and materialType columns
    - TypeScript compiles without new errors in these files: `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit --pretty 2>&1 | head -30` (pre-existing errors OK, no NEW errors in crafting_materials.ts or tables.ts)
  </verify>
  <done>
    - crafting_materials.ts exists with 10 MATERIAL_DEFS, a complete MATERIAL_AFFIX_MAP covering all 10 materials at uncommon/rare/epic tiers, and all helper functions
    - RecipeTemplate table has recipeType (string) and materialType (optional string) columns
  </done>
</task>

<task type="auto">
  <name>Task 2: Seed material items, gear recipes, enemy loot, resource nodes, and crafting locations</name>
  <files>
    spacetimedb/src/seeding/ensure_items.ts
    spacetimedb/src/seeding/ensure_enemies.ts
    spacetimedb/src/seeding/ensure_world.ts
    spacetimedb/src/seeding/ensure_content.ts
  </files>
  <action>
**Part A: Seed material ItemTemplates in `ensure_items.ts`**

1. Add `ensureGearMaterialItemTemplates(ctx)` function that creates 10 new ItemTemplate rows for materials. Each material:
   - `slot: 'resource'`, `stackable: true`, `rarity: 'common'`
   - `name`: from MATERIAL_DEFS[].name
   - `tier`: from MATERIAL_DEFS[].tier
   - Use existing `findItemTemplateByName` pattern to check if already seeded (idempotent)
   - NOTE: Check if `Copper Ore` and `Iron Shard` already exist in `ensureResourceItemTemplates`. If Copper Ore exists, reuse it as T1 metallic. If Iron Shard exists, either reuse or create new Iron Ore. The research recommends reusing existing ones where possible. Read the existing resource templates to determine exact names before creating.

2. Add `ensureGearRecipeTemplates(ctx)` function that creates gear recipes. Per the user decision: one recipe per item type, material tier determines output quality. Create recipes covering these gear slots:
   - **Weapons:** Longsword (mainHand), Dagger (mainHand), Staff (mainHand), Shield (offHand)
   - **Armor:** Helm (head), Breastplate (chest), Bracers (wrists), Gauntlets (hands), Girdle (belt), Greaves (legs), Sabatons (boots)
   - **Accessories:** Ring (earrings slot), Amulet (neck), Cloak (cloak)

   Each recipe:
   - `key`: e.g. `'craft_longsword'`
   - `name`: e.g. `'Longsword'`
   - `recipeType`: 'weapon', 'armor', or 'accessory' as appropriate
   - `materialType`: undefined (the material TYPE is determined by which material item the player supplies as req1)
   - `outputTemplateId`: references the corresponding ItemTemplate (look up by name using existing gear templates from `ensureWorldDropGearTemplates` or create new base templates if needed)
   - `outputCount`: 1n
   - Requirements: `req1TemplateId` = a placeholder material template ID. NOTE: Because the crafting system per user decision uses material TYPE chosen by the player to determine affixes, and material TIER determines quality, the recipe itself should NOT lock to a specific material. Instead, `materialType` on the recipe is left undefined, and the `craft_recipe` reducer (Plan 02) will accept any valid crafting material as req1. For now, set req1 to any Tier 1 metallic material (copper_ore) with count 4n as the base cost, and req2 to a secondary material with count 2n. The Plan 02 reducer will override the material-type matching logic.
   - IMPORTANT: The existing `craft_recipe` reducer validates that the player owns req1Count of req1TemplateId. Plan 02 will rework this to accept any material in the correct slot. For seeding purposes, set req1/req2 to reasonable material template IDs.

3. Update existing `ensureRecipeTemplates(ctx)` — add `recipeType: 'consumable'` to all existing consumable recipe inserts (Bandage, Rations, etc.). Since these are existing rows, check if recipeType field is empty and update if so. Also set `materialType: undefined` for consumables.

4. Add `ensureRecipeScrollItemTemplates(ctx)` function that creates one scroll ItemTemplate per gear recipe type. For each gear recipe created in step 2 (Longsword, Dagger, Staff, Shield, Helm, Breastplate, Bracers, Gauntlets, Girdle, Greaves, Sabatons, Ring, Amulet, Cloak), create a corresponding ItemTemplate:
   - `name`: `'Scroll: {recipeName}'` (e.g. `'Scroll: Longsword'`, `'Scroll: Breastplate'`)
   - `slot: 'resource'`, `stackable: true`, `rarity: 'uncommon'`
   - `tier: 1n` (scrolls are not tiered — tier 1 is sufficient)
   - Use `findItemTemplateByName` pattern for idempotent seeding
   - These templates are consumed by the `learn_recipe_scroll` reducer in Plan 02

   **NOTE on quest reward recipe discovery:** The third recipe discovery path (quest rewards) is deferred. CONTEXT.md lists three discovery paths: salvage (75% chance), scroll drops, and quest rewards. HOW scrolls enter the system is Claude's Discretion. For this phase, scrolls enter via enemy loot drops only (Part B below). Quest reward seeding can be added in a future phase when the quest reward system is extended — the scroll ItemTemplates created here are fully compatible with future quest reward entries.

**Part B: Add material drops to enemy loot tables in `ensure_enemies.ts`**

Add `LootTableEntry` rows that make enemies drop materials based on creature type (per MATERIAL_DEFS.dropCreatureTypes):
- `animal` enemies: drop rough_hide (T1), tanned_leather (T2 from higher-level animals)
- `beast` enemies: drop rough_hide (T1), tanned_leather (T2), shadowhide (T3)
- `undead` enemies: drop bone_shard (T1), spirit_essence (T2)
- `spirit` enemies: drop spirit_essence (T2), void_crystal (T3)
- `construct` enemies: drop shadowhide (T3), void_crystal (T3)
- `humanoid` enemies: drop bone_shard (T1), spirit_essence (T2)

Use existing loot table seeding pattern. Set reasonable drop weights (e.g., 15-25 weight for materials, comparable to existing resource drops). Material tier should match the enemy's zone tier (low-level enemies drop T1, mid-level T2, high-level T3).

Look up material ItemTemplate IDs using `findItemTemplateByName(ctx, materialName)`. The material templates must be seeded BEFORE this runs.

Additionally, add **recipe scroll drops** to mid-tier and high-tier enemy loot tables. These are the scroll ItemTemplates created in Part A step 4. Scroll drops should be rare:
- Mid-tier enemies (T2 zones): add 1-2 weapon/armor scroll drops with **weight 3-5** (much rarer than materials). Pick scrolls appropriate to the enemy type — e.g. humanoid enemies drop weapon scrolls, beast enemies drop armor scrolls.
- High-tier enemies (T3 zones): add 2-3 scroll drops with **weight 5-8** (slightly higher chance on harder enemies). Include a mix of weapon, armor, and accessory scrolls.
- Low-tier enemies (T1 zones): NO scroll drops — scrolls are a mid/endgame discovery path.
- Look up scroll template IDs using `findItemTemplateByName(ctx, 'Scroll: {recipeName}')`. Scroll templates must be seeded BEFORE this step runs.

**Part C: Add resource nodes and expand crafting locations in `ensure_world.ts`**

1. Add gatherable resource nodes for gather-source materials:
   - Copper Ore nodes: mountains, plains locations (T1 zones)
   - Iron Ore nodes: mountains locations (T2 zones)
   - Darksteel Ore nodes: dungeon, deep mountains locations (T3 zones)
   - Moonweave Cloth nodes: swamp, woods locations (T3 zones)
   Use existing `ResourceNode` insert pattern. Set `state: 'available'`, link to the material's `itemTemplateId`.

2. Expand `craftingAvailable: true` to additional town locations. Currently only Hollowmere and possibly one other location have it. Add 1-2 more towns in different regions so players have crafting access in mid/late game areas. Check existing locations in ensure_world.ts for suitable candidates.

**Part D: Update seeding order in `ensure_content.ts`**

Ensure `ensureGearMaterialItemTemplates(ctx)` is called BEFORE `ensureWorldLayout` / resource node seeding / enemy loot seeding, so that material ItemTemplate IDs exist when nodes and loot entries reference them. Insert the call after existing `ensureResourceItemTemplates(ctx)` and before `ensureWorldLayout(ctx)`.

Also call `ensureGearRecipeTemplates(ctx)` after material templates are created and after gear item templates exist.

Call `ensureRecipeScrollItemTemplates(ctx)` after `ensureGearRecipeTemplates(ctx)` and BEFORE enemy loot seeding, so that scroll ItemTemplate IDs exist when loot table entries reference them. Seeding order:
1. `ensureGearMaterialItemTemplates(ctx)` (material items)
2. `ensureGearRecipeTemplates(ctx)` (gear recipes)
3. `ensureRecipeScrollItemTemplates(ctx)` (scroll items)
4. Enemy loot seeding (references both material and scroll template IDs)
  </action>
  <verify>
    - Check seeding functions exist: grep for `ensureGearMaterialItemTemplates`, `ensureGearRecipeTemplates`, and `ensureRecipeScrollItemTemplates` in ensure_items.ts and ensure_content.ts
    - Check LootTableEntry additions in ensure_enemies.ts: grep for material names (rough_hide, bone_shard, etc.) and scroll names ('Scroll:')
    - Check resource node additions in ensure_world.ts: grep for new material node entries
    - TypeScript compiles without new errors in seeding files
  </verify>
  <done>
    - 10 material ItemTemplates are seeded (or fewer if some reuse existing resources)
    - 14 scroll ItemTemplates seeded (one 'Scroll: {recipeName}' per gear recipe type)
    - Gear recipes are seeded for 14+ equipment slot types with recipeType and material requirements
    - Existing consumable recipes have recipeType='consumable'
    - Enemy loot tables include material drops by creature type
    - Enemy loot tables include recipe scroll drops on mid/high-tier enemies (rare weight 3-8)
    - Resource nodes exist for gatherable materials at terrain-appropriate locations
    - At least 3 locations have craftingAvailable=true
    - Seeding order is correct (materials → recipes → scrolls → enemy loot)
  </done>
</task>

</tasks>

<verification>
- `spacetimedb/src/data/crafting_materials.ts` exists with complete material taxonomy and affix map
- `spacetimedb/src/schema/tables.ts` RecipeTemplate has recipeType and materialType columns
- All seeding functions are called in correct order from ensure_content.ts
- TypeScript compiles the backend without new errors
- No changes to reducer logic (that is Plan 02)
- No changes to frontend files (that is Plan 03)
</verification>

<success_criteria>
The crafting data foundation is complete: schema extended, 10 materials defined with deterministic affix mappings, gear recipes seeded for all slots, enemy loot tables include materials, resource nodes placed at appropriate locations, and multiple crafting stations available. Plan 02 (reducer rework) and Plan 03 (frontend UI) can proceed with this data in place.
</success_criteria>

<output>
After completion, create `.planning/phases/13-crafting-system-weapons-armor-extend-recipe-system-for-gear-crafting-material-requirements-and-gathering-crafted-gear-as-deterministic-progression-path/13-01-SUMMARY.md`
</output>
