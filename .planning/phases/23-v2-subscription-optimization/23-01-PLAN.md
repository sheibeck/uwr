---
phase: 23-v2-subscription-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/helpers/events.ts
  - spacetimedb/src/views/events.ts
  - spacetimedb/src/views/index.ts
  - spacetimedb/src/views/types.ts
  - src/module_bindings/
autonomous: true
requirements: []

must_haves:
  truths:
    - "Four event tables (event_world, event_location, event_private, event_group) use event:true in schema"
    - "Server-side trimming code (trimEventRows, EVENT_TRIM_MAX, EVENT_TRIM_AGE_MICROS) is removed from events.ts"
    - "Event append helpers no longer call trimEventRows after insert"
    - "my_private_events and my_location_events views are removed (views cannot access event tables)"
    - "Module publishes successfully with --delete-data=always"
    - "Client bindings are regenerated reflecting new event table types"
  artifacts:
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "Event tables with event:true flag"
      contains: "event: true"
    - path: "spacetimedb/src/helpers/events.ts"
      provides: "Event append helpers without trimming"
    - path: "src/module_bindings/"
      provides: "Regenerated client bindings"
  key_links:
    - from: "spacetimedb/src/helpers/events.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "ctx.db.event_world.insert() etc."
      pattern: "ctx\\.db\\.event_\\w+\\.insert"
---

<objective>
Convert the four event log tables (event_world, event_location, event_private, event_group) from persistent tables to SpacetimeDB v2 Event Tables. Remove all server-side trimming logic and event views that are incompatible with event tables. Publish module and regenerate client bindings.

Purpose: Event tables auto-delete rows after broadcast, eliminating the need for manual trimming reducers and reducing database storage. Views cannot access event tables, so the two event views must be removed before conversion.

Output: Published backend module with event tables, regenerated client bindings.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-v2-subscription-optimization/23-RESEARCH.md
@spacetimedb/src/schema/tables.ts
@spacetimedb/src/helpers/events.ts
@spacetimedb/src/views/events.ts
@spacetimedb/src/views/index.ts
@spacetimedb/src/views/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert event tables to event:true and remove server-side trimming</name>
  <files>
    spacetimedb/src/schema/tables.ts
    spacetimedb/src/helpers/events.ts
    spacetimedb/src/views/events.ts
    spacetimedb/src/views/index.ts
    spacetimedb/src/views/types.ts
  </files>
  <action>
    **Step 1 — Add `event: true` to all 4 event table definitions in `spacetimedb/src/schema/tables.ts`:**

    For each of EventWorld, EventLocation, EventPrivate, EventGroup, add `event: true` to the table options object (first argument). Keep all existing columns (id, message, kind, createdAt, etc.) and indexes. The `event` flag tells SpacetimeDB to auto-delete rows after they are broadcast to subscribers.

    - EventWorld: `{ name: 'event_world', public: true, event: true }`
    - EventLocation: `{ name: 'event_location', public: true, event: true, indexes: [...] }`
    - EventPrivate: `{ name: 'event_private', public: true, event: true, indexes: [...] }`
    - EventGroup: `{ name: 'event_group', public: true, event: true, indexes: [...] }`

    **Step 2 — Remove trimming logic from `spacetimedb/src/helpers/events.ts`:**

    - Delete the `EVENT_TRIM_MAX` constant (line 9)
    - Delete the `EVENT_TRIM_AGE_MICROS` constant (line 10)
    - Delete the entire `trimEventRows` function (lines 12-40)
    - In `appendWorldEvent`: Remove lines that collect rows and call trimEventRows (lines 73-74). Keep the insert and return.
    - In `appendLocationEvent`: Remove lines that collect rows and call trimEventRows (lines 93-94). Keep the insert and return.
    - In `appendPrivateEvent`: Remove lines that collect rows and call trimEventRows (lines 113-114). Keep the insert and return.
    - In `appendGroupEvent`: Remove lines that collect rows and call trimEventRows (lines 182-183). Keep the insert and return.

    Each append function should simply insert and return the row. No post-insert cleanup needed — event tables auto-delete.

    **Step 3 — Remove event views from `spacetimedb/src/views/events.ts`:**

    Event tables cannot be accessed within view functions. Delete the entire contents of `events.ts` and replace with an empty export:
    ```typescript
    // Event views removed — event tables (event: true) cannot be accessed in views.
    // Event data is delivered via onInsert callbacks on the client.
    export const registerEventViews = (_deps: any) => {};
    ```

    **Step 4 — Clean up view wiring in `spacetimedb/src/views/index.ts`:**

    The `registerEventViews` import and call can remain (it's now a no-op), OR remove the import and call entirely for cleanliness. Either approach works — prefer removing for clarity.

    **Step 5 — Clean up ViewDeps type in `spacetimedb/src/views/types.ts`:**

    Remove `EventLocation` and `EventPrivate` from the ViewDeps interface since they are no longer used by any view. These were only referenced in `registerEventViews`.
  </action>
  <verify>
    <automated>cd C:/projects/uwr/spacetimedb && npx tsc --noEmit</automated>
    <manual>Verify event:true flag is present on all 4 event tables, trimEventRows is gone, views are removed</manual>
  </verify>
  <done>All 4 event tables have event:true. trimEventRows, EVENT_TRIM_MAX, EVENT_TRIM_AGE_MICROS are deleted. Event append helpers only insert+return. my_private_events and my_location_events views are removed. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Publish module and regenerate client bindings</name>
  <files>
    src/module_bindings/
  </files>
  <action>
    **Step 1 — Publish with data deletion:**

    The `event` flag cannot change after publishing — this requires `--delete-data=always` (schema migration). Publish to LOCAL only (per project rules, NEVER auto-publish to maincloud):

    ```bash
    spacetime publish uwr --module-path C:/projects/uwr/spacetimedb --delete-data=always -y
    ```

    Note: v2 SDK uses `--module-path` (not `--project-path`) and `--delete-data=always` (not `--clear-database`). See 23-RESEARCH.md State of the Art table.

    If the publish fails, check `spacetime logs uwr` for errors. Common issue: event tables referencing views that still exist.

    **Step 2 — Regenerate client bindings:**

    ```bash
    spacetime generate --lang typescript --out-dir C:/projects/uwr/src/module_bindings --module-path C:/projects/uwr/spacetimedb
    ```

    **Step 3 — Verify bindings generated:**

    Check that `src/module_bindings/types/` contains updated event table types. The event table types should still exist but their table behavior will differ on the client (onInsert only, no iter/cache).
  </action>
  <verify>
    <automated>cd C:/projects/uwr && npx tsc --noEmit</automated>
    <manual>Verify spacetime publish succeeded and bindings exist in src/module_bindings/</manual>
  </verify>
  <done>Module published to local SpacetimeDB with event tables. Client bindings regenerated. TypeScript compiles cleanly (may have client-side errors related to useTable on event tables — those are expected and will be fixed in Plan 02).</done>
</task>

</tasks>

<verification>
1. `spacetimedb/src/schema/tables.ts` — grep for `event: true` returns 4 matches (one per event table)
2. `spacetimedb/src/helpers/events.ts` — no reference to `trimEventRows`, `EVENT_TRIM_MAX`, or `EVENT_TRIM_AGE_MICROS`
3. `spacetimedb/src/views/events.ts` — empty or no-op function body
4. Module publishes successfully to local SpacetimeDB
5. Client bindings exist in `src/module_bindings/`
</verification>

<success_criteria>
- Four event tables converted to event:true in schema
- All trimming code removed from server
- Event views removed (views cannot access event tables)
- Module published locally with --delete-data=always
- Client bindings regenerated
</success_criteria>

<output>
After completion, create `.planning/phases/23-v2-subscription-optimization/23-01-SUMMARY.md`
</output>
