---
phase: 20-perk-variety-expansion
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - spacetimedb/src/reducers/renown.ts
  - spacetimedb/src/data/renown_data.ts
  - spacetimedb/src/helpers/combat.ts
  - spacetimedb/src/schema/tables.ts
autonomous: true

must_haves:
  truths:
    - "Active ability perks auto-assign to hotbar when chosen"
    - "Active abilities can be cast from hotbar and trigger their effects"
    - "Active abilities have cooldowns that are tracked and enforced"
    - "Second Wind heals 20% max HP, Thunderous Blow deals 300% weapon damage, Wrath of the Fallen grants damage buff"
  artifacts:
    - path: "spacetimedb/src/reducers/renown.ts"
      provides: "Auto-hotbar assignment logic in choose_perk reducer"
      contains: "hotbarSlot"
    - path: "spacetimedb/src/helpers/combat.ts"
      provides: "Perk ability execution handlers"
      contains: "executePerkAbility"
  key_links:
    - from: "spacetimedb/src/reducers/renown.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "hotbarSlot table insert for perk abilities"
      pattern: "hotbarSlot.insert"
    - from: "spacetimedb/src/helpers/combat.ts"
      to: "spacetimedb/src/data/renown_data.ts"
      via: "RENOWN_PERK_POOLS lookup for ability data"
      pattern: "RENOWN_PERK_POOLS"
---

<objective>
Implement the three active ability perks (Second Wind at rank 6, Thunderous Blow at rank 8, Wrath of the Fallen at rank 10) with full hotbar integration, casting, cooldowns, and effects.

Purpose: Make active ability perks fully functional — players choose them, they appear on hotbar, they can be cast with meaningful combat effects.
Output: Working active perk abilities with auto-hotbar, casting, cooldowns, and combat effects.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-perk-variety-expansion/20-01-SUMMARY.md
@spacetimedb/src/data/renown_data.ts
@spacetimedb/src/reducers/renown.ts
@spacetimedb/src/helpers/combat.ts
@spacetimedb/src/schema/tables.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement hotbar auto-assignment for active perks</name>
  <files>spacetimedb/src/reducers/renown.ts, spacetimedb/src/data/renown_data.ts</files>
  <action>
Modify the `choose_perk` reducer in renown.ts to auto-assign active ability perks to the hotbar.

After the existing `ctx.db.renownPerk.insert(...)` call, add:

1. Look up the chosen perk definition from RENOWN_PERK_POOLS
2. Check if `perk.type === 'active'`
3. If active, find the first empty hotbar slot:
   - Query all `ctx.db.hotbarSlot.by_character.filter(characterId)` to get used slots
   - Build a Set of used slot numbers
   - Find first slot 0-11 not in the set
4. If empty slot found, insert a new HotbarSlot row:
   - Use `perkKey` as the `abilityKey` (prefix with `perk_` to distinguish from class abilities, e.g., `perk_second_wind`)
   - Set slot number
   - Log: "Second Wind added to hotbar slot 3"
5. If no empty slot, log: "Second Wind granted! Manage hotbar to use it."

Also update renown_data.ts: ensure active perk definitions include a `perkAbilityKey` field in their effect, e.g.:
```
effect: {
  cooldownSeconds: 300,
  perkAbilityKey: 'perk_second_wind',
  healPercent: 20,
}
```

Add these fields to PerkEffect type if not already present from Plan 01:
- `perkAbilityKey?: string`
- `healPercent?: number` (for Second Wind)
- `damagePercent?: number` (for Thunderous Blow, 300 = 300% weapon damage)
- `buffType?: string` (for Wrath of the Fallen)
- `buffMagnitude?: bigint` (buff strength)
- `buffDurationSeconds?: number` (buff duration)

Define the three active perks with full effect data:

**Rank 6 - Second Wind:**
```
perkAbilityKey: 'perk_second_wind',
cooldownSeconds: 300,
healPercent: 20, // Heal for 20% of max HP
```

**Rank 8 - Thunderous Blow:**
```
perkAbilityKey: 'perk_thunderous_blow',
cooldownSeconds: 300,
damagePercent: 300, // 300% weapon damage
```

**Rank 10 - Wrath of the Fallen:**
```
perkAbilityKey: 'perk_wrath_of_fallen',
cooldownSeconds: 600,
buffType: 'damage_boost',
buffMagnitude: 25n, // +25% damage
buffDurationSeconds: 20,
```
  </action>
  <verify>
1. TypeScript compiles
2. Choose an active perk via grant_test_renown + choose_perk — verify hotbar slot created
3. System message confirms hotbar assignment
  </verify>
  <done>Active perks auto-assign to hotbar when chosen. Perk ability keys use `perk_` prefix. Three active perks have full effect definitions with healing, damage, and buff data.</done>
</task>

<task type="auto">
  <name>Task 2: Implement perk ability execution and cooldown tracking</name>
  <files>spacetimedb/src/helpers/combat.ts, spacetimedb/src/schema/tables.ts</files>
  <action>
Add perk ability execution to the existing ability casting system.

**If ability casting goes through a use_ability or execute_ability reducer:**

1. Check if the abilityKey starts with `perk_`
2. If so, route to `executePerkAbility(ctx, character, abilityKey, combatId, seed)` instead of normal ability logic

**Implement `executePerkAbility` in combat.ts (or a new `helpers/perk_abilities.ts`):**

```
function executePerkAbility(ctx, character, abilityKey, combatId, seed):
  // Look up perk definition by stripping 'perk_' prefix and finding in RENOWN_PERK_POOLS
  const perkKey = abilityKey.replace('perk_', '');
  const perkDef = findPerkByKey(perkKey); // search all pools
  if (!perkDef || perkDef.type !== 'active') throw SenderError('Invalid perk ability');

  // Verify character has this perk
  let hasPerk = false;
  for (const row of ctx.db.renownPerk.by_character.filter(character.id)) {
    if (row.perkKey === perkKey) { hasPerk = true; break; }
  }
  if (!hasPerk) throw SenderError('You do not have this perk');

  // Check cooldown using AbilityCooldown table (reuse existing class ability cooldown system)
  const cooldownMicros = BigInt(perkDef.effect.cooldownSeconds || 300) * 1_000_000n;
  // Check if ability is on cooldown (same pattern as class abilities)
  for (const cd of ctx.db.abilityCooldown.by_character.filter(character.id)) {
    if (cd.abilityKey === abilityKey) {
      const elapsed = ctx.timestamp.microsSinceUnixEpoch - cd.usedAt.microsSinceUnixEpoch;
      if (elapsed < cooldownMicros) {
        const remainingSec = (cooldownMicros - elapsed) / 1_000_000n;
        throw SenderError(`${perkDef.name} is on cooldown (${remainingSec}s remaining)`);
      }
    }
  }

  // Execute the ability based on its effect:

  if (perkDef.effect.healPercent) {
    // Second Wind: heal for X% of max HP
    const maxHp = character.maxHp;
    const healAmount = (maxHp * BigInt(perkDef.effect.healPercent)) / 100n;
    const newHp = character.currentHp + healAmount > maxHp ? maxHp : character.currentHp + healAmount;
    ctx.db.character.id.update({ ...character, currentHp: newHp });
    logPrivateAndGroup(ctx, character, `${character.name} uses ${perkDef.name}! Heals for ${healAmount} HP.`);
  }

  if (perkDef.effect.damagePercent && combatId) {
    // Thunderous Blow: deal X% weapon damage to current target
    const weaponStats = getEquippedWeaponStats(ctx, character.id);
    const baseDamage = weaponStats.damage || 10n;
    const totalDamage = (baseDamage * BigInt(perkDef.effect.damagePercent)) / 100n;
    // Find target (highest aggro enemy or current target)
    // Apply damage to target enemy, log it
    logPrivateAndGroup(ctx, character, `${character.name} unleashes ${perkDef.name}! Deals ${totalDamage} damage!`);
  }

  if (perkDef.effect.buffType) {
    // Wrath of the Fallen: grant damage buff
    addCharacterEffect(
      ctx,
      character.id,
      perkDef.effect.buffType,
      perkDef.effect.buffMagnitude || 25n,
      BigInt(Math.ceil((perkDef.effect.buffDurationSeconds || 20) / 3)), // Convert seconds to combat rounds (3s per round)
      abilityKey
    );
    logPrivateAndGroup(ctx, character, `${character.name} activates ${perkDef.name}! +${perkDef.effect.buffMagnitude}% damage for ${perkDef.effect.buffDurationSeconds}s.`);
  }

  // Record cooldown (insert or update AbilityCooldown)
  // Use existing cooldown tracking pattern from class abilities
  recordAbilityCooldown(ctx, character.id, abilityKey);
```

**Integration with existing ability system:**

Find where abilities are executed (likely in a `use_ability` reducer or `executeAbilityAction` helper). Add a check at the top:

```typescript
if (abilityKey.startsWith('perk_')) {
  return executePerkAbility(ctx, character, abilityKey, combatId, seed);
}
```

This routes perk abilities to the new handler while keeping class abilities on their existing path.

**Cooldown tracking:** Reuse the existing AbilityCooldown table. Perk abilities use the same cooldown infrastructure as class abilities, just with `perk_` prefixed keys.

**Important:** Second Wind should be usable OUTSIDE combat (it's a self-heal). Check if the ability system requires combat context — if so, add a special case for perk abilities that can be used outside combat. Thunderous Blow and Wrath of the Fallen require combat context.

**Publish and regenerate bindings after implementation:**
```
spacetime publish uwr --project-path spacetimedb
spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb
```
  </action>
  <verify>
1. Module publishes successfully
2. Grant test renown to rank 6, choose Second Wind, verify it appears on hotbar
3. Use Second Wind ability — verify HP heals by 20% of max, cooldown starts
4. Try using Second Wind again before cooldown expires — verify error message
5. Grant to rank 8, choose Thunderous Blow, enter combat, use it — verify 300% weapon damage dealt
6. Verify existing class abilities still work
  </verify>
  <done>Three active perk abilities implemented: Second Wind (heal), Thunderous Blow (damage), Wrath of the Fallen (buff). Cooldowns tracked via AbilityCooldown table. Abilities route through existing casting system with perk_ prefix detection. Second Wind usable outside combat. Module published and bindings regenerated.</done>
</task>

</tasks>

<verification>
1. `spacetime publish uwr --project-path spacetimedb` succeeds
2. `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb` succeeds
3. Active perks appear on hotbar when chosen
4. Second Wind heals correctly (20% max HP)
5. Thunderous Blow deals correct damage (300% weapon)
6. Wrath of the Fallen grants damage buff (25% for 20s)
7. Cooldowns prevent spam casting
8. Existing class abilities unaffected
</verification>

<success_criteria>
- All 3 active ability perks castable from hotbar
- Cooldown tracking works correctly
- Effects apply as described (heal, damage, buff)
- Auto-hotbar assignment works on perk selection
- No regression in class ability system
</success_criteria>

<output>
After completion, create `.planning/phases/20-perk-variety-expansion/20-03-SUMMARY.md`
</output>
