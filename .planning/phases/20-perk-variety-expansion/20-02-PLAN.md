---
phase: 20-perk-variety-expansion
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - spacetimedb/src/helpers/renown.ts
  - spacetimedb/src/helpers/combat.ts
  - spacetimedb/src/reducers/items.ts
  - spacetimedb/src/helpers/character.ts
  - spacetimedb/src/helpers/npc_affinity.ts
  - spacetimedb/src/reducers/npc_interaction.ts
autonomous: true

must_haves:
  truths:
    - "Combat proc perks trigger at correct rates during combat (on-hit, on-crit, on-kill, on-damage-taken)"
    - "Crafting/gathering perks increase resource yields and quality when gathering or crafting"
    - "Social/utility perks improve NPC affinity gains, vendor prices, travel cooldowns, gold and XP"
    - "Proc events appear in combat log with clear messages"
    - "All perk effects use deterministic RNG (no Math.random)"
    - "Existing stat bonus perks continue working alongside new effect types"
  artifacts:
    - path: "spacetimedb/src/helpers/renown.ts"
      provides: "getPerkProcs and getPerkBonusByField helper functions"
      contains: "getPerkProcs"
    - path: "spacetimedb/src/helpers/combat.ts"
      provides: "Combat proc checking after damage resolution"
      contains: "applyPerkProcs"
    - path: "spacetimedb/src/reducers/items.ts"
      provides: "Gathering perk bonus application"
      contains: "gatherDoubleChance"
  key_links:
    - from: "spacetimedb/src/helpers/combat.ts"
      to: "spacetimedb/src/helpers/renown.ts"
      via: "getPerkProcs import"
      pattern: "getPerkProcs"
    - from: "spacetimedb/src/reducers/items.ts"
      to: "spacetimedb/src/helpers/renown.ts"
      via: "getPerkBonusByField import"
      pattern: "getPerkBonusByField"
    - from: "spacetimedb/src/helpers/npc_affinity.ts"
      to: "spacetimedb/src/helpers/renown.ts"
      via: "getPerkBonusByField import for affinity gains"
      pattern: "npcAffinityGainBonus"
---

<objective>
Implement passive perk effect hooks across all game systems: combat procs, crafting/gathering bonuses, and social/utility modifiers.

Purpose: Make the new perk effects from Plan 01 actually functional in gameplay. When a player has a combat proc perk, it triggers during fights. When they have a gathering perk, they get extra resources.
Output: Working passive perk integration in combat, items, NPC, vendor, travel, and XP systems.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-perk-variety-expansion/20-01-SUMMARY.md
@spacetimedb/src/data/renown_data.ts
@spacetimedb/src/helpers/renown.ts
@spacetimedb/src/helpers/combat.ts
@spacetimedb/src/reducers/items.ts
@spacetimedb/src/helpers/npc_affinity.ts
@spacetimedb/src/helpers/character.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add perk query helpers and implement combat proc system</name>
  <files>spacetimedb/src/helpers/renown.ts, spacetimedb/src/helpers/combat.ts</files>
  <action>
**In renown.ts**, add two new helper functions:

1. `getPerkProcs(ctx, characterId, eventType)` — Returns array of perk definitions that have proc effects matching the given event type (on_hit, on_crit, on_kill, on_damage_taken). Queries all RenownPerk rows for character, looks up each in RENOWN_PERK_POOLS, returns those with matching `procType`.

2. `getPerkBonusByField(ctx, characterId, fieldName)` — Returns the total numeric value for a specific perk effect field across all character's perks. Example: `getPerkBonusByField(ctx, charId, 'gatherDoubleChance')` returns 20 if they have the Keen Eye perk. Handles both number and bigint fields. For scaling perks (scalesWithLevel=true), look up character level and apply perLevelBonus scaling.

3. `getAllPerkEffects(ctx, characterId)` — Returns merged PerkEffect object with all passive bonuses summed (extending the existing calculatePerkBonuses pattern). Include the new fields.

**In combat.ts**, add perk proc checking:

Add function `applyPerkProcs(ctx, characterId, eventType, damageDealt, seed)`:
- Call `getPerkProcs(ctx, characterId, eventType)` to get applicable procs
- For each proc, do a deterministic roll: `(seed + BigInt(perkIndex)) % 100n`
- If roll < procChance, apply the proc effect:
  - `procDamageMultiplier`: deal (damageDealt * multiplier / 100n) bonus damage
  - `procHealPercent`: heal character for (damageDealt * percent / 100n)
  - `procBonusDamage`: deal flat bonus damage
- Log proc triggers to combat log: "Your [PerkName] triggered! [effect description]"
- Return total bonus damage dealt and total healing done

**Integration points in combat.ts** (find and modify existing code):

1. After auto-attack damage calculation (where `outcome === 'hit'` or `outcome === 'crit'`):
   - Call `applyPerkProcs(ctx, characterId, 'on_hit', damageDealt, attackSeed)`
   - If outcome was crit, also call `applyPerkProcs(ctx, characterId, 'on_crit', damageDealt, attackSeed + 1000n)`
   - Apply any bonus damage to the target

2. After enemy kill (where enemy HP reaches 0):
   - Call `applyPerkProcs(ctx, characterId, 'on_kill', lastDamageDealt, killSeed)`

3. After character takes damage:
   - Call `applyPerkProcs(ctx, characterId, 'on_damage_taken', damageTaken, damageSeed)`

**Critical: All random rolls must be deterministic.** Use seed-based arithmetic (`seed % 100n`), following the existing pattern in `rollAttackOutcome()`. Never use Math.random().

**For on_kill AoE proc (Deathbringer):** When the proc triggers, deal damage to all other enemies in the same combat. Iterate `combatEnemy.by_combat.filter(combatId)`, skip the already-dead enemy, apply damage to each living enemy.
  </action>
  <verify>
1. TypeScript compiles: `cd spacetimedb && npx tsc --noEmit`
2. Module publishes: `spacetime publish uwr --project-path spacetimedb`
3. Create test character, grant test renown to rank 5, choose "Savage Strikes" combat perk, enter combat, verify proc triggers appear in combat log at ~5% rate on crits
  </verify>
  <done>getPerkProcs and getPerkBonusByField helpers exist. Combat proc system triggers on-hit, on-crit, on-kill, on-damage-taken events. Proc effects apply damage/healing correctly. Combat log shows proc trigger messages. All RNG is deterministic.</done>
</task>

<task type="auto">
  <name>Task 2: Implement crafting/gathering and social/utility perk bonuses</name>
  <files>spacetimedb/src/reducers/items.ts, spacetimedb/src/helpers/character.ts, spacetimedb/src/helpers/npc_affinity.ts, spacetimedb/src/reducers/npc_interaction.ts</files>
  <action>
**Crafting/Gathering bonuses in items.ts (gather_resource reducer):**

After base quantity is calculated for a gather action:
1. Import `getPerkBonusByField` from renown helpers
2. Check `gatherDoubleChance`: Roll deterministic seed (`BigInt(resourceNodeId) + ctx.timestamp.microsSinceUnixEpoch`) % 100n. If roll < chance, multiply quantity by 2. Log: "Your gathering perk triggered! Double resources collected."
3. Check `rareGatherChance`: Roll another seed. If triggered, add a rare material drop (if the resource template has a rare variant, give that; otherwise give +50% extra of the normal resource). Log: "Your gathering perk found rare materials!"
4. Check `gatherSpeedBonus`: This one is trickier — if gathering has a cooldown or timer, reduce it by the percentage. If gathering is instant, this perk has no effect (document this limitation). If there is a gather cooldown, apply: `cooldown = baseCooldown * (100 - bonus) / 100`.

**Craft quality bonus:** If a crafting system exists (craft_item reducer), after item is created, check `craftQualityBonus`. This affects item stat rolls if they exist. If crafting currently creates fixed-stat items, document that this bonus will take effect when item stat variance is added. For now, store the bonus on the item's metadata if possible, or add a system message noting the quality bonus.

**Vendor price modifiers in character.ts or wherever buy/sell happens:**

Find the vendor buy/sell reducers. Apply perk bonuses:
- `vendorBuyDiscount`: Reduce purchase price by percentage. `finalPrice = basePrice * (100 - discount) / 100`
- `vendorSellBonus`: Increase sell price by percentage. `finalPrice = basePrice * (100 + bonus) / 100`
- Log adjusted prices in system messages so players see the discount.

**NPC affinity bonuses in npc_affinity.ts or npc_interaction.ts:**

Find where NPC affinity points are awarded (likely in a conversation or gift function). Apply:
- `npcAffinityGainBonus`: Multiply affinity gain by `(100 + bonus) / 100`. Log: "Your diplomatic perk boosted affinity gain!"

**Travel cooldown reduction:**

Find where travel cooldowns are applied (likely in move_character reducer or travel helpers). Apply:
- `travelCooldownReduction`: Reduce cooldown duration by percentage. `cooldown = baseCooldown * (100 - reduction) / 100`

**Gold find bonus:**

Find where gold is awarded (enemy kills, quest completion, etc.). Apply:
- `goldFindBonus`: Multiply gold by `(100 + bonus) / 100`

**XP bonus:**

Find where XP is awarded. Apply:
- `xpBonus`: Multiply XP by `(100 + bonus) / 100`

**For all bonuses:** Import `getPerkBonusByField` from renown helpers. Each call queries the character's perks and returns the total bonus for that field. Use it at each integration point.

**Scaling perks:** When `getPerkBonusByField` encounters a perk with `scalesWithLevel: true`, it should look up the character's level and add `perLevelBonus * characterLevel` to the base value. The helper function handles this — consumers just call `getPerkBonusByField` and get the total.
  </action>
  <verify>
1. TypeScript compiles without errors
2. Module publishes successfully
3. Test gathering with "Keen Eye" perk (rank 2 crafting) — verify 10% double gather triggers
4. Test vendor with "Shrewd Bargainer" perk (rank 3 social) — verify 5% discount applies
5. Test NPC conversation with "Smooth Talker" perk (rank 2 social) — verify +15% affinity gain
  </verify>
  <done>Gathering perks apply double yield and rare material chances. Vendor perks modify buy/sell prices. NPC perks boost affinity gains. Travel perks reduce cooldowns. Gold find and XP bonuses apply at award sites. All bonuses logged to system messages.</done>
</task>

</tasks>

<verification>
1. `spacetime publish uwr --project-path spacetimedb` succeeds
2. `spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb` regenerates bindings
3. Combat procs trigger at expected rates (test with grant_test_renown + perk selection)
4. Gathering bonuses apply (test with gathering and checking output)
5. Social bonuses apply (test NPC conversation, vendor, travel)
6. No regression in existing combat or perk stat bonus system
</verification>

<success_criteria>
- All passive perk effect types functional: procs, crafting, social, utility
- Effects integrated at correct game system hook points
- Deterministic RNG for all random effects
- System messages inform players when perk effects trigger
- Existing stat bonus perks continue working
</success_criteria>

<output>
After completion, create `.planning/phases/20-perk-variety-expansion/20-02-SUMMARY.md`
</output>
