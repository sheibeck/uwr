---
phase: 06-quest-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/helpers/search.ts
  - spacetimedb/src/reducers/movement.ts
  - spacetimedb/src/data/dialogue_data.ts
  - spacetimedb/src/seeding/ensure_world.ts
  - spacetimedb/src/seeding/ensure_content.ts
  - spacetimedb/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Passive search triggers on every location entry (travel reducer)"
    - "Search rolls independent chances for resources (65%), quest items (40%), named enemies (20%)"
    - "Previous SearchResult for character is deleted before inserting new one"
    - "14 new quest templates are seeded with correct quest types and target data"
    - "14 new dialogue branches are seeded with correct affinity gates and quest template names"
    - "Delivery chain Marla -> Thessa -> Mordane links all 3 regions narratively"
  artifacts:
    - path: "spacetimedb/src/helpers/search.ts"
      provides: "performPassiveSearch helper function"
      exports: ["performPassiveSearch"]
    - path: "spacetimedb/src/data/dialogue_data.ts"
      provides: "14 new dialogue option entries for new quests"
      contains: "Old Debts"
    - path: "spacetimedb/src/seeding/ensure_world.ts"
      provides: "14 new quest templates seeded in ensureQuestTemplates"
      contains: "kill_loot"
  key_links:
    - from: "spacetimedb/src/reducers/movement.ts"
      to: "spacetimedb/src/helpers/search.ts"
      via: "performPassiveSearch called after moveOne"
      pattern: "performPassiveSearch"
    - from: "spacetimedb/src/data/dialogue_data.ts"
      to: "spacetimedb/src/seeding/ensure_world.ts"
      via: "questTemplateName references match quest template names"
      pattern: "questTemplateName.*Old Debts"
---

<objective>
Implement the passive search system (triggered on location entry) and seed all 14 new quests with their dialogue branches. The search system creates SearchResult rows when characters enter locations, rolling for hidden resources, quest items, and named enemies. The quest data adds affinity-gated dialogue options to existing NPCs that offer the new quest types.

Purpose: This plan delivers the search mechanic that makes explore/boss_kill quests possible (search reveals quest items and named enemies) and seeds all the content that players interact with.

Output: Working passive search on travel, 14 seeded quest templates with proper types, 14+ dialogue options woven into existing NPC dialogue chains.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@spacetimedb/src/reducers/movement.ts
@spacetimedb/src/data/dialogue_data.ts
@spacetimedb/src/seeding/ensure_world.ts
@spacetimedb/src/seeding/ensure_content.ts
@spacetimedb/src/data/npc_data.ts
@spacetimedb/src/helpers/location.ts
@spacetimedb/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create passive search helper and wire into travel reducer</name>
  <files>spacetimedb/src/helpers/search.ts, spacetimedb/src/reducers/movement.ts, spacetimedb/src/index.ts</files>
  <action>
1. Create `spacetimedb/src/helpers/search.ts` with a `performPassiveSearch` function:

```typescript
export function performPassiveSearch(
  ctx: any,
  character: any,
  locationId: bigint,
  appendPrivateEvent: any,
) {
  // Delete any previous SearchResult for this character
  for (const sr of ctx.db.searchResult.by_character.filter(character.id)) {
    ctx.db.searchResult.id.delete(sr.id);
  }

  // Deterministic pseudo-random seed
  const seed = character.id ^ ctx.timestamp.microsSinceUnixEpoch;

  let foundResources = false;
  let foundQuestItem = false;
  let questItemId: bigint | undefined = undefined;
  let foundNamedEnemy = false;
  let namedEnemyId: bigint | undefined = undefined;

  // Roll 1: Hidden resources (65% chance)
  const resourceRoll = seed % 100n;
  if (resourceRoll < 65n) {
    foundResources = true;
  }

  // Roll 2: Quest items (40% chance) — only if character has active explore quest targeting this location
  // Use a different bit mix for independent roll
  const questRoll = ((seed >> 8n) ^ (seed * 7n)) % 100n < 0n
    ? (((seed >> 8n) ^ (seed * 7n)) % 100n) + 100n
    : ((seed >> 8n) ^ (seed * 7n)) % 100n;

  for (const qi of ctx.db.questInstance.by_character.filter(character.id)) {
    if (qi.completed) continue;
    const qt = ctx.db.questTemplate.id.find(qi.questTemplateId);
    if (!qt) continue;
    if ((qt.questType ?? 'kill') !== 'explore') continue;
    if (qt.targetLocationId !== locationId) continue;

    // Check if character already has a discovered (but not looted) quest item for this quest here
    let alreadyHasItem = false;
    for (const existingItem of ctx.db.questItem.by_character.filter(character.id)) {
      if (existingItem.questTemplateId === qt.id && existingItem.locationId === locationId && !existingItem.looted) {
        alreadyHasItem = true;
        break;
      }
    }
    if (alreadyHasItem) continue;

    if (questRoll < 40n) {
      // Create a quest item node at this location
      const newItem = ctx.db.questItem.insert({
        id: 0n,
        characterId: character.id,
        questTemplateId: qt.id,
        locationId,
        name: qt.targetItemName ?? 'Hidden Object',
        discovered: true,
        looted: false,
      });
      foundQuestItem = true;
      questItemId = newItem.id;
      appendPrivateEvent(ctx, character.id, character.ownerUserId, 'quest',
        `Your search reveals something: ${qt.targetItemName ?? 'a hidden object'}!`);
    }
    break; // Only one explore quest roll per location entry
  }

  // Roll 3: Named enemy (20% chance) — only if a named enemy is configured for this location
  // Use yet another bit mix for independent roll
  const enemyRoll = ((seed >> 16n) ^ (seed * 13n)) % 100n < 0n
    ? (((seed >> 16n) ^ (seed * 13n)) % 100n) + 100n
    : ((seed >> 16n) ^ (seed * 13n)) % 100n;

  // Check if there's a NamedEnemy configured at this location for this character that could be revealed
  // NamedEnemy rows are pre-created by quest data seeding — check if one exists but isn't alive
  // Actually, NamedEnemy rows should be created by the search system when a boss_kill quest is active
  for (const qi of ctx.db.questInstance.by_character.filter(character.id)) {
    if (qi.completed) continue;
    const qt = ctx.db.questTemplate.id.find(qi.questTemplateId);
    if (!qt) continue;
    if ((qt.questType ?? 'kill') !== 'boss_kill') continue;
    if (qt.targetLocationId !== locationId) continue;

    // Check if named enemy already exists (alive) at this location for this character
    let existingEnemy: any = null;
    for (const ne of ctx.db.namedEnemy.by_character.filter(character.id)) {
      if (ne.locationId === locationId && ne.enemyTemplateId === qt.targetEnemyTemplateId) {
        existingEnemy = ne;
        break;
      }
    }

    // If exists and alive, just reveal it
    if (existingEnemy && existingEnemy.isAlive) {
      foundNamedEnemy = true;
      namedEnemyId = existingEnemy.id;
      break;
    }

    // If exists but dead, check respawn timer
    if (existingEnemy && !existingEnemy.isAlive && existingEnemy.lastKilledAt) {
      const respawnMicros = existingEnemy.respawnMinutes * 60n * 1_000_000n;
      const killedAtMicros = existingEnemy.lastKilledAt.microsSinceUnixEpoch;
      if (ctx.timestamp.microsSinceUnixEpoch < killedAtMicros + respawnMicros) {
        break; // Still on respawn cooldown
      }
      // Respawned — revive it
      ctx.db.namedEnemy.id.update({ ...existingEnemy, isAlive: true, lastKilledAt: undefined });
      foundNamedEnemy = true;
      namedEnemyId = existingEnemy.id;
      break;
    }

    // No existing enemy — roll to discover
    if (enemyRoll < 20n) {
      const newEnemy = ctx.db.namedEnemy.insert({
        id: 0n,
        characterId: character.id,
        name: qt.targetItemName ?? 'Named Enemy', // We'll use a naming convention — see task 2 seeding
        enemyTemplateId: qt.targetEnemyTemplateId,
        locationId,
        isAlive: true,
        lastKilledAt: undefined,
        respawnMinutes: 30n, // 30 minute respawn
      });
      foundNamedEnemy = true;
      namedEnemyId = newEnemy.id;
      appendPrivateEvent(ctx, character.id, character.ownerUserId, 'quest',
        `You sense a powerful presence nearby...`);
    }
    break; // Only one boss check per location entry
  }

  // Always create a SearchResult row
  ctx.db.searchResult.insert({
    id: 0n,
    characterId: character.id,
    locationId,
    foundResources,
    foundQuestItem,
    questItemId,
    foundNamedEnemy,
    namedEnemyId,
    searchedAt: ctx.timestamp,
  });

  // Log resource discovery
  if (foundResources) {
    appendPrivateEvent(ctx, character.id, character.ownerUserId, 'move',
      'You notice some hidden resources in the area.');
  }
}
```

2. In `spacetimedb/src/reducers/movement.ts`, import and call `performPassiveSearch` after each character moves:

Add import at top:
```typescript
import { performPassiveSearch } from '../helpers/search';
```

In the `moveOne` function (around line 115-128), after `ensureSpawnsForLocation(ctx, location.id);`, add:
```typescript
performPassiveSearch(ctx, ctx.db.character.id.find(charId)!, location.id, appendPrivateEvent);
```

Note: Re-read the character row using `ctx.db.character.id.find(charId)!` since the character's locationId was just updated and the search function needs the fresh row.

3. In `spacetimedb/src/index.ts`, import `performPassiveSearch` from `'./helpers/search'` and add it to the deps object so it's available if other reducers need it. Also make sure the deps object passes `appendPrivateEvent` to movement.ts (it already does via the deps pattern, but verify).
  </action>
  <verify>Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` — should compile cleanly. Verify `performPassiveSearch` is called in the moveOne function of movement.ts.</verify>
  <done>Passive search triggers on every location entry. SearchResult rows created with independent rolls for resources (65%), quest items (40% for active explore quests), and named enemies (20% for active boss_kill quests). Previous SearchResult deleted on new location entry. Named enemies respect respawn timers.</done>
</task>

<task type="auto">
  <name>Task 2: Seed 14 new quest templates and dialogue branches</name>
  <files>spacetimedb/src/seeding/ensure_world.ts, spacetimedb/src/data/dialogue_data.ts</files>
  <action>
1. In `spacetimedb/src/seeding/ensure_world.ts`, modify the `ensureQuestTemplates` function:

First, update the `upsertQuestByName` helper to accept the new optional fields:
```typescript
const upsertQuestByName = (args: {
  name: string;
  npcName: string;
  enemyName?: string;
  requiredCount: bigint;
  minLevel: bigint;
  maxLevel: bigint;
  rewardXp: bigint;
  questType?: string;
  targetLocationName?: string;
  targetNpcName?: string;
  targetItemName?: string;
  itemDropChance?: bigint;
}) => {
  const npc = [...ctx.db.npc.iter()].find((row) => row.name === args.npcName);
  const enemy = args.enemyName ? findEnemyTemplateByName(ctx, args.enemyName) : null;
  const targetLocation = args.targetLocationName
    ? [...ctx.db.location.iter()].find((row) => row.name === args.targetLocationName)
    : null;
  const targetNpc = args.targetNpcName
    ? [...ctx.db.npc.iter()].find((row) => row.name === args.targetNpcName)
    : null;
  if (!npc) return;
  // enemy is optional for non-kill quests
  const existing = [...ctx.db.questTemplate.iter()].find((row) => row.name === args.name);
  if (existing) {
    ctx.db.questTemplate.id.update({
      ...existing,
      name: args.name,
      npcId: npc.id,
      targetEnemyTemplateId: enemy?.id ?? existing.targetEnemyTemplateId ?? 0n,
      requiredCount: args.requiredCount,
      minLevel: args.minLevel,
      maxLevel: args.maxLevel,
      rewardXp: args.rewardXp,
      questType: args.questType ?? 'kill',
      targetLocationId: targetLocation?.id,
      targetNpcId: targetNpc?.id,
      targetItemName: args.targetItemName,
      itemDropChance: args.itemDropChance,
    });
    return;
  }
  ctx.db.questTemplate.insert({
    id: 0n,
    name: args.name,
    npcId: npc.id,
    targetEnemyTemplateId: enemy?.id ?? 0n,
    requiredCount: args.requiredCount,
    minLevel: args.minLevel,
    maxLevel: args.maxLevel,
    rewardXp: args.rewardXp,
    questType: args.questType ?? 'kill',
    targetLocationId: targetLocation?.id,
    targetNpcId: targetNpc?.id,
    targetItemName: args.targetItemName,
    itemDropChance: args.itemDropChance,
  });
};
```

Then add these 14 new quest seeds AFTER the existing quest seeds:

```typescript
// === Phase 6: New Quest Types ===

// Marla the Guide — delivery quest
upsertQuestByName({
  name: 'Old Debts',
  npcName: 'Marla the Guide',
  requiredCount: 1n,
  minLevel: 1n,
  maxLevel: 10n,
  rewardXp: 80n,
  questType: 'delivery',
  targetNpcName: 'Scout Thessa',
});

// Warden Kael — kill_loot + explore
upsertQuestByName({
  name: 'Stolen Supply Cache',
  npcName: 'Warden Kael',
  enemyName: 'Thicket Wolf',
  requiredCount: 1n,
  minLevel: 1n,
  maxLevel: 5n,
  rewardXp: 70n,
  questType: 'kill_loot',
  targetItemName: 'Stolen Supply Pack',
  itemDropChance: 25n,
});
upsertQuestByName({
  name: "The Ranger's Cache",
  npcName: 'Warden Kael',
  requiredCount: 1n,
  minLevel: 2n,
  maxLevel: 6n,
  rewardXp: 100n,
  questType: 'explore',
  targetLocationName: 'Bramble Hollow',
  targetItemName: 'Buried Supply Cache',
});

// Herbalist Venna — explore + kill_loot
upsertQuestByName({
  name: 'Bogfen Healing Moss',
  npcName: 'Herbalist Venna',
  requiredCount: 1n,
  minLevel: 1n,
  maxLevel: 5n,
  rewardXp: 65n,
  questType: 'explore',
  targetLocationName: 'Willowfen',
  targetItemName: 'Rare Healing Moss',
});
upsertQuestByName({
  name: 'Croaker Bile Glands',
  npcName: 'Herbalist Venna',
  enemyName: 'Marsh Croaker',
  requiredCount: 1n,
  minLevel: 2n,
  maxLevel: 5n,
  rewardXp: 90n,
  questType: 'kill_loot',
  targetItemName: 'Fresh Bile Gland',
  itemDropChance: 30n,
});

// Scout Thessa — explore + delivery (unlocked via Marla delivery chain)
upsertQuestByName({
  name: 'Enemy Scouting Reports',
  npcName: 'Scout Thessa',
  requiredCount: 1n,
  minLevel: 3n,
  maxLevel: 8n,
  rewardXp: 120n,
  questType: 'explore',
  targetLocationName: 'Cinderwatch',
  targetItemName: 'Scouting Reports',
});
upsertQuestByName({
  name: 'The Iron Compact Leak',
  npcName: 'Scout Thessa',
  requiredCount: 1n,
  minLevel: 3n,
  maxLevel: 8n,
  rewardXp: 110n,
  questType: 'delivery',
  targetNpcName: 'Keeper Mordane',
});

// Ashwalker Ren — kill_loot + boss_kill
upsertQuestByName({
  name: 'Encryption Key',
  npcName: 'Ashwalker Ren',
  enemyName: 'Cinder Sentinel',
  requiredCount: 1n,
  minLevel: 3n,
  maxLevel: 7n,
  rewardXp: 100n,
  questType: 'kill_loot',
  targetItemName: 'Cipher Key Fragment',
  itemDropChance: 20n,
});
upsertQuestByName({
  name: 'The Ashforged Commander',
  npcName: 'Ashwalker Ren',
  enemyName: 'Cinder Sentinel',
  requiredCount: 1n,
  minLevel: 4n,
  maxLevel: 8n,
  rewardXp: 200n,
  questType: 'boss_kill',
  targetLocationName: 'Scoria Flats',
  targetItemName: 'Ashforged Commander',
});

// Torchbearer Isa — boss_kill + explore
upsertQuestByName({
  name: 'The Revenant Lord',
  npcName: 'Torchbearer Isa',
  enemyName: 'Ashforged Revenant',
  requiredCount: 1n,
  minLevel: 4n,
  maxLevel: 8n,
  rewardXp: 200n,
  questType: 'boss_kill',
  targetLocationName: 'Furnace Crypt',
  targetItemName: 'Revenant Lord',
});
upsertQuestByName({
  name: 'The Binding Seal',
  npcName: 'Torchbearer Isa',
  requiredCount: 1n,
  minLevel: 4n,
  maxLevel: 8n,
  rewardXp: 150n,
  questType: 'explore',
  targetLocationName: 'Embervault Sanctum',
  targetItemName: 'Ancient Binding Seal',
});

// Keeper Mordane — explore + boss_kill (unlocked via Thessa delivery chain)
upsertQuestByName({
  name: "The Keeper's Ledger",
  npcName: 'Keeper Mordane',
  requiredCount: 1n,
  minLevel: 5n,
  maxLevel: 10n,
  rewardXp: 160n,
  questType: 'explore',
  targetLocationName: 'Bonecinder Gallery',
  targetItemName: "Keeper's Ledger",
});
upsertQuestByName({
  name: 'The Vault Warden',
  npcName: 'Keeper Mordane',
  enemyName: 'Vault Sentinel',
  requiredCount: 1n,
  minLevel: 5n,
  maxLevel: 10n,
  rewardXp: 250n,
  questType: 'boss_kill',
  targetLocationName: 'The Crucible',
  targetItemName: 'Vault Warden',
});
```

2. In `spacetimedb/src/data/dialogue_data.ts`, add 14 new dialogue option entries at the end of the `NPC_DIALOGUE_OPTIONS` array (before the closing `];`). Each dialogue option offers the corresponding quest via its `questTemplateName` field:

```typescript
// === Phase 6: New Quest Dialogue Branches ===

// Marla the Guide — "Old Debts" (delivery) — Acquaintance gate (25)
{
  npcName: 'Marla the Guide',
  optionKey: 'marla_old_debts',
  parentOptionKey: null,
  playerText: 'debts',
  npcResponse: 'I owe Scout Thessa an explanation. Would you carry a sealed letter to her in the Fringe? She is stationed near the Embermarch Gate.',
  requiredAffinity: 25n,
  affinityChange: 5n,
  sortOrder: 5n,
  questTemplateName: 'Old Debts',
  affinityHint: 'Build trust with Marla to learn about her past.',
  isAffinityLocked: true,
},

// Warden Kael — "Stolen Supply Cache" (kill_loot) — Acquaintance gate (25)
{
  npcName: 'Warden Kael',
  optionKey: 'kael_supply_cache',
  parentOptionKey: null,
  playerText: 'supplies',
  npcResponse: 'The wolves have been raiding our supply caches. Kill wolves until you recover our stolen pack. It should still be intact.',
  requiredAffinity: 25n,
  affinityChange: 3n,
  sortOrder: 5n,
  questTemplateName: 'Stolen Supply Cache',
  affinityHint: 'Help Warden Kael with wolf patrols first.',
  isAffinityLocked: true,
},

// Warden Kael — "The Ranger's Cache" (explore) — Friend gate (50)
{
  npcName: 'Warden Kael',
  optionKey: 'kael_rangers_cache',
  parentOptionKey: null,
  playerText: 'cache',
  npcResponse: 'Years ago, I buried emergency supplies in the Bramble Hollow. Search the area carefully — it should still be there.',
  requiredAffinity: 50n,
  affinityChange: 5n,
  sortOrder: 6n,
  questTemplateName: "The Ranger's Cache",
  affinityHint: 'Prove yourself a trusted ally to Warden Kael.',
  isAffinityLocked: true,
},

// Herbalist Venna — "Bogfen Healing Moss" (explore) — Acquaintance gate (25)
{
  npcName: 'Herbalist Venna',
  optionKey: 'venna_healing_moss',
  parentOptionKey: null,
  playerText: 'moss',
  npcResponse: 'A rare healing moss grows deep in Willowfen, but it is hard to spot. Search the marsh carefully and you may find some.',
  requiredAffinity: 25n,
  affinityChange: 3n,
  sortOrder: 5n,
  questTemplateName: 'Bogfen Healing Moss',
  affinityHint: 'Help Herbalist Venna with her research first.',
  isAffinityLocked: true,
},

// Herbalist Venna — "Croaker Bile Glands" (kill_loot) — Friend gate (50)
{
  npcName: 'Herbalist Venna',
  optionKey: 'venna_bile_glands',
  parentOptionKey: null,
  playerText: 'glands',
  npcResponse: 'I need a specific organ from the marsh croakers — a fresh bile gland. Not all of them carry one, so you may need to slay several.',
  requiredAffinity: 50n,
  affinityChange: 5n,
  sortOrder: 6n,
  questTemplateName: 'Croaker Bile Glands',
  affinityHint: 'Deepen your friendship with Herbalist Venna.',
  isAffinityLocked: true,
},

// Scout Thessa — "Enemy Scouting Reports" (explore) — unlocked via receiving Marla's delivery
// This uses parentOptionKey to chain off the delivery completion. The parent is the delivery follow-up dialogue.
{
  npcName: 'Scout Thessa',
  optionKey: 'thessa_scouting_reports',
  parentOptionKey: null,
  playerText: 'scouting',
  npcResponse: 'Since you know Marla... I could use someone to search the Cinderwatch outpost for scouting reports left behind. Be careful — the area is hostile.',
  requiredAffinity: 25n,
  affinityChange: 5n,
  sortOrder: 5n,
  questTemplateName: 'Enemy Scouting Reports',
  affinityHint: 'Deliver Marla\'s letter to Scout Thessa first.',
  isAffinityLocked: true,
},

// Scout Thessa — "The Iron Compact Leak" (delivery) — Friend gate (50)
{
  npcName: 'Scout Thessa',
  optionKey: 'thessa_iron_compact_leak',
  parentOptionKey: null,
  playerText: 'leak',
  npcResponse: 'There is a leak in the Iron Compact supply chain. Take this evidence to Keeper Mordane in Sootveil Hall. He will know what to do.',
  requiredAffinity: 50n,
  affinityChange: 5n,
  sortOrder: 6n,
  questTemplateName: 'The Iron Compact Leak',
  affinityHint: 'Build a strong friendship with Scout Thessa.',
  isAffinityLocked: true,
},

// Ashwalker Ren — "Encryption Key" (kill_loot) — Acquaintance gate (25)
{
  npcName: 'Ashwalker Ren',
  optionKey: 'ren_encryption_key',
  parentOptionKey: null,
  playerText: 'cipher',
  npcResponse: 'The Cinder Sentinels guard cipher key fragments. Destroy them and bring me any fragments you find. The drop rate is low, so be persistent.',
  requiredAffinity: 25n,
  affinityChange: 3n,
  sortOrder: 5n,
  questTemplateName: 'Encryption Key',
  affinityHint: 'Earn Ashwalker Ren\'s trust first.',
  isAffinityLocked: true,
},

// Ashwalker Ren — "The Ashforged Commander" (boss_kill) — Friend gate (50)
{
  npcName: 'Ashwalker Ren',
  optionKey: 'ren_ashforged_commander',
  parentOptionKey: null,
  playerText: 'commander',
  npcResponse: 'An Ashforged Commander has been spotted near the Scoria Flats. Search the area and engage it if you can. It will not go down easily.',
  requiredAffinity: 50n,
  affinityChange: 5n,
  sortOrder: 6n,
  questTemplateName: 'The Ashforged Commander',
  affinityHint: 'Become a close ally of Ashwalker Ren.',
  isAffinityLocked: true,
},

// Torchbearer Isa — "The Revenant Lord" (boss_kill) — Acquaintance gate (25)
{
  npcName: 'Torchbearer Isa',
  optionKey: 'isa_revenant_lord',
  parentOptionKey: null,
  playerText: 'lord',
  npcResponse: 'A revenant lord haunts the Furnace Crypt. Search the depths for it. It only appears to those who look carefully.',
  requiredAffinity: 25n,
  affinityChange: 3n,
  sortOrder: 5n,
  questTemplateName: 'The Revenant Lord',
  affinityHint: 'Prove your mettle to Torchbearer Isa.',
  isAffinityLocked: true,
},

// Torchbearer Isa — "The Binding Seal" (explore) — Friend gate (50)
{
  npcName: 'Torchbearer Isa',
  optionKey: 'isa_binding_seal',
  parentOptionKey: null,
  playerText: 'seal',
  npcResponse: 'Deep in the Embervault Sanctum lies an ancient binding seal. Search for it — but be warned, disturbing it may attract attention.',
  requiredAffinity: 50n,
  affinityChange: 5n,
  sortOrder: 6n,
  questTemplateName: 'The Binding Seal',
  affinityHint: 'Build a strong bond with Torchbearer Isa.',
  isAffinityLocked: true,
},

// Keeper Mordane — "The Keeper's Ledger" (explore) — unlocked via Thessa delivery chain
{
  npcName: 'Keeper Mordane',
  optionKey: 'mordane_keepers_ledger',
  parentOptionKey: null,
  playerText: 'ledger',
  npcResponse: 'Since Scout Thessa trusts you with sensitive matters... There is a ledger hidden in the Bonecinder Gallery. Search for it. The vault\'s secrets must be preserved.',
  requiredAffinity: 25n,
  affinityChange: 5n,
  sortOrder: 5n,
  questTemplateName: "The Keeper's Ledger",
  affinityHint: 'Deliver Thessa\'s evidence to Keeper Mordane first.',
  isAffinityLocked: true,
},

// Keeper Mordane — "The Vault Warden" (boss_kill) — Friend gate (50)
{
  npcName: 'Keeper Mordane',
  optionKey: 'mordane_vault_warden',
  parentOptionKey: null,
  playerText: 'warden',
  npcResponse: 'A Vault Warden patrols The Crucible. It guards the deepest secrets. Search for it and put it down before it finds us.',
  requiredAffinity: 50n,
  affinityChange: 5n,
  sortOrder: 6n,
  questTemplateName: 'The Vault Warden',
  affinityHint: 'Become a trusted friend of Keeper Mordane.',
  isAffinityLocked: true,
},
```

The narrative chain works as follows:
- Player builds affinity with Marla -> sees "debts" dialogue option -> accepts "Old Debts" delivery quest
- Player delivers to Scout Thessa (hailNpc auto-completes) -> affinity boost with Thessa -> sees "scouting" option for explore quest
- Thessa offers "The Iron Compact Leak" delivery at Friend (50) -> player delivers to Keeper Mordane
- Mordane unlock -> player sees "ledger" option for explore quest
- All NPCs also have Friend (50) gated deeper quests (boss_kill, kill_loot, etc.)
  </action>
  <verify>Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` — should compile cleanly. Count the new quest template seeds (should be 14). Count the new dialogue options (should be 14). Verify each dialogue option's `questTemplateName` matches an existing or newly-seeded quest template name.</verify>
  <done>14 new quest templates seeded with correct quest types, target locations, target NPCs, item names, and drop chances. 14 new dialogue options woven into existing NPC dialogue trees with proper affinity gates. Delivery chain Marla -> Scout Thessa -> Keeper Mordane links all 3 regions. Passive search system wired into travel reducer and fires on every location entry.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project spacetimedb/tsconfig.json` compiles cleanly
- `performPassiveSearch` is called in movement.ts moveOne function
- 14 new quest templates in ensureQuestTemplates with diverse quest types
- 14 new dialogue options in NPC_DIALOGUE_OPTIONS with affinity gates
- Each dialogue option's questTemplateName matches a quest template name exactly
- Delivery chain: Old Debts targets Scout Thessa, Iron Compact Leak targets Keeper Mordane
- Boss quests reference correct enemy templates and target locations
- Explore quests reference correct target locations and item names
</verification>

<success_criteria>
- Passive search fires on location entry for every traveling character
- SearchResult rows created with deterministic pseudo-random rolls
- All 14 quest templates seeded correctly with proper types
- Dialogue branches accessible via affinity-gated NPC conversations
- Delivery quest chain connects Marla -> Thessa -> Mordane narratively
- No existing quest data broken (13 original kill quests unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/06-quest-system/06-02-SUMMARY.md`
</output>
