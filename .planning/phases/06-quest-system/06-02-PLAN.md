---
phase: 06-quest-system
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/composables/useGameData.ts
  - src/components/QuestPanel.vue
  - src/App.vue
autonomous: false
must_haves:
  truths:
    - "Quest panel shows available quests tab with faction-gated quests"
    - "Locked quests are visible with standing requirement shown"
    - "Player can accept an available quest via the quest panel"
    - "Active quests tab shows progress toward completion"
    - "Player can complete a quest from the active tab when objectives are met"
    - "Completed quests appear in the quest log tab"
    - "Quest panel correctly filters by selected character's faction standings"
  artifacts:
    - path: "src/components/QuestPanel.vue"
      provides: "Three-tab quest panel (Available, Active, Log)"
      min_lines: 100
    - path: "src/composables/useGameData.ts"
      provides: "factionQuests and playerFactionQuests table subscriptions"
      contains: "factionQuest"
    - path: "src/App.vue"
      provides: "Quest data wiring, accept/complete reducer calls, computed filters"
      contains: "acceptFactionQuest"
  key_links:
    - from: "src/components/QuestPanel.vue"
      to: "src/App.vue"
      via: "emit accept-quest and complete-quest events"
      pattern: "emit.*accept.*quest|emit.*complete.*quest"
    - from: "src/App.vue"
      to: "reducers.acceptFactionQuest"
      via: "useReducer call on accept-quest emit"
      pattern: "acceptFactionQuest"
    - from: "src/App.vue"
      to: "src/composables/useGameData.ts"
      via: "factionQuests and playerFactionQuests destructured"
      pattern: "factionQuests|playerFactionQuests"
---

<objective>
Frontend quest panel UI: replace the existing simple QuestPanel with a full three-tab panel (Available, Active, Log) showing faction-gated quests, accept/complete actions, and quest progress. Wire new table subscriptions and reducer calls in App.vue.

Purpose: Give players the ability to browse, accept, track, and complete faction quests through the UI.
Output: Working quest panel with all three tabs, reducer calls wired, data flowing from server subscriptions.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quest-system/06-RESEARCH.md
@.planning/phases/06-quest-system/06-01-SUMMARY.md
@src/components/QuestPanel.vue
@src/components/RenownPanel.vue
@src/composables/useGameData.ts
@src/App.vue
@src/ui/styles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add table subscriptions and wire quest data in App.vue</name>
  <files>
    src/composables/useGameData.ts
    src/App.vue
  </files>
  <action>
**1. Add new table subscriptions in `src/composables/useGameData.ts`:**

After the existing `questInstances` line (line ~53), add:
```typescript
const [factionQuests] = useTable(tables.factionQuest);
const [playerFactionQuests] = useTable(tables.playerFactionQuest);
```

Add `factionQuests` and `playerFactionQuests` to the return object (in the same alphabetical area as the existing quest-related returns, around line ~120).

**2. Wire quest data and reducers in `src/App.vue`:**

In the destructuring of `useGameData()` (around line ~610-630), add `factionQuests` and `playerFactionQuests` to the destructured list.

Add computed properties after the existing `characterQuests` computed (around line ~1009):

```typescript
// Filter player faction quests to current character
const characterFactionQuests = computed(() => {
  if (!selectedCharacter.value) return [];
  return playerFactionQuests.value.filter(
    (row: any) => row.characterId.toString() === selectedCharacter.value!.id.toString()
  );
});
```

Add `useReducer` calls for the two new reducers (near the other reducer declarations, around line ~1553):

```typescript
const acceptFactionQuestReducer = useReducer(reducers.acceptFactionQuest);
const completeFactionQuestReducer = useReducer(reducers.completeFactionQuest);
```

Add handler functions:

```typescript
const handleAcceptFactionQuest = (factionQuestId: bigint) => {
  if (!selectedCharacter.value || !conn.isActive) return;
  acceptFactionQuestReducer({ characterId: selectedCharacter.value.id, factionQuestId });
};

const handleCompleteFactionQuest = (playerQuestId: bigint) => {
  if (!selectedCharacter.value || !conn.isActive) return;
  completeFactionQuestReducer({ characterId: selectedCharacter.value.id, playerQuestId });
};
```

**3. Update the Quests Panel template in `src/App.vue`:**

Find the existing Quests Panel section (line ~218-222). Replace the QuestPanel component usage with the new props and events:

```html
<QuestPanel
  :styles="styles"
  :quest-instances="characterQuests"
  :quest-templates="questTemplates"
  :npcs="npcs"
  :locations="locations"
  :regions="regions"
  :faction-quests="factionQuests"
  :player-faction-quests="characterFactionQuests"
  :factions="factions"
  :faction-standings="characterFactionStandings"
  :selected-character="selectedCharacter"
  :conn-active="conn.isActive"
  @accept-quest="handleAcceptFactionQuest"
  @complete-quest="handleCompleteFactionQuest"
/>
```
  </action>
  <verify>
TypeScript check: `cd C:/projects/uwr && npx vue-tsc --noEmit` should produce no errors related to QuestPanel, factionQuests, or playerFactionQuests (may have pre-existing unrelated warnings).
  </verify>
  <done>
useGameData exports factionQuests and playerFactionQuests subscriptions. App.vue has computed characterFactionQuests, reducer handlers for accept/complete, and passes all necessary data as props to QuestPanel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rebuild QuestPanel with three-tab layout</name>
  <files>
    src/components/QuestPanel.vue
  </files>
  <action>
Replace the entire `QuestPanel.vue` with a three-tab panel (Available, Active, Log) following the RenownPanel tab pattern.

**Props to accept:**
```typescript
defineProps<{
  styles: Record<string, Record<string, string | number>>;
  questInstances: QuestInstanceRow[];
  questTemplates: QuestTemplateRow[];
  npcs: NpcRow[];
  locations: LocationRow[];
  regions: RegionRow[];
  factionQuests: FactionQuestRow[];
  playerFactionQuests: PlayerFactionQuestRow[];
  factions: FactionRow[];
  factionStandings: FactionStandingRow[];
  selectedCharacter: CharacterRow | null;
  connActive: boolean;
}>();
```

Import types from `'../module_bindings'`. The generated bindings will include `FactionQuestRow`, `PlayerFactionQuestRow`, `FactionRow`, `FactionStandingRow`.

**Emits:**
```typescript
const emit = defineEmits<{
  (e: 'accept-quest', factionQuestId: bigint): void;
  (e: 'complete-quest', playerQuestId: bigint): void;
}>();
```

**Tab state:**
```typescript
const activeTab = ref<'available' | 'active' | 'log'>('available');
```

**FACTION_RANKS constant** (replicate from RenownPanel.vue lines 322-330, same values):
```typescript
const FACTION_RANKS = [
  { name: 'Hostile', min: -Infinity, max: -5001, color: '#c55' },
  { name: 'Unfriendly', min: -5000, max: -1, color: '#c85' },
  { name: 'Neutral', min: 0, max: 999, color: '#aaa' },
  { name: 'Friendly', min: 1000, max: 2999, color: '#8af' },
  { name: 'Honored', min: 3000, max: 5999, color: '#5af' },
  { name: 'Revered', min: 6000, max: 8999, color: '#a5f' },
  { name: 'Exalted', min: 9000, max: Infinity, color: '#fa5' },
];
```

**Computed properties:**

`availableQuests` — All faction quests with metadata about whether the player meets the standing requirement and their current status:
```typescript
const availableQuests = computed(() => {
  if (!props.selectedCharacter) return [];
  return props.factionQuests.map(quest => {
    const faction = props.factions.find(f => f.id.toString() === quest.factionId.toString());
    const standing = props.factionStandings.find(s => s.factionId.toString() === quest.factionId.toString());
    const currentStanding = Number(standing?.standing ?? 0n);
    const requiredStanding = Number(quest.requiredStanding);
    const meetsStanding = currentStanding >= requiredStanding;
    const playerQuest = props.playerFactionQuests.find(
      pq => pq.factionQuestId.toString() === quest.id.toString()
    );
    const status = playerQuest?.status ?? null;
    const requiredRank = FACTION_RANKS.find(r => r.min <= requiredStanding && requiredStanding <= r.max);
    return {
      quest,
      factionName: faction?.name ?? 'Unknown',
      factionColor: requiredRank?.color ?? '#aaa',
      meetsStanding,
      requiredRankName: requiredRank?.name ?? 'Unknown',
      currentStanding,
      requiredStanding,
      status,
      isAccepted: status === 'active',
      isCompleted: status === 'completed',
    };
  });
});
```

`activeQuests` — Player's active faction quests with quest template details:
```typescript
const activeQuests = computed(() => {
  return props.playerFactionQuests
    .filter(pq => pq.status === 'active')
    .map(pq => {
      const quest = props.factionQuests.find(q => q.id.toString() === pq.factionQuestId.toString());
      const faction = quest ? props.factions.find(f => f.id.toString() === quest.factionId.toString()) : null;
      return {
        playerQuest: pq,
        quest,
        factionName: faction?.name ?? 'Unknown',
        isComplete: quest?.questType === 'kill'
          ? pq.progress >= (quest?.requiredCount ?? 0n)
          : quest?.questType === 'travel'
            ? props.selectedCharacter?.locationId?.toString() === quest?.targetLocationId?.toString()
            : false,
      };
    });
});
```

`completedQuests` — Player's completed faction quests:
```typescript
const completedQuests = computed(() => {
  return props.playerFactionQuests
    .filter(pq => pq.status === 'completed')
    .map(pq => {
      const quest = props.factionQuests.find(q => q.id.toString() === pq.factionQuestId.toString());
      const faction = quest ? props.factions.find(f => f.id.toString() === quest.factionId.toString()) : null;
      return { playerQuest: pq, quest, factionName: faction?.name ?? 'Unknown' };
    });
});
```

Also compute NPC quests for the Active tab (existing NPC kill quests from QuestInstance):
```typescript
const npcQuestRows = computed(() => {
  return props.questInstances.map(instance => {
    const template = props.questTemplates.find(t => t.id.toString() === instance.questTemplateId.toString());
    const npc = template ? props.npcs.find(n => n.id.toString() === template.npcId.toString()) : null;
    return {
      id: instance.id,
      name: template?.name ?? 'Unknown Quest',
      giver: npc?.name ?? 'Unknown',
      progress: instance.progress,
      requiredCount: template?.requiredCount ?? 0n,
      completed: instance.completed,
    };
  });
});
```

**Template structure:**

Tab bar using RenownPanel pattern (3 buttons with `actionButton`/`actionButtonActive` styling).

**Available Tab:**
- Show message "Select a character." if no selectedCharacter
- List all faction quests grouped or listed with:
  - Quest name (bold, white text)
  - Faction name (colored by faction rank color)
  - Description (subtle gray, `styles.subtleSmall`)
  - If `meetsStanding && !isAccepted && !isCompleted`: Show "Accept" button (`styles.actionButton` with green-ish background `#4a7`). On click: `emit('accept-quest', quest.quest.id)`
  - If `isAccepted`: Show "In Progress" label in amber color
  - If `isCompleted`: Show "Completed" label in green
  - If `!meetsStanding`: Show "Requires [requiredRankName] with [factionName]" in the rank color, with dimmed opacity (0.5)
- Sort: available (meetsStanding, not accepted/completed) first, then locked quests

**Active Tab:**
- Section header "Faction Quests" (if any active faction quests)
- Each active faction quest shows:
  - Quest name (bold)
  - Faction name in subtle text
  - Description (`quest.description`)
  - For kill quests: Progress bar showing `progress/requiredCount` (use `styles.subtle` for text, create inline div bar similar to RenownPanel progress bar pattern — dark `#333` container, colored `#8af` inner bar)
  - For travel quests: "Travel to [location name]" with checkmark if at location
  - If `isComplete`: Show "Complete Quest" button (`styles.actionButton` with gold-ish `#fa5` background). On click: `emit('complete-quest', playerQuest.playerQuest.id)`
- Section header "NPC Quests" (if any npcQuestRows)
- Each NPC quest shows same format as the original QuestPanel (name, giver, progress)

**Log Tab:**
- Show completed faction quests with quest name, faction name, and completion timestamp
- Use `completedAt` field formatted via `new Date(Number(pq.completedAt.microsSinceUnixEpoch / 1000n)).toLocaleDateString()`
- If no completed quests: "No quests completed yet."

**Styling notes:**
- Use existing `styles.panelBody`, `styles.rosterList`, `styles.rosterClickable`, `styles.actionButton`, `styles.actionButtonActive`, `styles.subtle`, `styles.subtleSmall` from the shared styles object
- Progress bars: inline style with `background: '#333'`, `borderRadius: '3px'`, `height: '6px'`, inner div with `background: '#8af'` and `width: percentage + '%'`
- Quest entries: use padding `6px 8px`, border-bottom `1px solid #333` for visual separation
- Locked quests: `opacity: 0.5` on the entire entry div
  </action>
  <verify>
1. `cd C:/projects/uwr && npx vue-tsc --noEmit` — no new type errors in QuestPanel
2. Open the app in browser, select a character, open Quests panel from ActionBar
3. Available tab shows 8 faction quests — some available (Accept button), some locked (standing requirement shown)
4. Click Accept on an available quest — quest moves to Active tab with progress 0/N
5. Active tab shows the accepted quest with description and progress bar
  </verify>
  <done>
QuestPanel has three tabs (Available, Active, Log). Available tab shows all 8 faction quests with standing gates. Active tab shows accepted quests with progress and complete button. Log tab shows completed quests. Existing NPC quests still visible in Active tab.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete faction quest system: 8 faction-gated quests, accept/complete flow with rewards, kill-based progress tracking, three-tab quest panel UI.
  </what-built>
  <how-to-verify>
1. Open the game in browser, select a character
2. Open Quests panel from ActionBar
3. **Available Tab:** Verify 8 quests are shown. Quests with 0 standing requirement should have an "Accept" button. Quests requiring Friendly (1000) or Honored (3000) should show as locked with the standing requirement displayed (unless your character already has enough standing)
4. **Accept a quest:** Click Accept on "The Lost Shipment" (Iron Compact, Neutral). Verify it moves to Active tab with progress 0/5
5. **Kill progress:** Go to a location with Bandits. Kill bandits. After each kill, check the quest progress increments in the Active tab (and a log message appears)
6. **Complete a quest:** After reaching 5/5, the "Complete Quest" button should appear. Click it. Verify:
   - XP and gold rewards granted (check character stats)
   - Faction standing increased (check Renown panel, Iron Compact standing)
   - Rival faction standing decreased
   - Quest moves to Log tab with completion date
7. **Standing gate test:** If you have a character with 0 Iron Compact standing, verify "Clearing the Route" (requires Friendly/1000) shows as locked and cannot be accepted
8. **Duplicate prevention:** Try accepting a quest you already have active — should not create a duplicate. Try accepting a completed quest — should not allow re-acceptance
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Quest panel opens from ActionBar toggle
2. Available tab shows faction-gated quests with correct lock/unlock state
3. Accept flow creates PlayerFactionQuest row visible in Active tab
4. Kill progress increments correctly for accepted kill quests
5. Complete flow grants XP, gold, faction standing rewards
6. Rival faction penalty applied on completion
7. Completed quests visible in Log tab
8. NPC quests still visible in Active tab (existing functionality preserved)
</verification>

<success_criteria>
- Quest panel shows 3 tabs (Available, Active, Log) with correct data
- Locked quests visible with standing requirement shown
- Accepting a quest creates PlayerFactionQuest row
- Kill-based progress tracking works and displays in UI
- Completing a quest grants XP, gold, and faction standing
- Rival faction standing penalized on completion
- Existing NPC quest display preserved
- Human verifies end-to-end flow
</success_criteria>

<output>
After completion, create `.planning/phases/06-quest-system/06-02-SUMMARY.md`
</output>
