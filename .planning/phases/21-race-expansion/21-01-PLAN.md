---
phase: 21-race-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/data/races.ts
  - spacetimedb/src/reducers/characters.ts
  - spacetimedb/src/helpers/character.ts
autonomous: true
requirements:
  - RACE-EXP-01
  - RACE-EXP-02
  - RACE-EXP-04
  - RACE-EXP-05

must_haves:
  truths:
    - "All 15 races exist in the Race table after publish and /synccontent"
    - "4 locked races (Dark-Elf, Half-Giant, Cyclops, Satyr) are seeded with unlocked=false in the Race table"
    - "A newly created character receives both racial bonuses from their chosen race"
    - "Non-stat bonuses (spell damage, phys damage, max HP, max mana, armor, crit, dodge, regen) are applied at character creation"
    - "recomputeCharacterDerived incorporates racial bonus columns into derived stats"
  artifacts:
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "Race table with bonus1Type/bonus1Value/bonus2Type/bonus2Value; Character table with 7 optional racial bonus columns"
      contains: "bonus1Type"
    - path: "spacetimedb/src/data/races.ts"
      provides: "RACE_DATA array with 15 race entries in new schema"
      contains: "Dark-Elf"
    - path: "spacetimedb/src/reducers/characters.ts"
      provides: "create_character reducer applying both racial bonuses at creation"
      exports: []
    - path: "spacetimedb/src/helpers/character.ts"
      provides: "recomputeCharacterDerived reading racial bonus columns"
  key_links:
    - from: "spacetimedb/src/data/races.ts"
      to: "spacetimedb/src/schema/tables.ts"
      via: "RACE_DATA shape must match Race table column types"
      pattern: "bonus1Type.*bonus1Value.*bonus2Type.*bonus2Value"
    - from: "spacetimedb/src/reducers/characters.ts"
      to: "spacetimedb/src/helpers/character.ts"
      via: "create_character calls recomputeCharacterDerived after insert"
      pattern: "recomputeCharacterDerived"
---

<objective>
Migrate the Race table schema from 5 stat-bonus columns to the 4-column flexible bonus system, expand RACE_DATA to 15 races, add optional racial bonus columns to the Character table, and wire racial bonuses into character creation and derived-stat recomputation.

Purpose: This is the schema foundation for all Phase 21 requirements. Without it the executor cannot do level-up fixes or UI updates.
Output: Published module with new Race schema, 15 seeded races, create_character applying dual bonuses, recomputeCharacterDerived incorporating racial contributions.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-race-expansion/21-CONTEXT.md
@.planning/phases/21-race-expansion/21-RESEARCH.md
@spacetimedb/src/schema/tables.ts
@spacetimedb/src/data/races.ts
@spacetimedb/src/reducers/characters.ts
@spacetimedb/src/helpers/character.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Race table schema and add Character racial bonus columns</name>
  <files>spacetimedb/src/schema/tables.ts</files>
  <action>
In `spacetimedb/src/schema/tables.ts`:

**1. Replace the Race table definition (currently lines ~1272-1286):**

Replace the 5 old stat columns (`strBonus`, `dexBonus`, `chaBonus`, `wisBonus`, `intBonus`) with 4 new flexible bonus columns:

```typescript
export const Race = table(
  { name: 'race', public: true },
  {
    id: t.u64().primaryKey().autoInc(),
    name: t.string(),
    description: t.string(),
    availableClasses: t.string(),
    bonus1Type: t.string(),
    bonus1Value: t.u64(),
    bonus2Type: t.string(),
    bonus2Value: t.u64(),
    unlocked: t.bool(),
  }
);
```

**2. Add 7 optional racial bonus columns to the Character table** (after the `combatTargetEnemyId` field, before the closing brace):

```typescript
    racialSpellDamage: t.u64().optional(),
    racialPhysDamage: t.u64().optional(),
    racialMaxHp: t.u64().optional(),
    racialMaxMana: t.u64().optional(),
    racialManaRegen: t.u64().optional(),
    racialStaminaRegen: t.u64().optional(),
    racialCritBonus: t.u64().optional(),
    racialArmorBonus: t.u64().optional(),
    racialDodgeBonus: t.u64().optional(),
```

Why optional: optional columns can be added with a plain `spacetime publish` in future. For this publish we need `--clear-database` anyway for the Race table schema change, but making them optional is the correct pattern for Character table additions.

Bonus type string key reference:
- `'stat_str'` → character.str
- `'stat_dex'` → character.dex
- `'stat_int'` → character.int
- `'stat_wis'` → character.wis
- `'stat_cha'` → character.cha
- `'spell_damage'` → character.racialSpellDamage
- `'phys_damage'` → character.racialPhysDamage
- `'max_hp'` → character.racialMaxHp
- `'max_mana'` → character.racialMaxMana
- `'mana_regen'` → character.racialManaRegen
- `'stamina_regen'` → character.racialStaminaRegen
- `'crit_chance'` → character.racialCritBonus
- `'armor'` → character.racialArmorBonus
- `'dodge'` → character.racialDodgeBonus
  </action>
  <verify>TypeScript compiles without errors: `cd spacetimedb && npx tsc --noEmit 2>&1 | head -30`</verify>
  <done>Race table has bonus1Type/bonus1Value/bonus2Type/bonus2Value columns. Character table has 9 optional racial bonus columns. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Expand RACE_DATA to 15 races with new schema</name>
  <files>spacetimedb/src/data/races.ts</files>
  <action>
Replace the entire contents of `spacetimedb/src/data/races.ts` with the new structure. The type changes from 5 stat fields to bonus1Type/bonus1Value/bonus2Type/bonus2Value.

**New RACE_DATA array (15 races):**

Starter races (4, all unlocked) — updated to dual-bonus system:
- Human: bonus1Type='stat_cha', bonus1Value=1n, bonus2Type='stamina_regen', bonus2Value=1n, availableClasses='' (all classes)
- Eldrin: bonus1Type='spell_damage', bonus1Value=2n, bonus2Type='max_mana', bonus2Value=10n, availableClasses='bard,enchanter,cleric,wizard,necromancer,spellblade,shaman,druid,reaver,summoner,paladin,ranger'
- Ironclad: bonus1Type='phys_damage', bonus1Value=2n, bonus2Type='armor', bonus2Value=1n, availableClasses='warrior,paladin,monk,beastmaster,spellblade,ranger,shaman'
- Wyldfang: bonus1Type='crit_chance', bonus1Value=5n, bonus2Type='stat_dex', bonus2Value=1n, availableClasses='rogue,ranger,monk,beastmaster,druid,shaman'

New unlocked races (7):
- Goblin: bonus1Type='spell_damage', bonus1Value=1n, bonus2Type='mana_regen', bonus2Value=1n, availableClasses='', unlocked=true, description='Cunning and quick-witted, goblins have a natural affinity for mana manipulation.'
- Troll: bonus1Type='max_hp', bonus1Value=15n, bonus2Type='phys_damage', bonus2Value=1n, availableClasses='', unlocked=true, description='Hulking and resilient, trolls endure punishment that would fell lesser beings.'
- Dwarf: bonus1Type='max_hp', bonus1Value=10n, bonus2Type='phys_damage', bonus2Value=2n, availableClasses='', unlocked=true, description='Stout and unyielding, dwarves hit harder than their stature suggests.'
- Gnome: bonus1Type='mana_regen', bonus1Value=2n, bonus2Type='max_mana', bonus2Value=15n, availableClasses='', unlocked=true, description='Inventive tinkerers with deep reserves of arcane energy and quick mental recovery.'
- Halfling: bonus1Type='crit_chance', bonus1Value=8n, bonus2Type='dodge', bonus2Value=8n, availableClasses='', unlocked=true, description='Nimble and surprisingly lucky, halflings dodge blows others never see coming.'
- Half-Elf: bonus1Type='stat_str', bonus1Value=1n, bonus2Type='stat_int', bonus2Value=1n, availableClasses='', unlocked=true, description='Bridging two worlds, half-elves excel through sheer versatility.'
- Orc: bonus1Type='phys_damage', bonus1Value=3n, bonus2Type='max_hp', bonus2Value=8n, availableClasses='', unlocked=true, description='Savage and strong, orcs deliver punishing blows while shrugging off wounds.'

New locked races (4):
- Dark-Elf: bonus1Type='spell_damage', bonus1Value=3n, bonus2Type='mana_regen', bonus2Value=1n, availableClasses='', unlocked=false, description='Graceful and sinister, dark elves wield shadow-touched magic with lethal precision.'
- Half-Giant: bonus1Type='max_hp', bonus1Value=20n, bonus2Type='phys_damage', bonus2Value=2n, availableClasses='', unlocked=false, description='Towering and immovable, half-giants absorb punishment that shatters entire warbands.'
- Cyclops: bonus1Type='phys_damage', bonus1Value=4n, bonus2Type='armor', bonus2Value=2n, availableClasses='', unlocked=false, description='Singular-minded and brutally strong, cyclops warriors are living siege weapons.'
- Satyr: bonus1Type='spell_damage', bonus1Value=2n, bonus2Type='stamina_regen', bonus2Value=2n, availableClasses='', unlocked=false, description='Wild and mercurial, satyrs channel primal magic through relentless motion.'

**Value notes:**
- crit_chance values (5n for Wyldfang, 8n for Halfling) are in the same unit as `critMelee = dex * 12n`. At dex=10, base crit=120 (1.2%). Adding 8n brings it to 128 (1.28%) — flavor-level bonus as intended.
- dodge values (8n for Halfling) similarly tiny relative to base dodgeChance = dex * 12n.

**`ensureRaces` function:** Keep the function body identical — it does a name-based upsert spreading all data fields. Only the RACE_DATA array type changes.
  </action>
  <verify>TypeScript compiles without errors: `cd spacetimedb && npx tsc --noEmit 2>&1 | head -30`</verify>
  <done>RACE_DATA has 15 entries. 4 locked races have unlocked=false. All entries use bonus1Type/bonus1Value/bonus2Type/bonus2Value. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 3: Update create_character, recomputeCharacterDerived, publish, and regenerate bindings</name>
  <files>
    spacetimedb/src/reducers/characters.ts
    spacetimedb/src/helpers/character.ts
  </files>
  <action>
**A. Add `applyRacialBonuses` helper at the top of `spacetimedb/src/reducers/characters.ts`** (or in a shared helpers location if preferred — but keeping it in characters.ts is simplest). This helper takes a race row and a stacking multiplier and returns all bonus contributions:

```typescript
// Compute racial bonus contributions from a race row.
// multiplier = 1n for initial application at level 1
// For even-level stacking, awardXp computes and passes the full accumulated value.
function computeRacialContributions(raceRow: any, multiplier: bigint = 1n) {
  const result = {
    str: 0n, dex: 0n, int: 0n, wis: 0n, cha: 0n,
    racialSpellDamage: 0n, racialPhysDamage: 0n,
    racialMaxHp: 0n, racialMaxMana: 0n,
    racialManaRegen: 0n, racialStaminaRegen: 0n,
    racialCritBonus: 0n, racialArmorBonus: 0n, racialDodgeBonus: 0n,
  };

  function applyBonus(bonusType: string, bonusValue: bigint) {
    const v = bonusValue * multiplier;
    switch (bonusType) {
      case 'stat_str': result.str += v; break;
      case 'stat_dex': result.dex += v; break;
      case 'stat_int': result.int += v; break;
      case 'stat_wis': result.wis += v; break;
      case 'stat_cha': result.cha += v; break;
      case 'spell_damage': result.racialSpellDamage += v; break;
      case 'phys_damage': result.racialPhysDamage += v; break;
      case 'max_hp': result.racialMaxHp += v; break;
      case 'max_mana': result.racialMaxMana += v; break;
      case 'mana_regen': result.racialManaRegen += v; break;
      case 'stamina_regen': result.racialStaminaRegen += v; break;
      case 'crit_chance': result.racialCritBonus += v; break;
      case 'armor': result.racialArmorBonus += v; break;
      case 'dodge': result.racialDodgeBonus += v; break;
    }
  }

  applyBonus(raceRow.bonus1Type, raceRow.bonus1Value);
  applyBonus(raceRow.bonus2Type, raceRow.bonus2Value);
  return result;
}
```

**B. Update `create_character` in `spacetimedb/src/reducers/characters.ts`:**

Replace the old stat bonus block:
```typescript
// OLD (remove):
const baseStats = {
  str: classStats.str + raceRow.strBonus,
  dex: classStats.dex + raceRow.dexBonus,
  cha: classStats.cha + raceRow.chaBonus,
  wis: classStats.wis + raceRow.wisBonus,
  int: classStats.int + raceRow.intBonus,
};
```

With:
```typescript
// NEW:
const racial = computeRacialContributions(raceRow, 1n);
const baseStats = {
  str: classStats.str + racial.str,
  dex: classStats.dex + racial.dex,
  cha: classStats.cha + racial.cha,
  wis: classStats.wis + racial.wis,
  int: classStats.int + racial.int,
};
```

Then update the `character.insert` call to include the 9 new optional racial bonus fields:
```typescript
const character = ctx.db.character.insert({
  // ... all existing fields unchanged ...
  racialSpellDamage: racial.racialSpellDamage || undefined,
  racialPhysDamage: racial.racialPhysDamage || undefined,
  racialMaxHp: racial.racialMaxHp || undefined,
  racialMaxMana: racial.racialMaxMana || undefined,
  racialManaRegen: racial.racialManaRegen || undefined,
  racialStaminaRegen: racial.racialStaminaRegen || undefined,
  racialCritBonus: racial.racialCritBonus || undefined,
  racialArmorBonus: racial.racialArmorBonus || undefined,
  racialDodgeBonus: racial.racialDodgeBonus || undefined,
});
```

Also update maxHp and maxMana to include racial contributions at creation:
```typescript
const maxHp = BASE_HP + baseStats.str * HP_STR_MULTIPLIER + (racial.racialMaxHp || 0n);
const maxMana = usesMana(className) ? BASE_MANA + manaStat * 6n + (racial.racialMaxMana || 0n) : 0n;
const armorClass = baseArmorForClass(className) + (racial.racialArmorBonus || 0n);
```

And update derived stats inline at insert:
```typescript
hitChance: baseStats.dex * 15n,
dodgeChance: baseStats.dex * 12n + (racial.racialDodgeBonus || 0n),
parryChance: baseStats.dex * 10n,
critMelee: baseStats.dex * 12n + (racial.racialCritBonus || 0n),
critRanged: baseStats.dex * 12n + (racial.racialCritBonus || 0n),
critDivine: baseStats.wis * 12n,
critArcane: baseStats.int * 12n,
armorClass,
```

**C. Update `recomputeCharacterDerived` in `spacetimedb/src/helpers/character.ts`:**

Add racial contributions to all derived stat computations. Add after the gear/effect totaling block (after `const totalStats = {...}`):

```typescript
// Read racial bonus columns (optional — default to 0n if not set)
const racialMaxHp = character.racialMaxHp ?? 0n;
const racialMaxMana = character.racialMaxMana ?? 0n;
const racialCritBonus = character.racialCritBonus ?? 0n;
const racialArmorBonus = character.racialArmorBonus ?? 0n;
const racialDodgeBonus = character.racialDodgeBonus ?? 0n;
```

Then update the computed values:
```typescript
const maxHp = BASE_HP + totalStats.str * HP_STR_MULTIPLIER + gear.hpBonus + racialMaxHp;
const maxMana = usesMana(character.className)
  ? BASE_MANA + manaStat * 6n + gear.manaBonus + racialMaxMana
  : 0n;

const dodgeChance = totalStats.dex * 12n + racialDodgeBonus;
const critMelee = totalStats.dex * 12n + racialCritBonus;
const critRanged = totalStats.dex * 12n + racialCritBonus;
const armorClass = baseArmorForClass(character.className) + gear.armorClassBonus + acBonus + racialArmorBonus;
```

Note: racialSpellDamage and racialPhysDamage are NOT applied in recomputeCharacterDerived — they live on the Character row and are read by the combat ability execution path. Plan 02 Task 3 wires racialSpellDamage/racialPhysDamage into executeAbility. racialManaRegen and racialStaminaRegen are read directly in the regen_health path (Plan 02 Task 2 handles this).

**D. Publish and regenerate bindings:**

```bash
# Determine the module name from spacetime server list or existing config
# Check what module name is in use:
spacetime server list
# Then publish with --clear-database (wipes all data; world re-seeds via syncAllContent on next client connect):
spacetime publish <module-name> --clear-database -y --project-path spacetimedb
# Regenerate TypeScript client bindings:
spacetime generate --lang typescript --out-dir src/module_bindings --project-path spacetimedb
```

The module name can be found by running `spacetime server list` or checking existing publish scripts/config in the project. After `--clear-database`, the world re-seeds automatically when the next client connects (syncAllContent is called in clientConnected).
  </action>
  <verify>
1. `cd spacetimedb && npx tsc --noEmit` — no errors
2. `spacetime logs <module-name>` shows no panic or error on startup
3. `spacetime sql <module-name> "SELECT COUNT(*) FROM race"` returns 15
4. `spacetime sql <module-name> "SELECT name, unlocked FROM race WHERE unlocked = false"` returns Dark-Elf, Half-Giant, Cyclops, Satyr
5. Module bindings in `src/module_bindings/` contain `bonus1Type` field on Race type (not `strBonus`)
  </verify>
  <done>Module published with new schema. 15 races in Race table. 4 locked. Character insert includes all 9 optional racial bonus fields. recomputeCharacterDerived uses racial columns for maxHp, maxMana, crit, armor, dodge. Client bindings regenerated showing new Race field names.</done>
</task>

</tasks>

<verification>
- Race table has 4 new columns (bonus1Type, bonus1Value, bonus2Type, bonus2Value); old 5 stat columns removed
- Character table has 9 new optional racial bonus columns
- RACE_DATA has 15 entries with correct structure
- 4 locked races have unlocked=false in the seeded data
- create_character applies both racial bonus slots
- recomputeCharacterDerived incorporates racialMaxHp, racialMaxMana, racialCritBonus, racialArmorBonus, racialDodgeBonus
- Module published clean (no panic in logs)
- Client bindings regenerated with new Race schema
</verification>

<success_criteria>
- `spacetime sql <module> "SELECT COUNT(*) FROM race"` = 15
- `spacetime sql <module> "SELECT name FROM race WHERE unlocked = false"` = Dark-Elf, Half-Giant, Cyclops, Satyr
- Creating an Eldrin character: character row has racialSpellDamage=2, racialMaxMana=10
- Creating an Ironclad character: character row has racialPhysDamage=2, racialArmorBonus=1, armorClass includes the +1
- Client bindings no longer reference strBonus/dexBonus fields on Race type
</success_criteria>

<output>
After completion, create `.planning/phases/21-race-expansion/21-01-SUMMARY.md` using the summary template.
</output>
