---
phase: 12-overall-renown-system
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/components/RenownPanel.vue
  - src/composables/useGameData.ts
  - src/App.vue
autonomous: false

must_haves:
  truths:
    - "Renown panel shows current rank name, renown points, and progress bar to next rank"
    - "Renown panel displays perk selection UI when character has unspent perk choice"
    - "Choosing a perk calls choose_perk reducer and updates display without page reload"
    - "Renown panel shows list of all chosen perks"
    - "Renown panel has a Leaderboard tab showing server-first achievements"
    - "Faction standings are still visible in the Renown panel (existing functionality preserved)"
    - "Rank-up notification appears as dismissible overlay when rank increases"
    - "ActionBar Renown button opens the panel (existing wiring preserved)"
  artifacts:
    - path: "src/components/RenownPanel.vue"
      provides: "Tabbed Renown panel: Faction Standings tab, Overall Renown tab, Leaderboard tab"
      min_lines: 100
    - path: "src/composables/useGameData.ts"
      provides: "useTable subscriptions for renown, renownPerk, renownServerFirst, achievement tables"
      contains: "renown"
    - path: "src/App.vue"
      provides: "Renown data props passed to RenownPanel, rank-up notification overlay"
      contains: "renownRows"
  key_links:
    - from: "src/App.vue"
      to: "src/components/RenownPanel.vue"
      via: "props binding for renown data"
      pattern: ":renown-rows"
    - from: "src/components/RenownPanel.vue"
      to: "src/App.vue"
      via: "choosePerk emit calls conn.reducers.choosePerk"
      pattern: "choosePerk"
    - from: "src/composables/useGameData.ts"
      to: "src/module_bindings"
      via: "useTable(tables.renown)"
      pattern: "useTable.*tables\\.renown"
---

<objective>
Build the complete Renown UI: transform the existing RenownPanel into a tabbed interface with Faction Standings (preserved), Overall Renown progression, and Leaderboard. Add rank-up notification overlay and wire all new table subscriptions.

Purpose: Surfaces the entire renown system to players — rank progression visualization, perk selection, chosen perks display, server-first leaderboard, and rank-up celebrations. This completes the Phase 12 user-facing experience.

Output: Tabbed RenownPanel component, useGameData subscriptions for renown tables, App.vue wiring with rank-up notification, human-verified functionality.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-overall-renown-system-character-wide-renown-separate-from-factions-renown-ranks-with-unlockable-perks-renown-gain-sources-from-events-bosses-achievements/12-01-SUMMARY.md
@.planning/phases/12-overall-renown-system-character-wide-renown-separate-from-factions-renown-ranks-with-unlockable-perks-renown-gain-sources-from-events-bosses-achievements/12-02-SUMMARY.md
@src/components/RenownPanel.vue
@src/composables/useGameData.ts
@src/App.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add renown table subscriptions and wire renown data through App.vue</name>
  <files>
    src/composables/useGameData.ts
    src/App.vue
  </files>
  <action>
**In `src/composables/useGameData.ts`:**

Add four new useTable subscriptions for the renown system tables:

```typescript
const [renownRows] = useTable(tables.renown);
const [renownPerks] = useTable(tables.renownPerk);
const [renownServerFirsts] = useTable(tables.renownServerFirst);
const [achievements] = useTable(tables.achievement);
```

Add all four to the return object:
```typescript
return {
  // ... existing ...
  renownRows,
  renownPerks,
  renownServerFirsts,
  achievements,
};
```

**In `src/App.vue`:**

1. **Destructure new data** from useGameData in the setup section alongside existing destructuring:
   ```typescript
   const { renownRows, renownPerks, renownServerFirsts, achievements, ... } = useGameData();
   ```

2. **Add computed properties** for the selected character's renown data:
   ```typescript
   const characterRenown = computed(() => {
     if (!selectedCharacter.value) return null;
     return renownRows.value.find(r => r.characterId.toString() === selectedCharacter.value.id.toString()) ?? null;
   });

   const characterRenownPerks = computed(() => {
     if (!selectedCharacter.value) return [];
     return renownPerks.value.filter(p => p.characterId.toString() === selectedCharacter.value.id.toString());
   });
   ```

3. **Add rank-up notification state:**
   ```typescript
   const rankUpNotification = ref<{ rankName: string } | null>(null);
   ```

4. **Add watcher for rank-up detection:**
   Watch `characterRenown.value?.currentRank` — when it changes to a higher value, look up the rank name from RENOWN_RANKS (import from data file or define client-side constant) and set `rankUpNotification`. The RENOWN_RANKS data should be duplicated as a client-side constant (not imported from the server module) — create a small constant array inline or in a shared utils file:

   ```typescript
   const RENOWN_RANKS_CLIENT = [
     { rank: 1, name: 'Unsung' }, { rank: 2, name: 'Whispered' }, { rank: 3, name: 'Recognized' },
     { rank: 4, name: 'Proven' }, { rank: 5, name: 'Stalwart' }, { rank: 6, name: 'Vanguard' },
     { rank: 7, name: 'Champion' }, { rank: 8, name: 'Paragon' }, { rank: 9, name: 'Exemplar' },
     { rank: 10, name: 'Hero' }, { rank: 11, name: 'Exalted' }, { rank: 12, name: 'Ascendant' },
     { rank: 13, name: 'Legend' }, { rank: 14, name: 'Mythic' }, { rank: 15, name: 'Eternal' },
   ];
   ```

   Watcher:
   ```typescript
   let lastRenownRank = 0;
   watch(characterRenown, (newVal, oldVal) => {
     if (!newVal) { lastRenownRank = 0; return; }
     const newRank = Number(newVal.currentRank);
     if (newRank > lastRenownRank && lastRenownRank > 0) {
       const rankInfo = RENOWN_RANKS_CLIENT.find(r => r.rank === newRank);
       rankUpNotification.value = { rankName: rankInfo?.name ?? `Rank ${newRank}` };
     }
     lastRenownRank = newRank;
   });
   ```

5. **Add rank-up notification overlay** in the template, similar to the existing death modal pattern (find the death modal in App.vue template and follow its style). Place it as a sibling overlay:

   ```html
   <div v-if="rankUpNotification" :style="{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', zIndex: 9999, display: 'flex', alignItems: 'center', justifyContent: 'center' }">
     <div :style="{ background: '#1a1a2e', border: '2px solid #fa5', borderRadius: '12px', padding: '32px 48px', textAlign: 'center', maxWidth: '400px' }">
       <div :style="{ color: '#fa5', fontSize: '1.5rem', fontWeight: 700, marginBottom: '8px' }">Rank Up!</div>
       <div :style="{ color: '#fff', fontSize: '1.2rem', marginBottom: '16px' }">{{ rankUpNotification.rankName }}</div>
       <div :style="{ color: '#aaa', fontSize: '0.85rem', marginBottom: '16px' }">Choose a perk from the Renown panel</div>
       <button :style="{ ...styles.actionButton, padding: '8px 24px', fontSize: '0.9rem' }" @click="rankUpNotification = null">Continue</button>
     </div>
   </div>
   ```

6. **Pass new props to RenownPanel** in the template. Find the existing RenownPanel render block (around line 229) and update it to pass additional props:
   ```html
   <RenownPanel
     :styles="styles"
     :factions="factions"
     :faction-standings="characterFactionStandings"
     :selected-character="selectedCharacter"
     :renown-data="characterRenown"
     :renown-perks="characterRenownPerks"
     :server-firsts="renownServerFirsts"
     :conn-active="!!connActive"
     @choose-perk="handleChoosePerk"
   />
   ```

7. **Add handleChoosePerk method:**
   ```typescript
   const handleChoosePerk = (perkKey: string) => {
     if (!selectedCharacter.value || !window.__db_conn) return;
     window.__db_conn.reducers.choosePerk({
       characterId: selectedCharacter.value.id,
       perkKey,
     });
   };
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify the client compiles. Check that the new useTable calls reference valid table names from module_bindings.
  </verify>
  <done>
    useGameData subscribes to all four renown tables. App.vue computes character-specific renown data, passes it to RenownPanel, handles perk selection via reducer call, and shows rank-up notification overlay on rank increases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Overhaul RenownPanel with tabs for Factions, Renown, and Leaderboard</name>
  <files>
    src/components/RenownPanel.vue
  </files>
  <action>
Completely rewrite RenownPanel.vue as a tabbed interface with three tabs:

**Tab 1: "Factions"** — Preserve the existing faction standing display exactly as it is today (faction rows with rank, progress bar, next rank info). This is the current RenownPanel content.

**Tab 2: "Renown"** — Overall renown progression:
- Current rank display: rank name (large), rank number, total points
- Progress bar from current rank threshold to next rank threshold (linear, styled similar to faction progress bars but with a gold/amber gradient: `linear-gradient(90deg, #fa5, #fc5)`)
- Next rank name and threshold shown below progress bar
- If max rank, show "Maximum rank achieved!"
- **Perk Selection Section** (visible only when character has an unspent perk choice — determine by checking if any RenownPerk row exists for current rank):
  - Header: "Choose a Perk for {RankName}"
  - Grid/list of 2-3 perk options as clickable cards
  - Each card shows: perk name (bold), type badge ("Passive" in blue, "Active" in amber), description, effect summary
  - Clicking a card emits `choose-perk` event with perkKey
  - Style cards with hover highlight and border to indicate clickability
- **Your Perks Section** (always visible, below perk selection):
  - Header: "Your Perks"
  - List of chosen perks sorted by rank ascending
  - Each entry shows: "Rank N: PerkName — description"
  - If no perks chosen yet, show subtle text "No perks chosen yet."

**Tab 3: "Leaderboard"** — Server-first hall of fame:
- Display all RenownServerFirst rows sorted by achievedAt descending (most recent first)
- Each entry: position badge (1st/2nd/3rd with gold/silver/bronze coloring), character name, achievement description (format: "{category}: {achievementKey}" humanized), timestamp
- If no entries, show "No server-firsts recorded yet."
- Group by category if helpful (boss_kill, achievement, etc.)

**Tab implementation:**
- Use a reactive `activeTab` ref with values 'factions' | 'renown' | 'leaderboard'
- Default to 'renown' tab
- Tab bar styled as inline buttons at top of panelBody (follow existing panel styling patterns — subtle borders, active tab highlighted)
- Tab buttons: "Factions", "Renown", "Leaderboard"

**Props interface:**
```typescript
defineProps<{
  styles: Record<string, Record<string, string | number>>;
  factions: FactionRow[];
  factionStandings: MyFactionStandingsRow[] | FactionStandingRow[];
  selectedCharacter: CharacterRow | null;
  renownData: RenownRow | null;
  renownPerks: RenownPerkRow[];
  serverFirsts: RenownServerFirstRow[];
  connActive: boolean;
}>();
```

**Emits:**
```typescript
defineEmits<{
  (e: 'choosePerk', perkKey: string): void;
}>();
```

**Client-side perk data:**
Duplicate the RENOWN_RANKS and RENOWN_PERK_POOLS as client-side constants inside RenownPanel.vue (or in a shared `src/data/renown_client.ts` file). These are needed for perk display and rank name lookups. Keep the format simple:

```typescript
const RENOWN_RANKS = [
  { rank: 1, name: 'Unsung', threshold: 0n },
  // ... all 15 ranks with thresholds
];

const RENOWN_PERK_POOLS: Record<number, Array<{ key: string; name: string; type: string; description: string }>> = {
  2: [
    { key: 'whispered_vitality', name: 'Whispered Vitality', type: 'passive', description: '+25 Max HP' },
    // ... etc
  ],
  // ... all ranks 2-15
};
```

Note: The perk descriptions are display-only — exact stat values should match what Plan 01 defined in renown_data.ts server-side. If the executor doesn't have access to the exact values, use reasonable approximations that match the tier scaling described in Plan 01.

**Styling:**
- Use existing `styles` prop patterns (styles.resultCard, styles.panelBody, styles.subtleSmall, styles.recipeName, etc.)
- Tab bar: flex row with gap, buttons using styles.actionButton pattern
- Active tab: styles.actionButtonActive or similar highlight
- Perk cards: solid border with hover effect, padding 12px, border-radius 8px
- Passive badge: color #5af (blue), Active badge: color #fa5 (amber)
- Progress bar: 8px height, rounded, gold gradient fill
- Leaderboard position colors: 1st=#fa5 (gold), 2nd=#aaa (silver), 3rd=#c85 (bronze)
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify the client compiles. Visually check that the RenownPanel renders by opening the app in browser and clicking the Renown button in the action bar.
  </verify>
  <done>
    RenownPanel displays three tabs (Factions, Renown, Leaderboard). Factions tab preserves existing faction standing display. Renown tab shows rank progression, perk selection, and chosen perks. Leaderboard tab shows server-first achievements. Perk selection emits to App.vue which calls the choose_perk reducer.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of Overall Renown System</name>
  <files>src/components/RenownPanel.vue, src/App.vue</files>
  <action>
    Human verifies the complete Overall Renown System:
    - Character-wide renown progression (15 ranks, 5 tiers)
    - Perk selection at each rank (permanent, pool-based choices)
    - Combat renown awards (small for regular enemies, large for bosses)
    - Server-first tracking with diminishing returns
    - Tabbed RenownPanel (Factions, Renown, Leaderboard)
    - Rank-up notification overlay

    Steps:
    1. Create a new character and verify the Renown panel opens from ActionBar
    2. Check Renown tab shows rank "Unsung" (Rank 1/15) with 0 renown and progress bar
    3. Check Factions tab still shows faction standings as before
    4. Check Leaderboard tab shows empty state or any existing entries
    5. Use /grant_test_renown command (or call reducer manually) to grant enough renown to reach rank 2 (100+ points)
    6. Verify rank-up notification appears as a dismissible overlay saying "Rank Up! Whispered"
    7. Dismiss notification and open Renown panel — verify perk selection is available with 2-3 options
    8. Choose a perk and verify it appears in "Your Perks" section and perk selection disappears
    9. Grant more renown to test progression through ranks 3-4
    10. Kill some enemies in combat and verify small renown gains appear in log
    11. Verify Factions tab still works correctly with faction standings from kills
  </action>
  <verify>Type "approved" or describe issues</verify>
  <done>All 11 verification steps pass. Renown system is fully functional end-to-end with rank progression, perk selection, combat integration, leaderboard, and notifications.</done>
</task>

</tasks>

<verification>
- Renown panel opens and shows three tabs
- Factions tab displays existing faction standings correctly
- Renown tab shows rank, points, and progress bar
- Perk selection appears at rank-up with correct number of options
- Choosing a perk is permanent (can't choose again for same rank)
- Leaderboard tab displays server-first entries
- Rank-up notification overlay appears and is dismissible
- Combat awards renown (visible in log messages)
- No regressions in existing combat, faction standing, or UI behavior
</verification>

<success_criteria>
Players see their renown progression, can choose perks at each rank, and observe renown gains from combat. The server-first leaderboard tracks milestone achievements. The entire system is human-verified as functional.
</success_criteria>

<output>
After completion, create `.planning/phases/12-overall-renown-system-character-wide-renown-separate-from-factions-renown-ranks-with-unlockable-perks-renown-gain-sources-from-events-bosses-achievements/12-03-SUMMARY.md`
</output>
