---
phase: 12-overall-renown-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/schema/tables.ts
  - spacetimedb/src/data/renown_data.ts
  - spacetimedb/src/helpers/renown.ts
  - spacetimedb/src/reducers/renown.ts
  - spacetimedb/src/reducers/index.ts
autonomous: true

must_haves:
  truths:
    - "Renown, RenownPerk, RenownServerFirst, and Achievement tables exist in the schema"
    - "15 named ranks with stepped 5-tier threshold curve are defined in renown_data.ts"
    - "Perk pools with 2-3 choices per rank (mix of passive stat bonuses and active abilities) are defined"
    - "choose_perk reducer validates rank eligibility, prevents duplicate picks, and records permanent selections"
    - "awardRenown helper grants points, calculates rank-ups, and announces rank-ups via world events"
    - "awardServerFirst helper tracks position, applies diminishing returns (1/2^n), and announces top 3"
    - "grant_test_renown admin reducer exists for testing renown point awards"
  artifacts:
    - path: "spacetimedb/src/schema/tables.ts"
      provides: "Renown, RenownPerk, RenownServerFirst, Achievement table definitions"
      contains: "renown"
    - path: "spacetimedb/src/data/renown_data.ts"
      provides: "RENOWN_RANKS, RENOWN_PERK_POOLS, RENOWN_GAIN constants"
    - path: "spacetimedb/src/helpers/renown.ts"
      provides: "awardRenown, awardServerFirst, calculateRankFromPoints, calculatePerkBonuses"
    - path: "spacetimedb/src/reducers/renown.ts"
      provides: "choose_perk, grant_test_renown, grant_test_achievement reducers"
    - path: "spacetimedb/src/reducers/index.ts"
      provides: "registerRenownReducers import and call"
  key_links:
    - from: "spacetimedb/src/helpers/renown.ts"
      to: "spacetimedb/src/data/renown_data.ts"
      via: "imports RENOWN_RANKS, RENOWN_PERK_POOLS"
      pattern: "import.*RENOWN_RANKS.*from.*renown_data"
    - from: "spacetimedb/src/reducers/renown.ts"
      to: "spacetimedb/src/helpers/renown.ts"
      via: "imports awardRenown, calculatePerkBonuses"
      pattern: "import.*awardRenown.*from.*helpers/renown"
    - from: "spacetimedb/src/reducers/index.ts"
      to: "spacetimedb/src/reducers/renown.ts"
      via: "registerRenownReducers call"
      pattern: "registerRenownReducers"
---

<objective>
Build the complete backend foundation for the Overall Renown System: database tables, rank/perk data definitions, helper functions, and core reducers.

Purpose: Establishes all server-side infrastructure for character-wide renown progression, perk selection, server-first tracking, and achievement system. This is the data layer that Plan 02 will integrate into combat and character creation, and Plan 03 will surface in the UI.

Output: Four new SpacetimeDB tables, rank/perk data constants, helper functions for renown award and server-first tracking, and choose_perk/grant_test_renown/grant_test_achievement reducers.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-overall-renown-system-character-wide-renown-separate-from-factions-renown-ranks-with-unlockable-perks-renown-gain-sources-from-events-bosses-achievements/12-RESEARCH.md
@spacetimedb/src/schema/tables.ts
@spacetimedb/src/helpers/events.ts
@spacetimedb/src/data/faction_data.ts
@spacetimedb/src/reducers/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Renown tables and rank/perk data constants</name>
  <files>
    spacetimedb/src/schema/tables.ts
    spacetimedb/src/data/renown_data.ts
  </files>
  <action>
**In `spacetimedb/src/schema/tables.ts`:**

Add four new tables before the `spacetimedb = schema(...)` export:

1. **Renown** — per-character renown progression:
   ```typescript
   export const Renown = table(
     {
       name: 'renown',
       public: true,
       indexes: [{ name: 'by_character', algorithm: 'btree', columns: ['characterId'] }],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       characterId: t.u64(),
       points: t.u64(),
       currentRank: t.u64(),
       updatedAt: t.timestamp(),
     }
   );
   ```

2. **RenownPerk** — permanent perk choices per character per rank:
   ```typescript
   export const RenownPerk = table(
     {
       name: 'renown_perk',
       public: true,
       indexes: [{ name: 'by_character', algorithm: 'btree', columns: ['characterId'] }],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       characterId: t.u64(),
       rank: t.u64(),
       perkKey: t.string(),
       chosenAt: t.timestamp(),
     }
   );
   ```

3. **RenownServerFirst** — tracks who achieved milestones and in what position:
   ```typescript
   export const RenownServerFirst = table(
     {
       name: 'renown_server_first',
       public: true,
       indexes: [{ name: 'by_category', algorithm: 'btree', columns: ['category'] }],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       category: t.string(),
       achievementKey: t.string(),
       characterId: t.u64(),
       characterName: t.string(),
       achievedAt: t.timestamp(),
       position: t.u64(),
     }
   );
   ```
   NOTE: Use single-column index on `category` only (multi-column indexes are broken per CLAUDE.md). Filter `achievementKey` manually in code.

4. **Achievement** — tracks character achievements (one-time milestones):
   ```typescript
   export const Achievement = table(
     {
       name: 'achievement',
       public: true,
       indexes: [{ name: 'by_character', algorithm: 'btree', columns: ['characterId'] }],
     },
     {
       id: t.u64().primaryKey().autoInc(),
       characterId: t.u64(),
       achievementKey: t.string(),
       achievedAt: t.timestamp(),
     }
   );
   ```

Add all four tables to the `schema(...)` call at the end of the file (add `Renown, RenownPerk, RenownServerFirst, Achievement` after `TravelCooldown`).

**In `spacetimedb/src/data/renown_data.ts` (NEW FILE):**

Create with these exports:

1. **RENOWN_RANKS** — 15 named ranks across 5 tiers with Shadeslinger-appropriate names:
   ```typescript
   export const RENOWN_RANKS = [
     // Tier 1: Fast early progression (ranks 1-3)
     { rank: 1, name: 'Unsung', threshold: 0n },
     { rank: 2, name: 'Whispered', threshold: 100n },
     { rank: 3, name: 'Recognized', threshold: 250n },
     // Tier 2: Moderate scaling (ranks 4-6)
     { rank: 4, name: 'Proven', threshold: 500n },
     { rank: 5, name: 'Stalwart', threshold: 900n },
     { rank: 6, name: 'Vanguard', threshold: 1500n },
     // Tier 3: Steeper climb (ranks 7-9)
     { rank: 7, name: 'Champion', threshold: 2500n },
     { rank: 8, name: 'Paragon', threshold: 4000n },
     { rank: 9, name: 'Exemplar', threshold: 6500n },
     // Tier 4: Prestige territory (ranks 10-12)
     { rank: 10, name: 'Hero', threshold: 10000n },
     { rank: 11, name: 'Exalted', threshold: 15000n },
     { rank: 12, name: 'Ascendant', threshold: 22000n },
     // Tier 5: Endgame legends (ranks 13-15)
     { rank: 13, name: 'Legend', threshold: 32000n },
     { rank: 14, name: 'Mythic', threshold: 47000n },
     { rank: 15, name: 'Eternal', threshold: 70000n },
   ] as const;
   ```

2. **calculateRankFromPoints** — reverse lookup from points to rank number.

3. **RENOWN_PERK_POOLS** — keyed by rank number (2-15), each with 2-3 perk options.
   - Ranks 2-3 (Tier 1): Simple stat bonuses (+25 HP, +1 STR, +1 INT, +1 DEX, etc.)
   - Ranks 4-6 (Tier 2): Larger stat bonuses (+50 HP, +2 stat) and one active ability per pool (e.g., "Second Wind" — restore 20% HP, 5 min cooldown)
   - Ranks 7-9 (Tier 3): Significant bonuses (+75 HP, +3 stat, +5% crit) and more active abilities (e.g., "Warcry" — +10% damage for 15s, 5 min cooldown)
   - Ranks 10-12 (Tier 4): Major bonuses (+100 HP, +4 stat, +2 armor) and powerful active abilities (e.g., "Rally" — group heal 15% HP, 10 min cooldown)
   - Ranks 13-15 (Tier 5): Legendary bonuses (+150 HP, +5 stat, +3 armor) and signature actives (e.g., "Defy Death" — prevent lethal blow once, 30 min cooldown)

   Each perk object: `{ key: string, name: string, type: 'passive' | 'active', description: string, effect: Record<string, bigint | number> }`
   - Passive effect keys: `maxHp`, `str`, `dex`, `int`, `wis`, `cha`, `armorClass`, `critMelee`, `critRanged`
   - Active effect keys: `cooldownSeconds`, `description` (effect described textually for now, actual activation deferred to future implementation)

   Rank 1 has no perk pool (starting rank). Provide at least 2 choices per rank, 3 for most.

4. **RENOWN_GAIN** — renown point amounts for each source type:
   ```typescript
   export const RENOWN_GAIN = {
     BOSS_KILL_BASE: 500n,           // Base renown for boss kills (modified by server-first)
     QUEST_COMPLETE_BASE: 50n,       // Base renown per quest completion
     ACHIEVEMENT_BASE: 200n,         // Base renown per achievement
     EVENT_PARTICIPATION_BASE: 100n, // Base renown per event participation
     PERSONAL_FIRST_BONUS: 50n,      // Additional bonus for personal-first completion
   } as const;
   ```

5. **ACHIEVEMENT_DEFINITIONS** — define at least 1 test achievement plus a few boss kill achievements:
   ```typescript
   export const ACHIEVEMENT_DEFINITIONS: Record<string, { name: string, description: string, renown: bigint }> = {
     'test_achievement': { name: 'First Steps', description: 'Begin your journey.', renown: 200n },
     'first_boss_kill': { name: 'Slayer', description: 'Defeat a powerful foe.', renown: 500n },
   };
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to verify no type errors. Verify the file exports are correct with `grep -c "export" spacetimedb/src/data/renown_data.ts`.
  </verify>
  <done>
    Four Renown-related tables defined in schema with proper indexes and added to schema() export. renown_data.ts contains RENOWN_RANKS (15 ranks, 5 tiers), RENOWN_PERK_POOLS (2-3 choices per rank, mix of passive/active), RENOWN_GAIN constants, ACHIEVEMENT_DEFINITIONS, and calculateRankFromPoints function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create renown helpers and reducers</name>
  <files>
    spacetimedb/src/helpers/renown.ts
    spacetimedb/src/reducers/renown.ts
    spacetimedb/src/reducers/index.ts
  </files>
  <action>
**In `spacetimedb/src/helpers/renown.ts` (NEW FILE):**

Create helper functions:

1. **awardRenown(ctx, character, points, reason)** — Core renown award function:
   - Get or lazy-create Renown row for character (insert with points=0n, currentRank=1n if missing)
   - Add points to existing total
   - Calculate new rank from total using calculateRankFromPoints
   - Update Renown row via `ctx.db.renown.id.update(...)` (use the id primary key for update)
   - Log system message: "You earned {points} renown: {reason}"
   - If rank increased: log "You have achieved rank: {rankName}!" and appendWorldEvent for the announcement
   - Import appendSystemMessage, appendWorldEvent from helpers/events.ts

2. **awardServerFirst(ctx, character, category, achievementKey, baseRenown)** — Server-first tracking:
   - Use single-column index `by_category` to filter, then manually filter by achievementKey (per CLAUDE.md multi-column index restriction)
   - Count existing entries for this category+achievementKey combo to determine position
   - Insert RenownServerFirst row with explicit position field
   - Calculate diminishing returns: `baseRenown / (2n ** (position - 1n))` using BigInt math (min 1n)
   - If position <= 3n, announce via appendWorldEvent: "{name} was {ordinal} to {category}: {key}!"
   - Return the calculated renown amount (caller uses awardRenown to actually grant it)

3. **calculatePerkBonuses(ctx, characterId)** — Aggregate passive perk stat bonuses:
   - Query RenownPerk by_character index for characterId
   - Look up each perkKey in RENOWN_PERK_POOLS
   - Accumulate only `passive` type perks' stat bonuses into a totals object
   - Return object with: `{ maxHp: bigint, str: bigint, dex: bigint, int: bigint, wis: bigint, cha: bigint, armorClass: bigint, critMelee: bigint, critRanged: bigint }`
   - All values default to 0n

4. **grantAchievement(ctx, character, achievementKey)** — Achievement grant helper:
   - Check if character already has this achievement (filter by_character, manual check achievementKey)
   - If already achieved, return false (no duplicate)
   - Insert Achievement row
   - Award renown using ACHIEVEMENT_DEFINITIONS lookup and awardServerFirst for position-based bonus
   - Add PERSONAL_FIRST_BONUS on top via awardRenown
   - Log system message about achievement earned
   - Return true

**In `spacetimedb/src/reducers/renown.ts` (NEW FILE):**

Create with `registerRenownReducers(deps)` pattern matching other reducer files:

1. **choose_perk** reducer — `{ characterId: t.u64(), perkKey: t.string() }`:
   - Use requireCharacterOwnedBy(ctx, characterId) for auth
   - Get Renown row via by_character index (error if none)
   - Lookup RENOWN_PERK_POOLS for current rank number
   - Validate perkKey exists in pool for this rank
   - Check no existing RenownPerk for this character+rank combo (filter by_character, find matching rank)
   - If already chosen, throw SenderError('Perk already chosen for this rank')
   - Insert RenownPerk row with rank, perkKey, chosenAt: ctx.timestamp
   - Log system message about perk choice

2. **grant_test_renown** reducer — `{ characterId: t.u64(), points: t.u64() }`:
   - Admin/test reducer for manually granting renown
   - Use requireCharacterOwnedBy for auth
   - Call awardRenown(ctx, character, points, 'Test grant')

3. **grant_test_achievement** reducer — `{ characterId: t.u64(), achievementKey: t.string() }`:
   - Admin/test reducer for granting test achievements
   - Use requireCharacterOwnedBy for auth
   - Call grantAchievement(ctx, character, achievementKey)
   - If returns false, throw SenderError('Achievement already earned')

Import deps pattern: receive `{ spacetimedb, t, SenderError }` from deps object, same as other reducer files. Check how registerCombatReducers or registerCharacterReducers receive their deps to match the exact pattern.

**In `spacetimedb/src/reducers/index.ts`:**

Add import for registerRenownReducers and call it in registerReducers function:
```typescript
import { registerRenownReducers } from './renown';
// Inside registerReducers:
registerRenownReducers(deps);
```
  </action>
  <verify>
    Run `npx tsc --noEmit --project spacetimedb/tsconfig.json` to verify no type errors. Verify reducers are registered by checking `grep "registerRenownReducers" spacetimedb/src/reducers/index.ts`.
  </verify>
  <done>
    renown.ts helpers (awardRenown, awardServerFirst, calculatePerkBonuses, grantAchievement) and renown.ts reducers (choose_perk, grant_test_renown, grant_test_achievement) are complete and registered. choose_perk enforces permanent single choice per rank. Server-first tracking uses diminishing returns with world event announcements for top 3.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project spacetimedb/tsconfig.json` passes with no errors
- All four new tables defined with correct indexes (single-column only)
- Tables added to schema() export
- 15 ranks defined with stepped threshold curve across 5 tiers
- Perk pools have 2-3 options per rank with mix of passive and active types
- choose_perk reducer enforces one permanent choice per rank
- awardRenown correctly calculates rank-ups and announces them
- awardServerFirst tracks positions and applies diminishing returns
- All reducer registrations wired in index.ts
</verification>

<success_criteria>
Backend compiles cleanly. Renown data layer is complete with all tables, constants, helpers, and core reducers ready for integration hooks (Plan 02) and UI (Plan 03).
</success_criteria>

<output>
After completion, create `.planning/phases/12-overall-renown-system-character-wide-renown-separate-from-factions-renown-ranks-with-unlockable-perks-renown-gain-sources-from-events-bosses-achievements/12-01-SUMMARY.md`
</output>
