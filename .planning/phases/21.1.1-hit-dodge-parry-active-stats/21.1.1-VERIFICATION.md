---
phase: 21.1.1-hit-dodge-parry-active-stats
verified: 2026-02-21T00:00:00Z
status: passed
score: 5/5 must-haves verified
re_verification: false
---

# Phase 21.1.1: Hit/Dodge/Parry Active Stats Verification Report

**Phase Goal:** Wire DEX-derived dodge/parry into combat via opposed roll — stat-derived avoidance replaces hardcoded 5% values, parry restricted against bow attacks.
**Verified:** 2026-02-21
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| #   | Truth                                                                                                                          | Status     | Evidence                                                                                                                        |
| --- | ------------------------------------------------------------------------------------------------------------------------------ | ---------- | ------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Enemy auto-attacks against player use player's dodgeChance and parryChance instead of hardcoded 5% (50n)                      | VERIFIED   | `clampedDodge`/`clampedParry` IIFEs at reducers/combat.ts:2994-3001 read from `targetCharacter.dodgeChance/parryChance`, passed as `dodgeChanceBasis`/`parryChanceBasis` at lines 3010-3011 |
| 2   | Player auto-attacks use player's hitChance to reduce enemy's effective dodge/parry window                                     | VERIFIED   | `attackerHitBonus` IIFE at reducers/combat.ts:2222-2225 reads `character.hitChance`, passed into `resolveAttack` at line 2233  |
| 3   | Parry is disabled when player-attacker is using a bow even if class is in PARRY_CLASSES                                       | VERIFIED   | reducers/combat.ts:2231: `canParry: canParry(character.className) && weapon.weaponType !== 'bow'`                               |
| 4   | Dodge and parry chances are capped (dodge max 250n, parry max 200n, hit bonus max 300n)                                       | VERIFIED   | reducers/combat.ts:2224 `raw > 300n ? 300n : raw`; :2996 `raw > 250n ? 250n : raw`; :3001 `raw > 200n ? 200n : raw`            |
| 5   | Pet attacks and enemy-attacks-pet call sites are unchanged — no regressions                                                   | VERIFIED   | reducers/combat.ts:2356 (pet attacks enemy): `canParry: false`, no dodge/parry basis passed; :2935 (enemy attacks pet): `canParry: false`, no dodge/parry basis passed — defaults to 50n floor unchanged |

**Score:** 5/5 truths verified

---

### Required Artifacts

| Artifact                                       | Expected                                                            | Status     | Details                                                                                                           |
| ---------------------------------------------- | ------------------------------------------------------------------- | ---------- | ----------------------------------------------------------------------------------------------------------------- |
| `spacetimedb/src/helpers/combat.ts`            | `rollAttackOutcome` with `dodgeChanceBasis`, `parryChanceBasis`, `attackerHitBonus` opts | VERIFIED | Lines 153-155: three optional opts declared; lines 163-174: `hitBonus = attackerHitBonus ?? 0n`; `net = raw > hitBonus ? raw - hitBonus : 0n` replaces former `cursor += 50n` |
| `spacetimedb/src/reducers/combat.ts`           | `resolveAttack` extended + two call sites wired with stat-derived values | VERIFIED | Lines 495-497: three opts destructured; lines 557-559: passed through to `rollAttackOutcome`; lines 2221-2233: player-attacks-enemy wired; lines 2993-3012: enemy-attacks-player wired |

---

### Key Link Verification

| From                                                          | To                                   | Via                                             | Status  | Details                                                                                                     |
| ------------------------------------------------------------- | ------------------------------------ | ----------------------------------------------- | ------- | ----------------------------------------------------------------------------------------------------------- |
| reducers/combat.ts enemy-attacks-player (~line 2993)          | rollAttackOutcome in helpers/combat.ts | resolveAttack passthrough of dodgeChanceBasis + parryChanceBasis | WIRED   | `clampedDodge` and `clampedParry` computed from `targetCharacter.dodgeChance/parryChance`, passed as `dodgeChanceBasis`/`parryChanceBasis` at lines 3010-3011; `resolveAttack` passes them to `rollAttackOutcome` at lines 557-558 |
| reducers/combat.ts player-attacks-enemy (~line 2221)          | rollAttackOutcome in helpers/combat.ts | resolveAttack passthrough of attackerHitBonus    | WIRED   | `attackerHitBonus` computed from `character.hitChance` (clamped 300n) at line 2222-2225, passed to `resolveAttack` at line 2233; threaded to `rollAttackOutcome` at line 559 |

---

### Anti-Patterns Found

No anti-patterns found in the two files modified by this phase.

Note: Pre-existing TypeScript errors exist in `src/helpers/combat.ts` at line 2382 (`computeEnemyStats` function) and in `src/helpers/corpse.ts`, `src/helpers/location.ts` — all confirmed pre-existing per the SUMMARY and none in the dodge/parry/hit logic introduced by this phase. Zero new errors were introduced.

---

### Human Verification Required

None. All behavioral assertions are verifiable via static code analysis:
- Stat derivation: character table schema at `schema/tables.ts:288-290` confirms `hitChance`, `dodgeChance`, `parryChance` columns on character table
- DEX computation: `helpers/character.ts:94-96` confirms stat derivation (`dex * 15n`, `dex * 12n`, `dex * 10n` formulas)
- Call site wiring: fully traceable via grep through `resolveAttack` to `rollAttackOutcome`

---

### Gaps Summary

No gaps. All five must-haves are fully implemented, wired, and substantive.

The hardcoded `cursor += 50n` lines for dodge and parry are confirmed absent from `helpers/combat.ts` (grep for `cursor += 50n` returns no matches). The stat-derived net formula (`raw > hitBonus ? raw - hitBonus : 0n`) is in place for both dodge and parry windows. All call site connections are verified end-to-end.

---

_Verified: 2026-02-21_
_Verifier: Claude (gsd-verifier)_
