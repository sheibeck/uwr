---
phase: 21.1.1-hit-dodge-parry-active-stats
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spacetimedb/src/helpers/combat.ts
  - spacetimedb/src/reducers/combat.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Enemy auto-attacks against a player use the player's dodgeChance and parryChance from the character table instead of the hardcoded 5% (50n) floor"
    - "Player auto-attacks against enemies use the player's hitChance to reduce the enemy's effective dodge/parry window"
    - "Parry is disabled when the player-attacker is using a bow (weaponType === 'bow') even if the class is in PARRY_CLASSES"
    - "Dodge and parry chances are capped (dodge max 250n, parry max 200n, hit bonus max 300n) so no build is untouchable"
    - "Pet attacks and enemy-attacks-pet call sites are unchanged — no regressions introduced"
  artifacts:
    - path: "spacetimedb/src/helpers/combat.ts"
      provides: "rollAttackOutcome with dodgeChanceBasis, parryChanceBasis, attackerHitBonus opts"
      contains: "dodgeChanceBasis"
    - path: "spacetimedb/src/reducers/combat.ts"
      provides: "resolveAttack opts extended + two call sites wired with stat-derived values"
      contains: "dodgeChanceBasis: clampedDodge"
  key_links:
    - from: "spacetimedb/src/reducers/combat.ts (enemy-attacks-player call site ~line 2933)"
      to: "rollAttackOutcome in helpers/combat.ts"
      via: "resolveAttack passthrough of dodgeChanceBasis + parryChanceBasis"
      pattern: "dodgeChanceBasis.*parryChanceBasis"
    - from: "spacetimedb/src/reducers/combat.ts (player-attacks-enemy call site ~line 2168)"
      to: "rollAttackOutcome in helpers/combat.ts"
      via: "resolveAttack passthrough of attackerHitBonus"
      pattern: "attackerHitBonus.*hitChance"
---

<objective>
Wire the character table's pre-computed `hitChance`, `dodgeChance`, and `parryChance` fields into `rollAttackOutcome`, replacing the hardcoded `50n` (5%) dodge and parry windows with stat-derived values.

Purpose: DEX-invested characters are meaningfully harder to hit and better at avoiding attacks. At DEX=10 (base), dodge=120 (12%), parry=100 (10%) replace the flat 5% floor — a significant gameplay change that makes DEX a live defensive stat.

Output: Modified `helpers/combat.ts` (new opts) and `reducers/combat.ts` (resolveAttack extended, two call sites wired). No schema changes, no publish, no bindings regeneration.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@spacetimedb/src/helpers/combat.ts
@spacetimedb/src/reducers/combat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend rollAttackOutcome with stat-derived dodge/parry/hit opts</name>
  <files>spacetimedb/src/helpers/combat.ts</files>
  <action>
Modify `rollAttackOutcome` (lines 145-189) to accept three new optional opts and use them in place of the hardcoded `50n`:

```typescript
// New opts to add to the opts object type (after canDodge, before characterDex):
dodgeChanceBasis?: bigint;   // on 1000-scale; default 50n (5%) — defender's pre-computed dodgeChance
parryChanceBasis?: bigint;   // on 1000-scale; default 50n (5%) — defender's pre-computed parryChance
attackerHitBonus?: bigint;   // on 1000-scale; default 0n  — attacker's pre-computed hitChance
```

Replace the existing dodge and parry blocks (lines 160-167):

**BEFORE:**
```typescript
if (opts.canDodge) {
  cursor += 50n;
  if (roll < cursor) return { outcome: 'dodge', multiplier: 0n };
}
if (opts.canParry) {
  cursor += 50n;
  if (roll < cursor) return { outcome: 'parry', multiplier: 0n };
}
```

**AFTER:**
```typescript
const hitBonus = opts.attackerHitBonus ?? 0n;
if (opts.canDodge) {
  const raw = opts.dodgeChanceBasis ?? 50n;
  const net = raw > hitBonus ? raw - hitBonus : 0n;
  cursor += net;
  if (roll < cursor) return { outcome: 'dodge', multiplier: 0n };
}
if (opts.canParry) {
  const raw = opts.parryChanceBasis ?? 50n;
  const net = raw > hitBonus ? raw - hitBonus : 0n;
  cursor += net;
  if (roll < cursor) return { outcome: 'parry', multiplier: 0n };
}
```

The `hitBonus` is subtracted from each window independently — a hit bonus doesn't double-dip against both dodge and parry, it reduces each window by the same flat amount. This matches the existing block system pattern where `blockChanceBasis` is simply a stat-derived value passed in.

No other changes to the function body. The `characterDex` field stays for crit chance (different mechanic). The block section is untouched.
  </action>
  <verify>
TypeScript compilation check: `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit 2>&1 | head -20`

Inspect that the new opts appear in the function signature and the replacement block uses `hitBonus`, `dodgeChanceBasis`, `parryChanceBasis`.
  </verify>
  <done>
`rollAttackOutcome` opts type contains `dodgeChanceBasis?: bigint`, `parryChanceBasis?: bigint`, `attackerHitBonus?: bigint`. The dodge/parry cursor additions use `net = raw > hitBonus ? raw - hitBonus : 0n` logic. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend resolveAttack and wire two call sites in combat.ts</name>
  <files>spacetimedb/src/reducers/combat.ts</files>
  <action>
**Step A — Extend `resolveAttack` opts type (~line 469)**

Add three new optional fields to the `resolveAttack` opts destructuring and type declaration, immediately after `blockMitigationPercent`:

```typescript
// In destructuring (after blockMitigationPercent):
dodgeChanceBasis,
parryChanceBasis,
attackerHitBonus,

// In the type annotation (after blockMitigationPercent?: bigint):
dodgeChanceBasis?: bigint;
parryChanceBasis?: bigint;
attackerHitBonus?: bigint;
```

Pass them through in the `rollAttackOutcome` call (~line 507):

```typescript
const outcome = rollAttackOutcome(seed, {
  canBlock,
  blockChanceBasis,
  blockMitigationPercent,
  canParry,
  canDodge,
  dodgeChanceBasis,   // ADD
  parryChanceBasis,   // ADD
  attackerHitBonus,   // ADD
  characterDex,
  weaponName,
  weaponType,
});
```

**Step B — Wire call site 1: player auto-attacks enemy (~line 2168)**

Before the `resolveAttack` call, compute the clamped hit bonus from the attacker's character:

```typescript
// Clamp attacker hitChance to [0n, 300n] (0%–30% on 1000-scale)
const attackerHitBonus: bigint = (() => {
  const raw = character.hitChance;
  return raw > 300n ? 300n : raw;
})();
```

Add `attackerHitBonus` to the `resolveAttack` call. Also update `canParry` to exclude bow-wielding attackers (enemies cannot parry a bow attack):

```typescript
canParry: canParry(character.className) && weapon.weaponType !== 'bow',
```

Note: at this call site `canParry` governs whether the ENEMY can parry the player's attack. The ranger using a bow should not trigger enemy parry. `weapon` is already in scope (it was read to get `weapon.weaponType` for `weaponName`/`weaponType` opts).

Full addition to the resolveAttack call:
```typescript
attackerHitBonus,
```

**Step C — Wire call site 2: enemy auto-attacks player (~line 2933)**

This is the primary defender-side wiring. After the existing `blockMitigationPercent` IIFE (~line 2927-2932), add two new clamped values:

```typescript
// Clamp defender dodgeChance to [0n, 250n] (0%–25% on 1000-scale)
const clampedDodge: bigint = (() => {
  const raw = targetCharacter.dodgeChance;
  return raw > 250n ? 250n : raw;
})();
// Clamp defender parryChance to [0n, 200n] (0%–20% on 1000-scale)
const clampedParry: bigint = (() => {
  const raw = targetCharacter.parryChance;
  return raw > 200n ? 200n : raw;
})();
```

Add both to the `resolveAttack` call:
```typescript
dodgeChanceBasis: clampedDodge,
parryChanceBasis: clampedParry,
```

Enemies have no `hitChance` column, so `attackerHitBonus` is omitted (defaults to 0n inside `rollAttackOutcome`).

**Call sites 3 and 4 (pet attacks enemy, enemy attacks pet) — NO CHANGES.** These already pass `canParry: false` and have no defender stat source, so the defaults are correct.

**Cap documentation (for future reference, add as inline comment above the IIFE):**
```typescript
// Caps: dodge [0,250] = max 25%, parry [0,200] = max 20%, hitBonus [0,300] = max 30%
```
  </action>
  <verify>
TypeScript compilation check: `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit 2>&1 | head -30`

Confirm:
1. `resolveAttack` opts type has the three new fields
2. The player-attacks-enemy call site has `attackerHitBonus` and the updated `canParry: canParry(character.className) && weapon.weaponType !== 'bow'`
3. The enemy-attacks-player call site has `dodgeChanceBasis: clampedDodge` and `parryChanceBasis: clampedParry`
4. No TypeScript errors
  </verify>
  <done>
`resolveAttack` opts type includes the three new bigint optional fields. Player-attacks-enemy call site passes `attackerHitBonus` (clamped hitChance) and excludes parry for bow attacks. Enemy-attacks-player call site passes `dodgeChanceBasis` and `parryChanceBasis` (clamped values). TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `npx tsc --noEmit` in `C:/projects/uwr/spacetimedb` — zero errors
2. Grep check: `grep -n "dodgeChanceBasis\|parryChanceBasis\|attackerHitBonus" spacetimedb/src/helpers/combat.ts spacetimedb/src/reducers/combat.ts` — should appear in both files
3. Grep check: `grep -n "weapon.weaponType !== 'bow'" spacetimedb/src/reducers/combat.ts` — should appear at the player-attacks-enemy call site
4. Verify the hardcoded `cursor += 50n` lines for dodge/parry are GONE from `helpers/combat.ts` (replaced by stat-derived logic)
5. Verify `blockChanceBasis` IIFE at ~line 2921 is untouched (block system must not regress)
</verification>

<success_criteria>
- `rollAttackOutcome` in `helpers/combat.ts` no longer uses hardcoded `50n` for dodge and parry windows
- Dodge window = `max(0, clampedDodgeChance - clampedHitBonus)`, parry window = same formula
- Player auto-attacks pass attacker's `hitChance` (clamped to 300n) as `attackerHitBonus`
- Enemy auto-attacks against player pass defender's `dodgeChance` (clamped 250n) and `parryChance` (clamped 200n)
- Bow-wielding players do not trigger enemy parry (`canParry: canParry(character.className) && weapon.weaponType !== 'bow'`)
- Pet attack and enemy-attacks-pet call sites are unchanged
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/21.1.1-hit-dodge-parry-active-stats/21.1.1-01-SUMMARY.md` using the summary template.
</output>
