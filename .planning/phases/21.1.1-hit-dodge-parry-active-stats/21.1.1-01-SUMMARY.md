---
phase: 21.1.1-hit-dodge-parry-active-stats
plan: 01
subsystem: combat
tags: [combat, dex, dodge, parry, hit-chance, auto-attack, spacetimedb]

# Dependency graph
requires:
  - phase: 21.1-stat-systems-off-stat-hooks
    provides: hitChance, dodgeChance, parryChance pre-computed on character table
provides:
  - rollAttackOutcome accepts stat-derived dodgeChanceBasis, parryChanceBasis, attackerHitBonus opts
  - resolveAttack passes the three new opts through to rollAttackOutcome
  - Player auto-attacks wire attacker hitChance (clamped 300n) as attackerHitBonus
  - Enemy auto-attacks wire defender dodgeChance (clamped 250n) and parryChance (clamped 200n)
  - Bow-wielding players no longer trigger enemy parry
affects: [combat, class-abilities, stats-panel]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Stat-derived chance on 1000-scale: raw - hitBonus pattern for net dodge/parry window"
    - "Clamped IIFE pattern for stat-derived combat values (consistent with blockChanceBasis)"
    - "Bow-type exclusion for parry: canParry(className) && weapon.weaponType !== 'bow'"

key-files:
  created: []
  modified:
    - spacetimedb/src/helpers/combat.ts
    - spacetimedb/src/reducers/combat.ts

key-decisions:
  - "hitBonus reduces dodge window and parry window independently (not double-dipped)"
  - "Caps: dodge max 250n (25%), parry max 200n (20%), hitBonus max 300n (30%) on 1000-scale"
  - "Default fallback is 50n (5%) for both dodge and parry when opts not provided — existing call sites unchanged"
  - "Bow attackers cannot trigger enemy parry — ranged attacks are unparriable by design"
  - "Enemies have no hitChance column so attackerHitBonus defaults to 0n at enemy call site"

patterns-established:
  - "Stat-derived window pattern: const net = raw > hitBonus ? raw - hitBonus : 0n; cursor += net;"

requirements-completed: []

# Metrics
duration: 12min
completed: 2026-02-21
---

# Phase 21.1.1 Plan 01: Hit/Dodge/Parry Active Stats Summary

**DEX-derived dodge (max 25%) and parry (max 20%) windows replace hardcoded 5% in rollAttackOutcome; attacker hitChance (max 30%) reduces each window independently**

## Performance

- **Duration:** ~12 min
- **Started:** 2026-02-21T00:00:00Z
- **Completed:** 2026-02-21T00:12:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Extended `rollAttackOutcome` with three new optional opts: `dodgeChanceBasis`, `parryChanceBasis`, `attackerHitBonus` — replacing hardcoded `cursor += 50n` for both dodge and parry windows
- Wired player-attacks-enemy call site to pass clamped `hitChance` as `attackerHitBonus` and disabled enemy parry for bow-wielding players
- Wired enemy-attacks-player call site to pass clamped `dodgeChance` and `parryChance` from defender character stats
- All other call sites (pet attacks, enemy-attacks-pet) remain unchanged — no regressions

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend rollAttackOutcome with stat-derived dodge/parry/hit opts** - `555c701` (feat)
2. **Task 2: Extend resolveAttack and wire two call sites in combat.ts** - `980492d` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `spacetimedb/src/helpers/combat.ts` - Added `dodgeChanceBasis?`, `parryChanceBasis?`, `attackerHitBonus?` to `rollAttackOutcome` opts; replaced hardcoded `cursor += 50n` with net = raw - hitBonus logic
- `spacetimedb/src/reducers/combat.ts` - Extended `resolveAttack` opts type and destructuring; pass-through to `rollAttackOutcome`; player-attacks-enemy site: hitChance IIFE + bow parry exclusion; enemy-attacks-player site: dodge/parry clamp IIFEs + opts wiring

## Decisions Made

- hitBonus reduces dodge and parry windows independently rather than once — a 30% hit bonus neutralizes up to 30% from each window separately, not 30% total. This is consistent with the additive cursor system.
- Bow weapons exclude enemy parry. A melee-parry is a physical deflection that doesn't apply to ranged projectiles.
- Fallback to 50n (5%) when opts omitted ensures all other call sites (pet attacks, enemy-pet attacks) behave identically to before.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

Pre-existing TypeScript errors exist across multiple other files (location.ts, corpse.ts, items.ts, movement.ts, social.ts, ensure_enemies.ts) — none are in the two files modified by this plan. The modifications introduced zero new TypeScript errors.

## User Setup Required

None - no external service configuration required. No schema changes, no publish, no bindings regeneration needed.

## Next Phase Readiness

- DEX is now a live defensive stat: at DEX=10 (base), dodge=120 (12%), parry=100 (10%) replace the old flat 5% floor
- StatsPanel already shows hitChance/dodgeChance/parryChance (wired in Phase 21.1 plan 04)
- Combat system ready for further tuning — caps can be adjusted in the IIFEs without schema changes

---
*Phase: 21.1.1-hit-dodge-parry-active-stats*
*Completed: 2026-02-21*
