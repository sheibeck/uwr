---
phase: 3.1-combat-balance
plan: 02
subsystem: combat
tags: [stat-scaling, combat-balance, critical-strikes, ability-damage, healing, damage-types]

# Dependency graph
requires:
  - phase: 3.1-01
    provides: Combat scaling foundation with formulas and constants
provides:
  - STR-scaled auto-attacks with multiplicative formula (1.5% per point)
  - DEX-based critical strikes with weapon-type-specific multipliers (150n-250n)
  - Stat-scaled ability damage using hybrid formula (base + stat_scaling) * ability_multiplier
  - WIS-scaled healing for healing classes (2% per point, multiplicative)
  - Damage type routing (magic bypasses armor, physical uses armor mitigation)
  - Published module with regenerated client bindings
affects: [all combat, all ability usage, all healing]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Stat scaling integrated into live combat pipeline"
    - "Critical strike system with weapon-type differentiation"
    - "Hybrid ability damage formula combining base power, stat scaling, and cast time"
    - "Damage type routing at mitigation layer"

key-files:
  created: []
  modified:
    - spacetimedb/src/index.ts
    - spacetimedb/src/reducers/combat.ts
    - spacetimedb/src/data/combat_scaling.ts
    - src/module_bindings/item_template_table.ts
    - src/module_bindings/item_template_type.ts

key-decisions:
  - "Magic damage bypasses armor entirely (per user decision: makes magic impactful)"
  - "Critical strikes use weapon type for multiplier lookup (fast=1.5x, medium=2.0x, slow=2.5x)"
  - "Roll granularity changed from /100n to /1000n for finer-grained crit probability"
  - "Weapon component in abilities only added when percent > 0n (pure spells use stat scaling only)"
  - "WIS healing scaling only applies to classes with wis as primary or secondary stat"

patterns-established:
  - "Import combat scaling functions at module level for use in nested functions"
  - "Damage type field from ability catalog drives mitigation routing"
  - "Caster's stats used for healing scaling, not target's stats"

# Metrics
duration: 8min
completed: 2026-02-12
---

# Phase 3.1 Plan 02: Wire Stat Scaling into Combat Pipeline Summary

**Live stat-scaled combat: STR scales auto-attacks (1.5%/point), DEX enables crits (weapon-specific multipliers), abilities scale via hybrid formula, WIS scales healing (2%/point), magic bypasses armor**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-12T21:07:26Z
- **Completed:** 2026-02-12T21:16:16Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- Player auto-attacks now scale multiplicatively with STR (1.5% per point, gear-dominant)
- DEX-based critical strikes with weapon-type-specific multipliers (daggers/rapiers/staffs 1.5x, swords/bows/maces 2.0x, axes 2.5x)
- Abilities use hybrid formula: (base + stat_scaling) * ability_multiplier / 100n
- Healing scales with caster's WIS (2% per point) for healing classes only
- Magic damage bypasses armor entirely, physical damage uses tuned armor curve
- Module published with clear-database and client bindings regenerated

## Task Commits

Each task was committed atomically:

1. **Task 1: Wire STR-scaled auto-attacks and DEX critical strikes** - `2da3bc1` (feat)
   - Updated rollAttackOutcome to support characterDex, weaponName, weaponType parameters
   - Changed roll granularity from /100n to /1000n for finer probability control
   - Wired calculateStatScaledAutoAttack into player auto-attack damage calculation
   - Added 'crit' outcome to combat log with specific message template
   - Updated getCritMultiplier to accept optional weaponType for direct lookup

2. **Task 2: Wire stat scaling into abilities, healing, damage type routing** - `c86f203` (feat - quick-35), `1617e72` (feat - bindings)
   - Added imports for getAbilityStatScaling, getAbilityMultiplier, calculateHealingPower, applyMagicResistMitigation
   - Updated applyDamage to calculate stat scaling based on ability type (STR/INT/WIS/CHA/hybrid)
   - Separated weapon component from pure ability damage for correct hybrid formula
   - Added damage type routing: magic bypasses armor, physical uses applyArmorMitigation
   - Updated applyHeal to apply WIS scaling via calculateHealingPower
   - Published module with clear-database
   - Regenerated client bindings (item_template_table.ts, item_template_type.ts)

**Note:** Task 2 code changes were committed in c86f203 (quick-35), bindings in 1617e72

## Files Created/Modified

- `spacetimedb/src/index.ts` - Added combat scaling imports, updated rollAttackOutcome signature for crit support, wired stat scaling into applyDamage and applyHeal
- `spacetimedb/src/reducers/combat.ts` - Imported calculateStatScaledAutoAttack, wired STR scaling into auto-attack damage, passed crit parameters to resolveAttack, added crit message
- `spacetimedb/src/data/combat_scaling.ts` - Updated getCritMultiplier to accept optional weaponType parameter
- `src/module_bindings/item_template_table.ts` - Regenerated bindings
- `src/module_bindings/item_template_type.ts` - Regenerated bindings

## Decisions Made

- **Magic damage impactful:** Magic damage bypasses armor entirely (per user decision from research phase). This makes INT-based casters highly effective against armored targets.
- **Weapon-specific crit multipliers:** Fast weapons (daggers/rapiers/staffs) crit for 1.5x, medium (swords/bows/maces) for 2.0x, slow (axes) for 2.5x. Balances high crit chance on DEX builds with weapon choice.
- **Finer crit probability:** Changed roll from /100n to /1000n to support 0.1% increments per DEX point (vs 1% increments with /100n).
- **Healing class gating:** WIS scaling only applies if className has wis as primary or secondary stat. Prevents non-healers from benefiting.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None. Module published successfully, bindings regenerated, client compiles (pre-existing readonly type warnings unrelated to this work).

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Stat scaling is now fully integrated into the combat pipeline. All combat damage (auto-attacks, abilities, healing) scales with character stats. Next steps could include:
- Testing stat scaling in live combat scenarios
- Balancing crit rates and multipliers based on gameplay feedback
- Adding magic resistance stat to enemies (foundation exists in combat_scaling.ts)
- Extending stat scaling to pet damage and enemy abilities

---
*Phase: 3.1-combat-balance*
*Completed: 2026-02-12*
