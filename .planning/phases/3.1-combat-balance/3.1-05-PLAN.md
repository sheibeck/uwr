---
phase: 3.1-combat-balance
plan: 05
type: execute
wave: 5
depends_on: ["3.1-04"]
gap_closure: true
files_modified:
  - spacetimedb/src/data/combat_scaling.ts
  - spacetimedb/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Shadow Cut deals ~25-30 damage at level 1 (not 52)"
    - "Mind Fray deals ~20-25 damage at level 1 (not 40-45)"
    - "Stats contribute ~30-40% of ability damage (gear-dominant design)"
    - "Auto-attacks remain unchanged at ~12 damage"
  artifacts:
    - path: "spacetimedb/src/data/combat_scaling.ts"
      provides: "Tuned ABILITY_STAT_SCALING_PER_POINT from 2n to 1n"
      contains: "ABILITY_STAT_SCALING_PER_POINT = 1n"
    - path: "spacetimedb/src/index.ts"
      provides: "Reduced power base multiplier from 10n to 5n"
      contains: "abilityEntry.power * 5n"
  key_links: []
---

<objective>
Tune ability damage scaling constants to achieve target damage ranges. Current formulas produce 2x expected damage because:
1. Power base multiplier (10n) is too high
2. Stat scaling per point (2n) makes stats contribute 50% of damage (violates gear-dominant principle)

Fix: Reduce both constants to bring level 1 abilities into 15-25 damage range.

Evidence:
- Mind Fray: (20 base + 20 stat) × 1.13 = 45 damage (expected ~20-25)
- Shadow Cut: (40 base + 16 stat) × 1.02 = 57 → 52 after armor (expected ~25-30)

Purpose: Make stats impactful but not dominant (~30-40% contribution), keep gear as primary power source.

Output: Published module with balanced ability damage scaling.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.1-combat-balance/3.1-CONTEXT.md
@.planning/phases/3.1-combat-balance/3.1-04-SUMMARY.md
@spacetimedb/src/index.ts
@spacetimedb/src/data/combat_scaling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tune ability scaling constants and republish</name>
  <files>
    spacetimedb/src/data/combat_scaling.ts
    spacetimedb/src/index.ts
  </files>
  <action>
**Part A: Reduce stat scaling constant in combat_scaling.ts**

Change line 35:
```typescript
// OLD
export const ABILITY_STAT_SCALING_PER_POINT = 2n;

// NEW
export const ABILITY_STAT_SCALING_PER_POINT = 1n;
```

**Reasoning:** With 2n per point, a character with 10 INT adds 20 damage, which equals the entire base damage of a power=2 ability. This makes stats contribute 50% of damage, violating the gear-dominant principle. Reducing to 1n makes stats contribute ~30-40% of damage at level 1.

**Part B: Reduce power base multiplier in index.ts**

Find line ~2053 in the applyDamage function:
```typescript
// OLD
const abilityBaseDamage = abilityEntry ? abilityEntry.power * 10n : 0n;

// NEW
const abilityBaseDamage = abilityEntry ? abilityEntry.power * 5n : 0n;
```

**Reasoning:** Power * 10n creates too much base damage. A power=4 ability starts at 40 damage before any scaling. Reducing to power * 5n brings base damage into reasonable range while preserving power rating differentiation (power=2 → 10 base, power=4 → 20 base, power=6 → 30 base).

**Expected results after changes:**

Mind Fray (power=2, INT=10, cast=1s, cooldown=6s):
- Base: 2 * 5n = 10n
- Stat: 10 * 1n = 10n
- Multiplier: 100n + 10n + 3n = 113n
- Total: ((10 + 10) * 113) / 100 = 22.6 ≈ 23 damage ✓

Shadow Cut (power=4, STR=8, cast=0s, cooldown=4s):
- Base: 4 * 5n = 20n
- Stat: 8 * 1n = 8n
- Multiplier: 100n + 0n + 2n = 102n
- Total: ((20 + 8) * 102) / 100 = 28.56 ≈ 28 damage → ~25 after armor ✓

**Part C: Publish and regenerate**

After code changes:
1. Compile check: `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit`
2. Publish: `spacetime publish uwr --clear-database -y --project-path C:/projects/uwr/spacetimedb`
3. Regenerate bindings: `spacetime generate --lang typescript --out-dir C:/projects/uwr/src/module_bindings --project-path C:/projects/uwr/spacetimedb`
4. Client compile: `cd C:/projects/uwr && npx vue-tsc --noEmit`
  </action>
  <verify>
1. TypeScript compiles: `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit`
2. Grep verifications:
   - `grep "ABILITY_STAT_SCALING_PER_POINT = 1n" C:/projects/uwr/spacetimedb/src/data/combat_scaling.ts`
   - `grep "abilityEntry.power \* 5n" C:/projects/uwr/spacetimedb/src/index.ts`
3. Publish succeeds: `spacetime publish uwr --clear-database -y`
4. Bindings regenerate: `spacetime generate --lang typescript ...`
5. Client compiles: `cd C:/projects/uwr && npx vue-tsc --noEmit`
  </verify>
  <done>
Ability scaling constants tuned. Power base multiplier reduced from 10n to 5n. Stat scaling reduced from 2n to 1n per point. Module published. Bindings regenerated. Ready for human re-verification.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- `spacetime publish` succeeds
- Grep confirms both constants changed
- Manual testing with Francis and Robbie:
  - Shadow Cut: ~25-30 damage (was 52)
  - Mind Fray: ~20-25 damage (was 40)
  - Stats contribute ~30-40% of damage (gear remains dominant)
</verification>

<success_criteria>
Ability damage in target range (15-25 for level 1). Stats meaningful but not dominant. Gear remains primary power source.
</success_criteria>

<output>
After completion, create `.planning/phases/3.1-combat-balance/3.1-05-SUMMARY.md`
</output>
