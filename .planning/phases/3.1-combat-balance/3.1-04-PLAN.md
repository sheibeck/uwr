---
phase: 3.1-combat-balance
plan: 04
type: execute
wave: 4
depends_on: ["3.1-02"]
gap_closure: true
files_modified:
  - spacetimedb/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Shadow Cut (power=4) deals ~20-30 damage at level 1, not 72"
    - "Mind Fray (power=2) deals ~15-25 damage at level 1, not 59"
    - "Abilities with power ratings use ONLY the hybrid formula, not weaponComponent"
    - "Abilities still scale with stats (INT, WIS, CHA, STR per ability)"
    - "Auto-attacks remain unchanged at ~12 damage"
  artifacts:
    - path: "spacetimedb/src/index.ts"
      provides: "Fixed ability damage calculations using only hybrid formula"
      contains: "applyDamage(0n, 0n"
  key_links:
    - from: "spacetimedb/src/index.ts"
      to: "spacetimedb/src/data/ability_catalog.ts"
      via: "reads power rating for hybrid formula"
      pattern: "abilityEntry.power"
---

<objective>
Fix ability damage double-dipping bug. Abilities are currently adding both weaponComponent (from old percent-based system) AND scaledAbilityDamage (from new hybrid formula), resulting in 5-6x expected damage.

Bug: Line 2063 in index.ts adds `weaponComponent + scaledAbilityDamage`. When abilities pass percent > 0 (e.g., Shadow Cut passes 150n, Mind Fray passes 105n), both components are calculated and summed.

Fix: Change all ability execution calls from `applyDamage(percent, bonus, ...)` to `applyDamage(0n, 0n, ...)` for abilities that have power ratings in ability_catalog.ts. This makes them use ONLY the hybrid formula: `(base + stat_scaling) * ability_multiplier / 100n`.

Evidence:
- Francis (Level 1 Rogue, STR 8): Shadow Cut 72 damage (expected ~20-30)
- Robbie (Level 1 Enchanter, INT 10): Mind Fray 59 damage (expected ~15-25)

Purpose: Restore ability damage to balanced levels while preserving stat scaling and ability multiplier mechanics.

Output: Published module with fixed ability damage. Abilities deal appropriate damage relative to auto-attacks.
</objective>

<execution_context>
@C:/Users/Dell/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dell/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.1-combat-balance/3.1-CONTEXT.md
@.planning/phases/3.1-combat-balance/3.1-02-SUMMARY.md
@spacetimedb/src/index.ts
@spacetimedb/src/data/ability_catalog.ts
@spacetimedb/src/data/combat_scaling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all ability execution calls to use 0n for percent and bonus</name>
  <files>
    spacetimedb/src/index.ts
  </files>
  <action>
Systematically update ALL ability execution cases in the executeAbility reducer (~lines 2084-2874) to change `applyDamage(percent, bonus, ...)` calls to `applyDamage(0n, 0n, ...)` for abilities that have a power rating in ability_catalog.ts.

**Strategy:**
1. Read ability_catalog.ts to identify ALL abilities with power > 0n
2. For each ability with power > 0n, find its execution case in index.ts
3. Change the applyDamage call from `applyDamage(somePercent, someBonus, ...)` to `applyDamage(0n, 0n, ...)`
4. Leave the rest of the ability logic unchanged (effects, cooldowns, etc.)

**Critical abilities from user testing:**
- `rogue_shadow_cut` (line ~2404): Change `applyDamage(150n, 4n, ...)` to `applyDamage(0n, 0n, ...)`
- `enchanter_mind_fray` (line ~2290): Change `applyDamage(105n, 1n, ...)` to `applyDamage(0n, 0n, ...)`

**Method:**
Use Grep to find all applyDamage calls with non-zero first argument:
```
pattern: "applyDamage\((?!0n,)\d+n,"
```

For each match:
1. Check if the ability has a power rating in ability_catalog.ts
2. If yes, change to `applyDamage(0n, 0n, ...)`
3. If no (ability uses weapon damage or has no power), leave unchanged

**Special cases to preserve:**
- Abilities that deal NO damage (utility abilities) — leave unchanged
- Abilities that apply damage through effects (DoTs) — leave unchanged, they use effect magnitude
- Pet abilities that call applyDamage with custom logic — review individually

**Abilities to update (from ability_catalog.ts, all with power > 0n):**

Level 1 damage abilities (power=2n):
- warrior_strike
- warrior_shield_bash
- rogue_shadow_cut
- rogue_pierce
- wizard_magic_missile
- wizard_frost_shard
- cleric_holy_bolt
- paladin_smite
- ranger_aimed_shot
- druid_thorn_lash
- necromancer_plague_spark
- shaman_chain_lightning
- reaver_blood_rend
- enchanter_mind_fray
- monk_palm_strike

Level 3 damage abilities (power=3n-4n):
- warrior_cleave
- rogue_fan_of_knives
- wizard_fireball
- cleric_consecrate
- paladin_hammer_of_justice
- ranger_multishot
- druid_nature_wrath
- necromancer_soul_drain
- shaman_lava_burst
- reaver_rend
- enchanter_psychic_scream
- monk_spinning_crane_kick

Level 5 damage abilities (power=4n-5n):
- warrior_execute
- rogue_envenom
- wizard_arcane_barrage
- cleric_divine_wrath
- paladin_divine_storm
- ranger_explosive_shot
- druid_starfall
- necromancer_death_coil
- shaman_earthquake
- reaver_blood_boil
- enchanter_dominate_mind
- monk_touch_of_death

**Verification pattern:**
After all changes, grep for `applyDamage\((?!0n)` should return ONLY:
- Abilities with no power rating (use weapon damage)
- Non-damage abilities (shouldn't have applyDamage calls anyway)

**Publish after changes:**
```bash
spacetime publish uwr --clear-database -y --project-path C:/projects/uwr/spacetimedb
```
  </action>
  <verify>
1. TypeScript compile: `cd C:/projects/uwr/spacetimedb && npx tsc --noEmit`
2. Grep verification: `pattern: "applyDamage\((?!0n,)\d+n,"` should return minimal matches (only non-power abilities)
3. Publish succeeds: `spacetime publish uwr --clear-database -y --project-path C:/projects/uwr/spacetimedb`
4. Key ability checks:
   - Grep for `rogue_shadow_cut` — should see `applyDamage(0n, 0n`
   - Grep for `enchanter_mind_fray` — should see `applyDamage(0n, 0n`
  </verify>
  <done>
All abilities with power ratings now call `applyDamage(0n, 0n, ...)`. weaponComponent is zero for these abilities. Only scaledAbilityDamage from hybrid formula is used. Module published. Ready for re-verification.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- `spacetime publish` succeeds
- Grep confirms all power-based abilities use `applyDamage(0n, 0n, ...)`
- Manual testing with Francis (Rogue) and Robbie (Enchanter):
  - Shadow Cut damage: ~20-30 (was 72)
  - Mind Fray damage: ~15-25 (was 59)
  - Auto-attacks unchanged: ~12
</verification>

<success_criteria>
Ability damage is balanced. Shadow Cut and Mind Fray deal appropriate damage relative to auto-attacks. Stat scaling still works. Ability multipliers still apply. No more double-dipping.
</success_criteria>

<output>
After completion, create `.planning/phases/3.1-combat-balance/3.1-04-SUMMARY.md`
</output>
