---
phase: 3.1-combat-balance
plan: 01
subsystem: combat-data
tags: [combat, balance, scaling, data-foundation]
completed: 2026-02-12
duration_minutes: 7

dependency_graph:
  requires: []
  provides:
    - combat_scaling.ts (all helper functions)
    - ABILITY_STAT_SCALING (ability-to-stat mapping)
    - damageType field on abilities
    - weaponType + magicResistanceBonus schema fields
    - Tuned armor mitigation curve
  affects:
    - spacetimedb/src/data/combat_scaling.ts (new)
    - spacetimedb/src/data/class_stats.ts (extended)
    - spacetimedb/src/data/ability_catalog.ts (extended)
    - spacetimedb/src/index.ts (schema + seeding)
    - spacetimedb/src/reducers/items.ts (schema)

tech_stack:
  added:
    - combat_scaling.ts data module
  patterns:
    - BigInt-only arithmetic for combat math
    - Centralized scaling constants
    - Stat-to-ability mapping via lookup table
    - Weapon type inference from name

key_files:
  created:
    - spacetimedb/src/data/combat_scaling.ts
  modified:
    - spacetimedb/src/data/class_stats.ts
    - spacetimedb/src/data/ability_catalog.ts
    - spacetimedb/src/index.ts
    - spacetimedb/src/reducers/items.ts

decisions:
  - STR scaling: 1.5% per point (15n per 1000) - multiplicative with weapon damage
  - Crit base: 5%, DEX adds 0.1% per point, cap at 50%
  - Weapon crit multipliers: fast 1.5x, medium 2.0x, slow 2.5x
  - Ability stat scaling: 2n flat per primary stat point, 1n per point for hybrid
  - Ability multiplier: cast time + cooldown affects damage multiplier
  - Healing WIS scaling: 2% per point (20n per 1000) - matches STR/INT magnitude
  - Magic resist: 3x multiplier (rarer but stronger than armor)
  - Armor curve: K=1 formula gives ~33% reduction at 50 armor, ~50% at 100 armor
  - Hybrid classes (paladin/spellblade/reaver) use physical damageType (weapon-primary)
  - inferWeaponType fallback: default to 'sword' if no match

metrics:
  lines_added: ~500
  files_created: 1
  files_modified: 4
  constants_defined: 9
  helper_functions: 7
  abilities_tagged: 80
---

# Phase 3.1 Plan 01: Combat Balance Data Foundation

**One-liner:** Create all combat scaling data, helper functions, and schema extensions for stat-based damage/healing/mitigation.

## What Was Built

This plan establishes the **data foundation** for stat-driven combat. Stats currently exist on Character rows but do NOT affect combat outcomes. This plan creates:

1. **combat_scaling.ts** — Centralized module with all scaling constants and helper functions
2. **ABILITY_STAT_SCALING** — Mapping of every ability to its primary scaling stat (str/int/wis/hybrid/cha/none)
3. **damageType field** — Added to all 80 abilities (physical/magic/none) for mitigation routing
4. **Schema extensions** — weaponType + magicResistanceBonus fields on ItemTemplate
5. **Armor mitigation tuning** — Changed curve from K=5 to K=1 (~33% at 50 armor, user-approved)
6. **getEquippedWeaponStats** — Extended to return weapon name + weaponType for crit lookup

**No functional changes to combat yet.** Plan 02 will wire these helpers into the combat pipeline.

---

## Technical Implementation

### Constants Defined (combat_scaling.ts)

```typescript
WEAPON_CRIT_MULTIPLIERS: Record<string, bigint>
  dagger/rapier/staff: 150n (1.5x)
  sword/blade/mace/bow: 200n (2.0x)
  axe: 250n (2.5x)

STR_SCALING_PER_1000 = 15n           // 1.5% per STR point
ABILITY_STAT_SCALING_PER_POINT = 2n  // Flat stat contribution for abilities
CRIT_BASE_CHANCE = 50n               // 5% base (per 1000 scale)
CRIT_DEX_BONUS_PER_POINT = 1n        // 0.1% per DEX
CRIT_CHANCE_CAP = 500n               // 50% max
HEALING_WIS_SCALING_PER_1000 = 20n   // 2% per WIS point
MAGIC_RESIST_SCALING = 3n            // 3x multiplier in formula
```

### Helper Functions Defined (combat_scaling.ts)

1. **calculateStatScaledAutoAttack**(baseWeaponDamage, characterStr)
   - Formula: `baseDamage + (baseDamage * str * 15n) / 1000n`
   - Multiplicative scaling keeps gear dominant

2. **calculateCritChance**(characterDex)
   - Formula: `min(50n + dex * 1n, 500n)`
   - Returns 0-1000 scale value

3. **getCritMultiplier**(weaponName)
   - Uses inferWeaponType + WEAPON_CRIT_MULTIPLIERS lookup
   - Fallback: 200n (2.0x)

4. **getAbilityStatScaling**(characterStats, abilityKey, className)
   - Pure classes: `stat * 2n` (str/int/wis/cha)
   - Hybrid classes: `(str + int) * 1n` (sum both stats, 1n per point)
   - Utility abilities: `0n`

5. **getAbilityMultiplier**(castSeconds, cooldownSeconds)
   - Formula: `100n + castSeconds * 10n + (cooldownSeconds > 0 ? cooldownSeconds * 5n / 10n : 0n)`
   - Longer cast/CD = higher multiplier

6. **calculateHealingPower**(baseHealing, casterWis, className)
   - Only applies WIS scaling for classes with primary='wis' or secondary='wis'
   - Formula: `baseHealing + (baseHealing * wis * 20n) / 1000n`

7. **applyMagicResistMitigation**(damage, magicResist)
   - Formula: `(damage * 100n) / (100n + magicResist * 3n)`
   - Returns max(mitigated, 1n)

### ABILITY_STAT_SCALING Mapping

- **STR (12 abilities):** warrior, rogue, monk, beastmaster melee
- **INT (12 abilities):** wizard, necromancer, summoner, enchanter arcane
- **WIS (12 abilities):** cleric, druid, shaman divine/nature, ranger shots
- **Hybrid (8 abilities):** paladin, spellblade, reaver (STR+INT)
- **CHA (3 abilities):** bard damage abilities
- **None (33 abilities):** utility/buff abilities

### Schema Extensions

**ItemTemplate table:**
```typescript
weaponType: t.string()             // sword/dagger/staff/axe/bow/mace/rapier/blade
magicResistanceBonus: t.u64()      // Rare magic damage mitigation
```

**Weapon seed data:**
All 8 training weapons updated with explicit weaponType values.

**All insert calls updated:**
- upsertItemTemplateByName defaults
- Resource items insert
- Bandage/craft items insert
- Food items insert
- create_item_template reducer

**getEquippedWeaponStats return type:**
```typescript
{ baseDamage, dps, name, weaponType }
```

### Armor Mitigation Tuning

**Before:**
```typescript
const scaledArmor = armorClass * 5n;  // K=5
const mitigated = (damage * 100n) / (100n + scaledArmor);
// 50 armor = 71% reduction (WAY too strong)
```

**After:**
```typescript
const mitigated = (damage * 100n) / (100n + armorClass);  // K=1
// 50 armor = 33.3% reduction
// 100 armor = 50% reduction
```

Matches user decision: "~30% at 50 armor, ~45% at 100 armor."

---

## Deviations from Plan

**None** — Plan executed exactly as written.

---

## Commits

| Task | Commit | Message |
|------|--------|---------|
| 1 | `ebfc83c` | feat(3.1-01): create combat scaling foundation data |
| 2 | `1b8a44d` | feat(3.1-01): extend schema and tune armor mitigation |

---

## Self-Check: PASSED

**Created files:**
```bash
FOUND: spacetimedb/src/data/combat_scaling.ts
```

**Modified files:**
```bash
FOUND: spacetimedb/src/data/class_stats.ts
FOUND: spacetimedb/src/data/ability_catalog.ts
FOUND: spacetimedb/src/index.ts
FOUND: spacetimedb/src/reducers/items.ts
```

**Commits:**
```bash
FOUND: ebfc83c (feat(3.1-01): create combat scaling foundation data)
FOUND: 1b8a44d (feat(3.1-01): extend schema and tune armor mitigation)
```

All claims verified.

---

## Next Steps

**Plan 02** will wire these helpers into the combat pipeline:
- Auto-attack damage uses calculateStatScaledAutoAttack
- Crit system uses calculateCritChance + getCritMultiplier
- Ability damage uses getAbilityStatScaling + getAbilityMultiplier
- Healing uses calculateHealingPower
- Magic damage uses applyMagicResistMitigation
- Physical damage continues using applyArmorMitigation (now tuned)

**Critical dependency:** Plan 02 MUST import from combat_scaling.ts and use these helpers. No hardcoded scaling logic should exist outside combat_scaling.ts.
