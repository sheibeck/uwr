---
phase: quick-313
task: fix v2 wire protocol table name mismatch
status: in_progress
last_updated: 2026-02-24T20:19:27.107Z
---

<current_state>
The v2 SpacetimeDB server sends snake_case table names over the wire (e.g. `location_connection`),
but the v2 SDK builds its `sourceNameToTableDef` lookup map using camelCase keys from the
`schema({...})` call (e.g. `locationConnection`). This causes "Cannot read properties of undefined
(reading 'columns')" on EVERY subscription response. The debug confirmed the server sends
`location_connection` while the client map has `locationConnection`.
</current_state>

<completed_work>

- quick-312: Committed v2 camelCase bindings (insufficient — wrong diagnosis)
- quick-313 partial: Removed 16 private tables from bindings, deleted 32 stale v1 files
- quick-313 partial: Replaced `aggroEntry` useTable with empty ref (private table not subscribable)
- quick-313 partial: Added debug logging to SDK cache — confirmed server sends snake_case `location_connection`
- quick-313 partial: Tried patching REMOTE_MODULE.tables sourceName in generated bindings — works but gets overwritten by `spacetime generate`
- Commits: d37b6f7, 5313fa5, dd55741, 4d69a65 (last one needs revert — modifies generated file)
</completed_work>

<remaining_work>

1. **Revert the generated file patch** (commit 4d69a65) — user confirmed we must not modify module_bindings
2. **Fix at source**: In `spacetimedb/src/schema/tables.ts` line 1768, change ALL ~99 schema keys from camelCase to snake_case:
   - `locationConnection: LocationConnection` → `location_connection: LocationConnection`
   - `abilityCooldown: AbilityCooldown` → `ability_cooldown: AbilityCooldown`
   - etc. for all ~99 table entries
3. **Republish**: `spacetime publish uwr --clear-database -y --project-path spacetimedb`
4. **Regenerate bindings**: `spacetime generate --lang typescript --out-dir src/module_bindings --module-path spacetimedb`
5. **Update ALL client code** referencing `tables.camelCase` to `tables.snake_case` (30+ files in src/composables/ and src/App.vue)
6. **Update server reducers** using `ctx.db.camelCase` to `ctx.db.snake_case` (all files in spacetimedb/src/)
7. Verify app loads without errors
</remaining_work>

<decisions_made>

- Cannot modify generated `src/module_bindings/` files — they get overwritten by `spacetime generate`
- The v2 server sends the `name:` field (snake_case) over the wire, NOT the `schema()` key (camelCase)
- The SDK sets `sourceName = accName` (the schema key), creating the mismatch
- Views already work because their schema keys ARE snake_case (e.g. `my_bank_slots`)
- This is likely a v2 SDK bug (sourceName should match wire name), but we fix at source level
</decisions_made>

<blockers>
- Large refactor: ~99 schema keys + all server ctx.db references + all client tables.X references
- Requires --clear-database on republish (table names change in DB)
</blockers>

<context>
The SDK's `tableToSchema()` at line 6282 sets `sourceName: accName` where accName is the key
in the `schema({...})` object. The `sourceNameToTableDef` map (line 5619) is keyed by this
sourceName. But the v2 server sends the canonical name (from `table({ name: 'xxx' })`) over
the wire protocol. The lookup fails because `'location_connection' !== 'locationConnection'`.

Key SDK locations in node_modules/spacetimedb/dist/index.browser.mjs:
- Line 6282: sourceName set to accName
- Line 5619: sourceNameToTableDef map built
- Line 5776: lookup that fails (parseRowList_fn)
- Line 7188: table() returns sourceName: accName

Server schema: spacetimedb/src/schema/tables.ts line 1768-1867
Client bindings: src/module_bindings/index.ts (GENERATED — do not edit)
</context>

<next_action>
1. Revert commit 4d69a65 (the generated file patch)
2. Write a script or do bulk find-replace to change all ~99 schema keys in tables.ts from camelCase to snake_case
3. Also update all ctx.db.X references in server reducers (spacetimedb/src/*.ts)
4. Republish with --clear-database, regenerate bindings
5. Update all client tables.X and conn.db.X references
</next_action>
