---
phase: quick-313
task: v2 wire protocol fix and v2 optimization research
status: completed_with_followup
last_updated: 2026-02-24T20:54:31.257Z
---

<current_state>
Quick-313 (schema rename) and quick-314 (race description fix) are COMPLETE and committed.
V2 refactoring research is complete — findings documented below. Next step is creating a new
phase for v2 subscription optimization work.
</current_state>

<completed_work>

- quick-313 RESOLVED: Renamed all ~78 multi-word schema keys from camelCase to snake_case
  across 51 files (schema keys, ctx.db.X, tables.X). This fixed the v2 wire protocol
  "Cannot read properties of undefined (reading 'columns')" error. Commit: 7fcb114
- quick-314: Fixed race description not showing on character creation — prop name mismatch
  in App.vue (selectedRaceRow → selectedRace). Commit: a3852f2
- Audit: No other prop name mismatches found across all 25 components
- V2 refactoring research: Fetched release notes, Vue quickstart, transactions docs,
  TypeScript SDK reference. Analyzed current codebase patterns.
- package.json updated: --project-path → --module-path (v2 CLI flag)
- spacetime publish flags updated: --clear-database → --delete-data=always

</completed_work>

<remaining_work>

## V2 Subscription Optimization (NEW PHASE NEEDED)

Research findings — three refactoring opportunities ranked by UI responsiveness impact:

### 1. HIGH: Replace subscribeToAllTables with scoped subscriptions
- SpacetimeDBProvider implicitly subscribes to ALL 77 public tables
- Every row change in ANY table triggers Vue reactivity
- Fix: Use explicit subscriptionBuilder().subscribe([...queries]) with feature groups
- Combat tables only during combat, crafting only when panel open, etc.

### 2. HIGH: Split monolithic useGameData into domain composables
- Currently 77 useTable() calls in one composable, ALL always active
- Split into: useCombatData, useCraftingData, useWorldData, useSocialData, etc.
- Lazy subscribe: only activate when relevant panel/feature is in use

### 3. MEDIUM: Use SQL-filtered subscriptions
- Currently subscribes to ALL rows of each table, filters in client JS
- Use: SELECT * FROM character WHERE locationId = X
- Dramatically reduces bandwidth for location-scoped data

### 4. MEDIUM: Convert event log tables to v2 Event Tables
- event_world, event_location, event_private, event_group stored permanently
- V2 Event Tables auto-delete at transaction boundary
- Reduces storage and bandwidth for ephemeral data

### 5. LOW: Typed query builder
- SQL strings → tables.character.where(c => c.locationId.eq(locId))
- Type safety improvement, minor perf impact

</remaining_work>

<decisions_made>

1. Schema keys renamed to snake_case (not camelCase table names to match) — the v2 generator
   mirrors server schema keys, so snake_case keys produce matching sourceName for wire protocol
2. No post-generate script needed — renaming at source fixed both server and generated client
3. v2 CLI flags: --module-path replaces --project-path, --delete-data replaces --clear-database
4. V2 subscription optimization is too large for a quick task — needs a dedicated phase

</decisions_made>

<blockers>
None. All quick tasks complete. V2 optimization is new planned work.
</blockers>

<context>
The UI responsiveness issue is real — subscribing to 77 tables simultaneously is the likely cause.
The SpacetimeDBProvider from spacetimedb/vue does subscribeToAllTables implicitly.
The v2 SDK provides subscriptionBuilder() for fine-grained control but the project doesn't use it yet.
This is a significant architectural refactor (new phase, not quick task).
</context>

<next_action>
Create a new phase for v2 subscription optimization:
1. /gsd:add-phase or /gsd:insert-phase for "V2 Subscription Optimization"
2. Phase should cover: scoped subscriptions, useGameData split, SQL-filtered queries
3. Consider /gsd:discuss-phase first to gather context on which tables are hot-path
</next_action>
