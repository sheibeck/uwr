# Quick Task 307: Migrate SpacetimeDB 1.12 → 2.0

## Status: IN PROGRESS — fatal error on publish, needs debugging

## Completed Steps

### 1. Package bumps ✅
- `spacetimedb/package.json`: `^1.12.0` → `^2.0.1` (npm installed)
- `package.json` (root): `^1.12.0` → `^2.0.1` (pnpm installed)

### 2. Schema export ✅
- `schema(T1, T2, ...)` → `schema({ T1, T2, ... })` (object syntax)
- `export default spacetimedb` + `export { spacetimedb }` in tables.ts
- `export default spacetimedb` in index.ts (via default import from tables)

### 3. Client connection ✅
- `withModuleName(DB_NAME)` → `withDatabaseName(DB_NAME)` in src/main.ts
- onConnect/onDisconnect callback signatures updated to v2

### 4. Scheduled tables ✅
- `scheduledReducers` registry in tables.ts
- All 14 scheduled tables: `scheduled: 'name'` → `scheduled: () => scheduledReducers['name']`
- All 14 scheduled reducer definitions capture return value into registry
- Files: tables.ts, index.ts, combat.ts, auth.ts, characters.ts, items_gathering.ts, world_events.ts

### 5. V2 export collection ✅
- ALL reducers must be named exports in v2 (spacetimedb.reducer() no longer auto-registers)
- Monkey-patch in index.ts wraps reducer/init/clientConnected/clientDisconnected/view
- Auto-collects return values into `_moduleExports` record
- Fixes v1 string-name convention: `('name', params, fn)` → `({ name }, params, fn)`
- Exports all via `export const _stdb_exports = spacetimedb.exportGroup(_moduleExports)`
- View in tables.ts (my_bank_slots) captured separately: `export const myBankSlotsView`

### 6. Index names ✅
- V2 requires globally unique index names (v1 allowed per-table duplicates)
- Fix: changed `name: 'by_xxx'` → `accessor: 'by_xxx'` in all 112 index defs
- `accessor` = JS property name (per-table, no uniqueness requirement)
- `name` = canonical SQL name (globally unique, now auto-generated by v2)

## Current Blocker: "The instance encountered a fatal error"

Publishing with `spacetime publish uwr --server local --delete-data=always -y -p spacetimedb` gives:
```
Publishing module...
Error: The instance encountered a fatal error.
Caused by: HTTP status server error (500 Internal Server Error)
```

BUT server logs show "Database updated" without errors. The fatal error has no JS stack trace (unlike previous errors). This may be:
1. A server-side crash during init reducer execution (large seeding logic)
2. A timeout issue (init reducer does a LOT of work: seeds 100+ tables)
3. The CLI retry causing a double-publish race condition
4. Something in the v2 runtime that crashes silently

### Debugging ideas:
- Check if `spacetime logs uwr -f` shows anything during a fresh publish
- Try publishing WITHOUT `--delete-data` to see if update works
- Comment out the `spacetimedb.init()` body to isolate if seeding causes the crash
- Check if the server process itself crashed (check OS process list / stderr)

## V2 Breaking Changes (from migration guide)

### Already handled:
- Schema object syntax + export default ✅
- withModuleName → withDatabaseName ✅
- Scheduled tables lazy thunks ✅
- All reducers/views must be named exports ✅
- Index name uniqueness ✅

### Not yet needed (verified absent from codebase):
- conn.reducers.onXxx() callbacks — NONE in codebase
- CallReducerFlags, withLightMode, UnknownTransaction — NONE
- setReducerFlags() — NONE

### Potentially still needed:
- Subscription API change: SQL strings → typed query builders (client-side, after bindings regen)
- CLI flag changes: `--project-path` → `-p`/`--module-path`, `--clear-database` → `--delete-data=always`
- `spacetime generate` flags may have changed too

## Key Commits
- 9f2a902: feat(quick-307): migrate server-side SpacetimeDB from 1.12 to 2.0
- 6b189de: feat(quick-307): migrate client-side SpacetimeDB from 1.12 to 2.0
- 834d986: feat(quick-307): v2 migration - scheduled reducers, export collection, index accessors
